<?php
// =================================================================
// UNI-PANEL (UNIPANEL) - KULÜP YÖNETİM PANELİ
// =================================================================

// Uygulama ortamı (production varsayılan, env veya sabit ile override edilebilir)
if (!defined('APP_ENV')) {
    $envFromSystem = getenv('APP_ENV') ?: ($_SERVER['APP_ENV'] ?? null);
    define('APP_ENV', $envFromSystem ? strtolower($envFromSystem) : 'production');
}

// DEBUG MODU - Sadece development ortamında hataları göster
if (APP_ENV === 'development') {
    error_reporting(E_ALL);
    ini_set('display_errors', 1);
    ini_set('display_startup_errors', 1);
} else {
    error_reporting(E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR);
    ini_set('display_errors', 0);
    ini_set('display_startup_errors', 0);
}
ini_set('log_errors', 1);
$tplLogFile = __DIR__ . '/../../logs/php_errors.log';
if (!file_exists($tplLogFile)) {
    @touch($tplLogFile);
}
@chmod($tplLogFile, 0600);
ini_set('error_log', $tplLogFile);

require_once __DIR__ . '/partials/logging.php';
require_once __DIR__ . '/partials/security_headers.php';
require_once __DIR__ . '/partials/path_guard.php';
require_once __DIR__ . '/partials/db_security.php';
require_once __DIR__ . '/partials/config_health.php';
require_once __DIR__ . '/partials/storage.php';
require_once __DIR__ . '/partials/inline_handler_bridge.php';
require_once __DIR__ . '/functions/validation.php';

// Autoloader (proj root bilinmese de templates/../lib yeterli)
$tplAutoloaderPath = __DIR__ . '/../lib/autoload.php';
tpl_safe_require($tplAutoloaderPath, 'Autoloader');

// Community bootstrap'ı önce yükle (PROJECT_ROOT tanımlanması için)
require_once __DIR__ . '/community_bootstrap.php';

// --- YAPILANDIRMA ---
// DB_PATH sabiti, tüm fonksiyon çağrılarından önce tanımlanmalıdır.
if (!defined('DB_PATH')) {
    define('DB_PATH', community_path('unipanel.sqlite'));
}
ensure_database_permissions(DB_PATH);
const CLUB_ID = 1; // Sabit kulüp ID'si

require_once __DIR__ . '/partials/schema_bootstrap.php';
tpl_inline_handler_transform_start();

// Security headers'ı ayarla (headers gönderilmeden önce)
set_security_headers();
$TPL_SCHEMA_STATUS = $GLOBALS['TPL_SCHEMA_STATUS'] ?? tpl_ensure_core_tables();
$TPL_CONFIG_HEALTH = tpl_get_comm_config_health();

if (!function_exists('tpl_filter_slug')) {
    /**
     * Safety shim for static analysers; real implementation lives in functions/validation.php.
     */
    function tpl_filter_slug($value, string $default = '', array $options = []): string
    {
        $value = trim((string)($value ?? ''));
        if ($value === '') {
            return $default;
        }

        $pattern = $options['pattern'] ?? '/^[a-z0-9_\-]+$/i';
        if (!preg_match($pattern, $value)) {
            return $default;
        }

        if (!empty($options['lowercase'])) {
            $value = strtolower($value);
        }

        return $value;
    }
}

if (!function_exists('tpl_current_action')) {
    function tpl_current_action(): string
    {
        static $cached = null;
        if ($cached !== null) {
            return $cached;
        }

        $cached = tpl_filter_slug($_POST['action'] ?? $_GET['action'] ?? '', '');
        return $cached;
    }
}

if (!function_exists('tpl_load_default_credentials')) {
    function tpl_load_default_credentials(): array
    {
        static $cache = null;
        if ($cache !== null) {
            return $cache;
        }

        $projectRoot = defined('PROJECT_ROOT') ? PROJECT_ROOT : dirname(__DIR__, 2);
        $configPath = $projectRoot . '/config/credentials.php';

        $defaults = [
            'smtp' => [
                'host' => 'mail.guzel.net.tr',
                'port' => 587,
                'username' => '',
                'password' => '',
                'from_email' => '',
                'from_name' => 'UniPanel',
                'encryption' => 'tls',
            ],
            'netgsm' => [
                'username' => '',
                'password' => '',
                'msgheader' => '',
            ],
        ];

        if (is_readable($configPath)) {
            try {
                $data = require $configPath;
                if (is_array($data)) {
                    if (isset($data['smtp']) && is_array($data['smtp'])) {
                        $defaults['smtp'] = array_merge($defaults['smtp'], $data['smtp']);
                    }
                    if (isset($data['netgsm']) && is_array($data['netgsm'])) {
                        $defaults['netgsm'] = array_merge($defaults['netgsm'], $data['netgsm']);
                    }
                }
            } catch (Throwable $e) {
                tpl_error_log('Default credential load failed: ' . $e->getMessage());
            }
        }

        $cache = $defaults;
        return $cache;
    }
}

if (!function_exists('tpl_seed_default_comm_settings')) {
    function tpl_seed_default_comm_settings(SQLite3 $db): void
    {
        if (!defined('CLUB_ID')) {
            return;
        }

        $creds = tpl_load_default_credentials();
        $smtp = $creds['smtp'];
        $netgsm = $creds['netgsm'];

        $defaults = [
            'smtp_host' => $smtp['host'] ?? '',
            'smtp_port' => (string)($smtp['port'] ?? '587'),
            'smtp_secure' => $smtp['encryption'] ?? 'tls',
            'smtp_username' => $smtp['username'] ?? '',
            'smtp_password' => $smtp['password'] ?? '',
            'smtp_from_email' => $smtp['from_email'] ?? ($smtp['username'] ?? ''),
            'smtp_from_name' => $smtp['from_name'] ?? 'UniPanel',
            'sms_provider' => 'netgsm',
            'netgsm_username' => $netgsm['username'] ?? '',
            'netgsm_password' => $netgsm['password'] ?? '',
            'netgsm_msgheader' => $netgsm['msgheader'] ?? '',
        ];

        foreach ($defaults as $key => $value) {
            $value = (string)$value;
            if ($value === '') {
                continue;
            }

            $check = $db->prepare("SELECT 1 FROM settings WHERE club_id = ? AND setting_key = ? LIMIT 1");
            $check->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $check->bindValue(2, $key, SQLITE3_TEXT);
            $exists = $check->execute();
            $hasRow = $exists && $exists->fetchArray(SQLITE3_NUM);
            if ($hasRow) {
                continue;
            }

            $insert = $db->prepare("INSERT INTO settings (club_id, setting_key, setting_value) VALUES (?, ?, ?)");
            $insert->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $insert->bindValue(2, $key, SQLITE3_TEXT);
            $insert->bindValue(3, $value, SQLITE3_TEXT);
            $insert->execute();
        }
    }
}

if (!function_exists('ensure_ai_helper_loaded')) {
    function ensure_ai_helper_loaded(): bool
    {
        static $aiHelperLoaded = null;
        if ($aiHelperLoaded !== null) {
            return $aiHelperLoaded;
        }

        $ai_helper_path = defined('PROJECT_ROOT')
            ? PROJECT_ROOT . '/lib/ai/AIHelper.php'
            : __DIR__ . '/../../lib/ai/AIHelper.php';

        if (tpl_safe_require($ai_helper_path, 'AIHelper')) {
            $aiHelperLoaded = true;
            return true;
        }

        tpl_error_log("AI Helper dosyası bulunamadı: " . $ai_helper_path);
        $aiHelperLoaded = false;
        return false;
    }
}

if (!function_exists('ensure_ai_function')) {
    function ensure_ai_function(string $functionName): bool
    {
        if (function_exists($functionName)) {
            return true;
        }

        if (!ensure_ai_helper_loaded()) {
            return false;
        }

        return function_exists($functionName);
    }
}

// Hata yakalama için exception handler (ErrorHandler'dan önce)
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    if (!(error_reporting() & $errno)) {
        return false;
    }
    
    $error_types = [
        E_ERROR => 'FATAL ERROR',
        E_WARNING => 'WARNING',
        E_PARSE => 'PARSE ERROR',
        E_NOTICE => 'NOTICE',
        E_CORE_ERROR => 'CORE ERROR',
        E_CORE_WARNING => 'CORE WARNING',
        E_COMPILE_ERROR => 'COMPILE ERROR',
        E_COMPILE_WARNING => 'COMPILE WARNING',
        E_USER_ERROR => 'USER ERROR',
        E_USER_WARNING => 'USER WARNING',
        E_USER_NOTICE => 'USER NOTICE',
        E_STRICT => 'STRICT',
        E_RECOVERABLE_ERROR => 'RECOVERABLE ERROR',
        E_DEPRECATED => 'DEPRECATED',
        E_USER_DEPRECATED => 'USER DEPRECATED'
    ];
    
    $error_type = $error_types[$errno] ?? 'UNKNOWN ERROR';
    
    $logMessage = sprintf('[%s] %s in %s on line %d', $error_type, $errstr, $errfile, $errline);
    tpl_error_log($logMessage);

    if (APP_ENV === 'development') {
        echo "<div style='background: #fee; border: 2px solid #f00; padding: 15px; margin: 10px; border-radius: 5px; font-family: monospace;'>";
        echo "<strong style='color: #c00;'>[$error_type]</strong><br>";
        echo "<strong>Dosya:</strong> " . htmlspecialchars($errfile) . "<br>";
        echo "<strong>Satır:</strong> $errline<br>";
        echo "<strong>Mesaj:</strong> " . htmlspecialchars($errstr) . "<br>";
        echo "</div>";
    }
    
    return true;
});

// Exception handler
set_exception_handler(function($exception) {
    // ErrorHandler varsa onu kullan
    if (class_exists('\UniPanel\Core\ErrorHandler')) {
        try {
            \UniPanel\Core\ErrorHandler::handleException($exception);
        } catch (Exception $e) {
            // ErrorHandler hatası varsa sessizce devam et
        }
    }
    
    $exceptionMessage = sprintf(
        '[UNCAUGHT EXCEPTION] %s in %s on line %d' . PHP_EOL . 'Stack trace: %s',
        $exception->getMessage(),
        $exception->getFile(),
        $exception->getLine(),
        $exception->getTraceAsString()
    );
    tpl_error_log($exceptionMessage);

    if (APP_ENV === 'development') {
        echo "<div style='background: #fee; border: 2px solid #f00; padding: 15px; margin: 10px; border-radius: 5px; font-family: monospace;'>";
        echo "<strong style='color: #c00;'>[UNCAUGHT EXCEPTION]</strong><br>";
        echo "<strong>Mesaj:</strong> " . htmlspecialchars($exception->getMessage()) . "<br>";
        echo "<strong>Dosya:</strong> " . htmlspecialchars($exception->getFile()) . "<br>";
        echo "<strong>Satır:</strong> " . $exception->getLine() . "<br>";
        echo "<strong>Stack Trace:</strong><pre>" . htmlspecialchars($exception->getTraceAsString()) . "</pre>";
        echo "</div>";
    }
});


tpl_safe_require(__DIR__ . '/lazy_loader.php', 'lazy_loader');

// SuperAdmin guard helper
require_once __DIR__ . '/partials/superadmin_guard.php';

// SuperAdmin Log Sistemi Fonksiyonları
function logToSuperAdmin($log_type, $data) {
    try {
        $superadmin_db = __DIR__ . '/../../unipanel.sqlite';
        if (!file_exists($superadmin_db)) {
            return;
        }
        
        $db = new SQLite3($superadmin_db);
        $db->enableExceptions(true);
        // Busy timeout ayarla (lock sorunlarını önler)
        $db->busyTimeout(5000);
        // DELETE mode kullan (WAL mode lock sorunlarına neden olabilir)
        @$db->exec('PRAGMA journal_mode = DELETE');
        
        // Community name'i al
        $community_name = 'Sistem';
        try {
            $db_temp = get_db();
            // Check if settings table exists
            $table_check = @$db_temp->query("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
            if ($table_check && $table_check->fetchArray()) {
                $club_name_stmt = @$db_temp->prepare("SELECT setting_value FROM settings WHERE setting_key = 'club_name' AND club_id = ? LIMIT 1");
                if ($club_name_stmt) {
            $club_name_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $club_name_result = $club_name_stmt->execute();
                } else {
                    $club_name_result = false;
                }
            } else {
                $club_name_result = false;
            }
            $club_name_row = $club_name_result->fetchArray(SQLITE3_ASSOC);
            if ($club_name_row && !empty($club_name_row['setting_value'])) {
                $community_name = $club_name_row['setting_value'];
            } elseif (defined('COMMUNITY_ID')) {
                $community_name = COMMUNITY_ID;
            }
        } catch (Exception $e) {
            if (defined('COMMUNITY_ID')) {
                $community_name = COMMUNITY_ID;
            }
        }
        
        switch ($log_type) {
            case 'admin_action':
                $stmt = $db->prepare("INSERT INTO activity_logs (community_name, user_type, user_id, username, action_type, action_description, ip_address, user_agent, additional_data) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
                $stmt->bindValue(1, $community_name, SQLITE3_TEXT);
                $stmt->bindValue(2, 'admin', SQLITE3_TEXT);
                $stmt->bindValue(3, $data['user_id'] ?? null, SQLITE3_INTEGER);
                $stmt->bindValue(4, $data['username'] ?? 'N/A', SQLITE3_TEXT);
                $stmt->bindValue(5, $data['action_type'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(6, $data['action_description'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(7, $_SERVER['REMOTE_ADDR'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(8, $_SERVER['HTTP_USER_AGENT'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(9, isset($data['additional_data']) ? json_encode($data['additional_data']) : null, SQLITE3_TEXT);
                $stmt->execute();
                break;
                
            case 'system_event':
                $stmt = $db->prepare("INSERT INTO system_logs (log_level, log_category, message, context, community_name) VALUES (?, ?, ?, ?, ?)");
                $stmt->bindValue(1, $data['log_level'] ?? 'info', SQLITE3_TEXT);
                $stmt->bindValue(2, $data['log_category'] ?? 'Genel', SQLITE3_TEXT);
                $stmt->bindValue(3, $data['message'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(4, isset($data['context']) ? json_encode($data['context']) : null, SQLITE3_TEXT);
                $stmt->bindValue(5, $community_name, SQLITE3_TEXT);
                $stmt->execute();
                break;
                
            case 'error':
                $stmt = $db->prepare("INSERT INTO error_logs (error_type, error_message, error_file, error_line, error_trace, community_name, user_id, request_url, ip_address) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
                $stmt->bindValue(1, $data['error_type'] ?? 'Error', SQLITE3_TEXT);
                $stmt->bindValue(2, $data['error_message'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(3, $data['error_file'] ?? null, SQLITE3_TEXT);
                $stmt->bindValue(4, $data['error_line'] ?? null, SQLITE3_INTEGER);
                $stmt->bindValue(5, $data['error_trace'] ?? null, SQLITE3_TEXT);
                $stmt->bindValue(6, $community_name, SQLITE3_TEXT);
                $stmt->bindValue(7, $data['user_id'] ?? null, SQLITE3_INTEGER);
                $stmt->bindValue(8, $_SERVER['REQUEST_URI'] ?? '', SQLITE3_TEXT);
                $stmt->bindValue(9, $_SERVER['REMOTE_ADDR'] ?? '', SQLITE3_TEXT);
                $stmt->execute();
                break;
        }
        
        $db->close();
    } catch (Exception $e) {
        // Log kaydetme hatası sessizce yok sayılır
    }
}

// Error Handler'ı başlat
use UniPanel\Core\ErrorHandler;

// Log dosyası yolunu PROJECT_ROOT kullanarak belirle
$errorLogPath = defined('PROJECT_ROOT') 
    ? PROJECT_ROOT . '/system/logs/error.log'
    : __DIR__ . '/../../system/logs/error.log';

// ErrorHandler'ı başlat (display errors ortam değişkenine göre)
$displayErrors = (defined('APP_ENV') && APP_ENV === 'development');
ErrorHandler::init($errorLogPath, $displayErrors);

// Session güvenlik ayarları
if (session_status() === PHP_SESSION_NONE) {
    // Session cookie güvenlik ayarları
    ini_set('session.cookie_httponly', 1);
    ini_set('session.cookie_secure', isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 1 : 0);
    ini_set('session.cookie_samesite', 'Strict');
    ini_set('session.use_strict_mode', 1);
    ini_set('session.cookie_lifetime', 0); // Session cookie browser kapanınca silinsin
    
    session_start();
    
    // Session fixation koruması
    if (!isset($_SESSION['initiated'])) {
        session_regenerate_id(true);
        $_SESSION['initiated'] = true;
    }
}

// error_reporting ve display_errors yukarıda ayarlandı, tekrar etmeye gerek yok

// --- CSRF KORUMASI ---
function generate_csrf_token() {
    if (!isset($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
        $_SESSION['csrf_token_time'] = time();
    }
    // Token 1 saatten eskiyse yenile
    if (isset($_SESSION['csrf_token_time']) && (time() - $_SESSION['csrf_token_time']) > 3600) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
        $_SESSION['csrf_token_time'] = time();
    }
    return $_SESSION['csrf_token'];
}

function verify_csrf_token($token) {
    // Session'da token yoksa false döndür
    if (!isset($_SESSION['csrf_token'])) {
        return false;
    }
    // Token boş veya null ise false döndür
    if (empty($token) || !is_string($token)) {
        return false;
    }
    return hash_equals($_SESSION['csrf_token'], $token);
}

function csrf_token_field() {
    $token = generate_csrf_token();
    return '<input type="hidden" name="csrf_token" value="' . htmlspecialchars($token) . '">';
}

// CSRF Token fonksiyonu (csrf_token() için)
if (!function_exists('csrf_token')) {
    function csrf_token() {
        return generate_csrf_token();
    }
}

// Token oluştur
generate_csrf_token();

// --- YAPILANDIRMA ---
// DB_PATH sabiti, tüm fonksiyon çağrılarından önce tanımlanmalıdır.
// Her topluluk için community_path yardımıyla dinamik olarak belirlenir.


// Import namespace'leri
use UniPanel\Core\Database;
use UniPanel\Core\Cache;
use UniPanel\Models\Event;
use UniPanel\Models\Member;
use UniPanel\Models\Notification;

// --- VERİTABANI İŞLEVLERİ ---

// Initialize Cache System
$fileCache = Cache::getInstance();

// In-memory cache (request-level)
$cache = [];
function getCachedData($key, $callback) {
    global $cache;
    if (!isset($cache[$key])) {
        $cache[$key] = $callback();
    }
    return $cache[$key];
}

// Helper function to get cache instance
function get_cache() {
    global $fileCache;
    return $fileCache;
}

// Helper function to clear cache for specific entity
function clear_entity_cache($entity) {
    $cache = get_cache();
    // Cache key'ini topluluk bazlı yap
    $cache_prefix = md5(DB_PATH);
    
    switch ($entity) {
        case 'events':
            $cache->delete('events_list_' . $cache_prefix);
            break;
        case 'members':
            $cache->delete('members_list_' . $cache_prefix);
            break;
        case 'board_members':
            $cache->delete('board_members_list_' . $cache_prefix);
            break;
        case 'partners':
            $cache->delete('partners_list_' . $cache_prefix);
            break;
        case 'membership_requests':
            $cache->delete('membership_requests_pending_' . $cache_prefix);
            $cache->delete('membership_requests_all_' . $cache_prefix);
            break;
        case 'settings':
            $cache->delete('settings_data_' . $cache_prefix);
            break;
        case 'all':
            // Tüm topluluk cache'lerini temizle
            $cache->delete('events_list_' . $cache_prefix);
            $cache->delete('members_list_' . $cache_prefix);
            $cache->delete('board_members_list_' . $cache_prefix);
            $cache->delete('partners_list_' . $cache_prefix);
            $cache->delete('settings_data_' . $cache_prefix);
            $cache->delete('membership_requests_pending_' . $cache_prefix);
            $cache->delete('membership_requests_all_' . $cache_prefix);
            break;
    }
}

/**
 * SQLite veritabanına bağlanır (Backward compatibility için).
 * @return SQLite3 Veritabanı bağlantı nesnesi.
 */
function get_db() {
    try {
        $database = Database::getInstance(DB_PATH);
        return $database->getDb();
    } catch (\Exception $e) {
        ErrorHandler::error("Veritabanı bağlantısı başarısız: " . $e->getMessage(), 500);
        exit;
    }
}

function ensure_settings_unique_index() {
    static $settingsIndexEnsured = false;
    if ($settingsIndexEnsured) {
        return;
    }
    $settingsIndexEnsured = true;

    try {
        $db = get_db();
        if (!$db instanceof SQLite3) {
            return;
        }

        $table_exists = $db->querySingle("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
        if (!$table_exists) {
            return;
        }

        // Ensure required columns exist before indexing
        $columns = [];
        $table_info = @$db->query("PRAGMA table_info(settings)");
        if ($table_info) {
            while ($row = $table_info->fetchArray(SQLITE3_ASSOC)) {
                $columns[] = $row['name'];
            }
        }
        if (!in_array('club_id', $columns, true)) {
            try {
                @$db->exec("ALTER TABLE settings ADD COLUMN club_id INTEGER DEFAULT 1");
            } catch (Exception $e) {
                tpl_error_log('Failed to add club_id column to settings: ' . $e->getMessage());
            }
        }
        if (!in_array('setting_key', $columns, true)) {
            // Cannot create index without setting_key column
            return;
        }

        $index_exists = false;
        $index_list = $db->query("PRAGMA index_list(settings)");
        if ($index_list) {
            while ($row = $index_list->fetchArray(SQLITE3_ASSOC)) {
                if (($row['name'] ?? '') === 'idx_settings_club_key') {
                    $index_exists = true;
                    break;
                }
            }
        }

        if (!$index_exists) {
            $duplicates = @$db->query("SELECT club_id, setting_key, MAX(id) AS keep_id FROM settings GROUP BY club_id, setting_key HAVING COUNT(*) > 1");
            if ($duplicates) {
                while ($dup = $duplicates->fetchArray(SQLITE3_ASSOC)) {
                    $stmt = @$db->prepare("DELETE FROM settings WHERE club_id = :club_id AND setting_key = :setting_key AND id <> :keep_id");
                    if ($stmt) {
                        $stmt->bindValue(':club_id', (int)($dup['club_id'] ?? 0), SQLITE3_INTEGER);
                        $stmt->bindValue(':setting_key', $dup['setting_key'] ?? '', SQLITE3_TEXT);
                        $stmt->bindValue(':keep_id', (int)($dup['keep_id'] ?? 0), SQLITE3_INTEGER);
                        $stmt->execute();
                    }
                }
            }

            @$db->exec("CREATE UNIQUE INDEX IF NOT EXISTS idx_settings_club_key ON settings (club_id, setting_key)");
        }
    } catch (Exception $e) {
        tpl_error_log('Settings unique index ensure failed: ' . $e->getMessage());
    }
}

ensure_settings_unique_index();

/**
 * email_campaigns ve email_queue tablolarının varlığını kontrol eder ve yoksa oluşturur.
 * Mevcut tablolarda eksik kolonları da ekler.
 * @param SQLite3 $db Veritabanı bağlantısı (opsiyonel, verilmezse get_db() kullanılır)
 */
function ensure_email_tables($db = null) {
    if ($db === null) {
        $db = get_db();
    }
    
    try {
        // Email Campaigns Tablosu (Toplu mail kampanyaları)
        $db->exec("CREATE TABLE IF NOT EXISTS email_campaigns (
            id INTEGER PRIMARY KEY,
            club_id INTEGER NOT NULL,
            subject TEXT NOT NULL,
            message TEXT NOT NULL,
            from_name TEXT,
            from_email TEXT,
            total_recipients INTEGER DEFAULT 0,
            sent_count INTEGER DEFAULT 0,
            failed_count INTEGER DEFAULT 0,
            status TEXT DEFAULT 'pending',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            started_at DATETIME,
            completed_at DATETIME
        )");
        
        // Email Queue Tablosu (Mail gönderim kuyruğu) - Gerçek hayat senaryoları için optimize edildi
        $db->exec("CREATE TABLE IF NOT EXISTS email_queue (
            id INTEGER PRIMARY KEY,
            campaign_id INTEGER NOT NULL,
            club_id INTEGER NOT NULL,
            recipient_email TEXT NOT NULL,
            recipient_name TEXT,
            subject TEXT NOT NULL,
            message TEXT NOT NULL,
            from_name TEXT,
            from_email TEXT,
            status TEXT DEFAULT 'pending',
            attempts INTEGER DEFAULT 0,
            max_attempts INTEGER DEFAULT 3,
            next_retry_at DATETIME,
            error_message TEXT,
            error_code TEXT,
            bounce_reason TEXT,
            is_bounced INTEGER DEFAULT 0,
            is_duplicate INTEGER DEFAULT 0,
            delivery_status TEXT,
            smtp_response TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            sent_at DATETIME,
            last_attempt_at DATETIME,
            FOREIGN KEY (campaign_id) REFERENCES email_campaigns(id) ON DELETE CASCADE
        )");
        
        // Email Bounces Tablosu (Geri dönen mailler)
        $db->exec("CREATE TABLE IF NOT EXISTS email_bounces (
            id INTEGER PRIMARY KEY,
            club_id INTEGER NOT NULL,
            recipient_email TEXT NOT NULL,
            bounce_type TEXT,
            bounce_reason TEXT,
            bounce_message TEXT,
            occurred_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            queue_id INTEGER,
            FOREIGN KEY (queue_id) REFERENCES email_queue(id) ON DELETE SET NULL
        )");
        
        // Email Delivery Logs Tablosu (Teslimat durumu takibi)
        $db->exec("CREATE TABLE IF NOT EXISTS email_delivery_logs (
            id INTEGER PRIMARY KEY,
            queue_id INTEGER NOT NULL,
            club_id INTEGER NOT NULL,
            recipient_email TEXT NOT NULL,
            delivery_status TEXT,
            smtp_response TEXT,
            provider TEXT,
            logged_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (queue_id) REFERENCES email_queue(id) ON DELETE CASCADE
        )");
        
        // SMS Queue Tablosu (SMS gönderim kuyruğu)
        $db->exec("CREATE TABLE IF NOT EXISTS sms_queue (
            id INTEGER PRIMARY KEY,
            club_id INTEGER NOT NULL,
            recipient_phone TEXT NOT NULL,
            recipient_name TEXT,
            message TEXT NOT NULL,
            provider TEXT DEFAULT 'netgsm',
            status TEXT DEFAULT 'pending',
            attempts INTEGER DEFAULT 0,
            max_attempts INTEGER DEFAULT 3,
            next_retry_at DATETIME,
            error_message TEXT,
            error_code TEXT,
            is_duplicate INTEGER DEFAULT 0,
            delivery_status TEXT,
            provider_response TEXT,
            cost REAL DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            sent_at DATETIME,
            last_attempt_at DATETIME
        )");
        
        // SMS Delivery Logs Tablosu (SMS teslimat durumu takibi)
        $db->exec("CREATE TABLE IF NOT EXISTS sms_delivery_logs (
            id INTEGER PRIMARY KEY,
            queue_id INTEGER NOT NULL,
            club_id INTEGER NOT NULL,
            recipient_phone TEXT NOT NULL,
            delivery_status TEXT,
            provider_response TEXT,
            provider TEXT,
            cost REAL DEFAULT 0,
            logged_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (queue_id) REFERENCES sms_queue(id) ON DELETE CASCADE
        )");
        
        // Mevcut tablolarda eksik kolonları kontrol et ve ekle
        // email_campaigns tablosu için
        $table_info = $db->query("PRAGMA table_info(email_campaigns)");
        $email_campaigns_columns = [];
        while ($row = $table_info->fetchArray(SQLITE3_ASSOC)) {
            $email_campaigns_columns[] = $row['name'];
        }
        
        $required_campaigns_columns = [
            'club_id' => 'INTEGER DEFAULT 1',
            'started_at' => 'DATETIME',
            'completed_at' => 'DATETIME'
        ];
        
        foreach ($required_campaigns_columns as $column => $definition) {
            if (!in_array($column, $email_campaigns_columns)) {
                try {
                    // Güvenlik: Column name ve definition'ı whitelist ile kontrol et
                    $allowed_columns = ['club_id', 'started_at', 'completed_at'];
                    if (in_array($column, $allowed_columns)) {
                        // Definition'ı sadece izin verilen değerlerle sınırla
                        $safe_definition = preg_replace('/[^A-Za-z0-9_ ()-]/', '', $definition);
                        $db->exec("ALTER TABLE email_campaigns ADD COLUMN $column $safe_definition");
                    }
                    // Eğer club_id eklendiyse, mevcut kayıtlara CLUB_ID değerini ata
                    if ($column === 'club_id') {
                        $update_stmt = $db->prepare("UPDATE email_campaigns SET club_id = ? WHERE club_id IS NULL OR club_id = 0");
                        $update_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                        $update_stmt->execute();
                    }
                } catch (Exception $e) {
                    tpl_error_log("email_campaigns tablosuna $column kolonu eklenemedi: " . $e->getMessage());
                }
            }
        }
        
        // email_queue tablosu için
        $table_info = $db->query("PRAGMA table_info(email_queue)");
        $email_queue_columns = [];
        while ($row = $table_info->fetchArray(SQLITE3_ASSOC)) {
            $email_queue_columns[] = $row['name'];
        }
        
        $required_queue_columns = [
            'club_id' => 'INTEGER DEFAULT 1',
            'recipient_name' => 'TEXT',
            'subject' => 'TEXT DEFAULT ""',
            'message' => 'TEXT DEFAULT ""',
            'from_name' => 'TEXT',
            'from_email' => 'TEXT',
            'max_attempts' => 'INTEGER DEFAULT 3',
            'next_retry_at' => 'DATETIME',
            'error_code' => 'TEXT',
            'bounce_reason' => 'TEXT',
            'is_bounced' => 'INTEGER DEFAULT 0',
            'is_duplicate' => 'INTEGER DEFAULT 0',
            'delivery_status' => 'TEXT',
            'smtp_response' => 'TEXT',
            'last_attempt_at' => 'DATETIME'
        ];
        
        foreach ($required_queue_columns as $column => $definition) {
            if (!in_array($column, $email_queue_columns)) {
                try {
                    // Güvenlik: Column name ve definition'ı whitelist ile kontrol et
                    $allowed_columns = ['club_id', 'recipient_name', 'subject', 'message', 'from_name', 'from_email', 'max_attempts', 'next_retry_at', 'error_code', 'bounce_reason', 'is_bounced', 'is_duplicate', 'delivery_status', 'smtp_response', 'last_attempt_at'];
                    if (in_array($column, $allowed_columns)) {
                        // Definition'ı sadece izin verilen değerlerle sınırla
                        $safe_definition = preg_replace('/[^A-Za-z0-9_ ()-]/', '', $definition);
                        $db->exec("ALTER TABLE email_queue ADD COLUMN $column $safe_definition");
                    }
                    // Eğer club_id eklendiyse, mevcut kayıtlara CLUB_ID değerini ata
                    if ($column === 'club_id') {
                        $update_stmt = $db->prepare("UPDATE email_queue SET club_id = ? WHERE club_id IS NULL OR club_id = 0");
                        $update_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                        $update_stmt->execute();
                    }
                } catch (Exception $e) {
                    tpl_error_log("email_queue tablosuna $column kolonu eklenemedi: " . $e->getMessage());
                }
            }
        }
    } catch (Exception $e) {
        tpl_error_log("ensure_email_tables hatası: " . $e->getMessage());
    }
}

/**
 * rate_limits tablosunun varlığını kontrol eder ve yoksa oluşturur.
 * @param SQLite3 $db Veritabanı bağlantısı (opsiyonel, verilmezse get_db() kullanılır)
 */
function ensure_rate_limits_table($db = null) {
    if ($db === null) {
        $db = get_db();
    }
    
    try {
        // Rate Limiting Tablosu (Email/SMS spam koruması)
        $db->exec("CREATE TABLE IF NOT EXISTS rate_limits (
            id INTEGER PRIMARY KEY,
            club_id INTEGER NOT NULL,
            action_type TEXT NOT NULL,
            action_count INTEGER DEFAULT 0,
            hour_timestamp TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )");
    } catch (Exception $e) {
        tpl_error_log("ensure_rate_limits_table hatası: " . $e->getMessage());
    }
}

/**
 * event_rsvp tablosunun varlığını kontrol eder ve yoksa oluşturur.
 * @param SQLite3 $db Veritabanı bağlantısı (opsiyonel, verilmezse get_db() kullanılır)
 */
function ensure_event_rsvp_table($db = null) {
    if ($db === null) {
        $db = get_db();
    }
    
    // event_rsvp tablosu yoksa oluştur
    $db->exec("CREATE TABLE IF NOT EXISTS event_rsvp (
        id INTEGER PRIMARY KEY,
        event_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        member_name TEXT NOT NULL,
        member_email TEXT NOT NULL,
        member_phone TEXT,
        rsvp_status TEXT DEFAULT 'attending',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
    )");
}

function ensure_products_table($db = null) {
    if ($db === null) {
        $db = get_db();
    }
    
    try {
        $db->exec("CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY,
            club_id INTEGER,
            name TEXT NOT NULL,
            description TEXT,
            price REAL DEFAULT 0,
            stock INTEGER DEFAULT 0,
            category TEXT DEFAULT 'Genel',
            image_path TEXT,
            status TEXT DEFAULT 'active',
            commission_rate REAL DEFAULT 8.0,
            iyzico_commission REAL DEFAULT 0,
            platform_commission REAL DEFAULT 0,
            total_price REAL DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )");
        
        // Migration: Eksik kolonları ekle
        // Önce mevcut kolonları kontrol et
        $table_info = $db->query("PRAGMA table_info(products)");
        $existing_columns = [];
        while ($row = $table_info->fetchArray(SQLITE3_ASSOC)) {
            $existing_columns[] = $row['name'];
        }
        
        $columns_to_add = [
            'commission_rate' => 'REAL DEFAULT 8.0',
            'iyzico_commission' => 'REAL DEFAULT 0',
            'platform_commission' => 'REAL DEFAULT 0',
            'total_price' => 'REAL DEFAULT 0'
        ];
        
        foreach ($columns_to_add as $column => $definition) {
            // Kolon zaten varsa ekleme
            if (!in_array($column, $existing_columns)) {
            try {
                    $safe_definition = preg_replace('/[^A-Za-z0-9_ ().-]/', '', $definition);
                    $db->exec("ALTER TABLE products ADD COLUMN {$column} {$safe_definition}");
            } catch (Exception $e) {
                    tpl_error_log("products tablosuna $column kolonu eklenemedi: " . $e->getMessage());
                }
            }
        }
    } catch (Exception $e) {
        tpl_error_log("ensure_products_table hatası: " . $e->getMessage());
    }
}

function ensure_membership_requests_table($db = null) {
    if ($db === null) {
        $db = get_db();
    }

    $db->exec("CREATE TABLE IF NOT EXISTS membership_requests (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        user_id INTEGER,
        full_name TEXT,
        email TEXT,
        phone TEXT,
        student_id TEXT,
        department TEXT,
        status TEXT DEFAULT 'pending',
        admin_notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        additional_data TEXT,
        UNIQUE(club_id, email)
    )");
}

/**
 * Gerekli tabloları oluşturur ve varsayılan ayarları ekler.
 * @param SQLite3 $db Veritabanı bağlantısı.
 */
function setup_database(SQLite3 $db) {
    // 1. Ayarlar Tablosu
    $db->exec("CREATE TABLE IF NOT EXISTS settings (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        setting_key TEXT NOT NULL,
        setting_value TEXT NOT NULL
    )");
    
    tpl_seed_default_comm_settings($db);
    
    // Varsayılan kulüp adını ayarla
    $stmt = @$db->prepare("SELECT COUNT(*) FROM settings WHERE setting_key = 'club_name'");
    if ($stmt) {
        $result = $stmt->execute();
        if ($result) {
            $count = $result->fetchArray()[0] ?? 0;
    if ($count == 0) {
        $db->exec("INSERT INTO settings (club_id, setting_key, setting_value) VALUES (1, 'club_name', 'Sanat ve Tasarım Topluluğu')");
        $db->exec("INSERT INTO settings (club_id, setting_key, setting_value) VALUES (1, 'status', 'active')");
            }
        }
    }

    // Trial başlangıç tarihini kontrol et ve yoksa ekle
    $trial_stmt = @$db->prepare("SELECT COUNT(*) FROM settings WHERE setting_key = 'trial_start_date' AND club_id = ?");
    if ($trial_stmt) {
    $trial_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
        $trial_result = $trial_stmt->execute();
        if ($trial_result) {
            $trial_count = $trial_result->fetchArray()[0] ?? 0;
    if ($trial_count == 0) {
        $trial_start_date = date('Y-m-d');
                $trial_insert = @$db->prepare("INSERT INTO settings (club_id, setting_key, setting_value) VALUES (?, ?, ?)");
                if ($trial_insert) {
        $trial_insert->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
        $trial_insert->bindValue(2, 'trial_start_date', SQLITE3_TEXT);
        $trial_insert->bindValue(3, $trial_start_date, SQLITE3_TEXT);
        $trial_insert->execute();
                }
            }
        }
    }

    // 2. Etkinlikler Tablosu (Genişletilmiş)
    $db->exec("CREATE TABLE IF NOT EXISTS events (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        title TEXT NOT NULL,
        date TEXT NOT NULL,
        time TEXT NOT NULL,
        location TEXT,
        description TEXT,
        image_path TEXT,
        video_path TEXT,
        -- Yeni alanlar
        category TEXT DEFAULT 'Genel',
        status TEXT DEFAULT 'planlanıyor',
        priority TEXT DEFAULT 'normal',
        capacity INTEGER,
        registration_required INTEGER DEFAULT 0,
        registration_deadline TEXT,
        start_datetime TEXT,
        end_datetime TEXT,
        organizer TEXT,
        contact_email TEXT,
        contact_phone TEXT,
        tags TEXT,
        visibility TEXT DEFAULT 'public',
        featured INTEGER DEFAULT 0,
        external_link TEXT,
        cost REAL DEFAULT 0,
        max_attendees INTEGER,
        min_attendees INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )");

    // 3. Üyeler Tablosu
    $db->exec("CREATE TABLE IF NOT EXISTS members (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        full_name TEXT, 
        email TEXT, 
        student_id TEXT, 
        phone_number TEXT, 
        registration_date TEXT
    )");

    // 4. Yönetim Kurulu Tablosu
    $db->exec("CREATE TABLE IF NOT EXISTS board_members (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        full_name TEXT NOT NULL,
        role TEXT,
        contact_email TEXT,
        phone TEXT
    )");
    
    // 5. Bildirimler Tablosu
    $db->exec("CREATE TABLE IF NOT EXISTS notifications (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        title TEXT NOT NULL,
        message TEXT NOT NULL,
        type TEXT DEFAULT 'info',
        is_read INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        sender_type TEXT DEFAULT 'system'
    )");
    
    // 6. İşbirliği Logoları Tablosu
    $db->exec("CREATE TABLE IF NOT EXISTS partner_logos (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        partner_name TEXT NOT NULL,
        partner_website TEXT,
        logo_path TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )");
    
    // 7. Ürünler Tablosu (Market)
    $db->exec("CREATE TABLE IF NOT EXISTS products (
        id INTEGER PRIMARY KEY,
        club_id INTEGER,
        name TEXT NOT NULL,
        description TEXT,
        price REAL DEFAULT 0,
        stock INTEGER DEFAULT 0,
        category TEXT DEFAULT 'Genel',
        image_path TEXT,
        status TEXT DEFAULT 'active',
        commission_rate REAL DEFAULT 8.0,
        iyzico_commission REAL DEFAULT 0,
        platform_commission REAL DEFAULT 0,
        total_price REAL DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )");
    
    // Events tablosuna image_path ve video_path kolonlarını ekle (eğer yoksa)
    // Önce mevcut kolonları kontrol et
    $events_columns = [];
    $columns_check = $db->query("PRAGMA table_info(events)");
    if ($columns_check) {
        while ($col = $columns_check->fetchArray(SQLITE3_ASSOC)) {
            $events_columns[] = $col['name'];
        }
    }
    
    if (!in_array('image_path', $events_columns)) {
        try {
            $db->exec("ALTER TABLE events ADD COLUMN image_path TEXT");
        } catch (Exception $e) {
            // Hata olsa da devam et
        }
    }
    
    if (!in_array('video_path', $events_columns)) {
        try {
            $db->exec("ALTER TABLE events ADD COLUMN video_path TEXT");
        } catch (Exception $e) {
            // Hata olsa da devam et
        }
    }
    
    // Events tablosuna has_survey kolonu ekle (eğer yoksa)
    if (!in_array('has_survey', $events_columns)) {
        try {
            $db->exec("ALTER TABLE events ADD COLUMN has_survey INTEGER DEFAULT 0");
        } catch (Exception $e) {
            // Hata olsa da devam et
        }
    }
    
    // Events tablosuna yeni kolonları ekle (migration için)
    // NOT: SQLite'da ALTER TABLE ile non-constant default (CURRENT_TIMESTAMP gibi) eklenemez
    // Bu yüzden sadece constant değerler kullanıyoruz
    $new_columns = [
        'category' => 'TEXT DEFAULT "Genel"',
        'status' => 'TEXT DEFAULT "planlanıyor"',
        'priority' => 'TEXT DEFAULT "normal"',
        'capacity' => 'INTEGER',
        'registration_required' => 'INTEGER DEFAULT 0',
        'registration_deadline' => 'TEXT',
        'start_datetime' => 'TEXT',
        'end_datetime' => 'TEXT',
        'organizer' => 'TEXT',
        'contact_email' => 'TEXT',
        'contact_phone' => 'TEXT',
        'tags' => 'TEXT',
        'visibility' => 'TEXT DEFAULT "public"',
        'featured' => 'INTEGER DEFAULT 0',
        'external_link' => 'TEXT',
        'cost' => 'REAL DEFAULT 0',
        'max_attendees' => 'INTEGER',
        'min_attendees' => 'INTEGER',
        'created_at' => 'DATETIME',
        'updated_at' => 'DATETIME'
    ];
    
    foreach ($new_columns as $column => $definition) {
        // Kolon zaten varsa ekleme
        if (in_array($column, $events_columns)) {
            continue;
        }
        
        try {
            // Güvenlik: Column name'i whitelist ile kontrol et
            $allowed_columns = [
                'category', 'status', 'priority', 'capacity', 'registration_required',
                'registration_deadline', 'start_datetime', 'end_datetime', 'organizer',
                'contact_email', 'contact_phone', 'tags', 'visibility', 'featured',
                'external_link', 'cost', 'max_attendees', 'min_attendees',
                'created_at', 'updated_at'
            ];
            if (in_array($column, $allowed_columns)) {
                // Definition'ı sadece izin verilen değerlerle sınırla
                $safe_definition = preg_replace('/[^A-Za-z0-9_ ()-]/', '', $definition);
                $db->exec("ALTER TABLE events ADD COLUMN $column $safe_definition");
            }
        } catch (Exception $e) {
            // Hata olsa da devam et
        }
    }
    
    // Event Images Tablosu (birden fazla fotoğraf için)
    $db->exec("CREATE TABLE IF NOT EXISTS event_images (
        id INTEGER PRIMARY KEY,
        event_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        image_path TEXT NOT NULL,
        uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
    )");
    
    // Event Videos Tablosu (birden fazla video için)
    $db->exec("CREATE TABLE IF NOT EXISTS event_videos (
        id INTEGER PRIMARY KEY,
        event_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        video_path TEXT NOT NULL,
        uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
    )");
    
    // Event Surveys Tablosu (anket için)
    $db->exec("CREATE TABLE IF NOT EXISTS event_surveys (
        id INTEGER PRIMARY KEY,
        event_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        title TEXT NOT NULL,
        description TEXT,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
    )");
    
    // Survey Questions Tablosu (anket soruları)
    $db->exec("CREATE TABLE IF NOT EXISTS survey_questions (
        id INTEGER PRIMARY KEY,
        survey_id INTEGER NOT NULL,
        question_text TEXT NOT NULL,
        question_type TEXT DEFAULT 'multiple_choice',
        is_required INTEGER DEFAULT 1,
        display_order INTEGER DEFAULT 0,
        FOREIGN KEY (survey_id) REFERENCES event_surveys(id) ON DELETE CASCADE
    )");
    
    // Survey Options Tablosu (anket seçenekleri)
    $db->exec("CREATE TABLE IF NOT EXISTS survey_options (
        id INTEGER PRIMARY KEY,
        question_id INTEGER NOT NULL,
        option_text TEXT NOT NULL,
        display_order INTEGER DEFAULT 0,
        FOREIGN KEY (question_id) REFERENCES survey_questions(id) ON DELETE CASCADE
    )");
    
    // Survey Responses Tablosu (anket cevapları)
    $db->exec("CREATE TABLE IF NOT EXISTS survey_responses (
        id INTEGER PRIMARY KEY,
        survey_id INTEGER NOT NULL,
        question_id INTEGER NOT NULL,
        member_id INTEGER,
        response_text TEXT,
        option_id INTEGER,
        submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (survey_id) REFERENCES event_surveys(id) ON DELETE CASCADE,
        FOREIGN KEY (question_id) REFERENCES survey_questions(id) ON DELETE CASCADE,
        FOREIGN KEY (option_id) REFERENCES survey_options(id) ON DELETE CASCADE
    )");
    
    // Board_members tablosuna phone kolonunu ekle (eğer yoksa)
    $board_members_columns = [];
    $board_columns_check = $db->query("PRAGMA table_info(board_members)");
    if ($board_columns_check) {
        while ($col = $board_columns_check->fetchArray(SQLITE3_ASSOC)) {
            $board_members_columns[] = $col['name'];
        }
    }
    
    if (!in_array('phone', $board_members_columns)) {
        try {
            $db->exec("ALTER TABLE board_members ADD COLUMN phone TEXT");
        } catch (Exception $e) {
            // Hata olsa da devam et
        }
    }
    
    // Performance: Index'leri oluştur
    // Events tablosu için index'ler
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_events_club_date ON events(club_id, date DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_events_club_id ON events(club_id)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_events_date ON events(date DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_events_status ON events(status)");
    
    // Members tablosu için index'ler
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_members_club_reg ON members(club_id, registration_date DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_members_club_id ON members(club_id)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_members_reg_date ON members(registration_date DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_members_email ON members(email)");
    
    // Board members tablosu için index'ler
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_board_club_id ON board_members(club_id)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_board_position ON board_members(position)");
    
    // Products tablosu için index'ler
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_products_club_created ON products(club_id, created_at DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_products_club_id ON products(club_id)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_products_created ON products(created_at DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_products_status ON products(status)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_products_category ON products(category)");
    
    // Campaigns tablosu için index'ler
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_campaigns_club_created ON campaigns(club_id, created_at DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_campaigns_club_id ON campaigns(club_id)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_campaigns_created ON campaigns(created_at DESC)");
    @$db->exec("CREATE INDEX IF NOT EXISTS idx_campaigns_status ON campaigns(status)");
    
    // Rate Limiting Tablosu (Email/SMS spam koruması)
    $db->exec("CREATE TABLE IF NOT EXISTS rate_limits (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        action_type TEXT NOT NULL,
        action_count INTEGER DEFAULT 0,
        hour_timestamp TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )");
    
    // Email Campaigns Tablosu (Toplu mail kampanyaları)
    $db->exec("CREATE TABLE IF NOT EXISTS email_campaigns (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        subject TEXT NOT NULL,
        message TEXT NOT NULL,
        from_name TEXT,
        from_email TEXT,
        total_recipients INTEGER DEFAULT 0,
        sent_count INTEGER DEFAULT 0,
        failed_count INTEGER DEFAULT 0,
        status TEXT DEFAULT 'pending',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        started_at DATETIME,
        completed_at DATETIME
    )");
    
    // Email Queue Tablosu (Mail gönderim kuyruğu)
    $db->exec("CREATE TABLE IF NOT EXISTS email_queue (
        id INTEGER PRIMARY KEY,
        campaign_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        recipient_email TEXT NOT NULL,
        subject TEXT NOT NULL,
        message TEXT NOT NULL,
        from_name TEXT,
        from_email TEXT,
        status TEXT DEFAULT 'pending',
        attempts INTEGER DEFAULT 0,
        error_message TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        sent_at DATETIME,
        FOREIGN KEY (campaign_id) REFERENCES email_campaigns(id) ON DELETE CASCADE
    )");
    
    // Event RSVP Tablosu (Etkinlik katılım takibi)
    $db->exec("CREATE TABLE IF NOT EXISTS event_rsvp (
        id INTEGER PRIMARY KEY,
        event_id INTEGER NOT NULL,
        club_id INTEGER NOT NULL,
        member_name TEXT NOT NULL,
        member_email TEXT NOT NULL,
        member_phone TEXT,
        rsvp_status TEXT DEFAULT 'attending',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
    )");
    
    // Financial Categories Tablosu (Finansal Kategoriler)
    $db->exec("CREATE TABLE IF NOT EXISTS financial_categories (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        type TEXT NOT NULL CHECK(type IN ('income', 'expense')),
        description TEXT,
        color TEXT DEFAULT '#6366f1',
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )");
    
    // Financial Transactions Tablosu (Gelir/Gider Kayıtları)
    $db->exec("CREATE TABLE IF NOT EXISTS financial_transactions (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        category_id INTEGER,
        type TEXT NOT NULL CHECK(type IN ('income', 'expense')),
        amount REAL NOT NULL,
        description TEXT NOT NULL,
        transaction_date TEXT NOT NULL,
        payment_method TEXT,
        reference_number TEXT,
        notes TEXT,
        created_by TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (category_id) REFERENCES financial_categories(id) ON DELETE SET NULL
    )");
    
    // Budget Plans Tablosu (Bütçe Planları)
    $db->exec("CREATE TABLE IF NOT EXISTS budget_plans (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        category_id INTEGER,
        name TEXT NOT NULL,
        type TEXT NOT NULL CHECK(type IN ('income', 'expense')),
        budgeted_amount REAL NOT NULL,
        period_start TEXT NOT NULL,
        period_end TEXT NOT NULL,
        description TEXT,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (category_id) REFERENCES financial_categories(id) ON DELETE SET NULL
    )");
    
    // Payments Tablosu (Ödeme Takibi - Etkinlik Ücretleri)
    $db->exec("CREATE TABLE IF NOT EXISTS payments (
        id INTEGER PRIMARY KEY,
        club_id INTEGER NOT NULL,
        event_id INTEGER,
        member_id INTEGER,
        member_name TEXT,
        member_email TEXT,
        amount REAL NOT NULL,
        payment_status TEXT DEFAULT 'pending' CHECK(payment_status IN ('pending', 'paid', 'refunded', 'cancelled')),
        payment_method TEXT,
        payment_date TEXT,
        transaction_id TEXT,
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE SET NULL,
        FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE SET NULL
    )");
    
    // Varsayılan kategorileri ekle
    $stmt = $db->prepare("SELECT COUNT(*) FROM financial_categories WHERE club_id = ?");
    $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $count = $stmt->execute()->fetchArray()[0];
    
    if ($count == 0) {
        // Gelir Kategorileri
        $income_categories = [
            ['Üye Aidatları', '#10b981'],
            ['Etkinlik Gelirleri', '#6366f1'],
            ['Bağışlar', '#8b5cf6'],
            ['Sponsorluk', '#f59e0b'],
            ['Diğer Gelirler', '#6b7280']
        ];
        
        // Gider Kategorileri
        $expense_categories = [
            ['Etkinlik Giderleri', '#ef4444'],
            ['Ofis Malzemeleri', '#f97316'],
            ['Ulaşım', '#eab308'],
            ['Yemek & İkram', '#ec4899'],
            ['İletişim', '#14b8a6'],
            ['Diğer Giderler', '#6b7280']
        ];
        
        $stmt = $db->prepare("INSERT INTO financial_categories (club_id, name, type, color) VALUES (?, ?, 'income', ?)");
        foreach ($income_categories as $cat) {
            $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(2, $cat[0], SQLITE3_TEXT);
            $stmt->bindValue(3, $cat[1], SQLITE3_TEXT);
            $stmt->execute();
        }
        
        $stmt = $db->prepare("INSERT INTO financial_categories (club_id, name, type, color) VALUES (?, ?, 'expense', ?)");
        foreach ($expense_categories as $cat) {
            $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(2, $cat[0], SQLITE3_TEXT);
            $stmt->bindValue(3, $cat[1], SQLITE3_TEXT);
            $stmt->execute();
        }
    }
    
    // Campaigns Tablosu (Üye Kampanyaları - İndirimler, Ödüller vb.)
    try {
        $db->exec("CREATE TABLE IF NOT EXISTS campaigns (
            id INTEGER PRIMARY KEY,
            club_id INTEGER NOT NULL,
            title TEXT NOT NULL,
            description TEXT,
            offer_text TEXT NOT NULL,
            partner_name TEXT,
            discount_percentage INTEGER,
            image_path TEXT,
            start_date TEXT,
            end_date TEXT,
            is_active INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )");
    } catch (Exception $e) {
        tpl_error_log("Campaigns table creation error: " . $e->getMessage());
    }
    
}

// --- RATE LIMITING SİSTEMİ ---

function check_rate_limit($db, $action_type, $max_per_hour = 100) {
    $current_hour = date('Y-m-d H:00:00');
    
    // Mevcut saatteki kayıtları kontrol et
    $stmt = $db->prepare("SELECT action_count FROM rate_limits WHERE club_id = ? AND action_type = ? AND hour_timestamp = ?");
    $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $stmt->bindValue(2, $action_type, SQLITE3_TEXT);
    $stmt->bindValue(3, $current_hour, SQLITE3_TEXT);
    $result = $stmt->execute();
    $row = $result->fetchArray(SQLITE3_ASSOC);
    
    $current_count = $row ? (int)$row['action_count'] : 0;
    
    if ($current_count >= $max_per_hour) {
        return ['allowed' => false, 'message' => "$action_type limiti aşıldı! Bu saat için maksimum $max_per_hour işlem yapabilirsiniz. Bir sonraki saatte tekrar deneyin."];
    }
    
    return ['allowed' => true, 'count' => $current_count];
}

function increment_rate_limit($db, $action_type) {
    // Tabloyu oluştur (eğer yoksa)
    ensure_rate_limits_table($db);
    
    $current_hour = date('Y-m-d H:00:00');
    
    // CLUB_ID kontrolü
    if (!defined('CLUB_ID') || !CLUB_ID) {
        error_log("increment_rate_limit: CLUB_ID tanımlı değil!");
        tpl_error_log("increment_rate_limit: CLUB_ID tanımlı değil!");
        return false;
    }
    
    // Mevcut kayıt var mı kontrol et
    $stmt = $db->prepare("SELECT id, action_count FROM rate_limits WHERE club_id = ? AND action_type = ? AND hour_timestamp = ?");
    $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $stmt->bindValue(2, $action_type, SQLITE3_TEXT);
    $stmt->bindValue(3, $current_hour, SQLITE3_TEXT);
    $result = $stmt->execute();
    $row = $result->fetchArray(SQLITE3_ASSOC);
    
    if ($row) {
        // Mevcut kaydı güncelle
        $update_stmt = $db->prepare("UPDATE rate_limits SET action_count = action_count + 1 WHERE id = ?");
        $update_stmt->bindValue(1, $row['id'], SQLITE3_INTEGER);
        $update_result = $update_stmt->execute();
        tpl_error_log("Rate limit updated: club_id=" . CLUB_ID . ", action_type=$action_type, hour=$current_hour, new_count=" . ($row['action_count'] + 1));
        return $update_result !== false;
    } else {
        // Yeni kayıt oluştur
        $insert_stmt = $db->prepare("INSERT INTO rate_limits (club_id, action_type, action_count, hour_timestamp) VALUES (?, ?, 1, ?)");
        $insert_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
        $insert_stmt->bindValue(2, $action_type, SQLITE3_TEXT);
        $insert_stmt->bindValue(3, $current_hour, SQLITE3_TEXT);
        $insert_result = $insert_stmt->execute();
        tpl_error_log("Rate limit created: club_id=" . CLUB_ID . ", action_type=$action_type, hour=$current_hour, count=1");
        return $insert_result !== false;
    }
}

// Eski rate limit kayıtlarını temizle (24 saatten eski)
function cleanup_old_rate_limits($db) {
    // Rate limits tablosunu oluştur
    ensure_rate_limits_table($db);
    
    $cutoff_time = date('Y-m-d H:00:00', strtotime('-24 hours'));
    $stmt = $db->prepare("DELETE FROM rate_limits WHERE hour_timestamp < ?");
    $stmt->bindValue(1, $cutoff_time, SQLITE3_TEXT);
    $stmt->execute();
}

// --- BACKUP SİSTEMİ ---

function create_database_backup($send_notification = false) {
    try {
        $db_path = DB_PATH;
        
        if (!file_exists($db_path)) {
            return ['success' => false, 'message' => 'Veritabanı dosyası bulunamadı'];
        }
        
        // Backup klasörü oluştur
        $backup_dir = community_path('backups');
        if (!is_dir($backup_dir)) {
            mkdir($backup_dir, 0755, true);
        }
        
        // Backup dosya adı (tarih ve saat ile)
        $backup_filename = 'backup_' . date('Y-m-d_H-i-s') . '_' . CLUB_ID . '.sqlite';
        $backup_path = $backup_dir . '/' . $backup_filename;
        
        // Veritabanını kopyala
        if (copy($db_path, $backup_path)) {
            // Eski backupları temizle (30 günden eski)
            $files = glob($backup_dir . '/backup_*.sqlite');
            $cutoff_time = time() - (30 * 24 * 60 * 60); // 30 gün
            $deleted_count = 0;
            foreach ($files as $file) {
                if (filemtime($file) < $cutoff_time) {
                    unlink($file);
                    $deleted_count++;
                }
            }
            
            $backup_size = round(filesize($backup_path) / 1024, 2);
            $result = [
                'success' => true, 
                'message' => 'Veritabanı yedeği başarıyla oluşturuldu: ' . $backup_filename,
                'file' => $backup_filename,
                'size' => $backup_size . ' KB',
                'path' => $backup_path
            ];
            
            // Bildirim gönder
            if ($send_notification) {
                send_backup_notification($result);
            }
            
            return $result;
        } else {
            return ['success' => false, 'message' => 'Backup oluşturulamadı'];
        }
    } catch (Exception $e) {
        tpl_error_log("Backup error: " . $e->getMessage());
        return ['success' => false, 'message' => 'Hata: ' . $e->getMessage()];
    }
}

/**
 * Otomatik yedekleme açıksa belirlenen sıklığa göre tetikleyen koruyucu.
 * Cron kurulu olmasa bile panel ziyaret edildiğinde yedek alınmasını sağlar.
 */
function maybe_run_auto_backup() {
    static $auto_backup_checked = false;
    
    if ($auto_backup_checked) {
        return;
    }
    $auto_backup_checked = true;
    
    try {
        $enabled = get_setting('auto_backup_enabled', '0');
        if ($enabled !== '1') {
            return;
        }
        
        $frequency = get_setting('auto_backup_frequency', 'daily');
        $interval_map = [
            'hourly' => 3600,
            'daily' => 86400,
            'weekly' => 604800,
            'monthly' => 2592000,
        ];
        $interval = $interval_map[$frequency] ?? $interval_map['daily'];
        
        $last_run = get_setting('auto_backup_last_run', null);
        if ($last_run) {
            $last_ts = strtotime($last_run);
            
            // Günlük yedekleme için özel mantık: Takvim günü değiştiyse
            if ($frequency === 'daily') {
                $last_date = date('Y-m-d', $last_ts);
                $today_date = date('Y-m-d');
                if ($last_date === $today_date) {
                    return; // Bugün zaten yedek alınmış
                }
            } 
            // Diğer periyotlar için saniye bazlı kontrol
            else {
                if ($last_ts !== false && (time() - $last_ts) < $interval) {
                    return;
                }
            }
        }
        
        $result = create_database_backup(true);
        $db = get_db();
        
        // Check if settings table exists
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
        if (!$table_check || !$table_check->fetchArray()) {
            return;
        }
        
        $now = date('Y-m-d H:i:s');
        
        $stmt = @$db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_last_run', :value)");
        if ($stmt) {
        $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
        $stmt->bindValue(':value', $now, SQLITE3_TEXT);
        $stmt->execute();
        }
        
        $status = $result['success'] ? 'success' : 'failed';
        $stmt = @$db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_last_status', :value)");
        if ($stmt) {
        $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
        $stmt->bindValue(':value', $status, SQLITE3_TEXT);
        $stmt->execute();
        }
        
        $error_message = $result['success'] ? '' : ($result['message'] ?? 'Bilinmeyen hata');
        $stmt = @$db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_last_error', :value)");
        if ($stmt) {
        $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
        $stmt->bindValue(':value', $error_message, SQLITE3_TEXT);
        $stmt->execute();
        }
        
        if (!$result['success']) {
            tpl_error_log('Auto backup failed: ' . $error_message);
        }
    } catch (Exception $e) {
        tpl_error_log('maybe_run_auto_backup error: ' . $e->getMessage());
    }
}

function send_backup_notification($backup_result) {
    try {
        $db = get_db();
        
        // Communication modülünü yükle (send_smtp_mail için)
        load_module('communication');
        
        $club_name = get_club_name();
        $notify_email = get_setting('auto_backup_notify_email', '');
        
        if (empty($notify_email) || !filter_var($notify_email, FILTER_VALIDATE_EMAIL)) {
            return false;
        }
        
        $subject = '[' . $club_name . '] Otomatik Yedekleme Tamamlandı';
        $message = '<html><body>';
        $message .= '<h2>Veritabanı Yedekleme Bildirimi</h2>';
        $message .= '<p>Merhaba,</p>';
        $message .= '<p><strong>' . htmlspecialchars($club_name) . '</strong> topluluğunun veritabanı yedeği başarıyla oluşturuldu.</p>';
        $message .= '<div style="background: #f3f4f6; padding: 15px; border-radius: 5px; margin: 20px 0;">';
        $message .= '<p><strong>Yedek Dosyası:</strong> ' . htmlspecialchars($backup_result['file']) . '</p>';
        $message .= '<p><strong>Dosya Boyutu:</strong> ' . htmlspecialchars($backup_result['size']) . '</p>';
        $message .= '<p><strong>Oluşturulma Tarihi:</strong> ' . date('d.m.Y H:i:s') . '</p>';
        $message .= '</div>';
        $message .= '<p>Bu yedek 30 gün boyunca saklanacaktır.</p>';
        $message .= '<p>İyi çalışmalar,<br>UniFour Yedekleme Sistemi</p>';
        $message .= '</body></html>';
        
        $from_email = get_setting('smtp_from_email', get_setting('smtp_username', 'noreply@unipanel.com'));
        $from_name = get_setting('smtp_from_name', $club_name);
        
        return send_smtp_mail($notify_email, $subject, $message, $from_name, $from_email);
    } catch (Exception $e) {
        tpl_error_log("Backup notification error: " . $e->getMessage());
        return false;
    }
}

function list_backups() {
    $backup_dir = community_path('backups');
    if (!is_dir($backup_dir)) {
        return [];
    }
    
    $files = glob($backup_dir . '/backup_*.sqlite');
    $backups = [];
    
    foreach ($files as $file) {
        $backups[] = [
            'filename' => basename($file),
            'size' => round(filesize($file) / 1024, 2) . ' KB',
            'date' => date('d.m.Y H:i:s', filemtime($file))
        ];
    }
    
    // Tarihe göre sırala (yeniden eskiye)
    usort($backups, function($a, $b) {
        return strcmp($b['filename'], $a['filename']);
    });
    
    return $backups;
}

function serve_secure_product_media(): void
{
    if (!isset($_SESSION['admin_id'])) {
        http_response_code(403);
        exit('Yetkisiz erişim');
    }

    $file = $_GET['file'] ?? '';
    if (!preg_match('/^[A-Za-z0-9._-]+$/', $file)) {
        http_response_code(400);
        exit('Geçersiz dosya adı');
    }

    $baseDir = realpath(tpl_get_product_storage_base_dir());
    $path = tpl_product_storage_path($file);
    $realPath = realpath($path);

    if (!$baseDir || !$realPath || strpos($realPath, $baseDir) !== 0 || !is_file($realPath)) {
        http_response_code(404);
        exit('Dosya bulunamadı');
    }

    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime = $finfo ? finfo_file($finfo, $realPath) : 'application/octet-stream';
    if ($finfo) {
        finfo_close($finfo);
    }

    header('Content-Type: ' . $mime);
    header('Content-Length: ' . filesize($realPath));
    header('X-Content-Type-Options: nosniff');
    readfile($realPath);
    exit;
}

// --- ANKET SİSTEMİ ---

// --- GÜVENLİK KONTROLÜ (ZORUNLU GİRİŞ) ---

handle_superadmin_auto_login();

$TPL_GET_ACTION = tpl_filter_slug($_GET['action'] ?? '', '');

if ($TPL_GET_ACTION === 'product_media') {
    serve_secure_product_media();
}

// Legacy auto_login parametresini tamamen devre dışı bırak
if (isset($_GET['auto_login'])) {
    tpl_error_log(sprintf(
        'Blocked legacy auto_login attempt from %s (env=%s)',
        $_SERVER['REMOTE_ADDR'] ?? 'unknown',
        defined('APP_ENV') ? APP_ENV : 'unknown'
    ));
    header("Location: login.php?error=auto_login_disabled");
    exit;
}

// Topluluk durumu kontrolü
if (isset($_SESSION['admin_id'])) {
    try {
        $db = get_db();
        $status = null;
        try {
            // Önce settings tablosunun var olup olmadığını kontrol et
            $table_check = $db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
            if ($table_check && $table_check->fetchArray()) {
                $status_stmt = @$db->prepare("SELECT setting_value FROM settings WHERE setting_key = 'status'");
                if ($status_stmt) {
        $status_result = $status_stmt->execute();
                    if ($status_result) {
        $status_row = $status_result->fetchArray(SQLITE3_ASSOC);
        $status = $status_row ? $status_row['setting_value'] : null;
                    }
                }
            }
        } catch (Exception $e) {
            // Settings tablosu yoksa veya hata varsa null kullan
            $status = null;
        }
        if ($status === 'disabled') {
            // Topluluk kapatılmış, oturumu sil ve login sayfasına yönlendir
            session_unset();
            session_destroy();
            header("Location: login.php?error=disabled");
            exit;
        }
    } catch (Exception $e) {
        // Hata durumunda devam et
    }
}

// Eğer oturum açılmamışsa, kullanıcıyı login sayfasına yönlendir.
if (!isset($_SESSION['admin_id'])) {
    header("Location: login.php");
    exit;
}

// --- KİMLİK DOĞRULAMA & YÖNETİM İŞLEVLERİ (Devamı) ---

/**
 * Yönetici çıkış işlemini gerçekleştirir.
 */
function handle_logout() {
    session_unset();
    session_destroy();
    header("Location: login.php");
    exit;
}

// --- VERİ ÇEKME İŞLEVLERİ (READ) ---

function get_club_name() {
    try {
    $db = get_db();
        
        // Önce settings tablosunun var olup olmadığını kontrol et
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
        if (!$table_check || !$table_check->fetchArray()) {
            return 'UniPanel Kulübü';
        }
        
        $stmt = @$db->prepare("SELECT setting_value FROM settings WHERE setting_key = 'club_name' AND club_id = :club_id");
        if (!$stmt) {
            return 'UniPanel Kulübü';
        }
    $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
    $result = $stmt->execute();
        if (!$result) {
            return 'UniPanel Kulübü';
        }
    $club_name = $result->fetchArray()[0] ?? null;
    return $club_name ?: 'UniPanel Kulübü';
    } catch (Exception $e) {
        return 'UniPanel Kulübü';
    }
}

function get_stats() {
    $db = get_db();
    
    // Events modülünü yükle (ensure_events_table_columns için)
    load_module('events');
    // Events tablosuna eksik kolonları ekle
    ensure_events_table_columns($db);
    
    $stats = [
        'total_members' => 0,
        'upcoming_events' => 0,
        'board_members' => 0,
        'total_events' => 0
    ];

    // Members tablosunu kontrol et
    $members_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='members'");
    if ($members_table_check && $members_table_check->fetchArray()) {
        try {
            $members_stmt = @$db->prepare("SELECT COUNT(*) as count FROM members WHERE club_id = ?");
            if ($members_stmt) {
    $members_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $members_result = $members_stmt->execute();
                if ($members_result) {
                    $row = $members_result->fetchArray();
                    $stats['total_members'] = (int) ($row[0] ?? 0);
                }
            }
        } catch (Exception $e) {
            // Hata durumunda 0 kullan
        }
    }
    
    // Events tablosunu kontrol et
    $events_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='events'");
    if ($events_table_check && $events_table_check->fetchArray()) {
        try {
            $events_stmt = @$db->prepare("SELECT COUNT(*) as count FROM events WHERE club_id = ?");
            if ($events_stmt) {
    $events_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $events_result = $events_stmt->execute();
                if ($events_result) {
                    $row = $events_result->fetchArray();
                    $stats['total_events'] = (int) ($row[0] ?? 0);
                }
            }
            
            $upcoming_q = @$db->prepare("SELECT COUNT(*) FROM events WHERE club_id = :club_id AND date >= date('now')");
            if ($upcoming_q) {
    $upcoming_q->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                $upcoming_result = $upcoming_q->execute();
                if ($upcoming_result) {
                    $row = $upcoming_result->fetchArray();
                    $stats['upcoming_events'] = (int) ($row[0] ?? 0);
                }
            }
        } catch (Exception $e) {
            // Hata durumunda 0 kullan
        }
    }

    // Board members tablosunu kontrol et
    $board_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='board_members'");
    if ($board_table_check && $board_table_check->fetchArray()) {
        try {
            $board_stmt = @$db->prepare("SELECT COUNT(*) as count FROM board_members WHERE club_id = ?");
            if ($board_stmt) {
    $board_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $board_result = $board_stmt->execute();
                if ($board_result) {
                    $row = $board_result->fetchArray();
                    $stats['board_members'] = (int) ($row[0] ?? 0);
                }
            }
        } catch (Exception $e) {
            // Hata durumunda 0 kullan
        }
    }

    return $stats;
}

// Raporlama Fonksiyonları
// --- KAMPANYA İŞLEVLERİ ---

// --- TOPLULUK LİSTELEME FONKSİYONU ---

function get_all_communities() {
    // CACHE: 500 topluluk için kritik! 10 dakika cache
    $cache = get_cache();
    $cache_key = 'all_communities_list_v3';
    
    return $cache->remember($cache_key, 600, function() {
        $communities_dir = COMMUNITIES_ROOT;
        $communities = [];
        
        if (!is_dir($communities_dir)) {
            return [];
        }
        
        $dirs = scandir($communities_dir);
        $excluded_dirs = ['.', '..', 'assets', 'public', 'templates', 'system', 'docs'];
        
        foreach ($dirs as $dir) {
        if (in_array($dir, $excluded_dirs) || !is_dir($communities_dir . '/' . $dir)) {
            continue;
        }
        
        $db_path = $communities_dir . '/' . $dir . '/unipanel.sqlite';
        if (!file_exists($db_path)) {
            continue;
        }
        
        try {
            $db = new SQLite3($db_path);
            $db->enableExceptions(true);
            // Busy timeout ayarla (lock sorunlarını önler)
            $db->busyTimeout(5000);
            // DELETE mode kullan (WAL mode lock sorunlarına neden olabilir)
            @$db->exec('PRAGMA journal_mode = DELETE');
            
            // Topluluk bilgilerini al
            $settings_stmt = $db->prepare("SELECT setting_key, setting_value FROM settings WHERE club_id = ?");
            $settings_stmt->bindValue(1, 1, SQLITE3_INTEGER);
            $settings_query = $settings_stmt->execute();
            $settings = [];
            while ($row = $settings_query->fetchArray(SQLITE3_ASSOC)) {
                $settings[$row['setting_key']] = $row['setting_value'];
            }
            
            // İstatistikler
            $member_count = 0;
            $event_count = 0;
            $campaign_count = 0;
            
            try {
                $members_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='members'");
                if ($members_table_check && $members_table_check->fetchArray()) {
                    $member_stmt = @$db->prepare("SELECT COUNT(*) FROM members WHERE club_id = ?");
                    if ($member_stmt) {
                $member_stmt->bindValue(1, 1, SQLITE3_INTEGER);
                        $member_result = $member_stmt->execute();
                        if ($member_result) {
                            $member_count = $member_result->fetchArray()[0] ?: 0;
                        }
                    }
                }
            } catch (Exception $e) {
                $member_count = 0;
            }
            
            try {
                $event_stmt = $db->prepare("SELECT COUNT(*) FROM events WHERE club_id = ?");
                $event_stmt->bindValue(1, 1, SQLITE3_INTEGER);
                $event_count = $event_stmt->execute()->fetchArray()[0] ?: 0;
            } catch (Exception $e) {
                $event_count = 0;
            }
            
            // Campaigns tablosunu oluştur (yoksa)
            try {
                $db->exec("CREATE TABLE IF NOT EXISTS campaigns (
                    id INTEGER PRIMARY KEY,
                    club_id INTEGER NOT NULL,
                    title TEXT NOT NULL,
                    description TEXT,
                    offer_text TEXT NOT NULL,
                    partner_name TEXT,
                    discount_percentage INTEGER,
                    image_path TEXT,
                    start_date TEXT,
                    end_date TEXT,
                    is_active INTEGER DEFAULT 1,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )");
            } catch (Exception $e) {
                // Tablo oluşturma hatası
            }
            
            try {
                $campaign_count = $db->querySingle("SELECT COUNT(*) FROM campaigns WHERE club_id = 1 AND is_active = 1") ?: 0;
            } catch (Exception $e) {
                $campaign_count = 0;
            }
            
            // Logo path
            $logo_path = null;
            if (!empty($settings['club_logo'])) {
                $logo_path = '../communities/' . $dir . '/' . $settings['club_logo'];
            }
            
            $communities[] = [
                'id' => $dir,
                'name' => $settings['club_name'] ?? ucwords(str_replace('_', ' ', $dir)),
                'description' => $settings['club_description'] ?? '',
                'logo_path' => $logo_path,
                'member_count' => (int)$member_count,
                'event_count' => (int)$event_count,
                'campaign_count' => (int)$campaign_count,
                'login_url' => '../communities/' . $dir . '/login.php'
            ];
            
            $db->close();
        } catch (Exception $e) {
            // Hata durumunda bu topluluğu atla
            continue;
        }
    }
    
    return $communities;
    }); // Cache remember kapanışı
}

function get_notifications() {
    try {
    $db = get_db();
    $notifications = [];
    
        // Önce notifications tablosunun var olup olmadığını kontrol et
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
        if (!$table_check || !$table_check->fetchArray()) {
            return $notifications;
        }
        
        $query = @$db->prepare("SELECT * FROM notifications WHERE club_id = :club_id ORDER BY created_at DESC LIMIT 10");
        if (!$query) {
            return $notifications;
        }
    $query->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
    $result = $query->execute();
        if (!$result) {
            return $notifications;
        }
    
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $notifications[] = $row;
    }
    
    return $notifications;
    } catch (Exception $e) {
        tpl_error_log("Error in get_notifications: " . $e->getMessage());
        return [];
    }
}

function get_unread_notification_count() {
    try {
        $database = Database::getInstance(DB_PATH);
        $notificationModel = new Notification($database->getDb(), CLUB_ID);
        return $notificationModel->getUnreadCount();
    } catch (\Exception $e) {
        ErrorHandler::error("Bildirim sayısı getirilemedi: " . $e->getMessage(), 500);
        return 0;
    }
}

// --- CRUD OPERASYONLARI (POST İŞLEYİCİLERİ) ---

function get_setting($key, $default = '') {
    try {
        $db = get_db();
        // Önce settings tablosunun var olup olmadığını kontrol et
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
        if (!$table_check || !$table_check->fetchArray()) {
            return $default;
        }
        $stmt = @$db->prepare("SELECT setting_value FROM settings WHERE club_id = ? AND setting_key = ? ORDER BY id DESC LIMIT 1");
        if (!$stmt) {
            return $default;
        }
        $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
        $stmt->bindValue(2, $key, SQLITE3_TEXT);
        $result = $stmt->execute();
        if (!$result) {
            return $default;
        }
        $row = $result->fetchArray();
        return $row ? $row['setting_value'] : $default;
    } catch (Exception $e) {
        return $default;
    }
}

function update_settings($db, $post) {
    try {
        // Topluluk adı güvenlik nedeniyle değiştirilemez
        
        // Log kaydet
        if (isset($_SESSION['admin_id']) && isset($_SESSION['admin_username'])) {
            $changedSettings = [];
            if (isset($post['club_description'])) $changedSettings[] = 'club_description';
            if (isset($post['club_categories'])) $changedSettings[] = 'club_categories';
            if (isset($post['email_notifications'])) $changedSettings[] = 'email_notifications';
            if (isset($post['sms_notifications'])) $changedSettings[] = 'sms_notifications';
            
            if (!empty($changedSettings)) {
            logToSuperAdmin('admin_action', [
                'user_id' => $_SESSION['admin_id'],
                'username' => $_SESSION['admin_username'],
                'action_type' => 'settings_update',
                'action_description' => 'Ayarlar güncellendi: ' . implode(', ', $changedSettings),
                'additional_data' => [
                    'changed_settings' => $changedSettings
                ]
            ]);
            }
        }
        
        // Diğer ayarları güncelle
        if (isset($post['club_description'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'club_description', :club_description)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':club_description', $post['club_description'], SQLITE3_TEXT);
            $stmt->execute();
        }
        
        // Dil ayarı
        if (isset($post['ui_language'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'ui_language', :ui_language)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':ui_language', $post['ui_language'], SQLITE3_TEXT);
            $result = $stmt->execute();
            if ($result) {
                tpl_error_log("Dil ayarı kaydedildi: " . $post['ui_language']);
            } else {
                tpl_error_log("Dil ayarı kaydedilemedi: " . $db->lastErrorMsg());
            }
        }
        
        // Topluluk kategorileri (max 3, JSON array olarak kaydet)
        // Form submit edildiğinde her zaman kaydet (boş array de olsa)
        // Debug: POST verilerini logla
        tpl_error_log("DEBUG: update_settings çağrıldı. POST keys: " . implode(', ', array_keys($post)), 'debug');
        tpl_error_log("DEBUG: club_categories_submitted var mı? " . (isset($post['club_categories_submitted']) ? 'EVET' : 'HAYIR'), 'debug');
        tpl_error_log("DEBUG: club_categories var mı? " . (isset($post['club_categories']) ? 'EVET' : 'HAYIR'), 'debug');
        if (isset($post['club_categories'])) {
            tpl_error_log("DEBUG: club_categories değeri: " . print_r($post['club_categories'], true), 'debug');
        }
        
        // Her zaman kategori kaydetme işlemini çalıştır (form submit edildiğinde)
        // club_categories_submitted kontrolü ile form submit edildiğini anlıyoruz
        // Eğer club_categories_submitted varsa veya club_categories varsa kaydet
        // Ayrıca action=update_settings ise de kaydet (form submit edildi demektir)
        if (isset($post['club_categories_submitted']) || isset($post['club_categories']) || (isset($post['action']) && $post['action'] === 'update_settings')) {
            $categories = [];
            // POST'ta club_categories var mı kontrol et
            // Not: Eğer hiç checkbox seçilmediyse, club_categories POST'ta olmayabilir
            // Bu durumda boş array olarak kaydet (kategoriler temizlenmiş demektir)
            if (isset($post['club_categories']) && is_array($post['club_categories'])) {
                tpl_error_log("DEBUG: club_categories array bulundu, işleniyor...", 'debug');
                $categories = array_filter($post['club_categories'], function($cat) {
                    $trimmed = trim($cat);
                    $result = !empty($trimmed) && $trimmed !== 'other';
                    tpl_error_log("DEBUG: Kategori filtreleniyor: '$cat' -> " . ($result ? 'KALDI' : 'ÇIKARILDI'), 'debug');
                    return $result;
                });
                // Max 3 kategori
                $categories = array_slice($categories, 0, 3);
                tpl_error_log("DEBUG: Filtrelenmiş kategoriler: " . print_r($categories, true), 'debug');
            } else {
                tpl_error_log("DEBUG: club_categories array bulunamadı veya boş, boş array kaydedilecek", 'debug');
            }
            // JSON olarak kaydet (boş array de olsa)
            $categories_json = json_encode($categories, JSON_UNESCAPED_UNICODE);
            tpl_error_log("DEBUG: JSON encode edildi: " . $categories_json, 'debug');
            
            try {
                $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'club_category', :club_category)");
                if (!$stmt) {
                    $error_msg = $db->lastErrorMsg();
                    tpl_error_log("ERROR: SQL prepare hatası: " . $error_msg);
                    throw new Exception("SQL prepare hatası: " . $error_msg);
                }
                $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                $stmt->bindValue(':club_category', $categories_json, SQLITE3_TEXT);
                $result = $stmt->execute();
                if (!$result) {
                    $error_msg = $db->lastErrorMsg();
                    tpl_error_log("ERROR: Kategori kaydetme hatası: " . $error_msg);
                    throw new Exception("Kategori kaydedilemedi: " . $error_msg);
                } else {
                    tpl_error_log("SUCCESS: Kategoriler başarıyla kaydedildi: " . $categories_json . " (Topluluk ID: " . CLUB_ID . ", Kategori sayısı: " . count($categories) . ")", 'info');
                    // Doğrulama: Kaydedilen değeri oku
                    $verify_stmt = $db->prepare("SELECT setting_value FROM settings WHERE club_id = :club_id AND setting_key = 'club_category'");
                    $verify_stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                    $verify_result = $verify_stmt->execute();
                    if ($verify_result) {
                        $verify_row = $verify_result->fetchArray(SQLITE3_ASSOC);
                        if ($verify_row) {
                            tpl_error_log("VERIFY: Veritabanında kayıtlı değer: " . $verify_row['setting_value']);
                        } else {
                            tpl_error_log("WARNING: Kayıt sonrası doğrulama: Değer bulunamadı!");
                        }
                    }
                }
            } catch (Exception $e) {
                tpl_error_log("EXCEPTION: Kategori kaydetme exception: " . $e->getMessage());
                throw $e;
            }
        } else {
        tpl_error_log("DEBUG: club_categories_submitted veya club_categories bulunamadı, kategori kaydetme atlandı", 'debug');
        }
        
        if (isset($post['email_notifications'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'email_notifications', '1')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        } else {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'email_notifications', '0')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        }
        
        if (isset($post['sms_notifications'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'sms_notifications', '1')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        } else {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'sms_notifications', '0')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        }
        
        if (isset($post['session_timeout'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'session_timeout', :session_timeout)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':session_timeout', $post['session_timeout'], SQLITE3_TEXT);
            $stmt->execute();
        }
        
        if (isset($post['max_login_attempts'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'max_login_attempts', :max_login_attempts)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':max_login_attempts', $post['max_login_attempts'], SQLITE3_TEXT);
            $stmt->execute();
        }
        
        // SMTP ayarlarını kaydet - ZORUNLU KAYDET
        if (isset($post['smtp_username'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_username', :smtp_username)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':smtp_username', trim($post['smtp_username']), SQLITE3_TEXT);
            $stmt->execute();
            tpl_error_log("SMTP Username kaydedildi (maskelenmiş).");
        }
        
        if (isset($post['smtp_password'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_password', :smtp_password)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':smtp_password', trim($post['smtp_password']), SQLITE3_TEXT);
            $stmt->execute();
            tpl_error_log("SMTP Password kaydedildi (maskelenmiş).");
        }

		// Domain SMTP için ek alanlar
		if (isset($post['smtp_host'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_host', :smtp_host)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':smtp_host', trim($post['smtp_host']), SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['smtp_port'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_port', :smtp_port)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':smtp_port', trim($post['smtp_port']), SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['smtp_secure'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_secure', :smtp_secure)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':smtp_secure', trim($post['smtp_secure']), SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['smtp_from_email'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_from_email', :smtp_from_email)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':smtp_from_email', trim($post['smtp_from_email']), SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['smtp_from_name'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'smtp_from_name', :smtp_from_name)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':smtp_from_name', trim($post['smtp_from_name']), SQLITE3_TEXT);
			$stmt->execute();
		}
		
		// SMS API ayarları (Twilio)
		if (isset($post['sms_provider'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'sms_provider', :sms_provider)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':sms_provider', trim($post['sms_provider']), SQLITE3_TEXT);
			$stmt->execute();
		}
		// SMS API ayarları (Twilio) - ZORUNLU KAYDET
		if (isset($post['twilio_account_sid'])) {
			$account_sid_clean = trim($post['twilio_account_sid']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'twilio_account_sid', :twilio_account_sid)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':twilio_account_sid', $account_sid_clean, SQLITE3_TEXT);
			$stmt->execute();
			tpl_error_log("Twilio Account SID kaydedildi (uzunluk: " . strlen($account_sid_clean) . ")");
		}
		if (isset($post['twilio_auth_token'])) {
			$auth_token_clean = trim($post['twilio_auth_token']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'twilio_auth_token', :twilio_auth_token)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':twilio_auth_token', $auth_token_clean, SQLITE3_TEXT);
			$stmt->execute();
			tpl_error_log("Twilio Auth Token kaydedildi (durum: " . (empty($auth_token_clean) ? 'EMPTY' : 'SET') . ")");
		}
		if (isset($post['twilio_from_number'])) {
			$from_number_clean = trim($post['twilio_from_number']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'twilio_from_number', :twilio_from_number)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':twilio_from_number', $from_number_clean, SQLITE3_TEXT);
			$stmt->execute();
			tpl_error_log("Twilio From Number kaydedildi (maskelenmiş).");
		}
		if (isset($post['twilio_messaging_service_sid'])) {
			$messaging_service_sid_clean = trim($post['twilio_messaging_service_sid']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'twilio_messaging_service_sid', :twilio_messaging_service_sid)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':twilio_messaging_service_sid', $messaging_service_sid_clean, SQLITE3_TEXT);
			$stmt->execute();
			tpl_error_log("Twilio MessagingServiceSid kaydedildi (uzunluk: " . strlen($messaging_service_sid_clean) . ")");
		}
		if (isset($post['sms_provider'])) {
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'sms_provider', :sms_provider)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':sms_provider', trim($post['sms_provider']), SQLITE3_TEXT);
			$stmt->execute();
		}
		// NetGSM ayarları
		if (isset($post['netgsm_username'])) {
			$username_clean = trim($post['netgsm_username']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'netgsm_username', :netgsm_username)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':netgsm_username', $username_clean, SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['netgsm_password'])) {
			$password_clean = trim($post['netgsm_password']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'netgsm_password', :netgsm_password)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':netgsm_password', $password_clean, SQLITE3_TEXT);
			$stmt->execute();
		}
		if (isset($post['netgsm_msgheader'])) {
			$msgheader_clean = trim($post['netgsm_msgheader']);
			$stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'netgsm_msgheader', :netgsm_msgheader)");
			$stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
			$stmt->bindValue(':netgsm_msgheader', $msgheader_clean, SQLITE3_TEXT);
			$stmt->execute();
        }
        
        // Otomatik yedekleme ayarları
        if (isset($post['auto_backup_enabled'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_enabled', '1')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        } else {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_enabled', '0')");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->execute();
        }
        
        if (isset($post['auto_backup_frequency'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_frequency', :auto_backup_frequency)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':auto_backup_frequency', trim($post['auto_backup_frequency']), SQLITE3_TEXT);
            $stmt->execute();
        }
        
        if (isset($post['auto_backup_time'])) {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_time', :auto_backup_time)");
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':auto_backup_time', trim($post['auto_backup_time']), SQLITE3_TEXT);
            $stmt->execute();
        }
        
        if (isset($post['auto_backup_notify_email'])) {
            $notify_email = trim($post['auto_backup_notify_email']);
            if (empty($notify_email) || filter_var($notify_email, FILTER_VALIDATE_EMAIL)) {
                $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'auto_backup_notify_email', :auto_backup_notify_email)");
                $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                $stmt->bindValue(':auto_backup_notify_email', $notify_email, SQLITE3_TEXT);
                $stmt->execute();
            }
        }
        
        $_SESSION['message'] = "Ayarlar başarıyla güncellendi! Sistem ayarları kaydedildi.";
        
        // Redirect case bloğunda yapılacak
        return true;
    } catch (Exception $e) {
        $_SESSION['error'] = "Ayarlar güncellenirken hata: " . $e->getMessage();
    }
}

// Sadece kategorileri kaydet
function update_categories_only($db, $post) {
    // Tüm output buffering'i temizle (HTML output'u önlemek için)
    while (ob_get_level()) {
        ob_end_clean();
    }
    
    // JSON header'ı hemen set et (hiçbir output'tan önce)
    header('Content-Type: application/json; charset=utf-8');
    
    // Error display'i kapat (sadece bu istek için)
    $old_display_errors = ini_get('display_errors');
    ini_set('display_errors', '0');
    
    try {
        tpl_error_log("DEBUG: update_categories_only çağrıldı. POST keys: " . implode(', ', array_keys($post)), 'debug');
        
        // Kategorileri al
        $categories = [];
        if (isset($post['club_categories']) && is_array($post['club_categories'])) {
            tpl_error_log("DEBUG: club_categories array bulundu: " . print_r($post['club_categories'], true), 'debug');
            $categories = array_filter($post['club_categories'], function($cat) {
                $trimmed = trim($cat);
                $result = !empty($trimmed) && $trimmed !== 'other';
                tpl_error_log("DEBUG: Kategori filtreleniyor: '$cat' -> " . ($result ? 'KALDI' : 'ÇIKARILDI'), 'debug');
                return $result;
            });
            // Max 3 kategori
            $categories = array_slice($categories, 0, 3);
            tpl_error_log("DEBUG: Filtrelenmiş kategoriler: " . print_r($categories, true), 'debug');
        } else {
            tpl_error_log("DEBUG: club_categories array bulunamadı, boş array kaydedilecek", 'debug');
        }
        
        // JSON olarak kaydet
        $categories_json = json_encode($categories, JSON_UNESCAPED_UNICODE);
        tpl_error_log("DEBUG: JSON encode edildi: " . $categories_json, 'debug');
        
        try {
            $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'club_category', :club_category)");
            if (!$stmt) {
                $error_msg = $db->lastErrorMsg();
                tpl_error_log("ERROR: SQL prepare hatası: " . $error_msg);
                throw new Exception("SQL prepare hatası: " . $error_msg);
            }
            $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(':club_category', $categories_json, SQLITE3_TEXT);
            $result = $stmt->execute();
            if (!$result) {
                $error_msg = $db->lastErrorMsg();
                tpl_error_log("ERROR: Kategori kaydetme hatası: " . $error_msg);
                throw new Exception("Kategori kaydedilemedi: " . $error_msg);
            } else {
                tpl_error_log("SUCCESS: Kategoriler başarıyla kaydedildi: " . $categories_json . " (Topluluk ID: " . CLUB_ID . ", Kategori sayısı: " . count($categories) . ")", 'info');
                // Doğrulama: Kaydedilen değeri oku
                $verify_stmt = $db->prepare("SELECT setting_value FROM settings WHERE club_id = :club_id AND setting_key = 'club_category'");
                $verify_stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                $verify_result = $verify_stmt->execute();
                if ($verify_result) {
                    $verify_row = $verify_result->fetchArray(SQLITE3_ASSOC);
                    if ($verify_row) {
                        tpl_error_log("VERIFY: Veritabanında kayıtlı değer: " . $verify_row['setting_value']);
                    } else {
                        tpl_error_log("WARNING: Kayıt sonrası doğrulama: Değer bulunamadı!");
                    }
                }
            }
        } catch (Exception $e) {
            tpl_error_log("EXCEPTION: Kategori kaydetme exception: " . $e->getMessage());
            throw $e;
        }
        
        $_SESSION['message'] = "Kategoriler başarıyla kaydedildi! (" . count($categories) . " kategori)";
        
        // Her zaman JSON döndür (AJAX veya normal istek fark etmez)
        // Header zaten set edildi, sadece JSON döndür
        echo json_encode([
            'success' => true, 
            'message' => 'Kategoriler başarıyla kaydedildi! (' . count($categories) . ' kategori)', 
            'categories' => $categories,
            'count' => count($categories),
            'redirect' => 'index.php?view=settings'
        ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
        
        // Error display'i geri yükle
        ini_set('display_errors', $old_display_errors);
        exit;
    } catch (Exception $e) {
        tpl_error_log("EXCEPTION: update_categories_only exception: " . $e->getMessage());
        $_SESSION['error'] = "Kategoriler kaydedilirken hata: " . $e->getMessage();
        
        // Her zaman JSON döndür (header zaten set edildi)
        http_response_code(500);
        echo json_encode([
            'success' => false, 
            'message' => 'Kategoriler kaydedilirken hata: ' . $e->getMessage(),
            'error' => $e->getMessage()
        ], JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
        
        // Error display'i geri yükle
        ini_set('display_errors', $old_display_errors);
        exit;
    }
}

function add_email_to_queue($db, $campaign_id, $recipient_email, $subject, $message, $from_name, $from_email, $recipient_name = null) {
    // Email tablolarını oluştur
    ensure_email_tables($db);
    
    $stmt = $db->prepare("INSERT INTO email_queue (campaign_id, club_id, recipient_email, recipient_name, subject, message, from_name, from_email, status) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')");
    $stmt->bindValue(1, $campaign_id, SQLITE3_INTEGER);
    $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
    $stmt->bindValue(3, $recipient_email, SQLITE3_TEXT);
    $stmt->bindValue(4, $recipient_name, SQLITE3_TEXT);
    $stmt->bindValue(5, $subject, SQLITE3_TEXT);
    $stmt->bindValue(6, $message, SQLITE3_TEXT);
    $stmt->bindValue(7, $from_name, SQLITE3_TEXT);
    $stmt->bindValue(8, $from_email, SQLITE3_TEXT);
    
    $result = $stmt->execute();
    if ($result === false) {
        return false;
    }
    
    return $db->lastInsertRowID();
}

// Email kampanyası oluştur
function create_email_campaign($db, $subject, $message, $from_name, $from_email, $total_recipients) {
    // Email tablolarını oluştur
    ensure_email_tables($db);
    
    $stmt = $db->prepare("INSERT INTO email_campaigns (club_id, subject, message, from_name, from_email, total_recipients, status) VALUES (?, ?, ?, ?, ?, ?, 'pending')");
    $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $stmt->bindValue(2, $subject, SQLITE3_TEXT);
    $stmt->bindValue(3, $message, SQLITE3_TEXT);
    $stmt->bindValue(4, $from_name, SQLITE3_TEXT);
    $stmt->bindValue(5, $from_email, SQLITE3_TEXT);
    $stmt->bindValue(6, $total_recipients, SQLITE3_INTEGER);
    $stmt->execute();
    return $db->lastInsertRowID();
}

function trigger_email_queue_processor() {
    // Script yolunu PROJECT_ROOT kullanarak belirle
    $script_path = defined('PROJECT_ROOT')
        ? PROJECT_ROOT . '/system/scripts/process_email_queue.php'
        : dirname(__DIR__, 2) . '/system/scripts/process_email_queue.php';
    
    // DB_PATH'nin tam yolunu al
    $db_path = DB_PATH;
    $club_id = CLUB_ID;
    
    // Non-blocking background process başlat
    // Güvenlik: Tüm parametreleri escapeshellarg ile koru
    $escaped_script_path = escapeshellarg($script_path);
    $escaped_db_path = escapeshellarg($db_path);
    $escaped_club_id = escapeshellarg((string)$club_id);
    
    if (PHP_OS_FAMILY === 'Windows') {
        // Windows için
        $command = "start /B php $escaped_script_path $escaped_db_path $escaped_club_id > NUL 2>&1";
        pclose(popen($command, "r"));
    } else {
        // Unix/Linux/Mac için
        $command = "php $escaped_script_path $escaped_db_path $escaped_club_id > /dev/null 2>&1 &";
        exec($command);
    }
}

function handle_upload_partner_logo() {
    try {
        // Hata raporlamayı aç
        error_reporting(E_ALL);
        ini_set('display_errors', 0); // HTML çıktısını engelle
        ini_set('log_errors', 1);
        
        // JSON header'ı ayarla
        header('Content-Type: application/json');
        
        // Dosya kontrolü
        if (!isset($_FILES['partner_logo'])) {
            echo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);
            exit;
        }
        
        $file = $_FILES['partner_logo'];
        
        // Dosya yükleme hatası kontrolü
        if ($file['error'] !== UPLOAD_ERR_OK) {
            $error_messages = [
                UPLOAD_ERR_INI_SIZE => 'Dosya boyutu çok büyük (php.ini limit)',
                UPLOAD_ERR_FORM_SIZE => 'Dosya boyutu çok büyük (form limit)',
                UPLOAD_ERR_PARTIAL => 'Dosya kısmen yüklendi',
                UPLOAD_ERR_NO_FILE => 'Dosya seçilmedi',
                UPLOAD_ERR_NO_TMP_DIR => 'Geçici klasör bulunamadı',
                UPLOAD_ERR_CANT_WRITE => 'Dosya yazılamadı',
                UPLOAD_ERR_EXTENSION => 'Dosya yükleme uzantı tarafından durduruldu'
            ];
            
            $error_message = $error_messages[$file['error']] ?? 'Bilinmeyen hata: ' . $file['error'];
            echo json_encode(['success' => false, 'message' => $error_message]);
            exit;
        }
        
        $partner_name = trim($_POST['partner_name'] ?? '');
        $partner_website = trim($_POST['partner_website'] ?? '');
        
        // Güvenlik: Partner adı validation (XSS koruması)
        $partner_name = htmlspecialchars($partner_name, ENT_QUOTES, 'UTF-8');
        if (empty($partner_name) || strlen($partner_name) > 255) {
            echo json_encode(['success' => false, 'message' => 'İşbirliği adı boş olamaz ve 255 karakterden uzun olamaz']);
            exit;
        }
        
        // Güvenlik: Partner website URL validation
        if (!empty($partner_website)) {
            $partner_website = filter_var($partner_website, FILTER_SANITIZE_URL);
            if (!filter_var($partner_website, FILTER_VALIDATE_URL)) {
                echo json_encode(['success' => false, 'message' => 'Geçersiz website URL formatı']);
                exit;
            }
            // Sadece http ve https protokollerine izin ver
            if (!preg_match('/^https?:\/\//i', $partner_website)) {
                echo json_encode(['success' => false, 'message' => 'Website URL sadece http veya https protokolü ile başlamalıdır']);
                exit;
            }
        }
        
        // Dosya boyutu kontrolü (2MB)
        if ($file['size'] > 2 * 1024 * 1024) {
            echo json_encode(['success' => false, 'message' => 'Dosya boyutu 2MB\'dan büyük olamaz']);
            exit;
        }
        
        // Güvenlik: Dosya tipi kontrolü - Gerçek MIME type kontrolü
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $real_mime_type = finfo_file($finfo, $file['tmp_name']);
        finfo_close($finfo);
        
        $allowed_types = ['image/jpeg', 'image/png', 'image/gif'];
        
        // Hem gerçek MIME type hem de bildirilen type kontrolü
        if (!in_array($real_mime_type, $allowed_types)) {
            echo json_encode(['success' => false, 'message' => 'Sadece JPG, PNG ve GIF dosyaları kabul edilir']);
            exit;
        }
        
        // Güvenlik: Resim dosyası gerçekten geçerli bir resim mi kontrol et
        $image_info = @getimagesize($file['tmp_name']);
        if ($image_info === false) {
            echo json_encode(['success' => false, 'message' => 'Dosya geçerli bir resim dosyası değil']);
            exit;
        }
        
        // Dosya uzantısını al
        $file_extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
        if (!in_array($file_extension, ['jpg', 'jpeg', 'png', 'gif'])) {
            echo json_encode(['success' => false, 'message' => 'Geçersiz dosya uzantısı']);
            exit;
        }
        
        // Güvenlik: MIME type ile uzantı uyumu kontrolü
        $extension_mime_map = [
            'jpg' => 'image/jpeg',
            'jpeg' => 'image/jpeg',
            'png' => 'image/png',
            'gif' => 'image/gif'
        ];
        if (isset($extension_mime_map[$file_extension]) && $real_mime_type !== $extension_mime_map[$file_extension]) {
            echo json_encode(['success' => false, 'message' => 'Dosya uzantısı ve içeriği uyuşmuyor']);
            exit;
        }
        
        // Dosya adını oluştur
        $new_filename = 'partner_' . time() . '_' . uniqid() . '.' . $file_extension;
        
        // Klasör yolu - communities/[community_name]/assets/images/partner-logos/
        $upload_dir = community_path('assets/images/partner-logos');
        $upload_path = $upload_dir . '/' . $new_filename;
        $logo_url = 'assets/images/partner-logos/' . $new_filename;
        
        // Klasör yoksa oluştur
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                echo json_encode(['success' => false, 'message' => 'Klasör oluşturulamadı: ' . $upload_dir]);
                exit;
            }
            // Güvenlik: Klasör izinleri 0755 (rwxr-xr-x) - sadece owner yazabilir
            chmod($upload_dir, 0755);
        }
        
        // Klasör yazılabilir mi kontrol et
        if (!is_writable($upload_dir)) {
            // İzinleri düzeltmeyi dene (0755 - owner read/write/execute, group/others read/execute)
            chmod($upload_dir, 0755);
            
            // Eğer hala yazılamıyorsa, parent klasörleri de düzelt
            if (!is_writable($upload_dir)) {
                $parent_dir = dirname($upload_dir);
                while ($parent_dir !== $upload_dir && $parent_dir !== dirname($parent_dir)) {
                    if (is_dir($parent_dir)) {
                        chmod($parent_dir, 0755);
                    }
                    $parent_dir = dirname($parent_dir);
                }
                
                // Son bir kez dene
                chmod($upload_dir, 0755);
            }
            
            if (!is_writable($upload_dir)) {
                echo json_encode(['success' => false, 'message' => 'Klasör yazılabilir değil: ' . $upload_dir . ' (İzinler: ' . substr(sprintf('%o', fileperms($upload_dir)), -4) . ') - Lütfen hosting sağlayıcınızla iletişime geçin.']);
                exit;
            }
        }
        
        // Dosyayı taşı
        if (move_uploaded_file($file['tmp_name'], $upload_path)) {
            // Dosya gerçekten oluştu mu kontrol et
            if (!file_exists($upload_path)) {
                echo json_encode(['success' => false, 'message' => 'Dosya oluşturulamadı']);
                exit;
            }
            
            // Veritabanına kaydet
            $db = get_db();
            
            // Önce mevcut logoyu sil
            $stmt = $db->prepare("SELECT logo_path FROM partner_logos WHERE club_id = ?");
            $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $existing_logo = $result->fetchArray(SQLITE3_ASSOC);
            if ($existing_logo && isset($existing_logo['logo_path'])) {
                // Güvenlik: Path traversal koruması - sadece izin verilen path'ler
                $logo_path = $existing_logo['logo_path'];
                // Sadece assets/images/partner-logos/ ile başlayan path'lere izin ver
                if (strpos($logo_path, 'assets/images/partner-logos/') === 0 && strpos($logo_path, '..') === false) {
                    $old_file_path = community_path($logo_path);
                    // Güvenlik: Dosya gerçekten community path içinde mi kontrol et
                    $real_old_path = realpath($old_file_path);
                    $real_community_path = realpath(community_path('assets/images/partner-logos'));
                    if ($real_old_path && $real_community_path && strpos($real_old_path, $real_community_path) === 0) {
                        if (file_exists($old_file_path)) {
                            unlink($old_file_path);
                        }
                    }
                }
                // Veritabanından sil
                $delete_stmt = $db->prepare("DELETE FROM partner_logos WHERE club_id = ?");
                $delete_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                $delete_stmt->execute();
            }
            
            // Yeni logoyu ekle
            $stmt = $db->prepare("INSERT INTO partner_logos (club_id, partner_name, partner_website, logo_path, created_at) VALUES (?, ?, ?, ?, datetime('now'))");
            $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $stmt->bindValue(2, $partner_name, SQLITE3_TEXT);
            $stmt->bindValue(3, $partner_website, SQLITE3_TEXT);
            $stmt->bindValue(4, $logo_url, SQLITE3_TEXT);
            
            if ($stmt->execute()) {
                echo json_encode(['success' => true, 'message' => 'İşbirliği logosu başarıyla eklendi', 'logo_url' => $logo_url]);
            } else {
                // Dosyayı sil
                if (file_exists($upload_path)) {
                    unlink($upload_path);
                }
                // Güvenlik: Sensitive bilgi sızıntısını önle
                tpl_error_log("Partner logo DB error: " . $db->lastErrorMsg());
                echo json_encode(['success' => false, 'message' => 'Veritabanına kaydedilemedi']);
            }
        } else {
            echo json_encode(['success' => false, 'message' => 'Dosya taşınamadı. Klasör izinleri: ' . substr(sprintf('%o', fileperms($upload_dir)), -4)]);
        }
    } catch (Exception $e) {
        tpl_error_log("Partner logo upload error: " . $e->getMessage());
        echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);
    } catch (Error $e) {
        tpl_error_log("Partner logo upload fatal error: " . $e->getMessage());
        echo json_encode(['success' => false, 'message' => 'Kritik hata: ' . $e->getMessage()]);
    }
    exit;
}

/**
 * İşbirliği logosu silme işlemi
 */
function handle_delete_partner_logo() {
    try {
        error_reporting(E_ALL);
        ini_set('display_errors', 0);
        ini_set('log_errors', 1);
        header('Content-Type: application/json');

        $db = get_db();
        
        // Mevcut logoyu bul
        $stmt = $db->prepare("SELECT logo_path FROM partner_logos WHERE club_id = ?");
        $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
        $result = $stmt->execute();
        $existing_logo = $result->fetchArray(SQLITE3_ASSOC);
        
        if ($existing_logo && isset($existing_logo['logo_path'])) {
            // Dosyayı sil
            $file_path = community_path($existing_logo['logo_path']);
            if (file_exists($file_path)) {
                unlink($file_path);
            }
            
            // Veritabanından sil
            $delete_stmt = $db->prepare("DELETE FROM partner_logos WHERE club_id = ?");
            $delete_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            
            if ($delete_stmt->execute()) {
                echo json_encode(['success' => true, 'message' => 'İşbirliği logosu başarıyla silindi']);
            } else {
                echo json_encode(['success' => false, 'message' => 'Veritabanından silinemedi: ' . $db->lastErrorMsg()]);
            }
        } else {
            echo json_encode(['success' => false, 'message' => 'Silinecek logo bulunamadı']);
        }
    } catch (Exception $e) {
        tpl_error_log("Partner logo delete error: " . $e->getMessage());
        echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);
    } catch (Error $e) {
        tpl_error_log("Partner logo delete fatal error: " . $e->getMessage());
        echo json_encode(['success' => false, 'message' => 'Kritik hata: ' . $e->getMessage()]);
    }
    exit;
}

/**
 * Topluluk logosu yükleme işlemi
 */
function handle_upload_club_logo() {
    try {
        error_reporting(E_ALL);
        ini_set('display_errors', 0);
        ini_set('log_errors', 1);
        header('Content-Type: application/json');
        
        if (!isset($_FILES['club_logo'])) {
            echo json_encode(['success' => false, 'message' => 'Dosya seçilmedi']);
            exit;
        }
        
        $file = $_FILES['club_logo'];
        
        if ($file['error'] !== UPLOAD_ERR_OK) {
            $error_messages = [
                UPLOAD_ERR_INI_SIZE => 'Dosya boyutu çok büyük (php.ini limit)',
                UPLOAD_ERR_FORM_SIZE => 'Dosya boyutu çok büyük (form limit)',
                UPLOAD_ERR_PARTIAL => 'Dosya kısmen yüklendi',
                UPLOAD_ERR_NO_FILE => 'Dosya seçilmedi',
                UPLOAD_ERR_NO_TMP_DIR => 'Geçici klasör bulunamadı',
                UPLOAD_ERR_CANT_WRITE => 'Dosya yazılamadı',
                UPLOAD_ERR_EXTENSION => 'Dosya yükleme uzantı tarafından durduruldu'
            ];
            echo json_encode(['success' => false, 'message' => $error_messages[$file['error']] ?? 'Bilinmeyen hata']);
            exit;
        }
        
        // Dosya tipi kontrolü
        $allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime_type = finfo_file($finfo, $file['tmp_name']);
        finfo_close($finfo);
        
        if (!in_array($mime_type, $allowed_types)) {
            echo json_encode(['success' => false, 'message' => 'Sadece JPG, PNG, GIF ve WebP formatları desteklenir']);
            exit;
        }
        
        // Dosya boyutu kontrolü (2MB)
        if ($file['size'] > 2 * 1024 * 1024) {
            echo json_encode(['success' => false, 'message' => 'Dosya boyutu 2MB\'dan büyük olamaz']);
            exit;
        }
        
        // Klasör yolu - assets/images/
        $upload_dir = community_path('assets/images');
        if (!is_dir($upload_dir)) {
            if (!mkdir($upload_dir, 0755, true)) {
                echo json_encode(['success' => false, 'message' => 'Klasör oluşturulamadı']);
                exit;
            }
            // Güvenlik: Klasör izinleri 0755 (rwxr-xr-x)
            chmod($upload_dir, 0755);
        }
        
        // Dosya adı oluştur
        $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
        $new_filename = 'club_logo_' . time() . '_' . uniqid() . '.' . $extension;
        $upload_path = $upload_dir . '/' . $new_filename;
        $logo_url = 'assets/images/' . $new_filename;
        
        // Dosyayı taşı
        if (move_uploaded_file($file['tmp_name'], $upload_path)) {
            // Eski logoyu sil
            $db = get_db();
            $stmt = $db->prepare("SELECT setting_value FROM settings WHERE club_id = ? AND setting_key = 'club_logo'");
            $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $existing_logo = $result->fetchArray(SQLITE3_ASSOC);
            
            if ($existing_logo && !empty($existing_logo['setting_value'])) {
                $old_file_path = community_path($existing_logo['setting_value']);
                if (file_exists($old_file_path) && strpos(realpath($old_file_path), realpath(community_path('assets/images'))) === 0) {
                    @unlink($old_file_path);
                }
            }
            
            // Veritabanına kaydet
            $delete_stmt = $db->prepare("DELETE FROM settings WHERE club_id = ? AND setting_key = 'club_logo'");
            $delete_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $delete_stmt->execute();
            
            $insert_stmt = $db->prepare("INSERT INTO settings (club_id, setting_key, setting_value) VALUES (?, ?, ?)");
            $insert_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
            $insert_stmt->bindValue(2, 'club_logo', SQLITE3_TEXT);
            $insert_stmt->bindValue(3, $logo_url, SQLITE3_TEXT);
            
            if ($insert_stmt->execute()) {
                echo json_encode(['success' => true, 'message' => 'Logo başarıyla yüklendi', 'logo_url' => $logo_url]);
            } else {
                @unlink($upload_path);
                echo json_encode(['success' => false, 'message' => 'Veritabanına kaydedilemedi']);
            }
        } else {
            echo json_encode(['success' => false, 'message' => 'Dosya taşınamadı']);
        }
    } catch (Exception $e) {
        tpl_error_log("Club logo upload error: " . $e->getMessage());
        echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);
    }
    exit;
}

/**
 * Acil bildirimleri kontrol eder ve JSON döner.
 */
function check_urgent_notifications() {
    // Session kontrolü
    if (!isset($_SESSION['admin_id'])) {
        header('Content-Type: application/json');
        echo json_encode([
            'success' => false,
            'error' => 'Unauthorized'
        ]);
        exit;
    }
    
    $db = get_db();
    
    try {
        // Notifications tablosunun var olup olmadığını kontrol et
        $table_check = $db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
        if (!$table_check->fetchArray()) {
            // Tablo yoksa, boş JSON döndür
            header('Content-Type: application/json');
            echo json_encode([
                'success' => true,
                'notification' => null
            ]);
            exit;
        }
        
        // Acil bildirimleri kontrol et
        $notification = null;
        // Önce notifications tablosunun var olup olmadığını kontrol et
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
        if ($table_check && $table_check->fetchArray()) {
            $stmt = @$db->prepare("SELECT * FROM notifications WHERE is_urgent = 1 AND is_read = 0 ORDER BY created_at DESC LIMIT 1");
            if ($stmt) {
        $result = $stmt->execute();
                if ($result) {
        $notification = $result->fetchArray(SQLITE3_ASSOC);
                }
            }
        }
        
        // Output buffering'i temizle
        if (ob_get_level()) {
            ob_clean();
        }
        
        header('Content-Type: application/json');
        echo json_encode([
            'success' => true,
            'notification' => $notification
        ]);
    } catch (Exception $e) {
        // Output buffering'i temizle
        if (ob_get_level()) {
            ob_clean();
        }
        
        header('Content-Type: application/json');
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage()
        ]);
    }
    exit;
}

/**
 * Acil bildirimi onaylar (okundu olarak işaretler).
 */
function acknowledge_urgent_notification($db) {
    try {
        // Önce notifications tablosunun var olup olmadığını kontrol et
        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
        if (!$table_check || !$table_check->fetchArray()) {
            header('Content-Type: application/json');
            echo json_encode(['success' => true]);
            exit;
        }
        
        $stmt = @$db->prepare("UPDATE notifications SET is_read = 1 WHERE is_urgent = 1 AND is_read = 0");
        if ($stmt) {
        $stmt->execute();
        }
        
        header('Content-Type: application/json');
        echo json_encode(['success' => true]);
    } catch (Exception $e) {
        header('Content-Type: application/json');
        // Güvenlik: Sensitive bilgi sızıntısını önle
        tpl_error_log("check_urgent_notifications error: " . $e->getMessage());
        echo json_encode(['success' => false, 'error' => 'Bildirim kontrolü başarısız']);
    }
    exit;
}

/**
 * Gelen POST isteğini işleyen ana yönlendirici.
 */
function handle_post_request() {
    // Admin kontrolü
    if (!isset($_SESSION['admin_id'])) {
        return;
    }
    
    // CSRF koruması (GET istekleri hariç, sadece POST için)
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Bazı action'lar CSRF korumasından muaf (örneğin log_activity_batch)
        $csrf_exempt_actions = ['log_activity_batch'];
        $action = tpl_filter_slug($_POST['action'] ?? '', '');
        
        if (!in_array($action, $csrf_exempt_actions)) {
            if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                header('Content-Type: application/json');
                echo json_encode(['success' => false, 'error' => 'CSRF token doğrulaması başarısız']);
                exit;
            }
        }
    }
    
    $db = get_db();
    $id = (int)($_POST['id'] ?? 0);
    
    // Action'ı POST veya GET'ten al
    $action = tpl_current_action();
    
    // Eğer action yoksa, işlem yapma
    if (empty($action)) {
        return;
    }
    
    // LAZY LOADING: Action'a göre gerekli modülleri yükle
    load_modules_for_context(null, $action);

    switch ($action) {
            case 'log_activity':
                // Frontend'den gelen aktivite loglarını kaydet
                if (isset($_POST['action_type']) && isset($_POST['action_description'])) {
                    if (isset($_SESSION['admin_id']) && isset($_SESSION['admin_username'])) {
                        logToSuperAdmin('admin_action', [
                            'user_id' => $_SESSION['admin_id'],
                            'username' => $_SESSION['admin_username'],
                            'action_type' => $_POST['action_type'],
                            'action_description' => $_POST['action_description'],
                            'additional_data' => array_merge(
                                // Güvenlik: JSON decode validation
                                (function($json_str) {
                                    $decoded = json_decode($json_str, true);
                                    if (json_last_error() !== JSON_ERROR_NONE) {
                                        return [];
                                    }
                                    // Sadece array ve scalar değerlere izin ver (recursive object injection koruması)
                                    return is_array($decoded) ? $decoded : [];
                                })($_POST['additional_data'] ?? '{}'),
                                [
                                    'page_url' => $_POST['page_url'] ?? '',
                                    'current_view' => $_POST['current_view'] ?? '',
                                    'timestamp' => $_POST['timestamp'] ?? date('Y-m-d H:i:s')
                                ]
                            )
                        ]);
                    }
                }
                if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
                    ob_clean();
                    header('Content-Type: application/json');
                    echo json_encode(['success' => true]);
                    exit;
                }
                break;
            case 'log_activity_batch':
                // Frontend'den gelen toplu aktivite loglarını kaydet (performans için)
                if (isset($_POST['logs']) && isset($_SESSION['admin_id']) && isset($_SESSION['admin_username'])) {
                    // Güvenlik: JSON decode validation ve size limit
                    $logs_json = $_POST['logs'] ?? '[]';
                    if (strlen($logs_json) > 100000) { // 100KB limit
                        echo json_encode(['success' => false, 'error' => 'Log verisi çok büyük']);
                        exit;
                    }
                    $logs = json_decode($logs_json, true);
                    if (json_last_error() !== JSON_ERROR_NONE || !is_array($logs)) {
                        echo json_encode(['success' => false, 'error' => 'Geçersiz log formatı']);
                        exit;
                    }
                    // Log sayısı limiti
                    if (count($logs) > 100) {
                        $logs = array_slice($logs, 0, 100);
                    }
                    if (count($logs) > 0) {
                        // Toplu log kaydetme
                        foreach ($logs as $log) {
                            if (isset($log['action_type']) && isset($log['action_description'])) {
                                logToSuperAdmin('admin_action', [
                                    'user_id' => $_SESSION['admin_id'],
                                    'username' => $_SESSION['admin_username'],
                                    'action_type' => $log['action_type'],
                                    'action_description' => $log['action_description'],
                                    'additional_data' => array_merge(
                                        $log['additional_data'] ?? [],
                                        [
                                            'page_url' => $_POST['page_url'] ?? '',
                                            'current_view' => $_POST['current_view'] ?? '',
                                            'timestamp' => $log['timestamp'] ?? date('Y-m-d H:i:s')
                                        ]
                                    )
                                ]);
                            }
                        }
                    }
                }
                if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
                    ob_clean();
                    header('Content-Type: application/json');
                    echo json_encode(['success' => true, 'logged' => count($logs ?? [])]);
                    exit;
                }
                break;
            case 'ai_generate_event_title_suggestions':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_event_title_suggestions')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $event_data = [
                    'title' => $_POST['title'] ?? '',
                    'category' => $_POST['category'] ?? 'Genel',
                    'location' => $_POST['location'] ?? '',
                    'date' => $_POST['date'] ?? ''
                ];
                $titles = ai_generate_event_title_suggestions($event_data);
                if ($titles === false || empty($titles)) {
                    echo json_encode(['success' => false, 'message' => 'Başlık önerileri oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'titles' => $titles]);
                }
                exit;
                
            case 'ai_generate_event_hashtags':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_event_hashtags')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $event_data = ['title' => $_POST['title'] ?? '', 'category' => $_POST['category'] ?? 'Genel', 'location' => $_POST['location'] ?? ''];
                $hashtags = ai_generate_event_hashtags($event_data);
                if ($hashtags === false) {
                    echo json_encode(['success' => false, 'message' => 'Hashtag\'ler oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'hashtags' => $hashtags]);
                }
                exit;
                
            case 'ai_generate_social_media_post':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_social_media_post')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $event_data = ['title' => $_POST['title'] ?? '', 'date' => $_POST['date'] ?? '', 'time' => $_POST['time'] ?? '', 'location' => $_POST['location'] ?? ''];
                $platform = $_POST['platform'] ?? 'instagram';
                $post = ai_generate_social_media_post($event_data, $platform);
                if ($post === false) {
                    echo json_encode(['success' => false, 'message' => 'Paylaşım metni oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'post' => $post]);
                }
                exit;
                
            case 'ai_improve_text':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_improve_text')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $text = $_POST['text'] ?? '';
                $improvement_type = $_POST['improvement_type'] ?? 'gramer';
                $improved = ai_improve_text($text, $improvement_type);
                if ($improved === false) {
                    echo json_encode(['success' => false, 'message' => 'Metin iyileştirilemedi']);
                } else {
                    echo json_encode(['success' => true, 'improved_text' => $improved]);
                }
                exit;
                
            case 'ai_generate_message':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_message')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $purpose = $_POST['purpose'] ?? 'duyuru';
                $tone = $_POST['tone'] ?? 'samimi';
                $subject = $_POST['subject'] ?? '';
                $is_sms = isset($_POST['is_sms']) && $_POST['is_sms'] === '1';
                $context = [
                    'tone' => $tone,
                    'subject' => $subject,
                    'is_sms' => $is_sms
                ];
                $message = ai_generate_message($purpose, $context);
                if ($message === false) {
                    echo json_encode(['success' => false, 'message' => 'Mesaj oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'message' => $message]);
                }
                exit;
                
            case 'ai_generate_email_subject':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_email_subject')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $purpose = $_POST['purpose'] ?? 'duyuru';
                $subject = ai_generate_email_subject($purpose);
                if ($subject === false) {
                    echo json_encode(['success' => false, 'message' => 'Konu oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'subject' => $subject]);
                }
                exit;
                
            case 'ai_generate_email_template':
                header('Content-Type: application/json');
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                if (!ensure_ai_function('ai_generate_email_template')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                $purpose = $_POST['purpose'] ?? 'duyuru';
                $subject = $_POST['subject'] ?? '';
                $template = ai_generate_email_template($purpose, ['subject' => $subject]);
                if ($template === false) {
                    echo json_encode(['success' => false, 'message' => 'Şablon oluşturulamadı']);
                } else {
                    echo json_encode(['success' => true, 'template' => $template]);
                }
                exit;
                
            case 'ai_analyze_reports':
                set_time_limit(120);
                ini_set('max_execution_time', 120);
                ini_set('memory_limit', '256M');
                
                while (ob_get_level()) {
                    ob_end_clean();
                }
                
                header('Content-Type: application/json; charset=utf-8');
                
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    tpl_error_log("AI Analyze Reports: CSRF token hatası");
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız'], JSON_UNESCAPED_UNICODE);
                    exit;
                }
                
                // Aylık limit kontrolü
                $last_analysis_date = get_setting('last_ai_analysis_date', '');
                $current_month = date('Y-m');
                
                if (!empty($last_analysis_date)) {
                    $last_month = date('Y-m', strtotime($last_analysis_date));
                    
                    if ($last_month === $current_month) {
                        // Bu ay zaten analiz yapılmış
                        $next_available = date('Y-m-01', strtotime('+1 month'));
                        $days_remaining = ceil((strtotime($next_available) - time()) / 86400);
                        
                        echo json_encode([
                            'success' => false, 
                            'message' => 'Bu ay için AI analizi zaten yapılmış. Bir sonraki analiz ' . date('d.m.Y', strtotime($next_available)) . ' tarihinden itibaren yapılabilir.',
                            'limit_reached' => true,
                            'next_available' => $next_available,
                            'days_remaining' => $days_remaining
                        ], JSON_UNESCAPED_UNICODE);
                        exit;
                    }
                }
                
                if (!ensure_ai_function('ai_analyze_reports')) {
                    tpl_error_log("AI Analyze Reports: ai_analyze_reports fonksiyonu bulunamadı");
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı'], JSON_UNESCAPED_UNICODE);
                    exit;
                }
                
                try {
                    $analysis = ai_analyze_reports($db);
                    
                    if ($analysis === false) {
                        tpl_error_log("AI Analyze Reports: Analiz false döndü");
                        echo json_encode(['success' => false, 'message' => 'Analiz oluşturulamadı. Lütfen tekrar deneyin.'], JSON_UNESCAPED_UNICODE);
                    } else {
                        // Analiz başarılı, tarihi ve sonuçları kaydet
                        $current_date = date('Y-m-d H:i:s');
                        
                        // Tarihi kaydet
                        $stmt = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'last_ai_analysis_date', :date)");
                        $stmt->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                        $stmt->bindValue(':date', $current_date, SQLITE3_TEXT);
                        $stmt->execute();
                        
                        // Analiz sonuçlarını kaydet (JSON formatında)
                        $analysis_json = json_encode($analysis, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                        $stmt2 = $db->prepare("INSERT OR REPLACE INTO settings (club_id, setting_key, setting_value) VALUES (:club_id, 'last_ai_analysis_data', :data)");
                        $stmt2->bindValue(':club_id', CLUB_ID, SQLITE3_INTEGER);
                        $stmt2->bindValue(':data', $analysis_json, SQLITE3_TEXT);
                        $stmt2->execute();
                        
                        if (strlen($analysis['summary'] ?? '') > 8000) {
                            $analysis['summary'] = substr($analysis['summary'], 0, 8000) . "\n\n[... devamı kısaltıldı]";
                        }
                        
                        $json_result = @json_encode(['success' => true, 'analysis' => $analysis], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                        
                        if ($json_result === false) {
                            $analysis['summary'] = substr($analysis['summary'] ?? '', 0, 3000);
                            $json_result = json_encode(['success' => true, 'analysis' => $analysis], JSON_UNESCAPED_UNICODE);
                            if ($json_result === false) {
                                echo json_encode(['success' => false, 'message' => 'JSON encode hatası: ' . json_last_error_msg()], JSON_UNESCAPED_UNICODE);
                                exit;
                            }
                        }
                        
                        echo $json_result;
                    }
                } catch (Exception $e) {
                    tpl_error_log("AI Analyze Reports Exception: " . $e->getMessage());
                    echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                } catch (Error $e) {
                    tpl_error_log("AI Analyze Reports Fatal Error: " . $e->getMessage());
                    echo json_encode(['success' => false, 'message' => 'Fatal hata: ' . $e->getMessage()], JSON_UNESCAPED_UNICODE);
                }
                exit;
                
            case 'ai_generate_campaign_text':
                header('Content-Type: application/json');
                
                // CSRF kontrolü
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                
                if (!ensure_ai_function('ai_generate_campaign_text')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                
                $campaign_data = [
                    'title' => $_POST['title'] ?? '',
                    'discount_percentage' => $_POST['discount_percentage'] ?? null,
                    'partner_name' => $_POST['partner_name'] ?? null,
                ];
                
                $text = ai_generate_campaign_text($campaign_data);
                
                if ($text === false) {
                    echo json_encode(['success' => false, 'message' => 'Kampanya metni oluşturulamadı. Lütfen tekrar deneyin.']);
                } else {
                    echo json_encode(['success' => true, 'text' => $text]);
                }
                exit;
                
            case 'ai_generate_product_description':
                header('Content-Type: application/json');
                
                // CSRF kontrolü
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode(['success' => false, 'message' => 'CSRF token doğrulaması başarısız']);
                    exit;
                }
                
                if (!ensure_ai_function('ai_generate_product_description')) {
                    echo json_encode(['success' => false, 'message' => 'AI Helper bulunamadı']);
                    exit;
                }
                
                $product_data = [
                    'name' => $_POST['name'] ?? '',
                    'price' => $_POST['price'] ?? '',
                    'category' => $_POST['category'] ?? 'Genel',
                ];
                
                $description = ai_generate_product_description($product_data);
                
                if ($description === false) {
                    echo json_encode(['success' => false, 'message' => 'Ürün açıklaması oluşturulamadı. Lütfen tekrar deneyin.']);
                } else {
                    echo json_encode(['success' => true, 'description' => $description]);
                }
                exit;
                
            case 'ai_generate_event_description':
                // AI ile etkinlik açıklaması oluştur
                header('Content-Type: application/json');
                
                // CSRF token kontrolü
                if (!isset($_POST['csrf_token']) || !verify_csrf_token($_POST['csrf_token'])) {
                    echo json_encode([
                        'success' => false,
                        'error' => 'Güvenlik hatası: Geçersiz CSRF token. Lütfen sayfayı yenileyin.'
                    ]);
                    exit;
                }
                
                try {
                    if (!ensure_ai_function('ai_generate_event_description')) {
                        tpl_error_log("AI Helper path not found veya fonksiyon yüklenmedi");
                        tpl_error_log("AI Helper functions not loaded. Available functions: " . implode(', ', get_defined_functions()['user'] ?? []));
                        echo json_encode([
                            'success' => false,
                            'error' => 'AI Helper fonksiyonları yüklenemedi'
                        ]);
                        exit;
                    }
                    
                    $event_data = [
                        'title' => $_POST['title'] ?? '',
                        'date' => $_POST['date'] ?? '',
                        'time' => $_POST['time'] ?? '',
                        'location' => $_POST['location'] ?? '',
                        'category' => $_POST['category'] ?? 'Genel',
                        'organizer' => $_POST['organizer'] ?? ''
                    ];
                    
                    $description = ai_generate_event_description($event_data);
                    
                    if ($description !== false && !empty($description)) {
                        echo json_encode([
                            'success' => true,
                            'description' => $description
                        ]);
                    } else {
                        // Son hata loglarını kontrol et
                        $error_log = error_get_last();
                        $error_msg = 'Açıklama oluşturulamadı. Lütfen tekrar deneyin.';
                        
                        // Debug için (sadece development'ta)
                        if (defined('APP_ENV') && APP_ENV === 'development') {
                            $error_msg .= ' (Logları kontrol edin: logs/php_errors.log)';
                        }
                        
                        echo json_encode([
                            'success' => false,
                            'error' => $error_msg
                        ]);
                    }
                } catch (Exception $e) {
                    tpl_error_log("AI generation error: " . $e->getMessage());
                    echo json_encode([
                        'success' => false,
                        'error' => 'Bir hata oluştu: ' . $e->getMessage()
                    ]);
                }
                exit;
                
            case 'add_event':
                try {
                    add_event($db, $_POST);
                    // Cache'i temizle
                    clear_entity_cache('events');
                    $_SESSION['message'] = "Etkinlik başarıyla eklendi.";
                } catch (Exception $e) {
                    $_SESSION['error'] = "Etkinlik eklenirken hata: " . $e->getMessage();
                    tpl_error_log("Etkinlik ekleme exception: " . $e->getMessage() . " - " . $e->getTraceAsString());
                }
                // Redirect yap
                header("Location: index.php?view=events");
                exit;
            case 'update_event':
                update_event($db, $_POST);
                // Güvenlik: View name validation (whitelist)
                $allowed_views = ['events', 'event_detail', 'members', 'dashboard', 'settings', 'notifications', 'finance', 'campaigns', 'market', 'subscription', 'support', 'verification', 'verification_admin'];
                $redirect_view = tpl_whitelist_value($_POST['current_view'] ?? 'events', $allowed_views, 'events');
                if ($redirect_view === 'event_detail' && isset($_POST['id'])) {
                    header("Location: index.php?view=event_detail&event_id=" . (int)$_POST['id']);
                } else {
                    header("Location: index.php?view=" . urlencode($redirect_view));
                }
                exit;
            case 'delete_event':
                delete_event($db, $id);
                break;
            case 'add_member':
                add_member($db, $_POST);
                break;
            case 'update_member':
                update_member($db, $_POST);
                // Güvenlik: View name validation
                $allowed_views = ['events', 'event_detail', 'members', 'dashboard', 'settings', 'notifications', 'finance', 'campaigns', 'market', 'subscription', 'support', 'verification', 'verification_admin'];
                $redirect_view = tpl_whitelist_value($_POST['current_view'] ?? 'members', $allowed_views, 'members');
                header("Location: index.php?view=" . urlencode($redirect_view));
                exit;
            case 'delete_member':
                delete_member($db, $id);
                break;
        case 'approve_membership_request':
            $request_id = (int)($_POST['request_id'] ?? 0);
            if ($request_id > 0) {
                approve_membership_request($db, $request_id);
            } else {
                $_SESSION['error'] = "Geçersiz başvuru talebi.";
            }
            break;
        case 'reject_membership_request':
            $request_id = (int)($_POST['request_id'] ?? 0);
            // Güvenlik: Admin notes XSS koruması
            $admin_notes = trim($_POST['admin_notes'] ?? '');
            $admin_notes = htmlspecialchars($admin_notes, ENT_QUOTES, 'UTF-8');
            // Maksimum uzunluk kontrolü
            if (strlen($admin_notes) > 1000) {
                $admin_notes = substr($admin_notes, 0, 1000);
            }
            if ($request_id > 0) {
                reject_membership_request($db, $request_id, $admin_notes);
            } else {
                $_SESSION['error'] = "Geçersiz başvuru talebi.";
            }
            break;
            case 'add_board_member':
                add_board_member($db, $_POST);
                break;
        case 'update_board_member':
            update_board_member($db, $_POST);
            // Güvenlik: View name validation
            $allowed_views = ['events', 'event_detail', 'members', 'dashboard', 'settings', 'notifications', 'finance', 'campaigns', 'verification', 'verification_admin'];
            $redirect_view = tpl_whitelist_value($_POST['current_view'] ?? 'members', $allowed_views, 'members');
            header("Location: index.php?view=" . urlencode($redirect_view));
            exit;
        case 'delete_board_member':
                // Güvenlik: ID validation
                $id = isset($_POST['id']) ? (int)$_POST['id'] : 0;
                if ($id <= 0) {
                    $_SESSION['error'] = "Geçersiz yönetim kurulu üyesi ID'si";
                    header("Location: index.php?view=board");
                    exit;
                }
                
                try {
                    $stmt = $db->prepare("DELETE FROM board_members WHERE id = ? AND club_id = ?");
                    $stmt->bindValue(1, $id, SQLITE3_INTEGER);
                    $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                    $stmt->execute();
                    
                    // Log kaydet
                    if (isset($_SESSION['admin_id']) && isset($_SESSION['admin_username'])) {
                        logToSuperAdmin('admin_action', [
                            'user_id' => $_SESSION['admin_id'],
                            'username' => $_SESSION['admin_username'],
                            'action_type' => 'board_member_delete',
                            'action_description' => 'Yönetim kurulu üyesi silindi: ID ' . $id,
                            'additional_data' => ['board_member_id' => $id]
                        ]);
                    }
                    
                    // Cache'i temizle
                    clear_entity_cache('board_members');
                    
                    $_SESSION['message'] = "Yönetim kurulu üyesi başarıyla silindi.";
                } catch (Exception $e) {
                    $_SESSION['error'] = "Yönetim kurulu üyesi silinirken hata: " . $e->getMessage();
                }
                
                // Güvenlik: View name validation
                $allowed_views = ['events', 'event_detail', 'members', 'dashboard', 'settings', 'notifications', 'finance', 'campaigns', 'board', 'verification', 'verification_admin'];
                $redirect_view = tpl_whitelist_value($_POST['current_view'] ?? 'board', $allowed_views, 'board');
                header("Location: index.php?view=" . urlencode($redirect_view));
                exit;
            case 'update_settings':
                update_settings($db, $_POST);
                header("Location: index.php?view=settings&saved=1");
                exit;
            case 'update_categories_only':
                // Tüm output'u durdur ve temizle (HTML output'u önlemek için)
                while (ob_get_level()) {
                    ob_end_clean();
                }
                // Error handler'ı geçici olarak devre dışı bırak (HTML output üretmesin)
                $old_error_handler = set_error_handler(null);
                $old_exception_handler = set_exception_handler(null);
                
                try {
                    update_categories_only($db, $_POST);
                } finally {
                    // Error handler'ları geri yükle
                    if ($old_error_handler) {
                        set_error_handler($old_error_handler);
                    }
                    if ($old_exception_handler) {
                        set_exception_handler($old_exception_handler);
                    }
                }
                // exit zaten fonksiyon içinde var, buraya gelmez
                break;
            case 'test_smtp':
                test_smtp_connection($_POST);
                break;
            case 'save_smtp':
                save_smtp_settings($_POST);
                break;
            case 'send_test_email':
                send_test_email();
                break;
            case 'send_email':
                // AJAX isteği ise JSON döndür
                if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
                    ob_clean();
                    header('Content-Type: application/json');
                    handle_send_email_ajax($_POST);
                    exit;
                } else {
                handle_send_email($_POST);
                }
                break;
            case 'send_sms': // DÜZELTİLDİ: 'send_message' yerine 'send_sms' action'ını kullanmak daha mantıklı.
                // AJAX isteği ise JSON döndür
                if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
                    // Tüm output buffer'ları temizle
                    while (ob_get_level() > 0) {
                        ob_end_clean();
                    }
                    
                    // PHP hatalarını gizle (JSON output'u bozmasın)
                    $old_error_reporting = error_reporting(0);
                    ini_set('display_errors', 0);
                    
                    // Error handler - PHP hatalarını yakala
                    $old_error_handler = set_error_handler(function($severity, $message, $file, $line) {
                        // Sadece kritik hataları yakala
                        if ($severity & (E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR | E_USER_ERROR | E_RECOVERABLE_ERROR)) {
                            throw new ErrorException($message, 0, $severity, $file, $line);
                        }
                        return false; // Diğer hatalar için default handler'ı kullan
                    });
                    
                    // Shutdown handler - Fatal error'ları yakala
                    register_shutdown_function(function() {
                        $error = error_get_last();
                        if ($error !== null && in_array($error['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR])) {
                            // Tüm output'u temizle
                            while (ob_get_level() > 0) {
                                ob_end_clean();
                            }
                            header('Content-Type: application/json; charset=utf-8');
                            echo json_encode([
                                'success' => false,
                                'message' => 'SMS gönderilirken kritik hata oluştu. Lütfen tekrar deneyin.'
                            ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                            exit;
                        }
                    });
                    
                    header('Content-Type: application/json; charset=utf-8');
                    
                    try {
                        // SMS gönderimini yap
                        handle_send_message($_POST);
                        
                        // Başarı/hata mesajını kontrol et
                        if (isset($_SESSION['message']) && !empty($_SESSION['message'])) {
                            $message = $_SESSION['message'];
                            unset($_SESSION['message']);
                            $response = ['success' => true, 'message' => $message];
                        } elseif (isset($_SESSION['error']) && !empty($_SESSION['error'])) {
                            $error = $_SESSION['error'];
                            unset($_SESSION['error']);
                            $response = ['success' => false, 'message' => $error];
                        } else {
                            // Mesaj yoksa varsayılan başarı mesajı
                            $response = ['success' => true, 'message' => 'SMS başarıyla gönderildi'];
                        }
                        
                        $json_response = json_encode($response, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                        if ($json_response === false) {
                            throw new Exception('JSON encode hatası: ' . json_last_error_msg());
                        }
                        echo $json_response;
                    } catch (Exception $e) {
                        // Tüm output'u temizle
                        while (ob_get_level() > 0) {
                            ob_end_clean();
                        }
                        error_log("SMS send exception: " . $e->getMessage() . " | Trace: " . $e->getTraceAsString());
                        header('Content-Type: application/json; charset=utf-8');
                        echo json_encode([
                            'success' => false, 
                            'message' => 'SMS gönderilirken hata oluştu: ' . $e->getMessage()
                        ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                    } catch (Error $e) {
                        // Tüm output'u temizle
                        while (ob_get_level() > 0) {
                            ob_end_clean();
                        }
                        error_log("SMS send fatal error: " . $e->getMessage() . " | Trace: " . $e->getTraceAsString());
                        header('Content-Type: application/json; charset=utf-8');
                        echo json_encode([
                            'success' => false, 
                            'message' => 'SMS gönderilirken kritik hata oluştu: ' . $e->getMessage()
                        ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                    } catch (Throwable $e) {
                        // Tüm output'u temizle
                        while (ob_get_level() > 0) {
                            ob_end_clean();
                        }
                        error_log("SMS send throwable error: " . $e->getMessage() . " | Trace: " . $e->getTraceAsString());
                        header('Content-Type: application/json; charset=utf-8');
                        echo json_encode([
                            'success' => false, 
                            'message' => 'SMS gönderilirken beklenmeyen hata oluştu: ' . $e->getMessage()
                        ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
                    } finally {
                        // Error handler'ı geri yükle
                        restore_error_handler();
                        error_reporting($old_error_reporting);
                        ini_set('display_errors', ini_get('display_errors'));
                    }
                    exit;
                } else {
                    // Normal form submit (geriye dönük uyumluluk)
                    handle_send_message($_POST);
                    // Mesaj sekmesinde kal - yönlendirme yapma
                    if (isset($_SESSION['stay_on_messages'])) {
                        unset($_SESSION['stay_on_messages']);
                    }
                    // View'i messages olarak ayarla (yönlendirme yapılmasın)
                    $_GET['view'] = 'messages';
                    $current_view = 'messages';
                }
                break;
            case 'get_sms_usage':
                // AJAX endpoint - SMS kullanım bilgisini döndür
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                
                if (!function_exists('get_sms_usage_info')) {
                    require_once __DIR__ . '/../lib/general/subscription_helper.php';
                }
                
                $smsUsage = get_sms_usage_info();
                echo json_encode([
                    'success' => true,
                    'current' => $smsUsage['current'] ?? 0,
                    'limit' => $smsUsage['limit'] ?? 0,
                    'remaining' => $smsUsage['remaining'] ?? 0
                ]);
                exit;
            case 'acknowledge_urgent_notification':
                acknowledge_urgent_notification($db);
                break;
            case 'mark_as_read':
                // JSON döndür
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                $notification_id = (int)($_POST['notification_id'] ?? $_GET['notification_id'] ?? 0);
                if ($notification_id > 0) {
                    try {
                        // Önce notifications tablosunun var olup olmadığını kontrol et
                        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
                        if ($table_check && $table_check->fetchArray()) {
                            $stmt = @$db->prepare("UPDATE notifications SET is_read = 1 WHERE id = ? AND club_id = ?");
                            if ($stmt) {
                        $stmt->bindValue(1, $notification_id, SQLITE3_INTEGER);
                        $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                        $stmt->execute();
                            }
                        }
                        echo json_encode(['success' => true]);
                    } catch (Exception $e) {
                        // Güvenlik: Sensitive bilgi sızıntısını önle
                        tpl_error_log("Notification update error: " . $e->getMessage());
                        echo json_encode(['success' => false, 'error' => 'Veritabanı hatası oluştu']);
                    }
                } else {
                    echo json_encode(['success' => false, 'error' => 'Bildirim ID gerekli']);
                }
                exit;
            case 'delete_notification':
                // JSON döndür
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                $notification_id = (int)($_POST['notification_id'] ?? $_GET['notification_id'] ?? 0);
                if ($notification_id > 0) {
                    try {
                        // Önce notifications tablosunun var olup olmadığını kontrol et
                        $table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='notifications'");
                        if ($table_check && $table_check->fetchArray()) {
                            $stmt = @$db->prepare("DELETE FROM notifications WHERE id = ? AND club_id = ?");
                            if ($stmt) {
                        $stmt->bindValue(1, $notification_id, SQLITE3_INTEGER);
                        $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                        $stmt->execute();
                            }
                        }
                        echo json_encode(['success' => true]);
                    } catch (Exception $e) {
                        // Güvenlik: Sensitive bilgi sızıntısını önle
                        tpl_error_log("Notification delete error: " . $e->getMessage());
                        echo json_encode(['success' => false, 'error' => 'Veritabanı hatası oluştu']);
                    }
                } else {
                    echo json_encode(['success' => false, 'error' => 'Bildirim ID gerekli']);
                }
                exit;
            case 'get_notification_count':
                // JSON döndür
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                $stmt = $db->prepare("SELECT COUNT(*) as count FROM notifications WHERE club_id = ? AND is_read = 0");
                $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                $result = $stmt->execute();
                $row = $result->fetchArray(SQLITE3_ASSOC);
                echo json_encode(['success' => true, 'count' => (int)$row['count']]);
                exit;
            case 'get_notifications':
                // JSON döndür
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                $stmt = $db->prepare("SELECT * FROM notifications WHERE club_id = ? ORDER BY created_at DESC LIMIT 10");
                $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                $result = $stmt->execute();
                $notifications = [];
                while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
                    $notifications[] = $row;
                }
                echo json_encode(['success' => true, 'notifications' => $notifications]);
                exit;
            case 'submit_verification_request':
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                load_module('verification');
                
                $notes = trim($_POST['verification_notes'] ?? '');
                if (!isset($_FILES['verification_document'])) {
                    echo json_encode(['success' => false, 'message' => 'PDF belgesini ekleyin.']);
                    exit;
                }
                
                try {
                    $upload = verification_upload_document($_FILES['verification_document']);
                    if (!$upload['success']) {
                        echo json_encode(['success' => false, 'message' => $upload['error'] ?? 'Belge yüklenemedi.']);
                        exit;
                    }
                    
                    $created = verification_create_request($upload['path'], $notes);
                    if ($created) {
                        if (isset($_SESSION['admin_id']) && isset($_SESSION['admin_username'])) {
                            logToSuperAdmin('verification_request', [
                                'user_id' => $_SESSION['admin_id'],
                                'username' => $_SESSION['admin_username'],
                                'community_id' => defined('COMMUNITY_ID') ? COMMUNITY_ID : (defined('CLUB_ID') ? CLUB_ID : ''),
                                'document_path' => $upload['path']
                            ]);
                        }
                        echo json_encode(['success' => true, 'message' => 'Onay talebiniz alındı.']);
                    } else {
                        echo json_encode(['success' => false, 'message' => 'Talep kaydedilemedi.']);
                    }
                } catch (Exception $e) {
                    tpl_error_log('Verification request error: ' . $e->getMessage());
                    echo json_encode(['success' => false, 'message' => 'Beklenmeyen bir hata oluştu.']);
                }
                exit;
            case 'review_verification_request':
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                load_module('verification');
                
                if (empty($_SESSION['is_superadmin'])) {
                    echo json_encode(['success' => false, 'message' => 'Bu işlem için superadmin izni gerekli.']);
                    exit;
                }
                
                $requestId = (int)($_POST['request_id'] ?? 0);
                $newStatus = tpl_filter_slug($_POST['new_status'] ?? '', '');
                $adminNotes = trim($_POST['admin_notes'] ?? '');
                
                if ($requestId <= 0 || !in_array($newStatus, ['approved', 'rejected', 'pending'], true)) {
                    echo json_encode(['success' => false, 'message' => 'Geçersiz talep veya durum.']);
                    exit;
                }
                
                $updated = verification_update_status(
                    $requestId,
                    $newStatus,
                    $_SESSION['admin_id'] ?? null,
                    $_SESSION['admin_username'] ?? 'superadmin',
                    $adminNotes
                );
                
                echo json_encode([
                    'success' => (bool)$updated,
                    'message' => $updated ? 'Durum güncellendi.' : 'Durum güncellenemedi.'
                ]);
                exit;
            case 'get_verification_status':
                if (ob_get_level() > 0) ob_clean();
                header('Content-Type: application/json');
                load_module('verification');
                $data = verification_get_status_for_api();
                echo json_encode([
                    'success' => true,
                    'status' => $data
                ]);
                exit;
            case 'clear_cache':
                $cache = get_cache();
                $count = $cache->clear();
                $_SESSION['message'] = "Cache başarıyla temizlendi! $count dosya silindi. 🗑️";
                header("Location: index.php?view=dashboard");
                exit;
            case 'create_backup':
                $backup_result = create_database_backup(true); // Bildirim gönder
                $is_ajax = isset($_POST['ajax']) && $_POST['ajax'];
                
                if ($is_ajax) {
                    if (ob_get_level() > 0) {
                        ob_end_clean();
                    }
                    header('Content-Type: application/json');
                    echo json_encode($backup_result);
                    exit;
                }
                
                if ($backup_result['success']) {
                    $_SESSION['message'] = $backup_result['message'] . ' (Boyut: ' . $backup_result['size'] . ')';
                } else {
                    $_SESSION['error'] = $backup_result['message'];
                }
                break;
            case 'import_members':
                if (isset($_FILES['csv_file']) && $_FILES['csv_file']['error'] === UPLOAD_ERR_OK) {
                    // Güvenlik: Dosya adını sanitize et
                    $original_filename = $_FILES['csv_file']['name'];
                    $safe_filename = preg_replace('/[^a-zA-Z0-9._-]/', '', basename($original_filename));
                    if (empty($safe_filename) || !preg_match('/\.csv$/i', $safe_filename)) {
                        $_SESSION['error'] = 'Geçersiz dosya adı veya formatı';
                        header("Location: index.php?view=members");
                        exit;
                    }
                    $upload_dir = sys_get_temp_dir();
                    $upload_file = $upload_dir . '/' . $safe_filename;
                    $finfo = finfo_open(FILEINFO_MIME_TYPE);
                    $mimeType = $finfo ? finfo_file($finfo, $_FILES['csv_file']['tmp_name']) : null;
                    if ($finfo) {
                        finfo_close($finfo);
                    }
                    $allowedCsvMimes = ['text/plain', 'text/csv', 'application/vnd.ms-excel'];
                    if (!in_array($mimeType, $allowedCsvMimes, true)) {
                        $_SESSION['error'] = 'Geçersiz dosya tipi. Lütfen CSV dosyası yükleyin.';
                        header("Location: index.php?view=members");
                        exit;
                    }
                    if (move_uploaded_file($_FILES['csv_file']['tmp_name'], $upload_file)) {
                        $result = import_members_csv($upload_file);
                        if ($result['success']) {
                            $message = $result['message'];
                            if (isset($result['updated']) && $result['updated'] > 0) {
                                $message .= " " . $result['updated'] . " üye güncellendi.";
                            }
                            $_SESSION['message'] = $message;
                            if (!empty($result['errors'])) {
                                $_SESSION['import_errors'] = $result['errors'];
                            }
                        } else {
                            $_SESSION['error'] = $result['message'];
                        }
                        @unlink($upload_file);
                    } else {
                        $_SESSION['error'] = 'Dosya yüklenemedi';
                    }
                } else {
                    $_SESSION['error'] = 'Dosya seçilmedi veya yükleme hatası oluştu';
                }
                header("Location: index.php?view=members");
                exit;
            case 'import_events':
                if (isset($_FILES['csv_file']) && $_FILES['csv_file']['error'] === UPLOAD_ERR_OK) {
                    // Güvenlik: Dosya adını sanitize et
                    $original_filename = $_FILES['csv_file']['name'];
                    $safe_filename = preg_replace('/[^a-zA-Z0-9._-]/', '', basename($original_filename));
                    if (empty($safe_filename) || !preg_match('/\.csv$/i', $safe_filename)) {
                        $_SESSION['error'] = 'Geçersiz dosya adı veya formatı';
                        header("Location: index.php?view=events");
                        exit;
                    }
                    $upload_dir = sys_get_temp_dir();
                    $upload_file = $upload_dir . '/' . $safe_filename;
                    $finfo = finfo_open(FILEINFO_MIME_TYPE);
                    $mimeType = $finfo ? finfo_file($finfo, $_FILES['csv_file']['tmp_name']) : null;
                    if ($finfo) {
                        finfo_close($finfo);
                    }
                    $allowedCsvMimes = ['text/plain', 'text/csv', 'application/vnd.ms-excel'];
                    if (!in_array($mimeType, $allowedCsvMimes, true)) {
                        $_SESSION['error'] = 'Geçersiz dosya tipi. Lütfen CSV dosyası yükleyin.';
                        header("Location: index.php?view=events");
                        exit;
                    }
                    if (move_uploaded_file($_FILES['csv_file']['tmp_name'], $upload_file)) {
                        $result = import_events_csv($upload_file);
                        if ($result['success']) {
                            $_SESSION['message'] = $result['message'];
                            if (!empty($result['errors'])) {
                                $_SESSION['import_errors'] = $result['errors'];
                            }
                        } else {
                            $_SESSION['error'] = $result['message'];
                        }
                        @unlink($upload_file);
                    } else {
                        $_SESSION['error'] = 'Dosya yüklenemedi';
                    }
                } else {
                    $_SESSION['error'] = 'Dosya seçilmedi veya yükleme hatası oluştu';
                }
                header("Location: index.php?view=events");
                exit;
            case 'add_financial_transaction':
                $result = add_financial_transaction($db, $_POST);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'update_financial_transaction':
                $result = update_financial_transaction($db, array_merge(['id' => $id], $_POST));
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'delete_financial_transaction':
                $result = delete_financial_transaction($db, ['id' => $id]);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'add_financial_category':
                $result = add_financial_category($db, $_POST);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'update_financial_category':
                $result = update_financial_category($db, array_merge(['id' => $id], $_POST));
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'delete_financial_category':
                $result = delete_financial_category($db, ['id' => $id]);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'add_budget_plan':
                $result = add_budget_plan($db, $_POST);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'update_budget_plan':
                $result = update_budget_plan($db, array_merge(['id' => $id], $_POST));
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'delete_budget_plan':
                $result = delete_budget_plan($db, ['id' => $id]);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'add_payment':
                $result = add_payment($db, $_POST);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'add_payments':
                // add_payments fonksiyonu yok, add_payment kullan
                $result = add_payment($db, $_POST);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'update_payment':
                $result = update_payment($db, array_merge(['id' => $id], $_POST));
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'delete_payment':
                $result = delete_payment($db, ['id' => $id]);
                $_SESSION['message'] = $result['message'];
                header("Location: index.php?view=finance");
                exit;
            case 'send_payment_confirmation_emails':
                // AJAX isteği ise JSON döndür
                $isAjax = !empty($_SERVER['HTTP_X_REQUESTED_WITH'])
                    || (isset($_GET['ajax']) && $_GET['ajax'] === '1')
                    || (isset($_POST['ajax']) && $_POST['ajax'] === '1');
                if ($isAjax) {
                    ob_clean();
                    header('Content-Type: application/json');
                    $result = send_payment_confirmation_emails($db, $_POST);
                    echo json_encode($result);
                    exit;
                } else {
                    $result = send_payment_confirmation_emails($db, $_POST);
                    $_SESSION['message'] = $result['message'];
                    header("Location: index.php?view=finance");
                    exit;
                }
            case 'logout':
                handle_logout();
                break;
            case 'upload_partner_logo':
                // JSON response için header ayarla
                header('Content-Type: application/json');
                handle_upload_partner_logo();
                break;
                
            case 'delete_partner_logo':
                // JSON response için header ayarla
                header('Content-Type: application/json');
                handle_delete_partner_logo();
                break;
                
            case 'upload_club_logo':
                // JSON response için header ayarla
                header('Content-Type: application/json');
                handle_upload_club_logo();
                break;
            case 'create_survey':
                header('Content-Type: application/json');
                // Tüm output'u temizle ve sadece JSON döndür
                ob_clean();
                try {
                    handle_create_survey($db, $_POST);
                } catch (Exception $e) {
                    tpl_error_log("create_survey exception: " . $e->getMessage());
                    echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);
                }
                exit; // JSON response'dan sonra çık
            case 'upload_event_media':
                header('Content-Type: application/json');
                try {
                    handle_upload_event_media($db, $_POST, $_FILES);
                } catch (Exception $e) {
                    tpl_error_log("upload_event_media exception: " . $e->getMessage());
                    echo json_encode(['success' => false, 'message' => 'Hata: ' . $e->getMessage()]);
                }
                break;
            case 'delete_event_image':
                header('Content-Type: application/json');
                handle_delete_event_image($db, (int)($_POST['image_id'] ?? 0));
                break;
            case 'delete_event_video':
                header('Content-Type: application/json');
                handle_delete_event_video($db, (int)($_POST['video_id'] ?? 0));
                break;
            case 'add_campaign':
                add_campaign($db, $_POST);
                break;
            case 'update_campaign':
                update_campaign($db, $_POST);
                break;
            case 'delete_campaign':
                delete_campaign($db, $id);
                break;
            case 'toggle_campaign_status':
                toggle_campaign_status($db, $id);
                break;
            case 'get_event_media':
                header('Content-Type: application/json');
                get_event_media_json($db, (int)($_GET['event_id'] ?? 0));
                exit; // JSON response, redirect yok
            case 'get_campaign_status':
                header('Content-Type: application/json');
                ensure_email_tables($db);
                $campaign_id = (int)($_GET['campaign_id'] ?? 0);
                if ($campaign_id > 0) {
                    $stmt = $db->prepare("SELECT * FROM email_campaigns WHERE id = ? AND club_id = ?");
                    $stmt->bindValue(1, $campaign_id, SQLITE3_INTEGER);
                    $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                    $result = $stmt->execute();
                    $campaign = $result->fetchArray(SQLITE3_ASSOC);
                    
                    if ($campaign) {
                        $progress = $campaign['total_recipients'] > 0 
                            ? round(($campaign['sent_count'] / $campaign['total_recipients']) * 100, 1) 
                            : 0;
                        
                        echo json_encode([
                            'success' => true,
                            'campaign' => [
                                'id' => $campaign['id'],
                                'status' => $campaign['status'],
                                'total' => $campaign['total_recipients'],
                                'sent' => $campaign['sent_count'],
                                'failed' => $campaign['failed_count'],
                                'progress' => $progress,
                                'subject' => $campaign['subject']
                            ]
                        ]);
                    } else {
                        echo json_encode(['success' => false, 'message' => 'Kampanya bulunamadı']);
                    }
                } else {
                    echo json_encode(['success' => false, 'message' => 'Geçersiz kampanya ID']);
                }
                exit;
            case 'process_email_queue':
                // Web tabanlı worker endpoint - AJAX ile sürekli çağrılabilir
                header('Content-Type: application/json');
                ob_clean();
                
                $db_path = DB_PATH;
                $club_id = CLUB_ID;
                
                if (!file_exists($db_path)) {
                    echo json_encode(['success' => false, 'message' => 'Database bulunamadı']);
                    exit;
                }
                
                // Worker'ı direkt burada çalıştır (include yerine)
                try {
                    $db = get_db();
                    
                    // Email tablolarını oluştur
                    ensure_email_tables($db);
                    $smtp_settings = [];
                    $stmt = $db->prepare("SELECT setting_key, setting_value FROM settings WHERE club_id = ? AND setting_key LIKE 'smtp_%'");
                    $stmt->bindValue(1, $club_id, SQLITE3_INTEGER);
                    $result = $stmt->execute();
                    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
                        $smtp_settings[$row['setting_key']] = $row['setting_value'];
                    }
                    
                    // Güvenlik: Hardcoded credentials kaldırıldı
                    if (empty($smtp_settings['smtp_username']) || empty($smtp_settings['smtp_password'])) {
                        tpl_error_log('SMTP credentials not configured. Email sending disabled. Please configure SMTP settings in admin panel.');
                        // SMTP ayarları boşsa email gönderilemez
                        $smtp_settings = [];
                    }
                    
                    // Kuyruktan 20 mail al ve gönder
                    $stmt = $db->prepare("SELECT campaign_id, subject, message, from_name, from_email FROM email_queue WHERE club_id = ? AND status = 'pending' ORDER BY created_at ASC LIMIT 1");
                    $stmt->bindValue(1, $club_id, SQLITE3_INTEGER);
                    $result = $stmt->execute();
                    $first_email = $result->fetchArray(SQLITE3_ASSOC);
                    
                    if (!$first_email) {
                        echo json_encode(['success' => true, 'processed' => 0, 'message' => 'Kuyrukta mail yok']);
                        exit;
                    }
                    
                    $campaign_id = $first_email['campaign_id'];
                    $subject = $first_email['subject'];
                    $message = $first_email['message'];
                    $from_name = $first_email['from_name'];
                    $from_email = $first_email['from_email'];
                    
                    // 20 mail al
                    $stmt = $db->prepare("SELECT id, recipient_email, subject, message, recipient_name FROM email_queue WHERE club_id = ? AND campaign_id = ? AND status = 'pending' ORDER BY created_at ASC LIMIT 20");
                    $stmt->bindValue(1, $club_id, SQLITE3_INTEGER);
                    $stmt->bindValue(2, $campaign_id, SQLITE3_INTEGER);
                    $result = $stmt->execute();
                    
                    $batch_emails = [];
                    $email_ids = [];
                    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
                        $batch_emails[] = [
                            'id' => $row['id'],
                            'email' => $row['recipient_email'],
                            'subject' => $row['subject'],
                            'message' => $row['message'],
                            'recipient_name' => $row['recipient_name']
                        ];
                        $email_ids[] = $row['id'];
                    }
                    
                    if (empty($batch_emails)) {
                        echo json_encode(['success' => true, 'processed' => 0, 'message' => 'Kuyrukta mail yok']);
                        exit;
                    }
                    
                    // Status'u 'sending' yap
                    $placeholders = implode(',', array_fill(0, count($email_ids), '?'));
                    $stmt = $db->prepare("UPDATE email_queue SET status = 'sending', attempts = attempts + 1 WHERE id IN ($placeholders)");
                    for ($i = 0; $i < count($email_ids); $i++) {
                        $stmt->bindValue($i + 1, $email_ids[$i], SQLITE3_INTEGER);
                    }
                    $stmt->execute();
                    
                    // BATCH GÖNDERİM
                    $result = send_smtp_mail_batch(
                        $batch_emails,
                        $subject,
                        $message,
                        $from_name,
                        $from_email,
                        [
                            'host' => $smtp_settings['smtp_host'] ?? 'smtp.example.com',
                            'port' => (int)($smtp_settings['smtp_port'] ?? 587),
                            'secure' => strtolower($smtp_settings['smtp_secure'] ?? 'tls'),
                            'username' => $smtp_settings['smtp_username'],
                            'password' => $smtp_settings['smtp_password'],
                        ]
                    );
                    
                    $success_ids = $result['success_ids'] ?? [];
                    $failed_ids = $result['failed_ids'] ?? [];
                    $sent_count = count($success_ids);
                    $failed_count = count($failed_ids);
                    
                    // Başarılı mailleri işaretle
                    if ($sent_count > 0) {
                        $placeholders = implode(',', array_fill(0, count($success_ids), '?'));
                        $stmt = $db->prepare("UPDATE email_queue SET status = 'sent', sent_at = datetime('now') WHERE id IN ($placeholders)");
                        for ($i = 0; $i < count($success_ids); $i++) {
                            $stmt->bindValue($i + 1, $success_ids[$i], SQLITE3_INTEGER);
                        }
                        $stmt->execute();
                        
                        // Kampanya sayacını güncelle
                        $stmt = $db->prepare("UPDATE email_campaigns SET sent_count = sent_count + ? WHERE id = ?");
                        $stmt->bindValue(1, $sent_count, SQLITE3_INTEGER);
                        $stmt->bindValue(2, $campaign_id, SQLITE3_INTEGER);
                        $stmt->execute();
                    }
                    
                    // Başarısız mailleri pending'e geri al
                    if ($failed_count > 0) {
                        $placeholders = implode(',', array_fill(0, count($failed_ids), '?'));
                        $stmt = $db->prepare("UPDATE email_queue SET status = 'pending' WHERE id IN ($placeholders)");
                        for ($i = 0; $i < count($failed_ids); $i++) {
                            $stmt->bindValue($i + 1, $failed_ids[$i], SQLITE3_INTEGER);
                        }
                        $stmt->execute();
                    }
                    
                    echo json_encode([
                        'success' => true,
                        'processed' => $sent_count,
                        'message' => "$sent_count e-posta gönderildi"
                    ]);
                    
                } catch (Exception $e) {
                    echo json_encode(['success' => false, 'message' => 'Worker hatası: ' . $e->getMessage()]);
                    tpl_error_log('Worker error: ' . $e->getMessage());
                }
                exit;
        }

        // JSON response olmayanlar için redirect
        if (!isset($_POST['action']) || !in_array($_POST['action'], ['create_survey', 'upload_event_media', 'delete_event_image', 'delete_event_video', 'add_campaign', 'update_campaign', 'delete_campaign', 'toggle_campaign_status', 'add_product', 'update_product', 'delete_product'])) {
            // Güvenlik: View name validation
            $allowed_views = ['events', 'event_detail', 'members', 'dashboard', 'settings', 'notifications', 'finance', 'campaigns', 'market'];
            $view = tpl_whitelist_value($_POST['current_view'] ?? 'dashboard', $allowed_views, 'dashboard');
            header("Location: index.php?view=" . $view);
            exit;
        }
    }

// GET request için medya çekme
if ($TPL_GET_ACTION === 'get_event_media' && isset($_SESSION['admin_id'])) {
    $db = get_db();
    header('Content-Type: application/json');
    get_event_media_json($db, (int)($_GET['event_id'] ?? 0));
    exit;
}

// Finans AJAX Endpoint'leri
if ($TPL_GET_ACTION !== '' && isset($_SESSION['admin_id'])) {
    $db = get_db();
    header('Content-Type: application/json');
    
    switch ($TPL_GET_ACTION) {
        case 'get_transaction':
            $id = (int)($_GET['id'] ?? 0);
            $stmt = $db->prepare("SELECT * FROM financial_transactions WHERE id = ? AND club_id = ?");
            $stmt->bindValue(1, $id, SQLITE3_INTEGER);
            $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $transaction = $result->fetchArray(SQLITE3_ASSOC);
            if ($transaction) {
                echo json_encode(['success' => true, 'transaction' => $transaction]);
            } else {
                echo json_encode(['success' => false, 'message' => 'İşlem bulunamadı']);
            }
            exit;
            
        case 'get_budget':
            $id = (int)($_GET['id'] ?? 0);
            $stmt = $db->prepare("SELECT * FROM budget_plans WHERE id = ? AND club_id = ?");
            $stmt->bindValue(1, $id, SQLITE3_INTEGER);
            $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $budget = $result->fetchArray(SQLITE3_ASSOC);
            if ($budget) {
                echo json_encode(['success' => true, 'budget' => $budget]);
            } else {
                echo json_encode(['success' => false, 'message' => 'Bütçe bulunamadı']);
            }
            exit;
            
        case 'get_payment':
            $id = (int)($_GET['id'] ?? 0);
            $stmt = $db->prepare("SELECT * FROM payments WHERE id = ? AND club_id = ?");
            $stmt->bindValue(1, $id, SQLITE3_INTEGER);
            $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $payment = $result->fetchArray(SQLITE3_ASSOC);
            if ($payment) {
                echo json_encode(['success' => true, 'payment' => $payment]);
            } else {
                echo json_encode(['success' => false, 'message' => 'Ödeme bulunamadı']);
            }
            exit;
            
        case 'get_category':
            $id = (int)($_GET['id'] ?? 0);
            $stmt = $db->prepare("SELECT * FROM financial_categories WHERE id = ? AND club_id = ?");
            $stmt->bindValue(1, $id, SQLITE3_INTEGER);
            $stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
            $result = $stmt->execute();
            $category = $result->fetchArray(SQLITE3_ASSOC);
            if ($category) {
                echo json_encode(['success' => true, 'category' => $category]);
            } else {
                echo json_encode(['success' => false, 'message' => 'Kategori bulunamadı']);
            }
            exit;
            
        case 'send_payment_confirmation_emails':
            // POST handler'da zaten var, buraya da ekleyelim
            if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                $result = send_payment_confirmation_emails($db, $_POST);
                echo json_encode($result);
                exit;
            }
            break;
    }
}

// --- ANA UYGULAMA MANTIĞI VE YÖNLENDİRME ---
// Market işlemleri için özel kontrol - template_market.php'de işlenecek
$market_actions = ['add_product', 'update_product', 'delete_product'];
$is_market_action = isset($_POST['action']) && in_array($_POST['action'], $market_actions);

// Market POST işlemlerini HTML çıktısından ÖNCE işle
if ($is_market_action) {
    // Sadece POST işlemlerini yap, HTML çıktısını gösterme
    $market_post_handled = false;
    $market_file = __DIR__ . '/template_market.php';
    if (file_exists($market_file)) {
        // Sadece POST işlemlerini çalıştırmak için buffer başlat
        ob_start();
        // POST işlemlerini yap (header gönderecek ve exit edecek)
        include $market_file;
        // Eğer buraya geldiysek, POST işlemi yapılmadı demektir
        ob_end_clean();
        $market_post_handled = true;
    }
    // POST işlemi yapıldıysa (header gönderildiyse), buraya gelmeyecek
    // Ama yine de güvenlik için kontrol edelim
    if (!$market_post_handled) {
        // POST işlemi yapılmadıysa, normal akışa devam et
    }
}

if (!$is_market_action) {
    handle_post_request();
}

$current_view = tpl_filter_slug($_GET['view'] ?? '', 'dashboard', ['lowercase' => true]);
if ($current_view === '') {
    $current_view = 'dashboard';
}

// Guard kontrolü - view render edilmeden önce kontrol et
if (!function_exists('require_subscription_feature')) {
    require_once __DIR__ . '/../lib/general/subscription_guard.php';
}

// Mesaj Merkezi, Raporlar ve Finans için erişim durumları (preview modları için)
$messages_feature_available = true;
$reports_feature_available = true;
$finance_feature_available = true;

if (in_array($current_view, ['messages', 'reports', 'finance'], true)) {
    if (!function_exists('has_subscription_feature')) {
        require_once __DIR__ . '/../lib/general/subscription_helper.php';
    }
}

if ($current_view === 'messages') {
    $messages_feature_available = has_subscription_feature('sms');
    if (!$messages_feature_available) {
        // Preview modunda göstereceğiz, guard'a düşürme
        error_log("SMS feature locked - preview mode enabled");
    }
}

if ($current_view === 'reports') {
    $reports_feature_available = has_subscription_feature('reports');
    if (!$reports_feature_available) {
        // Professional/Business dışında ön izleme
        error_log("Reports feature locked - preview mode enabled");
    }
}

if ($current_view === 'finance') {
    $finance_feature_available = has_subscription_feature('financial');
    if (!$finance_feature_available) {
        // Business dışı planlarda ön izleme
        error_log("Finance feature locked - preview mode enabled");
    }
}

// Guard kontrolünden sonra view değişmiş olabilir, tekrar kontrol et
global $subscription_required_data;
if (isset($subscription_required_data) || (isset($_GET['view']) && $_GET['view'] === 'subscription_required')) {
    if (!($current_view === 'messages' && !$messages_feature_available)) {
        $current_view = 'subscription_required';
        // Debug: Guard başarısız, view subscription_required olarak ayarlandı
        error_log("Guard failed - current_view set to subscription_required");
    }
} else {
    // Debug: Guard başarılı veya guard kontrolü yapılmadı
    error_log("Guard check - current_view: " . $current_view);
}

// LAZY LOADING: View'a göre gerekli modülleri yükle
load_modules_for_context($current_view, null);

maybe_run_auto_backup();

$event_detail = null;
if ($current_view === 'event_detail' && isset($_GET['event_id'])) {
    // Events modülünü yükle
    load_module('events');
    
    try {
        $event_detail = get_event_by_id((int)$_GET['event_id']);
        
        // Eğer event_detail null ise, hata mesajı göster
        if (!$event_detail) {
            $_SESSION['error'] = 'Etkinlik bulunamadı veya erişim yetkiniz yok.';
            header("Location: index.php?view=events");
            exit;
        }
    } catch (Exception $e) {
        tpl_error_log("Etkinlik detay hatası: " . $e->getMessage());
        $_SESSION['error'] = 'Etkinlik detayları yüklenirken bir hata oluştu.';
        header("Location: index.php?view=events");
        exit;
    }
    
    // AJAX isteği ise JSON döndür
    if (isset($_GET['ajax']) && ($_GET['ajax'] === '1')) {
        header('Content-Type: application/json');
        echo json_encode($event_detail ?: []);
        exit;
    }
}

// Session mesajlarını al ve temizle (GET isteklerinde de çalışsın)
$message = $_SESSION['message'] ?? '';
$error = $_SESSION['error'] ?? '';

// Error mesajını gösterdikten sonra temizle (sadece bir kez göster)
if (!empty($error)) {
    unset($_SESSION['error']);
}
if (!empty($message)) {
    unset($_SESSION['message']);
}

// Sayfa yüklendiğinde tüm tabloları ve kolonları kontrol et
$db_init = get_db();
if (function_exists('setup_database')) {
    setup_database($db_init);
}
// Events modülünü yükle (ensure_events_table_columns için)
load_module('events');
ensure_events_table_columns($db_init);
ensure_event_rsvp_table($db_init);
ensure_email_tables($db_init);
ensure_rate_limits_table($db_init);
ensure_membership_requests_table($db_init);
ensure_products_table($db_init);

$stats = get_stats();
// Events modülünü yükle (get_events için)
load_module('events');
// Etkinlikleri lazy loading için ilk 30'unu göster
$db = get_db();
$events_stmt = $db->prepare("SELECT * FROM events WHERE club_id = ? ORDER BY date DESC, id DESC LIMIT 30");
$events_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
$events_result = $events_stmt->execute();
$events = [];
while ($row = $events_result->fetchArray(SQLITE3_ASSOC)) {
    $events[] = $row;
}
// Toplam sayıyı kontrol et
$total_events_stmt = $db->prepare("SELECT COUNT(*) FROM events WHERE club_id = ?");
$total_events_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
$total_events_count = $total_events_stmt->execute()->fetchArray()[0] ?? 0;
$has_more_events = $total_events_count > count($events);

// Members modülünü yükle (get_members, get_board_members, vb. için)
load_module('members');
// Üyeleri lazy loading için ilk 30'unu göster
$members_stmt = $db->prepare("SELECT * FROM members WHERE club_id = ? ORDER BY registration_date DESC, id DESC LIMIT 30");
$members_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
$members_result = $members_stmt->execute();
$members = [];
while ($row = $members_result->fetchArray(SQLITE3_ASSOC)) {
    $members[] = $row;
}
// Toplam sayıyı kontrol et
$total_members_stmt = $db->prepare("SELECT COUNT(*) FROM members WHERE club_id = ?");
$total_members_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
$total_members_count = $total_members_stmt->execute()->fetchArray()[0] ?? 0;
$has_more_members = $total_members_count > count($members);
// Tüm yönetim kurulu üyelerini göster
$board = get_board_members();
$has_more_board = false;
$pending_membership_requests = get_membership_requests('pending');
$club_name = get_club_name();

// SMS ve Email contacts sadece ilgili view'larda yükle (guard kontrolünden sonra)
// Guard kontrolü başarısız olduysa bu değişkenler tanımlanmamalı
if ($current_view === 'messages') {
    $all_sms_contacts = get_sms_member_contacts();
    if (!is_array($all_sms_contacts)) {
        $all_sms_contacts = [];
    }
    $sms_contacts = $all_sms_contacts; // Tüm listeyi göster
    // Debug log
    error_log("SMS Contacts loaded: " . count($sms_contacts) . " contacts for club_id: " . CLUB_ID);
    if (count($sms_contacts) > 0) {
        error_log("First SMS contact: " . json_encode($sms_contacts[0]));
    }
} else {
    $sms_contacts = [];
    $all_sms_contacts = [];
}

if ($current_view === 'mail') {
    $all_email_contacts = get_email_member_contacts();
    if (!is_array($all_email_contacts)) {
        $all_email_contacts = [];
    }
    $email_contacts = $all_email_contacts; // Tüm listeyi göster
} else {
    $email_contacts = [];
    $all_email_contacts = [];
}

$notifications = get_notifications();
$unread_notification_count = get_unread_notification_count();
$db = get_db();
// Campaigns modülünü yükle (get_campaigns için)
load_module('campaigns');
// Tüm kampanyaları göster
$campaigns = get_campaigns($db);
$has_more_campaigns = false;
$all_communities = get_all_communities();

// İşbirliği logolarını çek
function get_partner_logos() {
    $db = get_db();
    $stmt = $db->prepare("SELECT * FROM partner_logos WHERE club_id = ? ORDER BY created_at DESC");
    $stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
    $result = $stmt->execute();
    
    $logos = [];
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $logos[] = $row;
    }
    return $logos;
}

$partner_logos = get_partner_logos();

// GET istekleri için export ve diğer işlemler
if ($_SERVER['REQUEST_METHOD'] === 'GET' && $TPL_GET_ACTION !== '' && isset($_SESSION['admin_id'])) {
    $action = $TPL_GET_ACTION;
    
    switch ($action) {
        case 'check_urgent_notifications':
            check_urgent_notifications();
            break;
        case 'export_members_csv':
            export_members_csv();
            break;
        case 'export_members_excel':
            export_members_excel();
            break;
        case 'export_events_csv':
            export_events_csv();
            break;
        case 'export_events_excel':
            export_events_excel();
            break;
        case 'generate_pdf_report':
            generate_pdf_report();
            break;
        case 'download_sample_members_csv':
            download_sample_members_csv();
            break;
        case 'download_sample_events_csv':
            download_sample_events_csv();
            break;
    }
}

?>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniFour | Kulüp Yönetim Paneli</title>
        
        <!-- DARK MODE - CİHAZ TEMASINI TAMAMEN GÖRMEZDEN GEL -->
        <script<?= tpl_script_nonce_attr(); ?>>
            // SADECE kullanıcı seçimini kullan, cihaz teması asla etkilemesin
            (function() {
                // Varsayılan LIGHT mode (cihaz dark mode olsa bile)
                let savedTheme = 'light';
                try {
                    savedTheme = localStorage.getItem('theme') || 'light';
                } catch (e) {
                    // localStorage erişimi engellendi, varsayılan değeri kullan
                    savedTheme = 'light';
                }
                
                // Tema uygula (cihaz temasından tamamen bağımsız)
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    document.documentElement.classList.remove('dark');
                }
                
                // Toggle butonunu güncelle
                setTimeout(function() {
                    const toggle = document.getElementById('theme-toggle');
                    if (toggle) {
                        if (savedTheme === 'dark') {
                            toggle.classList.add('active');
                        } else {
                            toggle.classList.remove('active');
                        }
                    }
                }, 100);
            })();
        </script>
        
        <!-- Global Helper Functions ve Error Handler - Tüm script'lerden önce tanımla -->
        <script<?= tpl_script_nonce_attr(); ?>>
            // Global Error Handler - EN ÖNCE YÜKLE (Promise rejections için)
            // Bu handler TÜM promise rejections'ı yakalar
            if (!window._storageErrorHandlerInstalled) {
                window._storageErrorHandlerInstalled = true;
                
                // console.error'u override et - Storage hatalarını filtrele
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    const message = args.join(' ').toLowerCase();
                    if (message.includes('access to storage') || 
                        message.includes('storage is not allowed') ||
                        message.includes('localstorage') ||
                        message.includes('sessionstorage')) {
                        // Storage hatası, sessizce geç
                        return;
                    }
                    // Diğer hatalar için normal console.error kullan
                    originalConsoleError.apply(console, args);
                };
                
                // Unhandled Promise Rejections - Storage hatalarını yakala
                window.addEventListener('unhandledrejection', function(event) {
                    const errorMessage = event.reason?.message || event.reason?.toString() || String(event.reason) || '';
                    const errorString = String(errorMessage).toLowerCase();
                    const stack = event.reason?.stack || '';
                    const stackString = String(stack).toLowerCase();
                    
                    // localStorage/sessionStorage hatalarını sessizce yakala
                    if (errorString.includes('access to storage') || 
                        errorString.includes('storage is not allowed') ||
                        errorString.includes('localstorage') ||
                        errorString.includes('sessionstorage') ||
                        errorString.includes('quotaexceedederror') ||
                        stackString.includes('localstorage') ||
                        stackString.includes('sessionstorage')) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return false;
                    }
                    
                    // 500 Internal Server Error'ları da yakala (check_urgent_notifications gibi)
                    if (errorString.includes('500') || 
                        errorString.includes('internal server error') ||
                        errorString.includes('check_urgent_notifications') ||
                        stackString.includes('check_urgent_notifications')) {
                        // Sessizce geç, console'a yazma
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return false;
                    }
                    
                    // Diğer hatalar için console'da göster
                    originalConsoleError('Unhandled Promise Rejection:', event.reason);
                    event.preventDefault();
                }, true); // Capture phase'de yakala
                
                // Genel Hatalar
                window.addEventListener('error', function(event) {
                    const errorMessage = event.message || event.error?.message || '';
                    const errorString = String(errorMessage).toLowerCase();
                    const stack = event.error?.stack || '';
                    const stackString = String(stack).toLowerCase();
                    
                    if (errorString.includes('access to storage') || 
                        errorString.includes('storage is not allowed') ||
                        errorString.includes('localstorage') ||
                        errorString.includes('sessionstorage') ||
                        stackString.includes('localstorage') ||
                        stackString.includes('sessionstorage')) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        return false;
                    }
                }, true); // Capture phase'de yakala
            }
            
            // escapeHtml ve escapeJs - Global scope'da tanımla
            if (typeof window.escapeHtml === 'undefined') {
                window.escapeHtml = function(text) {
                    if (text == null || text === undefined) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                };
            }
            
            if (typeof window.escapeJs === 'undefined') {
                window.escapeJs = function(text) {
                    if (text == null || text === undefined) return '';
                    return String(text)
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"')
                        .replace(/\n/g, '\\n')
                        .replace(/\r/g, '\\r');
                };
            }
            
            // localStorage ve sessionStorage'ı Proxy ile tamamen sarmala - EN GÜVENLİ YAKLAŞIM
            (function() {
                try {
                    // Orijinal localStorage ve sessionStorage'ı sakla
                    const _originalLocalStorage = window.localStorage;
                    const _originalSessionStorage = window.sessionStorage;
                    
                    // localStorage için Proxy oluştur
                    const localStorageProxy = new Proxy(_originalLocalStorage, {
                        get: function(target, prop) {
                            if (prop === 'getItem') {
                                return function(key) {
                                    try {
                                        return target.getItem(key);
                                    } catch (e) {
                                        return null;
                                    }
                                };
                            }
                            if (prop === 'setItem') {
                                return function(key, value) {
                                    try {
                                        target.setItem(key, value);
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'removeItem') {
                                return function(key) {
                                    try {
                                        target.removeItem(key);
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'clear') {
                                return function() {
                                    try {
                                        target.clear();
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'key') {
                                return function(index) {
                                    try {
                                        return target.key(index);
                                    } catch (e) {
                                        return null;
                                    }
                                };
                            }
                            if (prop === 'length') {
                                try {
                                    return target.length;
                                } catch (e) {
                                    return 0;
                                }
                            }
                            return target[prop];
                        }
                    });
                    
                    // sessionStorage için Proxy oluştur
                    const sessionStorageProxy = new Proxy(_originalSessionStorage, {
                        get: function(target, prop) {
                            if (prop === 'getItem') {
                                return function(key) {
                                    try {
                                        return target.getItem(key);
                                    } catch (e) {
                                        return null;
                                    }
                                };
                            }
                            if (prop === 'setItem') {
                                return function(key, value) {
                                    try {
                                        target.setItem(key, value);
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'removeItem') {
                                return function(key) {
                                    try {
                                        target.removeItem(key);
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'clear') {
                                return function() {
                                    try {
                                        target.clear();
                                    } catch (e) {
                                        // Sessizce geç
                                    }
                                };
                            }
                            if (prop === 'key') {
                                return function(index) {
                                    try {
                                        return target.key(index);
                                    } catch (e) {
                                        return null;
                                    }
                                };
                            }
                            if (prop === 'length') {
                                try {
                                    return target.length;
                                } catch (e) {
                                    return 0;
                                }
                            }
                            return target[prop];
                        }
                    });
                    
                    // window.localStorage ve window.sessionStorage'ı proxy ile değiştir
                    try {
                        Object.defineProperty(window, 'localStorage', {
                            value: localStorageProxy,
                            writable: false,
                            configurable: false
                        });
                    } catch (e) {
                        // Override edilemedi, devam et
                    }
                    
                    try {
                        Object.defineProperty(window, 'sessionStorage', {
                            value: sessionStorageProxy,
                            writable: false,
                            configurable: false
                        });
                    } catch (e) {
                        // Override edilemedi, devam et
                    }
                } catch (e) {
                    // Proxy oluşturulamadı, devam et
                }
            })();
        </script>
        
        <!-- CİHAZ DARK MODE'UNU TAMAMEN DEVRE DIŞI BIRAK -->
        <style>
            /* CİHAZ TEMASINI GÖRMEZDEN GEL - Her zaman light mode base */
            @media (prefers-color-scheme: dark) {
                html, body {
                    background-color: #ffffff !important;
                    color: #000000 !important;
                }
            }
            
            /* SADECE data-theme="dark" attribute'una göre dark mode uygula */
            html[data-theme="dark"], html[data-theme="dark"] body {
                background-color: #0f172a !important;
                color: #f1f5f9 !important;
            }
        </style>
        
        <style>
            /* Dark mode flash önleme - Hemen uygulanacak */
            html[data-theme="dark"] {
                background-color: #0f172a !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] body {
                background-color: #0f172a !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tüm elementler */
            html[data-theme="dark"] * {
                transition: none !important;
            }
            
            /* Dark mode - Tüm sayfalar için genel stiller */
            html[data-theme="dark"] {
                background-color: #0f172a !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] body {
                background-color: #0f172a !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode - Tüm container'lar */
            html[data-theme="dark"] .bg-white {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .bg-gray-50 {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .bg-gray-100 {
                background-color: #334155 !important;
            }
            
            /* Dark mode - Tüm kartlar */
            html[data-theme="dark"] .bg-white {
                background-color: #1e293b !important;
                border-color: #334155 !important;
            }
            
            /* Dark mode - Tüm tablolar */
            html[data-theme="dark"] table {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] th {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] td {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] tr:hover {
                background-color: #334155 !important;
            }
            
            /* Dark mode - Tüm input'lar */
            html[data-theme="dark"] input {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] input:focus {
                background-color: #475569 !important;
                border-color: #6366f1 !important;
            }
            
            html[data-theme="dark"] select {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] textarea {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            /* Dark mode - Tüm butonlar */
            html[data-theme="dark"] .btn-primary {
                background-color: #6366f1 !important;
                color: #ffffff !important;
            }
            
            html[data-theme="dark"] .btn-secondary {
                background-color: #6b7280 !important;
                color: #ffffff !important;
            }
            
            /* Dark mode - Tüm modal'lar */
            html[data-theme="dark"] .modal {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .modal-header {
                background-color: #334155 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] .modal-body {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode - Tüm form elementleri */
            html[data-theme="dark"] .form-control {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] .form-control:focus {
                background-color: #475569 !important;
                border-color: #6366f1 !important;
            }
            
            /* Dark mode - Tüm badge'ler */
            html[data-theme="dark"] .badge {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode - Tüm alert'ler */
            html[data-theme="dark"] .alert {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            /* Dark mode - Tüm dropdown'lar */
            html[data-theme="dark"] .dropdown-menu {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] .dropdown-item {
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .dropdown-item:hover {
                background-color: #334155 !important;
            }
            
            /* Dark mode flash önleme - Sidebar */
            html[data-theme="dark"] .bg-sidebar {
                background-color: #1e293b !important;
            }
            
            /* Dark mode flash önleme - Main content */
            html[data-theme="dark"] .bg-white {
                background-color: #1e293b !important;
            }
            
            /* Dark mode flash önleme - Cards */
            html[data-theme="dark"] .bg-gray-50 {
                background-color: #1e293b !important;
            }
            
            /* Dark mode flash önleme - Text */
            html[data-theme="dark"] .text-gray-900 {
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .text-gray-700 {
                color: #cbd5e1 !important;
            }
            
            html[data-theme="dark"] .text-gray-600 {
                color: #94a3b8 !important;
            }
            
            html[data-theme="dark"] .text-gray-500 dark:text-gray-400 {
                color: #64748b !important;
            }
            
            /* Dark mode flash önleme - Borders */
            html[data-theme="dark"] .border-gray-200 {
                border-color: #334155 !important;
            }
            
            html[data-theme="dark"] .border-gray-300 {
                border-color: #475569 !important;
            }
            
            /* Dark mode flash önleme - Buttons */
            html[data-theme="dark"] .bg-blue-500 {
                background-color: #4338ca !important;
            }
            
            html[data-theme="dark"] .bg-green-500 {
                background-color: #166534 !important;
            }
            
            html[data-theme="dark"] .bg-red-500 {
                background-color: #dc2626 !important;
            }
            
            /* Dark mode flash önleme - Input fields */
            html[data-theme="dark"] .bg-gray-100 {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tables */
            html[data-theme="dark"] .bg-white {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .bg-gray-50 {
                background-color: #1e293b !important;
            }
            
            /* Dark mode flash önleme - Modals */
            html[data-theme="dark"] .bg-white {
                background-color: #1e293b !important;
            }
            
            /* Dark mode flash önleme - Headers */
            html[data-theme="dark"] .bg-gray-100 {
                background-color: #334155 !important;
            }
            
            /* Dark mode flash önleme - Sidebar links */
            html[data-theme="dark"] .text-sidebar {
                color: #cbd5e1 !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gray-100:hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] .hover\\:text-blue-600:hover {
                color: #818cf8 !important;
            }
            
            /* Dark mode flash önleme - Active links */
            html[data-theme="dark"] .active-link {
                background-color: #312e81 !important;
                color: #818cf8 !important;
            }
            
            /* Dark mode flash önleme - Logout button */
            html[data-theme="dark"] .bg-red-50 {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .text-red-500 {
                color: #f87171 !important;
            }
            
            html[data-theme="dark"] .border-red-200 {
                border-color: #dc2626 !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-red-100:hover {
                background-color: #334155 !important;
            }
            
            /* Dark mode flash önleme - Tüm hover efektleri */
            html[data-theme="dark"] .hover\\:bg-white:hover {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gray-50:hover {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gray-100:hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gray-200:hover {
                background-color: #475569 !important;
            }
            
            /* Dark mode flash önleme - Tüm text hover efektleri */
            html[data-theme="dark"] .hover\\:text-gray-900:hover {
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .hover\\:text-gray-700:hover {
                color: #cbd5e1 !important;
            }
            
            html[data-theme="dark"] .hover\\:text-gray-600:hover {
                color: #94a3b8 !important;
            }
            
            html[data-theme="dark"] .hover\\:text-gray-500 dark:text-gray-400:hover {
                color: #64748b !important;
            }
            
            /* Dark mode flash önleme - Tüm border hover efektleri */
            html[data-theme="dark"] .hover\\:border-gray-200:hover {
                border-color: #334155 !important;
            }
            
            html[data-theme="dark"] .hover\\:border-gray-300:hover {
                border-color: #475569 !important;
            }
            
            html[data-theme="dark"] .hover\\:border-gray-400:hover {
                border-color: #64748b !important;
            }
            
            /* Dark mode flash önleme - Tüm shadow hover efektleri */
            html[data-theme="dark"] .hover\\:shadow-lg:hover {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
            }
            
            html[data-theme="dark"] .hover\\:shadow-xl:hover {
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
            }
            
            /* Dark mode flash önleme - Tüm transform hover efektleri */
            html[data-theme="dark"] .hover\\:scale-105:hover {
                transform: scale(1.05) !important;
            }
            
            html[data-theme="dark"] .hover\\:scale-110:hover {
                transform: scale(1.1) !important;
            }
            
            html[data-theme="dark"] .hover\\:rotate-3:hover {
                transform: rotate(3deg) !important;
            }
            
            html[data-theme="dark"] .hover\\:-rotate-3:hover {
                transform: rotate(-3deg) !important;
            }
            
            /* Dark mode flash önleme - Tüm opacity hover efektleri */
            html[data-theme="dark"] .hover\\:opacity-80:hover {
                opacity: 0.8 !important;
            }
            
            html[data-theme="dark"] .hover\\:opacity-90:hover {
                opacity: 0.9 !important;
            }
            
            /* Dark mode flash önleme - Tüm filter hover efektleri */
            html[data-theme="dark"] .hover\\:brightness-110:hover {
                filter: brightness(1.1) !important;
            }
            
            html[data-theme="dark"] .hover\\:brightness-125:hover {
                filter: brightness(1.25) !important;
            }
            
            html[data-theme="dark"] .hover\\:contrast-110:hover {
                filter: contrast(1.1) !important;
            }
            
            html[data-theme="dark"] .hover\\:saturate-110:hover {
                filter: saturate(1.1) !important;
            }
            
            /* Dark mode flash önleme - Tüm gradient hover efektleri */
            html[data-theme="dark"] .hover\\:bg-gradient-to-r:hover {
                background: linear-gradient(to right, #1e293b, #334155) !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gradient-to-b:hover {
                background: linear-gradient(to bottom, #1e293b, #334155) !important;
            }
            
            html[data-theme="dark"] .hover\\:bg-gradient-to-br:hover {
                background: linear-gradient(to bottom right, #1e293b, #334155) !important;
            }
            
            /* Dark mode flash önleme - Tüm ring hover efektleri */
            html[data-theme="dark"] .hover\\:ring-2:hover {
                box-shadow: 0 0 0 2px #1e293b !important;
            }
            
            html[data-theme="dark"] .hover\\:ring-blue-500:hover {
                box-shadow: 0 0 0 2px #6366f1 !important;
            }
            
            html[data-theme="dark"] .hover\\:ring-green-500:hover {
                box-shadow: 0 0 0 2px #166534 !important;
            }
            
            html[data-theme="dark"] .hover\\:ring-red-500:hover {
                box-shadow: 0 0 0 2px #dc2626 !important;
            }
            
            html[data-theme="dark"] .hover\\:ring-purple-500:hover {
                box-shadow: 0 0 0 2px #7c3aed !important;
            }
            
            /* Dark mode flash önleme - Etkinlik Açıklama Bölümü */
            html[data-theme="dark"] .bg-gradient-to-r {
                background: linear-gradient(to right, #1e293b, #334155) !important;
            }
            
            html[data-theme="dark"] .from-gray-50 {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .to-gray-100 {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] .bg-gradient-to-r.from-gray-50.to-gray-100 {
                background: linear-gradient(to right, #1e293b, #334155) !important;
            }
            
            /* Dark mode flash önleme - Etkinlik Açıklama Text */
            html[data-theme="dark"] .text-gray-700 {
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] .text-gray-800 dark:text-gray-200 {
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Etkinlik Açıklama Border */
            html[data-theme="dark"] .border-indigo-500 {
                border-color: #6366f1 !important;
            }
            
            /* Dark mode flash önleme - Etkinlik Detay Header */
            html[data-theme="dark"] .bg-white {
                background-color: #1f2937 !important;
            }
            
            html[data-theme="dark"] .text-gray-600 {
                color: #d1d5db !important;
            }
            
            html[data-theme="dark"] .bg-gray-50 {
                background-color: #374151 !important;
            }
            
            html[data-theme="dark"] .text-yellow-500 {
                color: #fbbf24 !important;
            }
            
            html[data-theme="dark"] .text-green-500 {
                color: #34d399 !important;
            }
            
            html[data-theme="dark"] .text-red-500 {
                color: #f87171 !important;
            }
            
            /* Dark mode flash önleme - Theme Toggle Button */
            html[data-theme="dark"] .theme-toggle {
                background: #3b82f6 !important;
                transition: none !important;
            }
            
            html[data-theme="dark"] .theme-toggle::before {
                transform: translateX(26px) !important;
                transition: none !important;
            }
            
            /* Profesyonel Animasyonlar */
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes fadeInLeft {
                from {
                    opacity: 0;
                    transform: translateX(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(30px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes slideInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            @keyframes bounceIn {
                0% {
                    opacity: 0;
                    transform: scale(0.3);
                }
                50% {
                    opacity: 1;
                    transform: scale(1.05);
                }
                70% {
                    transform: scale(0.9);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }
            
            @keyframes shake {
                0%, 100% {
                    transform: translateX(0);
                }
                10%, 30%, 50%, 70%, 90% {
                    transform: translateX(-2px);
                }
                20%, 40%, 60%, 80% {
                    transform: translateX(2px);
                }
            }
            
            @keyframes float {
                0%, 100% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-10px);
                }
            }
            
            @keyframes glow {
                0%, 100% {
                    box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
                }
                50% {
                    box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
                }
            }
            
            /* Animasyon Sınıfları */
            .animate-fadeInUp {
                animation: fadeInUp 0.6s ease-out;
            }
            
            .animate-fadeInLeft {
                animation: fadeInLeft 0.6s ease-out;
            }
            
            .animate-fadeInRight {
                animation: fadeInRight 0.6s ease-out;
            }
            
            .animate-slideInDown {
                animation: slideInDown 0.5s ease-out;
            }
            
            .animate-scaleIn {
                animation: scaleIn 0.4s ease-out;
            }
            
            .animate-bounceIn {
                animation: bounceIn 0.6s ease-out;
            }
            
            .animate-pulse {
                animation: pulse 2s infinite;
            }
            
            .animate-shake {
                animation: shake 0.5s ease-in-out;
            }
            
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            
            .animate-glow {
                animation: glow 2s ease-in-out infinite;
            }
            
            /* Hover Animasyonları */
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .hover-lift:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            }
            
            .hover-scale {
                transition: transform 0.3s ease;
            }
            
            .hover-scale:hover {
                transform: scale(1.05);
            }
            
            .hover-rotate {
                transition: transform 0.3s ease;
            }
            
            .hover-rotate:hover {
                transform: rotate(5deg);
            }
            
            .hover-glow {
                transition: box-shadow 0.3s ease;
            }
            
            .hover-glow:hover {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
            }
            
            /* Loading Animasyonları */
            .loading-spinner {
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }
            
            .loading-dots::after {
                content: '';
                animation: dots 1.5s infinite;
            }
            
            @keyframes dots {
                0%, 20% {
                    content: '';
                }
                40% {
                    content: '.';
                }
                60% {
                    content: '..';
                }
                80%, 100% {
                    content: '...';
                }
            }
            
            /* Stagger Animasyonları */
            .stagger-1 { animation-delay: 0.1s; }
            .stagger-2 { animation-delay: 0.2s; }
            .stagger-3 { animation-delay: 0.3s; }
            .stagger-4 { animation-delay: 0.4s; }
            .stagger-5 { animation-delay: 0.5s; }
            
            /* Smooth Transitions */
            .smooth-transition {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            /* Card Animations */
            .card-hover {
                transition: all 0.3s ease;
            }
            
            .card-hover:hover {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            }
            
            /* Button Animations */
            .btn-animate {
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .btn-animate::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }
            
            .btn-animate:hover::before {
                left: 100%;
            }
            
            /* Text Animations */
            .text-shimmer {
                background: linear-gradient(90deg, #000, #fff, #000);
                background-size: 200% 100%;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: shimmer 2s infinite;
            }
            
            @keyframes shimmer {
                0% {
                    background-position: -200% 0;
                }
                100% {
                    background-position: 200% 0;
                }
            }
            
            /* Dark Mode Geçiş Animasyonları */
            @keyframes darkModeTransition {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.7;
                    transform: scale(0.98);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            @keyframes lightModeTransition {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.02);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            
            @keyframes themeToggleSpin {
                0% {
                    transform: rotate(0deg) scale(1);
                }
                50% {
                    transform: rotate(180deg) scale(1.1);
                }
                100% {
                    transform: rotate(360deg) scale(1);
                }
            }
            
            @keyframes themeTogglePulse {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                }
            }
            
            @keyframes themeToggleGlow {
                0%, 100% {
                    box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
                }
                50% {
                    box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.4);
                }
            }
            
            /* Dark Mode Geçiş Sınıfları */
            .dark-mode-transition {
                animation: darkModeTransition 0.6s ease-in-out;
            }
            
            .light-mode-transition {
                animation: lightModeTransition 0.6s ease-in-out;
            }
            
            .theme-toggle-animate {
                animation: themeToggleSpin 0.8s ease-in-out, themeTogglePulse 0.8s ease-in-out;
            }
            
            .theme-toggle-glow {
                animation: themeToggleGlow 1s ease-in-out;
            }
            
            /* Smooth Dark Mode Transition */
            * {
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            }
            
            /* Dark Mode Geçiş Overlay */
            .theme-transition-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, #1e293b, #334155);
                z-index: 9999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            .theme-transition-overlay.active {
                opacity: 0.1;
            }
            
            /* Dark Mode Geçiş Ripple Effect */
            .theme-ripple {
                position: fixed;
                border-radius: 4px;
                background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, transparent 70%);
                transform: scale(0);
                animation: ripple 0.6s ease-out;
                pointer-events: none;
                z-index: 9998;
            }
            
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            
            /* Dark Mode Geçiş için Özel Animasyonlar */
            .dark-mode-fade-in {
                animation: fadeInUp 0.5s ease-out;
            }
            
            .light-mode-fade-in {
                animation: fadeInDown 0.5s ease-out;
            }
            
            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* Theme Toggle Button Özel Animasyonları */
            .theme-toggle {
                position: relative;
                overflow: hidden;
            }
            
            .theme-toggle::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                transform: translate(-50%, -50%);
                transition: width 0.3s ease, height 0.3s ease;
            }
            
            .theme-toggle:active::after {
                width: 100px;
                height: 100px;
            }
            
            /* Dark mode flash önleme - Theme Toggle Icons */
            html[data-theme="dark"] .theme-toggle + svg {
                color: #94a3b8 !important;
            }
            
            html[data-theme="dark"] .theme-toggle + svg + svg {
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Header Layout */
            html[data-theme="dark"] .main-header {
                position: sticky !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                transition: none !important;
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] .main-header > div {
                width: 100% !important;
                margin: 0 !important;
                padding: 1rem 1.5rem !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
            }
            
            /* Sistem temasından header'ı koru */
            .main-header {
                background-color: #ffffff !important;
            }
            
            html[data-theme="dark"] .main-header {
                background-color: #1e293b !important;
            }
            
            html[data-theme="light"] .main-header {
                background-color: #ffffff !important;
            }
            
            /* Dark mode flash önleme - Main Content */
            html[data-theme="dark"] main {
                margin-left: 16rem !important;
                width: calc(100% - 16rem) !important;
                position: relative !important;
            }
            
            /* Dark mode flash önleme - Sidebar */
            html[data-theme="dark"] aside {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 16rem !important;
                height: 100vh !important;
                z-index: 30 !important;
            }
            
            /* Dark mode flash önleme - Tablo Satırları */
            html[data-theme="dark"] tbody tr:hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] tbody tr:hover td {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] tbody tr:hover th {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Hücreleri */
            html[data-theme="dark"] tbody tr td:hover {
                background-color: #475569 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] tbody tr th:hover {
                background-color: #475569 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Başlıkları */
            html[data-theme="dark"] thead tr:hover {
                background-color: #1e293b !important;
            }
            
            html[data-theme="dark"] thead tr:hover th {
                background-color: #1e293b !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Genel Hover */
            html[data-theme="dark"] table tr:hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] table tr:hover td {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] table tr:hover th {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Hücre Hover */
            html[data-theme="dark"] table td:hover {
                background-color: #475569 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] table th:hover {
                background-color: #475569 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Satır Hover */
            html[data-theme="dark"] table tbody tr:hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] table tbody tr:hover td {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] table tbody tr:hover th {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            /* Dark mode flash önleme - Tablo Satır Hover - Alternatif */
            html[data-theme="dark"] table tbody tr:nth-child(even):hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] table tbody tr:nth-child(odd):hover {
                background-color: #334155 !important;
            }
            
            /* Dark mode flash önleme - Tablo Satır Hover - Tüm Varyantlar */
            html[data-theme="dark"] table tbody tr:hover,
            html[data-theme="dark"] table tbody tr:nth-child(even):hover,
            html[data-theme="dark"] table tbody tr:nth-child(odd):hover {
                background-color: #334155 !important;
            }
            
            html[data-theme="dark"] table tbody tr:hover td,
            html[data-theme="dark"] table tbody tr:nth-child(even):hover td,
            html[data-theme="dark"] table tbody tr:nth-child(odd):hover td {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
            
            html[data-theme="dark"] table tbody tr:hover th,
            html[data-theme="dark"] table tbody tr:nth-child(even):hover th,
            html[data-theme="dark"] table tbody tr:nth-child(odd):hover th {
                background-color: #334155 !important;
                color: #f1f5f9 !important;
            }
        </style>
<?php include __DIR__ . '/partials/tailwind_cdn_loader.php'; ?>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Yeni Minimalist ve Resmi Palet */
        .bg-sidebar { background-color: #ffffff; }
        .text-sidebar { color: #475569; transition: background 0.25s ease, color 0.25s ease, transform 0.2s ease, border-color 0.2s ease; }
        .active-link {
            background: linear-gradient(105deg, rgba(68,64,180,0.25), rgba(99,102,241,0.12));
            color: #3c36b3;
            border-left: 3px solid #3c36b3;
            box-shadow: inset 0 0 0 1px rgba(79,70,229,0.2), 0 8px 22px rgba(64,69,179,0.12);
            animation: activeRibbon 0.45s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        .active-link::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 10% 50%, rgba(255,255,255,0.4), rgba(255,255,255,0));
            opacity: 0;
            animation: activeSheen 1.4s ease forwards;
            pointer-events: none;
        }

        @keyframes activeRibbon {
            0% { transform: translateX(-6px); opacity: 0.4; box-shadow: inset 0 0 0 1px rgba(79,70,229,0.08); }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes activeSheen {
            0% { opacity: 0; transform: translateX(-80%); }
            35% { opacity: 0.38; }
            100% { opacity: 0; transform: translateX(80%); }
        }
        .active-link .sidebar-icon {
            color: #4338ca !important;
            transform: none;
        }
        .card-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .input-focus:focus { border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; }
        
        /* Sabit Renk Paleti */
        .color-primary { background-color: #6366f1; }
        .hover-primary:hover { background-color: #4f46e5; }
        .color-secondary-btn { background-color: #64748b; }
        .hover-secondary:hover { background-color: #475569; }
        
        .section-card {
            border: 1px solid #e2e8f0;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        .main-header {
            position: sticky;
            top: 0;
            z-index: 20; 
        }
        
        .sidebar-icon {
            transition: color 0.2s ease, transform 0.25s ease;
        }
        
        /* Zil (Notification) Shake Animasyonu - Soft ve yumuşak */
        @keyframes bellShake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-6deg); }
            20%, 40%, 60%, 80% { transform: rotate(6deg); }
        }
        
        .notification-shake {
            animation: bellShake 0.5s ease-in-out;
        }
        
        /* Zil hover animasyonu kaldırıldı */
        
        .sidebar-link {
            position: relative;
            overflow: hidden;
            transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
        }
        
        .sidebar-link::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255,255,255,0.35), rgba(255,255,255,0));
            opacity: 0;
            transform: translateX(-40%);
            transition: opacity 0.35s ease, transform 0.35s ease;
            pointer-events: none;
        }
        
        .sidebar-link:hover::before {
            opacity: 1;
            transform: translateX(40%);
        }
        
        .sidebar-link:hover {
            background: linear-gradient(90deg, rgba(148,163,184,0.08), rgba(79,70,229,0.07));
            box-shadow: inset 0 0 0 1px rgba(99,102,241,0.2), 0 6px 14px rgba(15,23,42,0.08);
        }
        
        .sidebar-link:hover .sidebar-icon {
            transform: none;
            color: #4f46e5;
        }
        
        .mail-metric-card {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .mail-metric-card::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.35;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.45), transparent 55%),
                        radial-gradient(circle at bottom left, rgba(255,255,255,0.25), transparent 60%);
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .mail-metric-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
        }

        .mail-template-btn {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.9rem 1rem;
            border-radius: 1rem;
            background: #f8fafc;
            border: 1px solid rgba(148, 163, 184, 0.3);
            transition: all 0.2s ease;
            text-align: left;
            height: 100%;
        }

        .mail-template-btn:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 15px 35px -20px rgba(59, 130, 246, 0.45);
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(99,102,241,0.1));
        }

        .mail-template-title {
            font-weight: 600;
            color: #1e293b;
        }

        .mail-template-desc {
            font-size: 0.75rem;
            color: #64748b;
        }

        html[data-theme="dark"] .mail-template-btn {
            background: rgba(15, 23, 42, 0.6);
            border-color: rgba(148, 163, 184, 0.35);
        }

        html[data-theme="dark"] .mail-template-title {
            color: #e2e8f0;
        }

        html[data-theme="dark"] .mail-template-desc {
            color: #94a3b8;
        }

        .editor-toggle-btn {
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            transition: all 0.2s ease;
        }

        .editor-toggle-btn:hover {
            background: rgba(79, 70, 229, 0.08);
            color: #1d4ed8;
        }

        .editor-toggle-btn.active {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            box-shadow: 0 12px 32px -20px rgba(79, 70, 229, 0.7);
        }

        html[data-theme="dark"] .editor-toggle-btn {
            color: #cbd5f5;
        }

        .mail-option-chip {
            cursor: pointer;
            margin-right: 0.75rem;
            margin-bottom: 0.5rem;
            display: inline-flex;
        }

        .mail-option-chip span {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: #f1f5f9;
            color: #475569;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.4);
        }

        .mail-option-chip:hover span {
            background: #e0f2fe;
            color: #0369a1;
        }

        .mail-option-chip input:checked + span {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            box-shadow: 0 12px 28px -18px rgba(79, 70, 229, 0.7);
        }

        html[data-theme="dark"] .mail-option-chip span {
            background: rgba(30, 41, 59, 0.85);
            color: #cbd5f5;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);
        }

        .email-contact-scroll,
        .sms-contact-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
            scroll-padding-bottom: 5rem;
        }

        .email-contact-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .email-contact-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .email-contact-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.4);
            border-radius: 999px;
        }

        .email-contact-item {
            transition: all 0.2s ease;
        }

        .email-contact-item:hover {
            transform: translateY(-1px);
        }

        .email-contact-item.selected {
            border-color: rgba(79, 70, 229, 0.45);
            background: rgba(79, 70, 229, 0.12);
            box-shadow: 0 18px 36px -28px rgba(79, 70, 229, 0.6);
        }

        html[data-theme="dark"] .email-contact-item.selected {
            border-color: rgba(129, 140, 248, 0.4);
            background: rgba(129, 140, 248, 0.25);
        }

        .sms-contact-item {
            transition: all 0.2s ease;
        }

        .sms-contact-item:hover {
            transform: translateY(-1px);
        }

        .sms-contact-item.selected {
            border-color: rgba(34, 197, 94, 0.45);
            background: rgba(34, 197, 94, 0.12);
            box-shadow: 0 18px 36px -28px rgba(34, 197, 94, 0.6);
        }

        html[data-theme="dark"] .sms-contact-item.selected {
            border-color: rgba(74, 222, 128, 0.4);
            background: rgba(74, 222, 128, 0.25);
        }

        .mail-hero {
            position: relative;
            overflow: hidden;
            background: linear-gradient(120deg, rgba(59,130,246,0.08), rgba(99,102,241,0.12), rgba(236,72,153,0.08));
            border-radius: 1.75rem;
        }

        .mail-hero::before {
            content: '';
            position: absolute;
            inset: -20%;
            background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 55%),
                        radial-gradient(circle at 80% 30%, rgba(236,72,153,0.2), transparent 60%),
                        radial-gradient(circle at 50% 80%, rgba(56,189,248,0.18), transparent 60%);
            opacity: 0.9;
            pointer-events: none;
        }

        .mail-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            background: rgba(59,130,246,0.12);
            color: #1d4ed8;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .mail-hero-title {
            font-size: clamp(1.9rem, 2.4vw, 2.4rem);
            font-weight: 700;
            color: #0f172a;
        }

        .mail-hero-sub {
            color: #475569;
            max-width: 48ch;
            line-height: 1.7;
        }

        .mail-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.85rem;
            border-radius: 999px;
            background: rgba(15,23,42,0.05);
            color: #1e293b;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mail-hero-aside {
            backdrop-filter: blur(10px);
            border-radius: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(255,255,255,0.6);
            padding: 1.25rem 1.5rem;
            display: grid;
            gap: 0.75rem;
            min-width: 220px;
        }

        .mail-hero-aside strong {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0f172a;
        }

        .mail-hero-aside span {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #1d4ed8;
            font-weight: 600;
        }

        .mail-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .mail-quick-actions button {
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            padding: 0.45rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: #ffffff;
            color: #1e293b;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .mail-quick-actions button svg {
            width: 1rem;
            height: 1rem;
        }

        .mail-quick-actions button:hover {
            border-color: rgba(59,130,246,0.5);
            color: #1d4ed8;
            box-shadow: 0 12px 24px -20px rgba(59,130,246,0.6);
        }

        .mail-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .mail-meta-card {
            padding: 0.85rem 1rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(248,250,252,0.8);
            display: grid;
            gap: 0.35rem;
        }

        .mail-meta-card span {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
        }

        .mail-attachment-drop {
            margin-top: 0.5rem;
            padding: 1rem 1.2rem;
            border: 1px dashed rgba(148, 163, 184, 0.6);
            border-radius: 1rem;
            background: rgba(248,250,252,0.6);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #475569;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .mail-attachment-drop svg {
            width: 1.25rem;
            height: 1.25rem;
            color: #3b82f6;
        }

        .mail-attachment-drop:hover {
            border-color: rgba(59,130,246,0.6);
            background: rgba(219,234,254,0.35);
        }

        .mail-preview-card {
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 1.5rem;
            background: rgba(15,23,42,0.02);
            padding: 1.5rem;
            display: grid;
            gap: 1rem;
        }

        .mail-preview-header {
            display: flex;
            align-items: center;
            gap: 0.85rem;
        }

        .mail-preview-header::before {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 6px rgba(34,197,94,0.12);
        }

        .mail-preview-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
        }

        .mail-preview-subject {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
        }

        .mail-preview-to {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .mail-preview-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            background: rgba(59,130,246,0.12);
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mail-preview-body {
            background: white;
            border-radius: 1rem;
            padding: 1.25rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
            min-height: 120px;
            line-height: 1.6;
            color: #475569;
            font-size: 0.9rem;
        }

        .mail-preview-footer {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 0.85rem;
            color: #64748b;
        }

        .mail-preview-footer button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.95rem;
            border-radius: 0.9rem;
            background: #1d4ed8;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .mail-preview-footer button:hover {
            background: #1e40af;
            box-shadow: 0 12px 28px -20px rgba(37, 99, 235, 0.65);
        }

        .mail-footer-tips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .mail-footer-tips span {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.75rem;
            border-radius: 0.85rem;
            background: rgba(15,23,42,0.04);
        }

        /* Aktif link için özel animasyon */
        .active-link .sidebar-icon {
            animation: activePulse 2s infinite;
        }
        
        @keyframes activePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Logo animasyonları */
        .logo-container img {
            transition: all 0.3s ease;
        }
        

        
        /* Partner logo animasyonu */
        .partner-logo {
            transition: all 0.3s ease;
        }
        
        .partner-logo:hover {
            transform: scale(1.15) rotate(-2deg);
        }
        
        /* Tema Sistemi */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --hover-bg: #f9fafb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --sidebar-bg: #0f172a;
            --input-bg: #334155;
            --input-border: #475569;
            --hover-bg: #334155;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
        }
        
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        body {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .bg-sidebar {
            background-color: var(--sidebar-bg);
        }
        
        .text-sidebar {
            color: var(--text-secondary);
        }
        
        .card-bg {
            background-color: var(--card-bg);
        }
        
        /* KUSURSUZ DARK MODE - TÜM ELEMENTLER İÇİN */
        
        /* Dark Mode Flash Önleme - Hemen Uygulanacak */
        body {
            transition: background-color 0.1s ease, color 0.1s ease;
        }
        
        /* Ana Arka Plan */
        [data-theme="dark"] body {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
        }
        
        /* Dark Mode Varsayılan Stiller - Flash Önleme */
        .dark-mode-flash-prevention {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        
        /* Beyaz Arka Planlar */
        [data-theme="dark"] .bg-white {
            background-color: #1e293b !important;
        }
        
        /* Gri Arka Planlar */
        [data-theme="dark"] .bg-gray-50 {
            background-color: #334155 !important;
        }
        
        [data-theme="dark"] .bg-gray-100 {
            background-color: #475569 !important;
        }
        
        [data-theme="dark"] .bg-gray-200 {
            background-color: #64748b !important;
        }
        
        /* Hover Efektleri - Koyu Renkler Kullan */
        [data-theme="dark"] .hover\\:bg-gray-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-100:hover {
            background-color: #334155 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-white:hover {
            background-color: #0f172a !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-200:hover {
            background-color: #475569 !important;
        }
        
        /* Sidebar Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .sidebar-link:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .sidebar-link:hover .sidebar-icon {
            color: #818cf8 !important;
        }
        
        /* Button Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .btn-animated:hover {
            background-color: #6366f1 !important;
            color: #ffffff !important;
        }
        
        /* Card Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .card-hover:hover {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }
        
        /* Table Row Hover - Koyu Renkler */
        [data-theme="dark"] .table-row:hover {
            background-color: #1e293b !important;
        }
        
        /* Modal Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .modal-content:hover {
            background-color: #1e293b !important;
        }
        
        /* Tüm Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:bg-blue-50:hover {
            background-color: #312e81 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-green-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-red-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-yellow-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-purple-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-pink-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-indigo-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-cyan-50:hover {
            background-color: #312e81 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-teal-50:hover {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:bg-orange-50:hover {
            background-color: #1e293b !important;
        }
        
        /* Button Hover Renkleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:bg-blue-500:hover {
            background-color: #4338ca !important;
        }
        
        [data-theme="dark"] .hover\\:bg-green-500:hover {
            background-color: #166534 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-red-500:hover {
            background-color: #dc2626 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-yellow-500:hover {
            background-color: #ca8a04 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-purple-500:hover {
            background-color: #7c3aed !important;
        }
        
        /* Text Hover Renkleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:text-blue-600:hover {
            color: #818cf8 !important;
        }
        
        [data-theme="dark"] .hover\\:text-green-600:hover {
            color: #4ade80 !important;
        }
        
        [data-theme="dark"] .hover\\:text-red-600:hover {
            color: #f87171 !important;
        }
        
        [data-theme="dark"] .hover\\:text-yellow-600:hover {
            color: #facc15 !important;
        }
        
        [data-theme="dark"] .hover\\:text-purple-600:hover {
            color: #a78bfa !important;
        }
        
        /* Border Hover Renkleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:border-blue-300:hover {
            border-color: #6366f1 !important;
        }
        
        [data-theme="dark"] .hover\\:border-green-300:hover {
            border-color: #166534 !important;
        }
        
        [data-theme="dark"] .hover\\:border-red-300:hover {
            border-color: #dc2626 !important;
        }
        
        [data-theme="dark"] .hover\\:border-yellow-300:hover {
            border-color: #ca8a04 !important;
        }
        
        [data-theme="dark"] .hover\\:border-purple-300:hover {
            border-color: #7c3aed !important;
        }
        
        /* Shadow Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:shadow-lg:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
        }
        
        [data-theme="dark"] .hover\\:shadow-xl:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Transform Hover Efektleri */
        [data-theme="dark"] .hover\\:scale-105:hover {
            transform: scale(1.05) !important;
        }
        
        [data-theme="dark"] .hover\\:scale-110:hover {
            transform: scale(1.1) !important;
        }
        
        [data-theme="dark"] .hover\\:rotate-3:hover {
            transform: rotate(3deg) !important;
        }
        
        [data-theme="dark"] .hover\\:-rotate-3:hover {
            transform: rotate(-3deg) !important;
        }
        
        /* Opacity Hover Efektleri */
        [data-theme="dark"] .hover\\:opacity-80:hover {
            opacity: 0.8 !important;
        }
        
        [data-theme="dark"] .hover\\:opacity-90:hover {
            opacity: 0.9 !important;
        }
        
        /* Filter Hover Efektleri */
        [data-theme="dark"] .hover\\:brightness-110:hover {
            filter: brightness(1.1) !important;
        }
        
        [data-theme="dark"] .hover\\:brightness-125:hover {
            filter: brightness(1.25) !important;
        }
        
        [data-theme="dark"] .hover\\:contrast-110:hover {
            filter: contrast(1.1) !important;
        }
        
        [data-theme="dark"] .hover\\:saturate-110:hover {
            filter: saturate(1.1) !important;
        }
        
        /* Gradient Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:bg-gradient-to-r:hover {
            background: linear-gradient(to right, #1e293b, #334155) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gradient-to-b:hover {
            background: linear-gradient(to bottom, #1e293b, #334155) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gradient-to-br:hover {
            background: linear-gradient(to bottom right, #1e293b, #334155) !important;
        }
        
        /* Ring Hover Efektleri - Koyu Renkler */
        [data-theme="dark"] .hover\\:ring-2:hover {
            box-shadow: 0 0 0 2px #1e293b !important;
        }
        
        [data-theme="dark"] .hover\\:ring-blue-500:hover {
            box-shadow: 0 0 0 2px #1e40af !important;
        }
        
        [data-theme="dark"] .hover\\:ring-green-500:hover {
            box-shadow: 0 0 0 2px #166534 !important;
        }
        
        [data-theme="dark"] .hover\\:ring-red-500:hover {
            box-shadow: 0 0 0 2px #dc2626 !important;
        }
        
        [data-theme="dark"] .hover\\:ring-purple-500:hover {
            box-shadow: 0 0 0 2px #7c3aed !important;
        }
        
        /* Backdrop Hover Efektleri */
        [data-theme="dark"] .hover\\:backdrop-blur-sm:hover {
            backdrop-filter: blur(4px) !important;
        }
        
        [data-theme="dark"] .hover\\:backdrop-blur-md:hover {
            backdrop-filter: blur(8px) !important;
        }
        
        [data-theme="dark"] .hover\\:backdrop-blur-lg:hover {
            backdrop-filter: blur(12px) !important;
        }
        
        /* Text Renkleri */
        [data-theme="dark"] .text-gray-800 dark:text-gray-200 {
            color: #f1f5f9 !important;
        }
        
        [data-theme="dark"] .text-gray-700 {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .text-gray-500 dark:text-gray-400 {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .text-gray-400 {
            color: #64748b !important;
        }
        
        [data-theme="dark"] .text-gray-300 {
            color: #475569 !important;
        }
        
        [data-theme="dark"] .text-gray-200 {
            color: #334155 !important;
        }
        
        [data-theme="dark"] .text-gray-900 {
            color: #f8fafc !important;
        }
        
        /* Border Renkleri */
        [data-theme="dark"] .border-gray-200 {
            border-color: #334155 !important;
        }
        
        [data-theme="dark"] .border-gray-300 {
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] .border-gray-400 {
            border-color: #64748b !important;
        }
        
        [data-theme="dark"] .border-gray-500 {
            border-color: #94a3b8 !important;
        }
        
        /* Input ve Form Elementleri */
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: #334155 !important;
            border-color: #475569 !important;
            color: #f1f5f9 !important;
        }
        
        [data-theme="dark"] input:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #64748b !important;
        }
        
        /* Shadow Efektleri */
        [data-theme="dark"] .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }
        
        [data-theme="dark"] .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
        }
        
        [data-theme="dark"] .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
        }
        
        [data-theme="dark"] .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Card ve Section Efektleri */
        [data-theme="dark"] .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }
        
        [data-theme="dark"] .section-card {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }
        
        /* Finans, Kampanya ve Reports sekmelerinde animasyonları kapat */
        [data-view="finance"],
        [data-view="campaigns"],
        [data-view="reports"] {
            animation: none !important;
        }
        
        [data-view="finance"] [class*="animate-"],
        [data-view="campaigns"] [class*="animate-"],
        [data-view="reports"] [class*="animate-"] {
            animation: none !important;
        }
        
        /* Reports ve Campaigns sekmelerindeki butonlarda animasyonları kapat */
        [data-view="reports"] button,
        [data-view="campaigns"] button {
            transition: none !important;
            transform: none !important;
        }
        
        [data-view="reports"] button:hover,
        [data-view="campaigns"] button:hover {
            transform: none !important;
        }
        
        /* Reports ve Campaigns sekmelerindeki tüm elementlerde animasyonları kapat */
        [data-view="reports"] *,
        [data-view="campaigns"] * {
            animation: none !important;
            transition: none !important;
        }
        
        /* Hover efektlerini koru ama animasyon olmadan */
        [data-view="reports"] button:hover,
        [data-view="campaigns"] button:hover {
            opacity: 0.9;
        }

        /* Reports erişim kilidi efektleri */
        [data-view="reports"].reports-locked .reports-blur-card,
        [data-view="reports"].reports-locked .reports-blur-grid > * {
            position: relative;
            filter: blur(6px);
            opacity: 0.65;
            pointer-events: none;
            user-select: none;
            transition: none !important;
        }

        [data-view="reports"].reports-locked .reports-blur-card::after,
        [data-view="reports"].reports-locked .reports-blur-grid > *::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: rgba(15, 23, 42, 0.25);
            pointer-events: none;
        }

        @supports ((-webkit-backdrop-filter: blur(0)) or (backdrop-filter: blur(0))) {
            [data-view="reports"].reports-locked .reports-blur-card::after,
            [data-view="reports"].reports-locked .reports-blur-grid > *::after {
                backdrop-filter: blur(2px);
                -webkit-backdrop-filter: blur(2px);
            }
        }
        
        /* Sidebar Dark Mode */
        [data-theme="dark"] .bg-sidebar {
            background-color: #0f172a !important;
        }
        
        [data-theme="dark"] .text-sidebar {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .active-link {
            background-color: #312e81 !important;
            color: #818cf8 !important;
            border-left-color: #6366f1 !important;
        }
        
        /* Tablo Dark Mode */
        [data-theme="dark"] .table-row:hover {
            background-color: #334155 !important;
        }
        
        [data-theme="dark"] .divide-y > * + * {
            border-color: #334155 !important;
        }
        
        /* Modal Dark Mode */
        [data-theme="dark"] .modal-content {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }
        
        /* Button Dark Mode */
        [data-theme="dark"] .btn-animated:hover {
            background-color: #6366f1 !important;
        }
        
        /* Scrollbar Dark Mode */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
            background-color: #1e293b;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background-color: #334155;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background-color: #64748b;
            border-radius: 4px;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        /* Özel Dark Mode Sınıfları */
        [data-theme="dark"] .dark-bg-primary {
            background-color: #0f172a !important;
        }
        
        [data-theme="dark"] .dark-bg-secondary {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .dark-text-primary {
            color: #f1f5f9 !important;
        }
        
        [data-theme="dark"] .dark-text-secondary {
            color: #94a3b8 !important;
        }
        
        [data-theme="dark"] .dark-border {
            border-color: #334155 !important;
        }
        
        /* Hover Text Renkleri */
        [data-theme="dark"] .hover\\:text-gray-600:hover {
            color: #cbd5e1 !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-700:hover {
            color: #e2e8f0 !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-800 dark:text-gray-200:hover {
            color: #f1f5f9 !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-900:hover {
            color: #f8fafc !important;
        }
        
        /* Hover Border Renkleri */
        [data-theme="dark"] .hover\\:border-gray-300:hover {
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-400:hover {
            border-color: #64748b !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-500:hover {
            border-color: #94a3b8 !important;
        }
        
        /* Focus Efektleri */
        [data-theme="dark"] .focus\\:border-blue-500:focus {
            border-color: #6366f1 !important;
        }
        
        [data-theme="dark"] .focus\\:ring-blue-500:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }
        
        /* Özel Renkler - Dark Mode'da Korun */
        [data-theme="dark"] .text-blue-600 {
            color: #818cf8 !important;
        }
        
        [data-theme="dark"] .text-green-600 {
            color: #4ade80 !important;
        }
        
        [data-theme="dark"] .text-red-600 {
            color: #f87171 !important;
        }
        
        [data-theme="dark"] .text-yellow-600 {
            color: #facc15 !important;
        }
        
        [data-theme="dark"] .text-purple-600 {
            color: #a78bfa !important;
        }
        
        [data-theme="dark"] .text-pink-600 {
            color: #f472b6 !important;
        }
        
        [data-theme="dark"] .text-indigo-500 {
            color: #818cf8 !important;
        }
        
        [data-theme="dark"] .text-teal-600 {
            color: #2dd4bf !important;
        }
        
        [data-theme="dark"] .text-orange-600 {
            color: #fb923c !important;
        }
        
        [data-theme="dark"] .text-cyan-600 {
            color: #818cf8 !important;
        }
        
        [data-theme="dark"] .text-gray-800 dark:text-gray-200 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-700 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-500 dark:text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .border-gray-200 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .bg-gray-50 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-100 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-50:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-100:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-white:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] input:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 1px #3b82f6 !important;
        }
        
        [data-theme="dark"] .shadow-md {
            box-shadow: var(--shadow) !important;
        }
        
        [data-theme="dark"] .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
        
        [data-theme="dark"] .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }
        
        [data-theme="dark"] .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Ek Dark Mode Sınıfları */
        [data-theme="dark"] .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-300 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-gray-200 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .bg-gray-200 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-300 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-400 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-500 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-600 {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-700 {
            background-color: var(--card-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-800 {
            background-color: var(--card-bg) !important;
        }
        
        [data-theme="dark"] .bg-gray-900 {
            background-color: var(--bg-primary) !important;
        }
        
        [data-theme="dark"] .border-gray-400 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-500 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-600 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-800 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .border-gray-900 {
            border-color: var(--border-color) !important;
        }
        
        /* Hover Efektleri */
        [data-theme="dark"] .hover\\:bg-gray-200:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-300:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-400:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-500:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-600:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-700:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-800:hover {
            background-color: var(--hover-bg) !important;
        }
        
        [data-theme="dark"] .hover\\:bg-gray-900:hover {
            background-color: var(--hover-bg) !important;
        }
        
        /* Text Hover Efektleri */
        [data-theme="dark"] .hover\\:text-gray-600:hover {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-700:hover {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-800 dark:text-gray-200:hover {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .hover\\:text-gray-900:hover {
            color: var(--text-primary) !important;
        }
        
        /* Border Hover Efektleri */
        [data-theme="dark"] .hover\\:border-gray-300:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-400:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-500:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-600:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-700:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-800:hover {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\\:border-gray-900:hover {
            border-color: var(--border-color) !important;
        }
        
        /* Focus Efektleri */
        [data-theme="dark"] .focus\\:border-blue-500:focus {
            border-color: #6366f1 !important;
        }
        
        [data-theme="dark"] .focus\\:ring-blue-500:focus {
            box-shadow: 0 0 0 1px #3b82f6 !important;
        }
        
        [data-theme="dark"] .focus\\:ring-2:focus {
            box-shadow: 0 0 0 2px #3b82f6 !important;
        }
        
        /* Placeholder */
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: var(--text-secondary) !important;
        }
        
        /* Scrollbar */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Modal ve Overlay */
        [data-theme="dark"] .bg-gray-900 {
            background-color: rgba(15, 23, 42, 0.8) !important;
        }
        
        [data-theme="dark"] .bg-gray-800 {
            background-color: var(--card-bg) !important;
        }
        
        /* Card Shadow */
        [data-theme="dark"] .card-shadow {
            box-shadow: var(--shadow) !important;
        }
        
        /* Button Hover */
        [data-theme="dark"] .hover\\:bg-blue-600:hover {
            background-color: #4f46e5 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-green-600:hover {
            background-color: #059669 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-red-600:hover {
            background-color: #dc2626 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-yellow-600:hover {
            background-color: #d97706 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-purple-600:hover {
            background-color: #7c3aed !important;
        }
        
        [data-theme="dark"] .hover\\:bg-pink-600:hover {
            background-color: #db2777 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-indigo-500:hover {
            background-color: #6366f1 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-teal-600:hover {
            background-color: #0d9488 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-orange-600:hover {
            background-color: #ea580c !important;
        }
        
        [data-theme="dark"] .hover\\:bg-cyan-600:hover {
            background-color: #6366f1 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-lime-600:hover {
            background-color: #65a30d !important;
        }
        
        [data-theme="dark"] .hover\\:bg-emerald-600:hover {
            background-color: #059669 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-rose-600:hover {
            background-color: #e11d48 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-violet-600:hover {
            background-color: #7c3aed !important;
        }
        
        [data-theme="dark"] .hover\\:bg-fuchsia-600:hover {
            background-color: #c026d3 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-sky-600:hover {
            background-color: #0284c7 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-amber-600:hover {
            background-color: #d97706 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-stone-600:hover {
            background-color: #57534e !important;
        }
        
        [data-theme="dark"] .hover\\:bg-neutral-600:hover {
            background-color: #525252 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-zinc-600:hover {
            background-color: #525252 !important;
        }
        
        [data-theme="dark"] .hover\\:bg-slate-600:hover {
            background-color: #475569 !important;
        }
        
        .theme-toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .theme-toggle.active {
            background: #6366f1;
        }
        
        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 3px;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle.active::before {
            transform: translateX(26px);
        }
        
        /* Mobil Optimizasyon */
        @media (max-width: 768px) {
            .mobile-menu-open {
                transform: translateX(0);
            }
            
            .mobile-menu-closed {
                transform: translateX(-100%);
            }
            
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-grid-1 {
                grid-template-columns: 1fr;
            }
            
            .mobile-stack {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .mobile-full-width {
                width: 100%;
            }
            
            .mobile-hidden {
                display: none;
            }
            
            .mobile-visible {
                display: block;
            }
            
            /* Touch-friendly buttons */
            .touch-button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Mobile navigation */
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e2e8f0;
                z-index: 50;
                display: flex;
                justify-content: space-around;
                padding: 0.5rem 0;
            }
            
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0.5rem;
                text-decoration: none;
                color: #64748b;
                font-size: 0.75rem;
                transition: color 0.2s;
            }
            
            .mobile-nav-item.active {
                color: #6366f1;
            }
            
            .mobile-nav-item svg {
                width: 1.5rem;
                height: 1.5rem;
                margin-bottom: 0.25rem;
            }
        }
        
        /* Tablet optimizasyonu */
        @media (min-width: 768px) and (max-width: 1024px) {
            .tablet-grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tablet-padding {
                padding: 1.5rem;
            }
        }
        
        /* PWA Stilleri */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Modern Toast Animasyonları */
        .toast-enter {
            transform: translateX(0) !important;
            opacity: 1 !important;
        }

        .toast-exit {
            transform: translateX(100%) !important;
            opacity: 0 !important;
        }

        /* Yeni Toast Progress Bar Sistemi - Soldan Sağa Akış */
        .toast-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0,0,0,0.15);
            overflow: hidden;
            border-radius: 0 0 8px 8px;
        }
        
        .toast-progress-fill {
            height: 100%;
            background: currentColor;
            opacity: 0.8;
            width: 0%;
            animation: progressFlow linear forwards;
            border-radius: 0 0 8px 8px;
        }
        
        @keyframes progressFlow {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* Toast Hover Efektleri */
        .toast:hover {
            transform: translateX(-2px) !important;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }

        .toast-enter:hover {
            transform: translateX(-2px) !important;
        }

        /* Toast Container Animasyonu */
        #toast-container {
            pointer-events: none;
        }

        #toast-container .toast {
            pointer-events: auto;
        }

        /* Dark Mode Toast Düzenlemeleri */
        html[data-theme="dark"] .toast {
            background-color: #1f2937 !important;
            border-color: #374151 !important;
        }

        html[data-theme="dark"] .toast-progress {
            background-color: #374151 !important;
        }

        /* Toast Tip Renkleri - Daha Belirgin Progress Bar */
        .toast-success .toast-progress-fill {
            background: linear-gradient(90deg, #10b981, #34d399) !important;
            opacity: 1 !important;
        }

        .toast-error .toast-progress-fill {
            background: linear-gradient(90deg, #ef4444, #f87171) !important;
            opacity: 1 !important;
        }

        .toast-warning .toast-progress-fill {
            background: linear-gradient(90deg, #f59e0b, #fbbf24) !important;
            opacity: 1 !important;
        }

        .toast-info .toast-progress-fill {
            background: linear-gradient(90deg, #6366f1, #818cf8) !important;
            opacity: 1 !important;
        }
    </style>
    
    <?php 
    // Sayfa yüklenmeden önce dil ayarını kontrol et ve Google Translate'i hazırla
    $ui_language = get_setting('ui_language', 'tr');
    if ($ui_language === 'en'): 
    ?>
    <!-- Google Translate Script - Head'de yükle (sayfa yüklenmeden önce) -->
    <script<?= tpl_script_nonce_attr(); ?>>
        // Cookie ve hash'i hemen ayarla (sayfa yüklenmeden önce)
        (function() {
            document.cookie = 'googtrans=tr|en; path=/; max-age=31536000';
            if (!window.location.hash.includes('googtrans')) {
                window.location.hash = '#googtrans(tr|en)';
            }
        })();
    </script>
    <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>
    <script<?= tpl_script_nonce_attr(); ?>>
        // Google Translate callback - sayfa yüklenir yüklenmez çalışacak
        window.googleTranslateElementInit = function() {
            if (typeof google !== 'undefined' && google.translate) {
                // Widget'ı hemen oluştur
                new google.translate.TranslateElement({
                    pageLanguage: 'tr',
                    includedLanguages: 'tr,en',
                    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                    autoDisplay: false
                }, 'google_translate_element');
                
                // Çeviriyi hemen başlat (çok kısa gecikme - widget hazır olana kadar)
                let attempts = 0;
                const maxAttempts = 30; // 3 saniye max
                
                const startTranslate = function() {
                    attempts++;
                    const select = document.querySelector('.goog-te-combo');
                    
                    if (select) {
                        // Widget hazır, çeviriyi başlat
                        select.value = 'en';
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                    } else if (attempts < maxAttempts) {
                        // Widget henüz hazır değil, tekrar dene (çok hızlı - 100ms)
                        setTimeout(startTranslate, 100);
                    }
                };
                
                // Hemen başlat
                startTranslate();
            }
        };
        
        // Sayfa yüklenir yüklenmez çeviriyi kontrol et
        (function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // DOM yüklendi, çeviriyi kontrol et
                    setTimeout(function() {
                        if (typeof google !== 'undefined' && google.translate) {
                            const select = document.querySelector('.goog-te-combo');
                            if (select && select.value !== 'en') {
                                select.value = 'en';
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    }, 50);
                });
            } else {
                // DOM zaten yüklü
                setTimeout(function() {
                    if (typeof google !== 'undefined' && google.translate) {
                        const select = document.querySelector('.goog-te-combo');
                        if (select && select.value !== 'en') {
                            select.value = 'en';
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }
                }, 50);
            }
        })();
    </script>
    <?php endif; ?>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex min-h-screen pt-0 overflow-x-hidden">
    <!-- Google Translate Widget (Gizli) - Head'de script yüklendi, burada sadece container -->
    <div id="google_translate_element" style="position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; width: 1px; height: 1px; overflow: hidden; z-index: -9999; visibility: hidden;"></div>
    
    <!-- Dil Değişimi Loading Overlay -->
    <div id="language-change-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 99999; backdrop-filter: blur(4px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
            <div style="width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 10px;">Dil Değiştiriliyor</h3>
            <p style="font-size: 16px; opacity: 0.9; margin-bottom: 20px;">Tüm sekmeler çevriliyor, lütfen bekleyin...</p>
            <div id="translation-progress" style="font-size: 14px; opacity: 0.8;"></div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Google Translate widget'ını tamamen gizle */
        .goog-te-banner-frame,
        .goog-te-menu-frame,
        .goog-te-ftab,
        .skiptranslate {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
        }
        
        /* Sayfa çevrildiğinde body'ye eklenen class'ı temizle */
        body.translated-ltr,
        body.translated-rtl {
            top: 0 !important;
            position: relative !important;
        }
        
        /* Google Translate iframe'lerini gizle */
        iframe[src*="translate.googleapis.com"],
        iframe[src*="translate.google.com"] {
            display: none !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        /* Google Translate'in neden olduğu layout shift'leri önle */
        body {
            will-change: auto !important;
        }
        
        /* Google Translate widget'ının DOM'a eklediği elementleri optimize et */
        .goog-te-spinner-pos,
        .goog-te-balloon-frame {
            display: none !important;
        }
    </style>
    <script<?= tpl_script_nonce_attr(); ?>>
        let googleTranslateLoaded = false;
        let googleTranslateInitialized = false;
        let translateWidget = null;
        let translationInProgress = false;
        let currentLanguage = '<?= get_setting('ui_language', 'tr') ?>';
        
        // Bu fonksiyon artık head'de tanımlı, burada sadece flag kontrolü yap
        function googleTranslateElementInit() {
            // Head'deki fonksiyon zaten widget'ı oluşturdu
            // Burada sadece flag'i güncelle
            if (typeof google !== 'undefined' && google.translate) {
                googleTranslateInitialized = true;
            }
        }
        
        function startTranslation(targetLang, isInitialLoad) {
            if (translationInProgress && !isInitialLoad) {
                return; // İlk yükleme değilse ve zaten çeviri yapılıyorsa, tekrar başlatma
            }
            
            translationInProgress = true;
            
            // Cookie ve hash zaten ayarlı, sadece select element'ini bul ve çeviriyi tetikle
            function tryTranslateViaSelect() {
                const selectors = [
                    '.goog-te-combo',
                    'select.goog-te-combo',
                    'select[id*="goog"]'
                ];
                
                for (let i = 0; i < selectors.length; i++) {
                    try {
                        const select = document.querySelector(selectors[i]);
                        if (select && select.options && select.options.length > 0) {
                            // İngilizce seçeneğini bul
                            for (let j = 0; j < select.options.length; j++) {
                                const optionValue = select.options[j].value;
                                const optionText = select.options[j].text.toLowerCase();
                                
                                if (optionValue === targetLang || 
                                    optionValue === 'en' ||
                                    optionText.includes('english') ||
                                    optionText.includes('ingilizce')) {
                                    if (select.value !== optionValue) {
                                        select.value = optionValue;
                                        select.selectedIndex = j;
                                        
                                        // Event'leri gönder
                                        select.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                                        
                                        translationInProgress = false;
                                        return true;
                                    } else {
                                        // Zaten doğru dil seçili, sadece flag'i temizle
                                        translationInProgress = false;
                                        return true;
                                    }
                                }
                            }
                        }
                    } catch(e) {
                        continue;
                    }
                }
                return false;
            }
            
            // Hemen dene
            if (tryTranslateViaSelect()) {
                return;
            }
            
            // Bulunamadıysa kısa süre bekle (max 2 deneme = 0.6 saniye - daha hızlı)
            let attempts = 0;
            const maxAttempts = 2;
            const interval = setInterval(function() {
                attempts++;
                if (tryTranslateViaSelect() || attempts >= maxAttempts) {
                    clearInterval(interval);
                    translationInProgress = false;
                }
            }, 300);
        }
        
        function saveLanguageAndReload(language) {
            // Dil ayarını direkt kaydet ve sayfayı yenile
            const form = document.getElementById('settingsForm');
            if (!form) {
                // Form bulunamadı, direkt URL ile kaydet
                const formData = new URLSearchParams();
                formData.append('action', 'update_settings');
                formData.append('ui_language', language);
                formData.append('current_view', 'settings');
                
                // CSRF token'ı al
                const csrfInput = document.querySelector('input[name="csrf_token"]');
                if (csrfInput) {
                    formData.append('csrf_token', csrfInput.value);
                }
                
                fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                }).finally(function() {
                    window.location.reload();
                });
                return;
            }
            
            const languageSelect = document.getElementById('ui_language');
            if (languageSelect) {
                languageSelect.value = language;
            }
            
            const formData = new FormData(form);
            // Dil değerini güncelle
            formData.set('ui_language', language);
            
            fetch('index.php', {
                method: 'POST',
                body: formData
            }).then(function(response) {
                // Başarılı veya başarısız, her durumda sayfayı yenile
                window.location.reload();
            }).catch(function(error) {
                // Hata olsa bile sayfayı yenile
                window.location.reload();
            });
        }
        
        function loadGoogleTranslate(callback) {
            if (!googleTranslateLoaded) {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
                script.async = true;
                if (callback) {
                    script.onload = callback;
                }
                document.head.appendChild(script);
                googleTranslateLoaded = true;
            } else if (callback) {
                callback();
            }
        }
        
        // Global scope'a ekle - inline handler'lar için
        window.handleLanguageChange = function(language) {
            if (language === currentLanguage) {
                return; // Aynı dil seçildi, işlem yapma
            }
            
            if (language === 'en') {
                // İngilizce seçildi - Loading ekranı göster ve tüm sekmeleri çevir
                showLanguageChangeLoading();
                preloadAndTranslateAllViews(language);
            } else {
                // Türkçe seçildi - Direkt kaydet ve yenile
                saveLanguageAndReload(language);
            }
        };
        
        function showLanguageChangeLoading() {
            const overlay = document.getElementById('language-change-overlay');
            if (overlay) {
                overlay.style.display = 'block';
            }
        }
        
        function hideLanguageChangeLoading() {
            const overlay = document.getElementById('language-change-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        function updateTranslationProgress(text) {
            const progress = document.getElementById('translation-progress');
            if (progress) {
                progress.textContent = text;
            }
        }
        
        async function preloadAndTranslateAllViews(language) {
            // Önce ayarı kaydet
            const form = document.getElementById('settingsForm');
            if (!form) {
                saveLanguageAndReload(language);
                return;
            }
            
            const formData = new FormData(form);
            formData.set('ui_language', language);
            
            try {
                // Ayarı kaydet
                await fetch('index.php', {
                    method: 'POST',
                    body: formData
                });
                
                // Cookie ve hash'i ayarla
                document.cookie = 'googtrans=tr|en; path=/; max-age=31536000';
                window.location.hash = '#googtrans(tr|en)';
                
                // Google Translate'i yükle
                updateTranslationProgress('Google Translate yükleniyor...');
                loadGoogleTranslate(function() {
                    updateTranslationProgress('Tüm sekmeler hazırlanıyor...');
                    
                    // Widget yüklendikten sonra çeviriyi başlat
                    setTimeout(function() {
                        // Önce mevcut sayfayı çevir
                        startTranslation('en', true);
                        
                        // Sonra tüm sekmeleri arka planda hazırla (cache için)
                        updateTranslationProgress('Sekmeler hazırlanıyor...');
                        prepareAllViewsCache(language, function() {
                            updateTranslationProgress('Hazır!');
                            setTimeout(function() {
                                hideLanguageChangeLoading();
                                window.location.reload();
                            }, 500);
                        });
                    }, 2000);
                });
            } catch(error) {
                console.error('Dil değiştirme hatası:', error);
                hideLanguageChangeLoading();
                saveLanguageAndReload(language);
            }
        }
        
        function prepareAllViewsCache(language, callback) {
            // Cache flag'ini ayarla - sayfa yüklendiğinde cache kullanılacak
            const cacheKey = 'translation_cache_enabled';
            try {
                localStorage.setItem(cacheKey, '1');
                localStorage.setItem('translation_language', language);
                localStorage.setItem('translation_timestamp', Date.now().toString());
            } catch (e) {
                console.warn('localStorage erişimi engellendi:', e);
            }
            
            // Tüm view'ları arka planda fetch et (sadece cache için, çeviri Google Translate yapacak)
            const views = ['dashboard', 'events', 'members', 'board', 'market', 'reports', 'finance', 'messages', 'mail', 'campaigns', 'notifications', 'verification', 'verification_admin'];
            let completed = 0;
            const total = views.length;
            
            // Paralel olarak tüm view'ları fetch et (yükü dağıt)
            views.forEach(function(view, index) {
                setTimeout(function() {
                    fetch('index.php?view=' + view, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }).then(function(response) {
                        return response.text();
                    }).then(function(html) {
                        // View içeriğini cache'le (çevrilmemiş hali)
                        const cacheKey = 'view_cache_' + view;
                        try {
                            localStorage.setItem(cacheKey, html);
                        } catch (e) {
                            console.warn('localStorage erişimi engellendi:', e);
                        }
                        
                        completed++;
                        if (completed === total) {
                            if (callback) callback();
                        }
                    }).catch(function(error) {
                        completed++;
                        if (completed === total) {
                            if (callback) callback();
                        }
                    });
                }, index * 50); // Her view arasında 50ms bekle (daha hızlı)
            });
        }
        
        // Sayfa yüklendiğinde dil ayarını kontrol et (sadece bir kez)
        (function() {
            <?php 
            $ui_language = get_setting('ui_language', 'tr');
            if ($ui_language === 'en'): 
            ?>
            // Cookie ve hash zaten head'de ayarlandı, sadece widget'ı kontrol et
            // Google Translate script'i head'de yüklendi, sadece çeviriyi başlat
            
            // Yeni içerik yüklendiğinde otomatik çevir (sekme değişimleri için)
            let contentObserver = null;
            let lastTranslateTime = 0;
            
            function observeNewContent() {
                if (contentObserver) {
                    contentObserver.disconnect();
                }
                
                contentObserver = new MutationObserver(function(mutations) {
                    // Yeni içerik eklendiğinde çeviriyi tetikle
                    let hasNewContent = false;
                    mutations.forEach(function(mutation) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && (node.hasAttribute('data-view') || node.querySelector('[data-view]'))) {
                                hasNewContent = true;
                            }
                        });
                    });
                    
                    if (hasNewContent && currentLanguage === 'en') {
                        // Son çeviriden en az 100ms geçmiş olmalı (spam önleme, daha hızlı)
                        const now = Date.now();
                        if (now - lastTranslateTime > 100) {
                            lastTranslateTime = now;
                            
                            // Yeni içerik var, çeviriyi tetikle (çok hızlı)
                            setTimeout(function() {
                                const select = document.querySelector('.goog-te-combo');
                                if (select && select.value !== 'en') {
                                    select.value = 'en';
                                    select.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                            }, 30); // Çok hızlı - 30ms
                        }
                    }
                });
                
                // Ana içerik alanını izle
                const mainContent = document.querySelector('main') || document.body;
                if (mainContent) {
                    contentObserver.observe(mainContent, {
                        childList: true,
                        subtree: true,
                        attributes: false
                    });
                }
            }
            
            function initTranslate() {
                // Google Translate zaten head'de yüklendi, sadece çeviriyi başlat
                // Widget hazır olana kadar bekle
                let attempts = 0;
                const maxAttempts = 20; // 2 saniye max bekleme
                
                const checkAndTranslate = function() {
                    attempts++;
                    const select = document.querySelector('.goog-te-combo');
                    
                    if (select) {
                        // Widget hazır, çeviriyi başlat
                        if (select.value !== 'en') {
                            select.value = 'en';
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        
                        // Yeni içerik gözlemcisini başlat
                        observeNewContent();
                        googleTranslateInitialized = true;
                    } else if (attempts < maxAttempts) {
                        // Widget henüz hazır değil, tekrar dene
                        setTimeout(checkAndTranslate, 100);
                    } else {
                        // Widget yüklenemedi, normal akışa devam et
                        observeNewContent();
                    }
                };
                
                // Hemen kontrol et
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', checkAndTranslate);
                } else {
                    checkAndTranslate();
                }
            }
            
            // Hash değişikliğini dinle
            window.addEventListener('hashchange', function() {
                if (window.location.hash.includes('googtrans(tr|en)')) {
                    translationInProgress = false;
                }
            });
            
            // Hemen başlat
            initTranslate();
            <?php endif; ?>
        })();
    </script>

    <div id="mobile-menu-toggle" class="lg:hidden fixed top-4 left-4 z-40 p-2 color-primary text-white rounded-md shadow-lg cursor-pointer">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 flex-shrink-0 bg-sidebar dark:bg-gray-900 transform -translate-x-full lg:translate-x-0 transition duration-200 ease-in-out border-r border-gray-200 dark:border-gray-700">
        <div class="h-full flex flex-col p-4">
            <div class="flex flex-col items-center justify-center p-4 mb-8 border-b border-gray-300 dark:border-gray-700">
                <!-- Ana Logo ve UniFour İsmi -->
                <div class="flex flex-col items-center justify-center logo-container">
                    <img src="assets/images/logo_tr.png" alt="UniFour Logo" class="w-16 h-16 mb-2">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">UniFour</h2>
                </div>
            </div>
            <nav class="flex-1 space-y-2">
                <?php
                $menu_items = [
                    'dashboard' => ['Pano', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>', null],
                    'events' => ['Etkinlik Yönetimi', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>', null],
                    'members' => ['Üyelik Listesi', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', null],
                    'board' => ['Yönetim Kurulu', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', null],
                    'market' => ['Market', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>', null],
                    'reports' => ['Raporlar & Analitik', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>', null],
                    'finance' => ['Finans Yönetimi', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', 'professional'],
                    'messages' => ['Mesaj Merkezi', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>', 'business'],
                    'mail' => ['Mail Merkezi', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>', 'professional'],
                    'campaigns' => ['Kampanyalar', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', 'professional']
                ];
                if (!empty($_SESSION['is_superadmin'])) {
                    $menu_items['verification_admin'] = ['Topluluk Onayı', '<svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.5l7 3V12c0 4.5-3 8.5-7 9-4-.5-7-4.5-7-9V7.5l7-3z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.5 12.5l2 2 3-3.5"></path></svg>', null];
                }

                // Ana menü öğelerini göster
                foreach ($menu_items as $view => $item):
                    $requiredTier = $item[2] ?? null;
                    $is_active = $current_view === $view ? 'active-link' : 'text-sidebar hover:bg-gray-100 hover:text-indigo-500';
                ?>
                    <a href="?view=<?= $view ?>" class="sidebar-link flex items-center p-3 rounded-md <?= $is_active ?> transition duration-150">
                        <span class="sidebar-icon"><?= $item[1] ?></span>
                        <span class="font-normal"><?= $item[0] ?></span>
                    </a>
                    
                    <!-- Etkinlik Yönetimi Alt Başlığı -->
                    <?php if ($view === 'events' && $current_view === 'event_detail' && $event_detail): ?>
                        <div class="ml-4 mt-1 mb-2 border-l-3 border-indigo-500 dark:border-indigo-400 pl-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-r-md py-2">
                            <a href="?view=event_detail&event_id=<?= $event_detail['id'] ?>" class="flex items-center text-sm font-semibold text-indigo-500 dark:text-indigo-300 hover:text-indigo-800 dark:hover:text-indigo-200 transition duration-150">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                <span class="truncate"><?= htmlspecialchars($event_detail['title']) ?></span>
                                </a>
                        </div>
                    <?php endif; ?>
                <?php endforeach; ?>
            </nav>
            
            <!-- Copyright ve Versiyon Bilgisi -->
                <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                            © 2025 UniFour - Four Software tarafından
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 lg:ml-64 pb-16 lg:pb-0 min-w-0 overflow-x-hidden pt-20 px-6">
        <header class="main-header bg-white dark:bg-gray-900 fixed top-0 left-0 lg:left-64 right-0 z-40 border-b border-gray-200 dark:border-gray-700 shadow-sm max-w-full overflow-x-hidden">
            <div class="p-4 sm:p-6 lg:p-4 flex items-center justify-between w-full max-w-full">
                <div class="flex items-center gap-3">
                    <div>
                        <?php
                        if (!function_exists('verification_is_verified')) {
                            load_module('verification');
                        }
                        $verificationLatestRequest = function_exists('verification_get_latest_request') ? verification_get_latest_request() : null;
                        $verificationStatusCode = $verificationLatestRequest['status'] ?? 'none';
                        $verificationStatusMeta = function_exists('verification_get_status_meta')
                            ? verification_get_status_meta($verificationStatusCode)
                            : ['label' => 'Belge yok', 'color' => '', 'description' => 'Henüz doğrulama talebi oluşturmadınız.'];
                        $communityVerified = ($verificationStatusCode === 'approved');
                        $verificationBadgeImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWgAAAFoCAMAAABNO5HnAAAAS1BMVEUAAAAeofMeofMeofMeofMeofMeofMeofMeofMeofMeofMeofMeofMeofMeofMboPM4rPVSuPaKz/rI6f3x+v/////g8/5swviq3PsPzdMlAAAAD3RSTlMACyFJcV83re34/8Lcg5fQ1lRhAAAJpUlEQVR42uzBgQAAAACAoP2pF6kCAAAAAAAAAAAAAAAAYHbsAll2GAaiqCWj2rL3v9xP8AgUcoFLZwEDdyZJJzsjjinlQsGtRLk2ASA9cXDLxC74RzMFtwSNhldkcnALcBW81b30ks4Alpd23IH1pR1XYH1pRxVfqF76QTTxpUrBPYSG4GvTSz8lC74hw0s/IzZ8S1JwD4gKQ8vB3VYUJo3B3cQdNtES3IIBvejGxQe0TXxOv8IxjTlHjkwXBrRhHH1NLnnMOVLkXTMPFfwm2kehYEsCw8mRR2XUl08xeP+VBjnQOjec0LJduct+a8WO1ozWueEUjVbl/Ra4vYbt1rEBD5UmTr3hM1o2X2l266w4TXP4BOfa8JVOOz8WsltTarigDf6wdKYKviY5bIQ6DNLHq7lFsQqu6ZmNyjv/pUuDTXTmwkRcUhdc9/tlmEtMVQUmiWEfAwc1/UlwlzTVJhAcMX+wc0fHAYQgEECDngIr2n+5KSF/BBheCY7jst54JaPwbwpnRnU6oSEw3XVKoSKy76eKDyHUP6QfQjtUZ4oOzUZnoQvZnYU+Vmehj9tZ6IM7C30c6ix0IaPK1V1wOqtc+nvosePCRZdwRnhMPXQEK+E9dHQJn4rwdHUB93G7gMcq4Z2F/YF2CDx0Gi546EOaGCkcKvIYs++VSmzo3tKfIgn9+uDwIbPiK25/hd850zJkkP1PevspkhHe2Zaa5hMkJLwGZVnjsdc7ipQUauetHXu1ifa8fEyRndp539xEIbfxZRNFHSrGb81BgX7o/I4JalI5fNd/hySN9Y4pyhPjX/bONNtxFQbClwTHRr5Ynsn+N/qmST8f3W1XEKiW8B2dQoAG/wHY0sY+BGpE4a+M5CMJXD9Qaxo794lhzg0q9A/47K5GNT4q/HG18jFP7Sp0VuWF0eisygui4VWbc5h3RGpavjbQBroz0HYYAtRZegdReFVXf2QNL94uLNYMe7tihY9KVncazaLvlXlHmKpsAbKKdW85R1XeYV1Frrdrof6HJXMOe++IBfR42zeWvZUy8/3OYak0z8uyzMRaR01HLZjXbT/2c535RuewVJqX7fhbZ7qxSsm8I53Hv9pX4pucw67haT8O0XtmjaM1X4MezkL6cucw7xDOom1mhestoibOQvpi57A7yyqcLyHdOxvSmMH510l7G7WWyVlIa5skNinjLKSVDQOKqjiL3tqGTHtdnEWJr7Boi+j1+B+dsy7Qk1LOx55Y07BHNyrjLFr5V9Noe+x4H/eA/n6YRYtYON95GtrFMJPzOXPpbeAiN1Fp4jmP87HSz2hytjHoT3E2521WtHPhOSiI54uflYYPkH59643n5eefpL2Dc24pnkUhYkk/W+MsmpC5R9eeP4t6GGnnC+S8oTgTfb9A95QptMlZSHeQY3Ck4oThLBqiQxyDzcazKEyP2+3Z4hnw8OGmoDee3zNr2b3w6Kk8ATjDjkSxZ4tnwH28K5HzgucsCpO75Rg0zoBboouhRM4ngDOUtJtUcyZWMubY9aSX8y6cS49pN5HqeL5AmJ9E1f686pns+ByMM6Jw2vWodm1mylWuP6+QDQtOUafKnNb3mjLTMAZwxod0hPRrn/+2EXNG8CcAZ3ihqesxDxb5dwsIZ3yhqRsxF+n8V+PiONO3BtBiuEIawLkY0KK7rUM4C+kLOCeCKYyXgO4A8Zxfs5X2YjiLYlll0PkJxLmwJs7Dq/jCfuGcQRrMGd/d8hiB8SykUZwLqlx6DgB/ziCdyflMajcN+YDjLLhYB+foSv/IkvtgFuk1lzMr4Awkzbz+CDKumrPI+QAMaIHWSjyLXDdc7dB7tt3mc16gnAfvyi9U4pQXoADOpRWFPcdrc+jMFIK5VM5PFUuqeT7zHuGW5X0AOBdVuOv6cCHpTH77DuBc2ip2FwMqpEVFco5OT8k/p10r56HT1cRyHekNynl8aWvLSrtCzgHVPPvoA4w0oA2o4MZ7FwGkoZzx2TP+SEw7gDPEnktvaEm7ccYkH+k0zpjRKOnU4s/CuaGYxnMO3ZfuMWHM6QRwhjZRlNlCxBkFz4i2Nrxx4MsQlrN0zjTVMW13OQvnHJ51DOrm5YRyVjBtV9QRgDSIM36ZAj7vkBOxYM7Uf6mPaCG9ZXMmpoZAR7pUTPMGa+/WNHre9R8a3COc2/Dox0AfIb2SqImswwOGURXDmcKrEueQ7k4IZ03LFAbA4FxA+2Dxp6FHjzYXzk2ZtOsBw6AL4kyhq8c5JKbL4Szqq3EOIU1vAGeAdygYL7FmtA+i5WvcSDavAM4aLocevGbzBHAu8c7iRoKS3hYqQFGnc+SXIezy/NzacRiJcEOttkRMJSh0lW5BZZrXc19npjIU+nq3oPK8SDi35x2RYGKmguRtf3KVT3jPgRrV8LIV9xh5cw6Ud5hz1Jd3eGpYHfSFtGFN0BX3DWt0tV0LLcF7BkLITLqjphUNNEZTTdZhoO0wJG/pXXXdWROR3cHNO2r6CfeBWtX4QIJ2MRhn2LCfBjX0whmlVz+0h/npvvByv7N3H1iChCAQQAEVsUXvf9zNoTc5kVmd+keo10+hTTq9vaOU+1CmNyJp9HcQdvM+yz3leCxaRu1u7ciIrddRVJgWwuM+7DNOT4g4Lm5rRwwVT8g4FkvK1fYNueYkTJtgyX5tyGdi2owMuzZjU2hHqV9b8USbkq2SdqVtieN7vsMmvZZpZzyxSTSGGhYCQ3DFhroYGVsIYqhh42II9msDzrS9em2g0v4G9mrESA1bnkOoYS4MwR3b6WJUtCsxMraWx86G6AvxUzoRHTMboujA+YDmTEco+OkfQxsa8LjZEA04ZsOmdIiJBjxGQQMeQw1zYQh29IUxKoboGAXtyv81SDfvtXZvzz4Z0btbQBW9ZyXd+kjCH0mafj2ZzST8kZbp7bCRY2088rikznY9Sat6PwZpAT/9txk7rGdluit+PYFlphvWxcElUzrKXKT8u/SEpK3Q71hK/fsgMpmOIr5IeZH0E3K+Zz29LUboQyRbpLxI+ok5LwZsT7S3dWxes/KLHsxomRZYc7ffZs7jyPT24wSwMK0Ve0TOg2mNNX8dsJvVwnQmSXmMUZLwK9zdtMj5PmDXmZMwweLuphevHoBnzA8L4BpzdxdIj8kZxGNOcYMukrZE8CKKxbwxCLktGhV4/XJ6MkFAOV2F4AVJjSrskHRUzki6vc24gRmxTeT8Kvi+YOuZCV6HTLu+sqoEr0dHd7OAS7OBRfVDe3YgAwAAADDI3/oeX2kkRwAAAAAAAAAAAAAAAADmAjdCJPhC760WAAAAAElFTkSuQmCC';
                        ?>
                        <h1 class="text-lg font-semibold text-gray-900 dark:text-gray-100 leading-tight !text-gray-900 dark:!text-gray-100 flex items-center gap-2">
                            <?= htmlspecialchars($club_name) ?>
                            <?php if ($communityVerified): ?>
                                <img src="<?= htmlspecialchars($verificationBadgeImage) ?>" alt="Onaylı topluluk" class="w-5 h-5" loading="lazy">
                            <?php endif; ?>
                        </h1>
                        <?php
                        if (!function_exists('get_current_subscription_info')) {
                            require_once __DIR__ . '/../lib/general/subscription_helper.php';
                        }
                        $subscriptionInfo = get_current_subscription_info();
                        $currentTier = $subscriptionInfo['tier'] ?? 'standard';
                        $currentTierLabel = $subscriptionInfo['tier_label'] ?? 'Standart';
                        
                        $tierTextColors = [
                            'standard' => 'text-gray-700 dark:text-gray-300',
                            'professional' => 'text-blue-600 dark:text-blue-400',
                            'business' => 'text-purple-600 dark:text-purple-400'
                        ];
                        $textColor = $tierTextColors[$currentTier] ?? $tierTextColors['standard'];
                        ?>
                        <a href="?view=subscription" class="text-sm font-semibold <?= $textColor ?> hover:opacity-80 transition-opacity duration-200">
                            <?= htmlspecialchars($currentTierLabel) ?> Plan
                        </a>
                    </div>
                    <!-- QR Kod Butonu -->
                    <?php 
                    $community_id_for_qr = defined('COMMUNITY_ID') ? COMMUNITY_ID : (defined('CLUB_ID') ? CLUB_ID : '');
                    if (!empty($community_id_for_qr)): 
                    ?>
                    <button onclick="showQRCode('community', <?= tpl_js_escaped($community_id_for_qr) ?>, <?= tpl_js_escaped($club_name) ?>)" class="p-2 text-gray-600 dark:text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-300 flex items-center" title="QR Kod">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                    </button>
                    <?php endif; ?>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Tema Toggle -->
                    <button onclick="toggleTheme()" class="group p-2 text-gray-600 dark:text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-300 flex items-center pointer-events-auto z-[110] relative overflow-hidden">
                        <svg class="w-5 h-5 transform transition-transform duration-500 ease-in-out group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <!-- Hover glow effect -->
                        <div class="absolute inset-0 bg-indigo-500/10 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 blur-sm"></div>
                    </button>
                    
                    <!-- Bildirimler Butonu -->
                    <div class="relative z-50">
                        <button id="notification-btn" class="group p-2 text-gray-600 dark:text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-300 relative flex items-center pointer-events-auto overflow-hidden">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <!-- Hover glow effect -->
                            <div class="absolute inset-0 bg-indigo-500/10 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 blur-sm pointer-events-none"></div>
                        </button>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-medium z-20 <?= $unread_notification_count > 0 ? '' : 'hidden' ?>" style="min-width: 1.25rem;"><?= $unread_notification_count ?></span>
                        
                        
                        <!-- Bildirim Dropdown - Portal için placeholder -->
                        <div id="notification-dropdown-placeholder"></div>
                    </div>
                    
                    <!-- Profil Kutusu -->
                    <div class="relative z-50">
                        <button id="profile-btn" class="flex items-center space-x-2 p-1.5 pr-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-200 pointer-events-auto">
                            <div class="w-9 h-9 rounded-md bg-white dark:bg-gray-800 flex items-center justify-center border border-gray-300 dark:border-gray-600">
                                <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Profil Dropdown - Portal için placeholder -->
                        <div id="profile-dropdown-placeholder"></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
            <!-- Session mesajları artık toast olarak gösterilecek -->
            <?php if ($message): ?>
                <script<?= tpl_script_nonce_attr(); ?>>
                    document.addEventListener('DOMContentLoaded', function() {
                        if (typeof toastManager !== 'undefined') {
                            toastManager.show('Başarılı', <?= json_encode($message) ?>, 'success', 3000);
                        }
                    });
                </script>
            <?php endif; ?>
            <?php if ($error): ?>
                <script<?= tpl_script_nonce_attr(); ?>>
                    document.addEventListener('DOMContentLoaded', function() {
                        if (typeof toastManager !== 'undefined') {
                            toastManager.show('Hata', <?= json_encode($error) ?>, 'error', 4000);
                        }
                    });
                </script>
            <?php endif; ?>
            
            <?php
            // Guard kontrolünden sonra view değişmiş olabilir, tekrar kontrol et
            global $subscription_required_data;
            if (isset($subscription_required_data) || (isset($_GET['view']) && $_GET['view'] === 'subscription_required')) {
                $current_view = 'subscription_required';
            }
            ?>

            <div id="content-container" class="pt-6">
                <?php if ($current_view === 'dashboard'): ?>
                    <!-- Dashboard Widgets -->
                    <div id="dashboard-view" data-view="dashboard">
                        <?php
                        $config_health = $TPL_CONFIG_HEALTH ?? tpl_get_comm_config_health();
                        $needs_smtp = !$config_health['smtp']['configured'];
                        $needs_sms = !$config_health['sms']['configured'];
                        if ($needs_smtp || $needs_sms):
                        ?>
                        <div class="mb-6 space-y-4">
                            <?php if ($needs_smtp): ?>
                            <div class="rounded-xl border border-amber-300 bg-amber-50 p-4 text-amber-800">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-.01 4a9 9 0 110-18 9 9 0 010 18z"/></svg>
                                    <div>
                                        <h3 class="font-semibold">SMTP Ayarları Eksik</h3>
                                        <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                                            <?php foreach ($config_health['smtp']['issues'] as $issue): ?>
                                            <li><?= htmlspecialchars($issue) ?></li>
                                            <?php endforeach; ?>
                                        </ul>
                                        <a href="?view=settings" class="mt-2 inline-flex items-center text-sm font-semibold text-amber-900 hover:underline">Ayarları tamamla →</a>
                                    </div>
                                </div>
                            </div>
                            <?php endif; ?>
                            <?php if ($needs_sms): ?>
                            <div class="rounded-xl border border-red-300 bg-red-50 p-4 text-red-800">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>
                                    <div>
                                        <h3 class="font-semibold">SMS Sağlayıcı Ayarları Eksik</h3>
                                        <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                                            <?php foreach ($config_health['sms']['issues'] as $issue): ?>
                                            <li><?= htmlspecialchars($issue) ?></li>
                                            <?php endforeach; ?>
                                        </ul>
                                        <a href="?view=settings#sms" class="mt-2 inline-flex items-center text-sm font-semibold text-red-900 hover:underline">SMS ayarlarını güncelle →</a>
                                    </div>
                                </div>
                            </div>
                            <?php endif; ?>
                        </div>
                        <?php endif; ?>
                        <!-- İstatistik Kartları -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-fadeInUp">
                        <?php
                        $cards = [
                                ['title' => 'Toplam Üye', 'value' => $stats['total_members'], 'icon' => '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', 'color' => 'indigo', 'bg_color' => 'bg-indigo-50', 'border_color' => 'border-indigo-500', 'text_color' => 'text-indigo-500', 'trend' => '', 'link' => '?view=members'],
                                ['title' => 'Yaklaşan Etkinlik', 'value' => $stats['upcoming_events'], 'icon' => '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>', 'color' => 'indigo', 'bg_color' => 'bg-indigo-50', 'border_color' => 'border-indigo-500', 'text_color' => 'text-indigo-500', 'trend' => '', 'link' => '?view=events'],
                                ['title' => 'Yönetim Kurulu', 'value' => $stats['board_members'], 'icon' => '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', 'color' => 'indigo', 'bg_color' => 'bg-indigo-50', 'border_color' => 'border-indigo-500', 'text_color' => 'text-indigo-500', 'trend' => '', 'link' => '?view=board'],
                                ['title' => 'Toplam Etkinlik', 'value' => $stats['total_events'], 'icon' => '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>', 'color' => 'slate', 'bg_color' => 'bg-slate-50', 'border_color' => 'border-slate-500', 'text_color' => 'text-slate-600', 'trend' => '', 'link' => '?view=events'],
                        ];
                        foreach ($cards as $card):
                        ?>
                                <a href="<?= $card['link'] ?>" class="block bg-white p-6 rounded-md card-shadow transition duration-300 hover:shadow-lg border-l-4 <?= $card['border_color'] ?> <?= $card['bg_color'] ?> group card-hover animate-scaleIn stagger-<?= array_search($card, $cards) + 1 ?> cursor-pointer hover:scale-105 transform">
                                <div class="flex items-center justify-between">
                                    <p class="text-md font-medium text-gray-500 dark:text-gray-400"><?= $card['title'] ?></p>
                                        <div class="p-2 rounded-full <?= $card['text_color'] ?> group-hover:scale-110 transition-transform duration-200">
                                        <?= $card['icon'] ?>
                                    </div>
                                </div>
                                    <div class="flex items-end justify-between mt-2">
                                        <p class="text-4xl font-extrabold text-gray-900"><?= $card['value'] ?></p>
                                        <span class="text-sm font-semibold <?= $card['text_color'] ?> bg-white px-2 py-1 rounded-full">
                                            <?= $card['trend'] ?>
                                        </span>
                                    </div>
                            </a>
                        <?php endforeach; ?>
                        </div>

                        <!-- Grafik ve Analiz Bölümü -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 reports-blur-grid">
                            <!-- Üye İstatistikleri -->
                            <div class="bg-white p-6 rounded-md card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Üye İstatistikleri</h3>
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                
                                    <?php
                                // Gerçek veriler - son kayıt tarihlerine göre istatistikler
                                $today = date('Y-m-d');
                                $this_week_start = date('Y-m-d', strtotime('monday this week'));
                                $this_month_start = date('Y-m-d', strtotime('first day of this month'));
                                
                                $today_new = $week_new = $month_new = 0;
                                $members_table_exists = false;
                                $members_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='members'");
                                if ($members_table_check && $members_table_check->fetchArray()) {
                                    $members_table_exists = true;
                                }

                                if ($members_table_exists) {
                                // Bugün kayıt olanlar
                                    $today_stmt = @$db->prepare("SELECT COUNT(*) as count FROM members WHERE DATE(registration_date) = ? AND club_id = ?");
                                    if ($today_stmt) {
                                $today_stmt->bindValue(1, $today, SQLITE3_TEXT);
                                $today_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $today_result = $today_stmt->execute();
                                        if ($today_result) {
                                            $today_new = (int) ($today_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                
                                // Bu hafta kayıt olanlar
                                    $week_stmt = @$db->prepare("SELECT COUNT(*) as count FROM members WHERE DATE(registration_date) >= ? AND club_id = ?");
                                    if ($week_stmt) {
                                $week_stmt->bindValue(1, $this_week_start, SQLITE3_TEXT);
                                $week_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $week_result = $week_stmt->execute();
                                        if ($week_result) {
                                            $week_new = (int) ($week_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                
                                // Bu ay kayıt olanlar
                                    $month_stmt = @$db->prepare("SELECT COUNT(*) as count FROM members WHERE DATE(registration_date) >= ? AND club_id = ?");
                                    if ($month_stmt) {
                                $month_stmt->bindValue(1, $this_month_start, SQLITE3_TEXT);
                                $month_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $month_result = $month_stmt->execute();
                                        if ($month_result) {
                                            $month_new = (int) ($month_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                }
                                
                                // Son kayıt olan 5 üye
                                $recent_members = [];
                                if ($members_table_exists) {
                                    $recent_stmt = @$db->prepare("SELECT full_name, registration_date FROM members WHERE club_id = ? ORDER BY registration_date DESC LIMIT 5");
                                    if ($recent_stmt) {
                                $recent_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                                $recent_result = $recent_stmt->execute();
                                        if ($recent_result) {
                                while ($row = $recent_result->fetchArray(SQLITE3_ASSOC)) {
                                    $recent_members[] = $row;
                                            }
                                        }
                                    }
                                }
                                ?>
                                
                                <!-- Hızlı İstatistikler -->
                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg text-center">
                                        <p class="text-2xl font-bold text-blue-600 dark:text-blue-400"><?= $today_new ?></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Bugün</p>
                                    </div>
                                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg text-center">
                                        <p class="text-2xl font-bold text-green-600 dark:text-green-400"><?= $week_new ?></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Bu Hafta</p>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg text-center">
                                        <p class="text-2xl font-bold text-purple-600 dark:text-purple-400"><?= $month_new ?></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Bu Ay</p>
                                    </div>
                                </div>
                                
                                <!-- Son Kayıt Olan Üyeler -->
                                <div class="border-t pt-4">
                                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Son Kayıt Olan Üyeler</h4>
                                    <?php if (count($recent_members) > 0): ?>
                                        <div class="space-y-2">
                                            <?php foreach ($recent_members as $member): ?>
                                                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                                            <?= strtoupper(mb_substr($member['full_name'] ?? 'Ü', 0, 1)) ?>
                                            </div>
                                                        <span class="ml-3 text-sm text-gray-700 dark:text-gray-300"><?= htmlspecialchars($member['full_name'] ?? 'İsimsiz Üye') ?></span>
                                        </div>
                                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                                        <?= $member['registration_date'] ? date('d.m.Y', strtotime($member['registration_date'])) : '-' ?>
                                                    </span>
                                                </div>
                                            <?php endforeach; ?>
                                        </div>
                                        <a href="?view=members" class="block text-center mt-4 text-sm text-indigo-500 dark:text-indigo-400 hover:underline">
                                            Tüm üyeleri gör →
                                        </a>
                                    <?php else: ?>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Henüz kayıtlı üye yok</p>
                                    <?php endif; ?>
                                </div>
                            </div>

                            <!-- Etkinlik İstatistikleri -->
                            <div class="bg-white p-6 rounded-md card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Etkinlik İstatistikleri</h3>
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                </div>
                                
                                    <?php
                                // Gerçek veriler - etkinlik istatistikleri
                                $today = date('Y-m-d');
                                $this_week_start = date('Y-m-d', strtotime('monday this week'));
                                $this_month_start = date('Y-m-d', strtotime('first day of this month'));
                                
                                $today_events = $week_events = $month_events = 0;
                                $events_table_exists = false;
                                $events_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='events'");
                                if ($events_table_check && $events_table_check->fetchArray()) {
                                    $events_table_exists = true;
                                }
                                
                                if ($events_table_exists) {
                                // Bugün oluşturulan etkinlikler
                                    $today_stmt = @$db->prepare("SELECT COUNT(*) as count FROM events WHERE DATE(date) = ? AND club_id = ?");
                                    if ($today_stmt) {
                                $today_stmt->bindValue(1, $today, SQLITE3_TEXT);
                                $today_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $today_result = $today_stmt->execute();
                                        if ($today_result) {
                                            $today_events = (int) ($today_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                
                                // Bu hafta oluşturulan etkinlikler
                                    $week_stmt = @$db->prepare("SELECT COUNT(*) as count FROM events WHERE DATE(date) >= ? AND club_id = ?");
                                    if ($week_stmt) {
                                $week_stmt->bindValue(1, $this_week_start, SQLITE3_TEXT);
                                $week_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $week_result = $week_stmt->execute();
                                        if ($week_result) {
                                            $week_events = (int) ($week_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                
                                // Bu ay oluşturulan etkinlikler
                                    $month_stmt = @$db->prepare("SELECT COUNT(*) as count FROM events WHERE DATE(date) >= ? AND club_id = ?");
                                    if ($month_stmt) {
                                $month_stmt->bindValue(1, $this_month_start, SQLITE3_TEXT);
                                $month_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $month_result = $month_stmt->execute();
                                        if ($month_result) {
                                            $month_events = (int) ($month_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                }
                                
                                // Yaklaşan etkinlikler (bugünden sonra)
                                $upcoming_count = 0;
                                if ($events_table_exists) {
                                    $upcoming_stmt = @$db->prepare("SELECT COUNT(*) as count FROM events WHERE DATE(date) >= ? AND club_id = ?");
                                    if ($upcoming_stmt) {
                                $upcoming_stmt->bindValue(1, $today, SQLITE3_TEXT);
                                $upcoming_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $upcoming_result = $upcoming_stmt->execute();
                                        if ($upcoming_result) {
                                            $upcoming_count = (int) ($upcoming_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                }
                                ?>
                                
                                <!-- Hızlı İstatistikler -->
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg text-center">
                                        <p class="text-2xl font-bold text-green-600 dark:text-green-400"><?= $week_events ?></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Bu Hafta</p>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg text-center">
                                        <p class="text-2xl font-bold text-purple-600 dark:text-purple-400"><?= $month_events ?></p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Bu Ay</p>
                                    </div>
                                </div>
                                
                                <!-- Ek Bilgiler -->
                                <div class="border-t pt-4 space-y-2">
                                        <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">Yaklaşan Etkinlikler</span>
                                        <span class="text-sm font-semibold text-gray-800 dark:text-gray-200"><?= $upcoming_count ?></span>
                                            </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">Bugün</span>
                                        <span class="text-sm font-semibold text-gray-800 dark:text-gray-200"><?= $today_events ?></span>
                                                </div>
                                            </div>
                                
                                <a href="?view=events" class="block text-center mt-4 text-sm text-blue-600 dark:text-blue-400 hover:underline">
                                    Tüm etkinlikleri gör →
                                </a>
                                        </div>
                            
                            <!-- Son Eklenen Etkinlikler -->
                            <div class="bg-white p-6 rounded-md card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Son Eklenen Etkinlikler</h3>
                                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                
                                <?php
                                // Son eklenen 5 etkinlik
                                $recent_events = [];
                                if (!isset($events_table_exists)) {
                                    $events_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='events'");
                                    $events_table_exists = $events_table_check && $events_table_check->fetchArray();
                                }
                                if ($events_table_exists) {
                                    $recent_stmt = @$db->prepare("SELECT id, title, date, time, location FROM events WHERE club_id = ? ORDER BY date DESC, id DESC LIMIT 5");
                                    if ($recent_stmt) {
                                $recent_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                                $recent_result = $recent_stmt->execute();
                                        if ($recent_result) {
                                while ($row = $recent_result->fetchArray(SQLITE3_ASSOC)) {
                                    $recent_events[] = $row;
                                            }
                                        }
                                    }
                                }
                                ?>
                                
                                <?php if (count($recent_events) > 0): ?>
                                    <div class="space-y-2">
                                        <?php foreach ($recent_events as $event): ?>
                                            <a href="?view=event_detail&event_id=<?= $event['id'] ?>" class="block p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><?= htmlspecialchars($event['title']) ?></p>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                            <?= date('d.m.Y', strtotime($event['date'])) ?>
                                                            <?php if ($event['time']): ?>
                                                                @ <?= htmlspecialchars($event['time']) ?>
                                                            <?php endif; ?>
                                                        </p>
                            </div>
                                                    <?php if (strtotime($event['date']) >= strtotime('today')): ?>
                                                        <span class="ml-2 px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-full">
                                                            Yaklaşan
                                                        </span>
                                                    <?php endif; ?>
                                                </div>
                                            </a>
                                        <?php endforeach; ?>
                                    </div>
                                    <a href="?view=events" class="block text-center mt-4 text-sm text-indigo-500 dark:text-indigo-400 hover:underline">
                                        Tüm etkinlikleri gör →
                                    </a>
                                <?php else: ?>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Henüz etkinlik eklenmemiş</p>
                                    <a href="?view=events" class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline">
                                        İlk etkinliği ekle →
                                    </a>
                                <?php endif; ?>
                        </div>

                            <!-- Yönetim Kurulu Özeti -->
                            <div class="bg-white p-6 rounded-md card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Yönetim Kurulu</h3>
                                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                    </div>

                        <?php
                                $board_members_list = [];
                                $total_board_members = 0;
                                $board_table_exists = false;
                                $board_table_check = @$db->query("SELECT name FROM sqlite_master WHERE type='table' AND name='board_members'");
                                if ($board_table_check && $board_table_check->fetchArray()) {
                                    $board_table_exists = true;
                                }
                                
                                if ($board_table_exists) {
                                    $board_summary_stmt = @$db->prepare("SELECT id, full_name, role FROM board_members WHERE club_id = ? AND (is_active = 1 OR is_active IS NULL) ORDER BY id ASC LIMIT 5");
                                    if ($board_summary_stmt) {
                                $board_summary_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                                $board_summary_result = $board_summary_stmt->execute();
                                        if ($board_summary_result) {
                                while ($row = $board_summary_result->fetchArray(SQLITE3_ASSOC)) {
                                    $board_members_list[] = $row;
                                            }
                                        }
                                }
                                
                                    $total_board_stmt = @$db->prepare("SELECT COUNT(*) as count FROM board_members WHERE club_id = ? AND (is_active = 1 OR is_active IS NULL)");
                                    if ($total_board_stmt) {
                                $total_board_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                                $total_board_result = $total_board_stmt->execute();
                                        if ($total_board_result) {
                                            $total_board_members = (int) ($total_board_result->fetchArray()[0] ?? 0);
                                        }
                                    }
                                }
                                ?>
                                
                                <!-- Toplam Üye Sayısı -->
                                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg text-center mb-4">
                                    <p class="text-3xl font-bold text-indigo-500 dark:text-indigo-400"><?= $total_board_members ?></p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Aktif Üye</p>
                                    </div>
                                
                                <!-- Yönetim Kurulu Üyeleri Listesi -->
                                <?php if (count($board_members_list) > 0): ?>
                                    <div class="space-y-2">
                                        <?php foreach ($board_members_list as $member): ?>
                                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                                        <?= strtoupper(mb_substr($member['full_name'] ?? 'Ü', 0, 1)) ?>
                                                    </div>
                                                    <div class="ml-3">
                                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><?= htmlspecialchars($member['full_name'] ?? 'İsimsiz') ?></p>
                                                        <?php if ($member['role']): ?>
                                                            <p class="text-xs text-gray-500 dark:text-gray-400"><?= htmlspecialchars($member['role']) ?></p>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            </div>
                            <?php endforeach; ?>
                                    </div>
                                    
                                    <?php if ($total_board_members > 5): ?>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-2">
                                            +<?= $total_board_members - 5 ?> üye daha
                                        </p>
                                    <?php endif; ?>
                                    
                                    <a href="?view=board" class="block text-center mt-4 text-sm text-indigo-500 dark:text-indigo-400 hover:underline">
                                        Tüm üyeleri gör →
                                    </a>
                        <?php else: ?>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Henüz yönetim kurulu üyesi tanımlanmamış</p>
                                    <a href="?view=board" class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline">
                                        İlk üyeyi ekle →
                                    </a>
                        <?php endif; ?>
                            </div>
                        </div>

                    </div>

                <?php elseif ($current_view === 'event_detail' && $event_detail): ?>
                    <?php
                    // Etkinlik detayları için veri hazırlığı
                    $status = $event_detail['status'] ?? 'planlanıyor';
                    $category = $event_detail['category'] ?? 'Genel';
                    $priority = $event_detail['priority'] ?? 'normal';
                    $featured = $event_detail['featured'] ?? 0;
                    $status_colors = [
                        'planlanıyor' => 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-200',
                        'devam_ediyor' => 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200',
                        'tamamlandı' => 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
                        'iptal' => 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200'
                    ];
                    
                    // Tarih formatlama
                    $turkish_months = [
                        'January' => 'Ocak', 'February' => 'Şubat', 'March' => 'Mart',
                        'April' => 'Nisan', 'May' => 'Mayıs', 'June' => 'Haziran',
                        'July' => 'Temmuz', 'August' => 'Ağustos', 'September' => 'Eylül',
                        'October' => 'Ekim', 'November' => 'Kasım', 'December' => 'Aralık'
                    ];
                    $turkish_days = [
                        'Monday' => 'Pazartesi', 'Tuesday' => 'Salı', 'Wednesday' => 'Çarşamba',
                        'Thursday' => 'Perşembe', 'Friday' => 'Cuma', 'Saturday' => 'Cumartesi', 'Sunday' => 'Pazar'
                    ];
                    $formatted_date = date('d F Y (l)', strtotime($event_detail['date']));
                    foreach ($turkish_months as $en => $tr) {
                        $formatted_date = str_replace($en, $tr, $formatted_date);
                    }
                    foreach ($turkish_days as $en => $tr) {
                        $formatted_date = str_replace($en, $tr, $formatted_date);
                    }
                    
                    // RSVP verileri
                    if (!isset($rsvp_list) || !is_array($rsvp_list)) {
                        $rsvp_list = [];
                        try {
                            ensure_event_rsvp_table($db);
                            $rsvp_stmt = $db->prepare("SELECT * FROM event_rsvp WHERE event_id = ? AND club_id = ? ORDER BY created_at DESC");
                            if ($rsvp_stmt) {
                                $rsvp_stmt->bindValue(1, $event_detail['id'], SQLITE3_INTEGER);
                                $rsvp_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                $rsvp_result = $rsvp_stmt->execute();
                                while ($rsvp_result && ($row = $rsvp_result->fetchArray(SQLITE3_ASSOC))) {
                                    $rsvp_list[] = $row;
                                }
                            }
                        } catch (Exception $e) {
                            // Sessizce geç
                        }
                    }
                    $attending_count = count(array_filter($rsvp_list, function($r) { return ($r['rsvp_status'] ?? '') === 'attending'; }));
                    
                    // Anket verileri
                    $survey = $event_detail['survey'] ?? get_event_survey($event_detail['id']);
                    $survey_exists = !empty($survey);
                    ?>
                    <div data-view="event_detail" class="max-w-7xl mx-auto">
                        <!-- Unified Main Card -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg card-shadow border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-8 py-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-3">
                                            <a href="?view=events" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-white/20 hover:bg-white/30 text-white transition-colors">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                                </svg>
                                            </a>
                                            <div class="flex flex-wrap items-center gap-2">
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <?= $status_colors[$status] ?? $status_colors['planlanıyor'] ?> bg-white/20 backdrop-blur-sm">
                                                    <?= ucfirst($status) ?>
                                                </span>
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 backdrop-blur-sm text-white">
                                                    <?= htmlspecialchars($category) ?>
                                                </span>
                                                <?php if ($priority === 'yüksek'): ?>
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-500/80 backdrop-blur-sm text-white">
                                                    Yüksek Öncelik
                                                </span>
                                                <?php endif; ?>
                                                <?php if ($featured): ?>
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-500/80 backdrop-blur-sm text-white">
                                                    Öne Çıkarılmış
                                                </span>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <h1 class="text-3xl font-bold text-white mb-1"><?= htmlspecialchars($event_detail['title']) ?></h1>
                                        <p class="text-white/80 text-sm">ID: #<?= $event_detail['id'] ?></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Content -->
                            <div class="p-8">
                                <!-- Essential Info Grid -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 pb-8 border-b-2 border-gray-200 dark:border-gray-700">
                                    <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-all">
                                        <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M16 11h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Tarih</p>
                                            <p class="text-sm font-semibold text-gray-900 dark:text-gray-100"><?= $formatted_date ?></p>
                                            <?php if (!empty($event_detail['end_datetime'])): 
                                                $end_date = new DateTime($event_detail['end_datetime']);
                                            ?>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Bitiş: <?= $end_date->format('d.m.Y H:i') ?></p>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-all">
                                        <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Saat</p>
                                            <p class="text-sm font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($event_detail['time']) ?></p>
                                            <?php if (!empty($event_detail['end_time'])): ?>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Bitiş: <?= htmlspecialchars($event_detail['end_time']) ?></p>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-all">
                                        <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Konum</p>
                                            <p class="text-sm font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($event_detail['location'] ?: 'Belirtilmemiş') ?></p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-all">
                                        <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Katılımcı</p>
                                            <p class="text-sm font-semibold text-gray-900 dark:text-gray-100"><?= $attending_count ?> / <?= count($rsvp_list) ?></p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">RSVP yanıtı</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Description and Media Row -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                    <div class="lg:col-span-2">
                                        <div class="mb-6">
                                            <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Açıklama
                                            </h3>
                                            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700">
                                                <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap"><?= nl2br(htmlspecialchars($event_detail['description'] ?: 'Bu etkinlik için detaylı açıklama bulunmamaktadır.')) ?></p>
                                            </div>
                                        </div>
                                        
                                        <?php if (!empty($event_detail['image_path']) || !empty($event_detail['video_path'])): ?>
                                        <div>
                                            <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                Medya
                                            </h3>
                                            <div class="space-y-3">
                                                <?php if (!empty($event_detail['image_path'])): ?>
                                                <div>
                                                    <img src="<?= htmlspecialchars($event_detail['image_path']) ?>" 
                                                         alt="Etkinlik Görseli" 
                                                         class="w-full h-64 object-cover rounded-lg shadow-sm border border-gray-200 dark:border-gray-600"
                                                         onerror="this.style.display='none';">
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['video_path'])): ?>
                                                <div>
                                                    <video controls class="w-full h-64 object-cover rounded-lg shadow-sm border border-gray-200 dark:border-gray-600">
                                                        <source src="<?= htmlspecialchars($event_detail['video_path']) ?>" type="video/mp4">
                                                        <source src="<?= htmlspecialchars($event_detail['video_path']) ?>" type="video/quicktime">
                                                        Tarayıcınız video oynatmayı desteklemiyor.
                                                    </video>
                                                </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <?php endif; ?>
                                    </div>
                                    
                                    <!-- Sidebar Info -->
                                    <div class="space-y-6">
                                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border-2 border-gray-200 dark:border-gray-700">
                                            <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-3 border-b-2 border-gray-200 dark:border-gray-700">Detaylar</h3>
                                            <div class="space-y-3">
                                                <?php if (!empty($event_detail['organizer'])): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Organizatör</span>
                                                    <span class="text-xs font-semibold text-gray-900 dark:text-gray-100 text-right"><?= htmlspecialchars($event_detail['organizer']) ?></span>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['contact_email'])): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">E-posta</span>
                                                    <a href="mailto:<?= htmlspecialchars($event_detail['contact_email']) ?>" class="text-xs font-semibold text-purple-600 dark:text-purple-400 hover:underline text-right"><?= htmlspecialchars($event_detail['contact_email']) ?></a>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['contact_phone'])): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Telefon</span>
                                                    <a href="tel:<?= htmlspecialchars($event_detail['contact_phone']) ?>" class="text-xs font-semibold text-purple-600 dark:text-purple-400 hover:underline text-right"><?= htmlspecialchars($event_detail['contact_phone']) ?></a>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (isset($event_detail['cost']) && $event_detail['cost'] > 0): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Ücret</span>
                                                    <span class="text-xs font-semibold text-gray-900 dark:text-gray-100 text-right"><?= number_format($event_detail['cost'], 2) ?> TL</span>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['capacity'])): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Kapasite</span>
                                                    <span class="text-xs font-semibold text-gray-900 dark:text-gray-100 text-right"><?= $event_detail['capacity'] ?> kişi</span>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['registration_deadline'])): ?>
                                                <div class="flex items-center justify-between py-2.5 border-b border-gray-100 dark:border-gray-700">
                                                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Kayıt Son Tarihi</span>
                                                    <span class="text-xs font-semibold text-gray-900 dark:text-gray-100 text-right"><?= date('d.m.Y H:i', strtotime($event_detail['registration_deadline'])) ?></span>
                                                </div>
                                                <?php endif; ?>
                                                
                                                <?php if (!empty($event_detail['tags'])): 
                                                    $tags = json_decode($event_detail['tags'], true);
                                                    if (is_array($tags) && count($tags) > 0):
                                                ?>
                                                <div class="pt-3">
                                                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Etiketler</p>
                                                    <div class="flex flex-wrap gap-1.5">
                                                        <?php foreach ($tags as $tag): ?>
                                                        <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 border border-purple-200 dark:border-purple-700">
                                                            <?= htmlspecialchars(trim($tag)) ?>
                                                        </span>
                                                        <?php endforeach; ?>
                                                    </div>
                                                </div>
                                                <?php endif; endif; ?>
                                                
                                                <?php if (!empty($event_detail['external_link'])): ?>
                                                <div class="pt-2">
                                                    <a href="<?= htmlspecialchars($event_detail['external_link']) ?>" target="_blank" rel="noopener noreferrer" 
                                                       class="inline-flex items-center gap-1.5 text-xs font-semibold text-purple-600 dark:text-purple-400 hover:underline">
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                        </svg>
                                                        Dış Bağlantı
                                                    </a>
                                                </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        
                                        <!-- RSVP List -->
                                        <?php if (count($rsvp_list) > 0): ?>
                                        <div class="bg-white dark:bg-gray-800 rounded-xl p-5 border-2 border-gray-200 dark:border-gray-700">
                                            <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-gray-200 dark:border-gray-700">
                                                <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Katılımcılar</h3>
                                                <div class="flex items-center gap-2">
                                                    <span class="px-2.5 py-1 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-xs font-semibold border border-purple-200 dark:border-purple-700"><?= $attending_count ?></span>
                                                    <span class="px-2.5 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg text-xs font-semibold border border-gray-200 dark:border-gray-600"><?= count($rsvp_list) - $attending_count ?></span>
                                                </div>
                                            </div>
                                            <div class="max-h-64 overflow-y-auto space-y-2">
                                                <?php foreach (array_slice($rsvp_list, 0, 10) as $rsvp): ?>
                                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-xs font-medium text-gray-900 dark:text-gray-100 truncate"><?= htmlspecialchars($rsvp['member_name']) ?></p>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate"><?= htmlspecialchars($rsvp['member_email']) ?></p>
                                                    </div>
                                                    <?php if ($rsvp['rsvp_status'] === 'attending'): ?>
                                                    <span class="ml-2 inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 border border-purple-200 dark:border-purple-700 flex-shrink-0">
                                                        Katılacak
                                                    </span>
                                                    <?php else: ?>
                                                    <span class="ml-2 inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 flex-shrink-0">
                                                        Katılmayacak
                                                    </span>
                                                    <?php endif; ?>
                                                </div>
                                                <?php endforeach; ?>
                                                <?php if (count($rsvp_list) > 10): ?>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 text-center pt-2">+<?= count($rsvp_list) - 10 ?> katılımcı daha</p>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <?php endif; ?>
                                    </div>
                                </div>
                                
                                <!-- Survey Section -->
                                <div class="border-t-2 border-gray-200 dark:border-gray-700 pt-8">
                                    <div class="flex items-center justify-between mb-6">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Etkinlik Anketi</h3>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                                    <?= $survey_exists && !empty($survey['is_active']) ? 'Aktif' : 'Henüz oluşturulmadı' ?>
                                                </p>
                                            </div>
                                        </div>
                                        <button onclick="openSurveyModal(<?= $event_detail['id'] ?>)" 
                                                class="inline-flex items-center gap-2 px-4 py-2 <?= $survey_exists ? 'bg-purple-600 hover:bg-purple-700' : 'bg-white border-2 border-purple-600 text-purple-600 hover:bg-purple-50' ?> text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                            <?= $survey_exists ? 'Düzenle' : 'Oluştur' ?>
                                        </button>
                                    </div>
                                    
                                    <?php if ($survey_exists): 
                                        $survey_total_responses = (int)($survey['total_responses'] ?? 0);
                                        $survey_participant_count = (int)($survey['participant_count'] ?? 0);
                                    ?>
                                    <div class="grid grid-cols-3 gap-4 mb-6">
                                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-purple-200 dark:border-purple-700 text-center">
                                            <p class="text-xs font-medium text-purple-600 dark:text-purple-400 uppercase tracking-wide mb-1">Katılımcı</p>
                                            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= $survey_participant_count ?></p>
                                        </div>
                                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700 text-center">
                                            <p class="text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-1">Yanıt</p>
                                            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= $survey_total_responses ?></p>
                                        </div>
                                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-gray-200 dark:border-gray-700 text-center">
                                            <p class="text-xs font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide mb-1">Soru</p>
                                            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= count($survey['questions'] ?? []) ?></p>
                                        </div>
                                    </div>
                                    
                                    <?php if (!empty($survey['questions'])): ?>
                                    <div class="space-y-4">
                                        <?php foreach ($survey['questions'] as $index => $question): 
                                            $question_total = (int)($question['total_responses'] ?? 0);
                                            $question_title = $question['question_text'] ?? '';
                                            $question_options = $question['options'] ?? [];
                                        ?>
                                        <div class="border-2 border-gray-200 dark:border-gray-700 rounded-xl p-5 bg-white dark:bg-gray-800">
                                            <div class="flex items-start justify-between mb-4">
                                                <div class="flex items-start gap-3 flex-1">
                                                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-lg bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 text-xs font-bold flex-shrink-0 border border-purple-200 dark:border-purple-700"><?= $index + 1 ?></span>
                                                    <div class="flex-1 min-w-0">
                                                        <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($question_title) ?></h4>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5"><?= ($question['question_type'] ?? 'multiple_choice') === 'multiple_choice' ? 'Çoktan seçmeli' : 'Metin yanıtı' ?></p>
                                                    </div>
                                                </div>
                                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400 ml-2 flex-shrink-0"><?= $question_total ?> yanıt</span>
                                            </div>
                                            
                                            <?php if (!empty($question_options)): ?>
                                            <div class="space-y-3">
                                                <?php foreach ($question_options as $option): 
                                                    $option_text = $option['option_text'] ?? '';
                                                    $option_count = (int)($option['response_count'] ?? 0);
                                                    $option_percentage = $question_total > 0 ? round(($option_count / $question_total) * 100, 1) : 0;
                                                    $bar_width = $question_total > 0 ? max(4, min(100, $option_percentage)) : 0;
                                                ?>
                                                <div>
                                                    <div class="flex items-center justify-between text-xs mb-2">
                                                        <span class="font-medium text-gray-700 dark:text-gray-300 truncate"><?= htmlspecialchars($option_text) ?></span>
                                                        <span class="font-semibold text-gray-900 dark:text-gray-100 ml-2 flex-shrink-0"><?= number_format($option_percentage, 1) ?>% (<?= $option_count ?>)</span>
                                                    </div>
                                                    <div class="h-2.5 rounded-full bg-gray-200 dark:bg-gray-700 overflow-hidden">
                                                        <div class="h-full rounded-full bg-purple-600" style="width: <?= $bar_width ?>%;"></div>
                                                    </div>
                                                </div>
                                                <?php endforeach; ?>
                                            </div>
                                            <?php endif; ?>
                                        </div>
                                        <?php endforeach; ?>
                                    </div>
                                    <?php endif; ?>
                                    <?php else: ?>
                                    <div class="text-center py-8">
                                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Henüz anket oluşturulmamış</p>
                                    </div>
                                    <?php endif; ?>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="flex flex-wrap items-center gap-3 pt-6 mt-8 border-t border-gray-200 dark:border-gray-700">
                                    <button onclick="openEditModal('event', <?= (int)$event_detail['id'] ?>, <?= tpl_js_escaped($event_detail['title'] ?? '') ?>, <?= tpl_js_escaped($event_detail['date'] ?? '') ?>, <?= tpl_js_escaped($event_detail['time'] ?? '') ?>, <?= tpl_js_escaped($event_detail['location'] ?? '') ?>, <?= tpl_js_escaped(preg_replace('/\r|\n/', ' ', $event_detail['description'] ?? '')) ?>)" 
                                            class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Düzenle
                                    </button>
                                    
                                    <button onclick="openSurveyModal(<?= $event_detail['id'] ?>)" 
                                            class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                        Anket
                                    </button>
                                    
                                    <button onclick="openMediaUploadModal(<?= $event_detail['id'] ?>)" 
                                            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold transition-all duration-200">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Medya
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                <?php elseif ($current_view === 'events'): ?>
                    <div data-view="events" class="space-y-8 max-w-full overflow-x-hidden">
                        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm p-6 section-card max-w-full overflow-x-hidden">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
                                            Etkinlik Yönetimi
                                        </h2>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                                            <?= isset($total_events_count) ? $total_events_count : count($events) ?> etkinlik
                                            <?php if ($has_more_events): ?>
                                                <span class="text-xs text-indigo-600 dark:text-indigo-400">(<?= count($events) ?> gösteriliyor)</span>
                                            <?php endif; ?>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="relative group">
                                        <button class="px-4 py-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-500 dark:text-indigo-300 rounded-lg font-medium shadow-sm transition duration-150 hover:bg-indigo-200 dark:hover:bg-indigo-800/50 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Dışa Aktar
                                        </button>
                                        <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700 hidden group-hover:block z-10">
                                            <a href="?action=export_events_csv" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20">CSV olarak</a>
                                            <a href="?action=export_events_excel" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20">Excel olarak</a>
                                        </div>
                                    </div>
                                    <button onclick="document.getElementById('importEventsModal').classList.remove('hidden')" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm transition duration-150 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                        İçe Aktar
                                    </button>
                                    <button onclick="openAddModal('event')" id="open-event-modal-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Yeni Etkinlik
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtreleme ve Arama -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <input type="text" id="event_search" onkeyup="filterEvents()" placeholder="Ara..." 
                                           class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-transparent transition-all">
                                </div>
                                <div>
                                    <select id="filter_status" onchange="filterEvents()" 
                                            class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-transparent transition-all">
                                        <option value="">Tüm Durumlar</option>
                                        <option value="planlanıyor">Planlanıyor</option>
                                        <option value="devam_ediyor">Devam Ediyor</option>
                                        <option value="tamamlandı">Tamamlandı</option>
                                        <option value="iptal">İptal</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="filter_category" onchange="filterEvents()" 
                                            class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-transparent transition-all">
                                        <option value="">Tüm Kategoriler</option>
                                        <option value="Genel">Genel</option>
                                        <option value="Seminer">Seminer</option>
                                        <option value="Workshop">Workshop</option>
                                        <option value="Kongre">Kongre</option>
                                        <option value="Sosyal">Sosyal Etkinlik</option>
                                        <option value="Spor">Spor</option>
                                        <option value="Kültür">Kültür & Sanat</option>
                                        <option value="Eğitim">Eğitim</option>
                                        <option value="Teknoloji">Teknoloji</option>
                                    </select>
                                </div>
                                <div>
                                    <select id="sort_events" onchange="sortEvents()" 
                                            class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500 focus:border-transparent transition-all">
                                        <option value="date_desc">Tarih (Yeni → Eski)</option>
                                        <option value="date_asc">Tarih (Eski → Yeni)</option>
                                        <option value="title_asc">Başlık (A → Z)</option>
                                        <option value="title_desc">Başlık (Z → A)</option>
                                        <option value="priority">Öncelik</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Desktop Tablo Görünümü (Gizlendi - Grid görünümü kullanılıyor) -->
                            <div class="hidden overflow-x-auto max-w-full">
                                <table class="min-w-full divide-y divide-gray-100 dark:divide-gray-700/50" id="eventsTable">
                                    <thead class="bg-gray-50/50 dark:bg-gray-800/50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Başlık</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Kategori</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Tarih/Saat</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Durum</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Konum</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Medya</th>
                                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-100 dark:divide-gray-700/30" id="eventsTableBody">
                                        <?php if (count($events) > 0): ?>
                                        <?php foreach ($events as $event): 
                                            $status = $event['status'] ?? 'planlanıyor';
                                            $category = $event['category'] ?? 'Genel';
                                            $priority = $event['priority'] ?? 'normal';
                                            $featured = $event['featured'] ?? 0;
                                            $is_past = strtotime($event['date']) < strtotime('today');
                                            $status_colors = [
                                                'planlanıyor' => 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                                                'devam_ediyor' => 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                                                'tamamlandı' => 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
                                                'iptal' => 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                            ];
                                            $priority_colors = [
                                                'yüksek' => 'text-red-600 dark:text-red-400',
                                                'normal' => 'text-gray-600 dark:text-gray-400',
                                                'düşük' => 'text-gray-400 dark:text-gray-500'
                                            ];
                                        ?>
                                        <tr id="event-row-<?= $event['id'] ?>" 
                                            class="event-row hover:bg-gray-50/50 dark:hover:bg-gray-700/30 transition-colors"
                                            data-title="<?= strtolower(htmlspecialchars($event['title'])) ?>"
                                            data-status="<?= $status ?>"
                                            data-category="<?= $category ?>"
                                            data-priority="<?= $priority ?>"
                                            data-date="<?= $event['date'] ?>">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <?php if ($featured): ?>
                                                        <svg class="w-4 h-4 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                        </svg>
                                                    <?php endif; ?>
                                                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($event['title']) ?></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="text-sm text-gray-700 dark:text-gray-300"><?= htmlspecialchars($category) ?></span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm text-gray-700 dark:text-gray-300">
                                                    <?= date('d/m/Y', strtotime($event['date'])) ?>
                                                    <?php if ($event['time']): ?>
                                                        <span class="text-gray-500 dark:text-gray-400">@ <?= htmlspecialchars($event['time']) ?></span>
                                                    <?php endif; ?>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?= $status_colors[$status] ?? $status_colors['planlanıyor'] ?>">
                                                    <?= ucfirst($status) ?>
                                                </span>
                                                <?php if ($priority === 'yüksek'): ?>
                                                    <span class="ml-2 text-xs <?= $priority_colors[$priority] ?>">⚡</span>
                                                <?php endif; ?>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300"><?= htmlspecialchars($event['location'] ?: '-') ?></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex space-x-2">
                                                    <?php if (!empty($event['image_path'])): ?>
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                                            </svg>
                                                            Görsel
                                                        </span>
                                                    <?php endif; ?>
                                                    <?php if (!empty($event['video_path'])): ?>
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                                            </svg>
                                                            Video
                                                        </span>
                                                    <?php endif; ?>
                                                    <?php if (empty($event['image_path']) && empty($event['video_path'])): ?>
                                                        <span class="text-gray-400 dark:text-gray-500 text-xs">-</span>
                                                    <?php endif; ?>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <a href="?view=event_detail&event_id=<?= $event['id'] ?>" class="text-indigo-500 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold mx-2 transition duration-150">Görüntüle</a>
                                                <button onclick="openEditModal('event', <?= (int)$event['id'] ?>, <?= tpl_js_escaped($event['title'] ?? '') ?>, <?= tpl_js_escaped($event['date'] ?? '') ?>, <?= tpl_js_escaped($event['time'] ?? '') ?>, <?= tpl_js_escaped($event['location'] ?? '') ?>, <?= tpl_js_escaped(preg_replace('/\r|\n/', ' ', $event['description'] ?? '')) ?>)" 
                                                        class="text-indigo-500 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold mx-2 transition duration-150">Düzenle</button>
                                                <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu etkinliği silmek istediğinizden emin misiniz?');">
                                                    <input type="hidden" name="action" value="delete_event">
                                                    <input type="hidden" name="current_view" value="events">
                                                    <input type="hidden" name="id" value="<?= $event['id'] ?>">
                                                    <?= csrf_token_field() ?>
                                                    <button type="submit" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold transition duration-150">Sil</button>
                                                </form>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                        <?php else: ?>
                                            <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Henüz kayıtlı bir etkinlik yok.</td></tr>
                                        <?php endif; ?>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Mobil ve Desktop Kart Görünümü -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="eventsCardsContainer">
                                <?php if (count($events) > 0): ?>
                                <?php foreach ($events as $event): 
                                    $status = $event['status'] ?? 'planlanıyor';
                                    $category = $event['category'] ?? 'Genel';
                                    $priority = $event['priority'] ?? 'normal';
                                    $featured = $event['featured'] ?? 0;
                                    $is_past = strtotime($event['date']) < strtotime('today');
                                    $status_colors = [
                                        'planlanıyor' => 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200',
                                        'devam_ediyor' => 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                                        'tamamlandı' => 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
                                        'iptal' => 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                    ];
                                    $priority_colors = [
                                        'yüksek' => 'text-red-600 dark:text-red-400',
                                        'normal' => 'text-gray-600 dark:text-gray-400',
                                        'düşük' => 'text-gray-400 dark:text-gray-500'
                                    ];
                                    // Etkinlik görseli kontrolü
                                    $event_image = !empty($event['image_path']) ? $event['image_path'] : null;
                                    if (!$event_image) {
                                        $images_stmt = $db->prepare("SELECT image_path FROM event_images WHERE event_id = ? AND club_id = ? ORDER BY uploaded_at DESC LIMIT 1");
                                        $images_stmt->bindValue(1, $event['id'], SQLITE3_INTEGER);
                                        $images_stmt->bindValue(2, CLUB_ID, SQLITE3_INTEGER);
                                        $images_result = $images_stmt->execute();
                                        $image_row = $images_result->fetchArray(SQLITE3_ASSOC);
                                        if ($image_row) {
                                            $event_image = $image_row['image_path'];
                                        }
                                    }
                                    // Gradient renkleri kategoriye göre
                                    $gradient_colors = [
                                        'Genel' => 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        'Seminer' => 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                        'Workshop' => 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                        'Kongre' => 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                        'Sosyal' => 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                        'Spor' => 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                                        'Kültür' => 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                        'Eğitim' => 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                        'Teknoloji' => 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                    ];
                                    $gradient = $gradient_colors[$category] ?? $gradient_colors['Genel'];
                                    // RSVP sayısı
                                    ensure_event_rsvp_table($db);
                                    $rsvp_stmt = $db->prepare("SELECT COUNT(*) as count FROM event_rsvp WHERE event_id = ? AND rsvp_status = 'attending'");
                                    $rsvp_stmt->bindValue(1, $event['id'], SQLITE3_INTEGER);
                                    $rsvp_result = $rsvp_stmt->execute();
                                    $rsvp_count = $rsvp_result->fetchArray()['count'] ?? 0;
                                ?>
                                <div class="event-card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col"
                                     data-title="<?= strtolower(htmlspecialchars($event['title'])) ?>"
                                     data-status="<?= $status ?>"
                                     data-category="<?= $category ?>"
                                     data-priority="<?= $priority ?>"
                                     data-date="<?= $event['date'] ?>">
                                    <!-- Event Image -->
                                    <div class="event-image relative h-48 overflow-hidden bg-white dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                                        <?php if ($event_image): ?>
                                            <img src="<?= htmlspecialchars($event_image) ?>" 
                                                 alt="<?= htmlspecialchars($event['title']) ?>" 
                                                 class="w-full h-full object-cover"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <?php endif; ?>
                                        <div class="absolute inset-0 flex items-center justify-center" style="<?= $event_image ? 'display: none;' : '' ?>">
                                            <div class="flex flex-col items-center justify-center">
                                                <svg class="w-16 h-16 text-indigo-500 dark:text-indigo-400 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span class="mt-2 text-xs text-gray-400 dark:text-gray-500 font-medium">Etkinlik Görseli</span>
                                            </div>
                                        </div>
                                                <?php if ($featured): ?>
                                            <div class="absolute top-3 right-3">
                                                <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                    </svg>
                                            </div>
                                                <?php endif; ?>
                                            </div>
                                    
                                    <!-- Event Content -->
                                    <div class="p-5 flex flex-col flex-grow">
                                        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-3 line-clamp-2">
                                            <?= htmlspecialchars($event['title']) ?>
                                        </h3>
                                        
                                        <div class="space-y-2 mb-4 flex-grow">
                                            <?php if ($event['location']): ?>
                                                <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                                    <i class="fas fa-map-marker-alt text-indigo-500 dark:text-indigo-400 w-4 mr-2"></i>
                                                    <span><?= htmlspecialchars($event['location']) ?></span>
                                                </div>
                                            <?php endif; ?>
                                            
                                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                                <i class="fas fa-clock text-indigo-500 dark:text-indigo-400 w-4 mr-2"></i>
                                                <span><?= date('d/m/Y', strtotime($event['date'])) ?></span>
                                                <?php if ($event['time']): ?>
                                                    <span class="ml-2"><?= htmlspecialchars($event['time']) ?></span>
                                                <?php endif; ?>
                                            </div>
                                            
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold <?= $status_colors[$status] ?? $status_colors['planlanıyor'] ?>">
                                                    <?= ucfirst($status) ?>
                                                    </span>
                                                <span class="text-xs text-gray-500 dark:text-gray-400"><?= htmlspecialchars($category) ?></span>
                                                <?php if ($priority === 'yüksek'): ?>
                                                    <span class="text-xs <?= $priority_colors[$priority] ?>">⚡</span>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        
                                        <!-- Footer -->
                                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                                <i class="fas fa-users text-indigo-500 dark:text-indigo-400 mr-1.5"></i>
                                                <span><?= $rsvp_count ?> katılımcı</span>
                                    </div>
                                            <div class="flex gap-2">
                                                <a href="?view=event_detail&event_id=<?= $event['id'] ?>" 
                                                   class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-xs font-semibold transition">
                                                    Detay
                                        </a>
                                        <button onclick="openEditModal('event', <?= (int)$event['id'] ?>, <?= tpl_js_escaped($event['title'] ?? '') ?>, <?= tpl_js_escaped($event['date'] ?? '') ?>, <?= tpl_js_escaped($event['time'] ?? '') ?>, <?= tpl_js_escaped($event['location'] ?? '') ?>, <?= tpl_js_escaped(preg_replace('/\r|\n/', ' ', $event['description'] ?? '')) ?>)" 
                                                        class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-xs font-semibold transition">
                                            Düzenle
                                        </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <?php endforeach; ?>
                                <?php else: ?>
                                    <div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">
                                        <p class="text-lg">Henüz kayıtlı bir etkinlik yok.</p>
                                    </div>
                                <?php endif; ?>
                            </div>
                            
                            <!-- Lazy Loading Spinner for Events -->
                            <div id="eventsLoadingSpinner" class="mt-6 text-center hidden" style="min-height: 60px;">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Etkinlikler yükleniyor...</p>
                            </div>
                            
                        </div>
                    </div>

                <?php elseif ($current_view === 'members'): ?>
                    <div data-view="members" class="max-w-full overflow-x-hidden">
                        <!-- Tüm İçerik Tek Kart İçinde -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 section-card">
                            <!-- Başlık -->
                            <div class="mb-8 flex flex-wrap items-start justify-between gap-4 border-b border-gray-200 dark:border-gray-700 pb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Üye Listesi</h1>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Toplam <strong><?= isset($total_members_count) ? $total_members_count : count($members) ?></strong> kayıtlı üye
                                            <?php if ($has_more_members): ?>
                                                <span class="text-xs text-indigo-600 dark:text-indigo-400">(<?= count($members) ?> gösteriliyor)</span>
                                            <?php endif; ?>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <div class="relative group">
                                        <button class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium shadow-sm transition duration-150 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Dışa Aktar
                                        </button>
                                        <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden group-hover:block z-10">
                                            <a href="?action=export_members_csv" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-t-lg">CSV olarak</a>
                                            <a href="?action=export_members_excel" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-b-lg">Excel olarak</a>
                                        </div>
                                    </div>
                                    <button onclick="document.getElementById('importMembersModal').classList.remove('hidden')" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium shadow-sm transition duration-150 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                        İçe Aktar
                                    </button>
                                    <button onclick="openAddModal('member')" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow-sm transition duration-200 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        Yeni Üye Ekle
                                    </button>
                                </div>
                            </div>

                            <!-- Bekleyen Üyelik Başvuruları -->
                        <?php if (!empty($pending_membership_requests)): ?>
                            <div class="mb-8 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                                <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        Bekleyen Üyelik Başvuruları (<?= count($pending_membership_requests) ?>)
                                    </h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Aşağıdaki başvuruları onaylayarak üyelik kaydı oluşturabilir veya reddedebilirsiniz.</p>
                                </div>
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                    <?= count($pending_membership_requests) ?> bekleyen başvuru
                                </span>
                            </div>
                            <div class="space-y-3">
                                <?php foreach ($pending_membership_requests as $request): ?>
                                    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-5">
                                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                        <div class="space-y-1">
                                                <div class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-gray-100">
                                                    <svg class="w-4 h-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                    </svg>
                                                <?= htmlspecialchars($request['full_name'] ?? 'İsimsiz Başvuru') ?>
                                            </div>
                                                <div class="flex flex-wrap gap-3 text-xs text-gray-500 dark:text-gray-400">
                                                <?php if (!empty($request['email'])): ?>
                                                <span class="inline-flex items-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                        </svg>
                                                    <?= htmlspecialchars($request['email']) ?>
                                                </span>
                                                <?php endif; ?>
                                                <?php if (!empty($request['phone'])): ?>
                                                <span class="inline-flex items-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                                        </svg>
                                                    <?= htmlspecialchars($request['phone']) ?>
                                                </span>
                                                <?php endif; ?>
                                                <?php if (!empty($request['student_id'])): ?>
                                                <span class="inline-flex items-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                                                        </svg>
                                                    <?= htmlspecialchars($request['student_id']) ?>
                                                </span>
                                                <?php endif; ?>
                                                <?php if (!empty($request['department'])): ?>
                                                <span class="inline-flex items-center gap-1">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                                        </svg>
                                                    <?= htmlspecialchars($request['department']) ?>
                                                </span>
                                                <?php endif; ?>
                                            </div>
                                                <div class="text-xs text-gray-400 dark:text-gray-500">
                                                Başvuru tarihi: <?= isset($request['created_at']) ? date('d.m.Y H:i', strtotime($request['created_at'])) : 'Bilinmiyor' ?>
                                            </div>
                                        </div>
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full lg:w-auto">
                                            <form method="POST" action="index.php" class="flex-1 sm:flex-none">
                                                <input type="hidden" name="action" value="approve_membership_request">
                                                <input type="hidden" name="current_view" value="members">
                                                <input type="hidden" name="request_id" value="<?= $request['id'] ?>">
                                                <?= csrf_token_field() ?>
                                                    <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg shadow-sm transition">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                    Onayla ve Üye Yap
                                                </button>
                                            </form>
                                            <form method="POST" action="index.php" class="flex-1 sm:flex items-center gap-2">
                                                <input type="hidden" name="action" value="reject_membership_request">
                                                <input type="hidden" name="current_view" value="members">
                                                <input type="hidden" name="request_id" value="<?= $request['id'] ?>">
                                                <?= csrf_token_field() ?>
                                                    <input type="text" name="admin_notes" placeholder="Not (opsiyonel)" class="w-full sm:w-40 px-3 py-2 text-xs border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-red-300 dark:focus:ring-red-500" />
                                                    <button type="submit" class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-lg shadow-sm transition" onclick="return confirm('Bu üyelik başvurusunu reddetmek istediğinize emin misiniz?');">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                        </svg>
                                                    Reddet
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <?php endforeach; ?>
                            </div>
                            
                        </div>
                        <?php endif; ?>
                            
                            <!-- Arama -->
                            <div class="mb-6">
                            <div class="relative">
                                    <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-gray-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M5 11a6 6 0 1112 0 6 6 0 01-12 0z"></path>
                                    </svg>
                                </span>
                                    <input type="text" id="member_search" onkeyup="filterMemberCards()" placeholder="Üye adı, e-posta, öğrenci no veya telefon ile arama yapın..." class="w-full pl-10 pr-4 py-3 text-sm border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-200">
                                </div>
                            </div>

                            <!-- Üye Kartları -->
                            <div class="space-y-6">
                                        <?php if (count($members) > 0): ?>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="member_cards_container">
                                <?php foreach ($members as $member): 
                                    $full_name = htmlspecialchars($member['full_name'] ?: 'İsimsiz Üye');
                                    $name_parts = explode(' ', $full_name, 2);
                                    $first_name = $name_parts[0] ?? '';
                                    $last_name = $name_parts[1] ?? '';
                                    $initials = strtoupper(substr($first_name, 0, 1) . (isset($name_parts[1]) ? substr($last_name, 0, 1) : ''));
                                ?>
                                <div class="member-card bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg p-5 hover:shadow-md transition-all duration-200" 
                                     data-name="<?= strtolower($full_name) ?>"
                                     data-email="<?= strtolower(htmlspecialchars($member['email'] ?: '')) ?>"
                                     data-student-id="<?= htmlspecialchars($member['student_id'] ?: '') ?>"
                                     data-phone="<?= htmlspecialchars($member['phone_number'] ?: '') ?>">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-lg shadow-md">
                                                <?= $initials ?: '?' ?>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-slate-900 dark:text-slate-100 text-base"><?= $full_name ?></h3>
                                                <?php if ($member['student_id']): ?>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5"><?= htmlspecialchars($member['student_id']) ?></p>
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1">
                                                <button onclick="openEditModal('member', <?= (int)$member['id'] ?>, <?= tpl_js_escaped($member['full_name'] ?? '') ?>, <?= tpl_js_escaped($member['email'] ?? '') ?>, <?= tpl_js_escaped($member['student_id'] ?? '') ?>, <?= tpl_js_escaped($member['phone_number'] ?? '') ?>)" 
                                                    class="p-2 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition duration-150" title="Düzenle">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                            </button>
                                                <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu üyeyi listeden kaldırmak istediğinizden emin misiniz?');">
                                                    <input type="hidden" name="action" value="delete_member">
                                                    <input type="hidden" name="current_view" value="members">
                                                    <input type="hidden" name="id" value="<?= $member['id'] ?>">
                                                    <?= csrf_token_field() ?>
                                                <button type="submit" class="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition duration-150" title="Sil">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                                </button>
                                                </form>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <?php if ($member['email']): ?>
                                        <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                            <span class="truncate"><?= htmlspecialchars($member['email']) ?></span>
                                        </div>
                                        <?php endif; ?>
                                        
                                        <?php if ($member['phone_number']): ?>
                                        <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                            <span><?= htmlspecialchars($member['phone_number']) ?></span>
                                        </div>
                                        <?php endif; ?>
                                        
                                        <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 pt-2 border-t border-slate-100 dark:border-slate-700">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            <span>Kayıt: <?= date('d.m.Y', strtotime($member['registration_date'])) ?></span>
                                        </div>
                                    </div>
                                </div>
                                        <?php endforeach; ?>
                            </div>
                            
                                        <?php else: ?>
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <p class="text-gray-500 dark:text-gray-400 text-lg font-medium">Henüz kayıtlı üye yok</p>
                                <p class="text-gray-400 dark:text-gray-500 text-sm mt-2">Yeni üye eklemek için yukarıdaki butonu kullanın</p>
                            </div>
                                        <?php endif; ?>
                            </div>
                            
                            <!-- Lazy Loading Spinner for Members -->
                            <div id="membersLoadingSpinner" class="mt-6 text-center hidden" style="min-height: 60px;">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Üyeler yükleniyor...</p>
                            </div>
                        </div>
                    </div>

                <?php elseif ($current_view === 'board'): ?>
                    <div data-view="board" class="max-w-full overflow-x-hidden">
                        <!-- Tüm İçerik Tek Kart İçinde -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 section-card">
                            <!-- Başlık -->
                            <div class="mb-8 flex flex-wrap items-start justify-between gap-4 border-b border-gray-200 dark:border-gray-700 pb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Yönetim Kurulu</h1>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Mevcut yönetim kurulu listesi (<?= count($board) ?>)</p>
                                    </div>
                                </div>
                                <button onclick="openAddModal('board')" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow-sm transition duration-200 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Yeni Görevli Ekle
                                </button>
                            </div>

                            <!-- Yönetim Kurulu Tablosu -->
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden">
                            <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Adı Soyadı</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Görevi</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Telefon</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">E-posta</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">İşlemler</th>
                                        </tr>
                                    </thead>
                                        <tbody id="boardMembersContainer" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <?php if (count($board) > 0): ?>
                                        <?php foreach ($board as $officer): ?>
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($officer['full_name']) ?></td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                                        <?= htmlspecialchars($officer['role']) ?>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300"><?= htmlspecialchars($officer['phone'] ?? 'Belirtilmemiş') ?></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300"><?= htmlspecialchars($officer['contact_email']) ?></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button onclick="openEditModal('board', <?= (int)$officer['id'] ?>, <?= tpl_js_escaped($officer['full_name'] ?? '') ?>, <?= tpl_js_escaped($officer['role'] ?? '') ?>, <?= tpl_js_escaped($officer['contact_email'] ?? '') ?>, <?= tpl_js_escaped($officer['phone'] ?? '') ?>)" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold mx-2 transition duration-150">Düzenle</button>
                                                <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu görevliyi silmek istediğinizden emin misiniz?');">
                                                    <input type="hidden" name="action" value="delete_board_member">
                                                    <input type="hidden" name="current_view" value="board">
                                                    <input type="hidden" name="id" value="<?= $officer['id'] ?>">
                                                    <?= csrf_token_field() ?>
                                                        <button type="submit" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold transition duration-150">Sil</button>
                                                </form>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                        <?php else: ?>
                                                <tr>
                                                    <td colspan="5" class="px-6 py-12 text-center">
                                                        <svg class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                        </svg>
                                                        <p class="text-gray-500 dark:text-gray-400 text-lg font-medium">Henüz yönetim kurulu üyesi tanımlanmamış</p>
                                                        <p class="text-gray-400 dark:text-gray-500 text-sm mt-2">Yeni görevli eklemek için yukarıdaki butonu kullanın</p>
                                                    </td>
                                                </tr>
                                        <?php endif; ?>
                                    </tbody>
                                </table>
                                
                                </div>
                            </div>
                            
                        </div>
                    </div>
                
                <?php elseif ($current_view === 'messages'): ?>
                    <?php 
                    // Guard kontrolü zaten yukarıda yapıldı
                    // Eğer guard başarısız olduysa $current_view subscription_required olarak ayarlandı
                    // Bu durumda bu blok çalışmayacak çünkü $current_view artık 'messages' değil
                    
                    // SMS contacts kontrolü - eğer boşsa veya tanımlı değilse hata göster
                    if (!isset($sms_contacts) || !is_array($sms_contacts)) {
                        $sms_contacts = [];
                    }
                        // Tüm SMS contacts sayısını kullan (sadece ilk 50 değil)
                        $smsTotal = isset($all_sms_contacts) ? count($all_sms_contacts) : count($sms_contacts);
                    $messagesLocked = !$messages_feature_available;
                    ?>
                    <?php if ($messagesLocked): ?>
                    <div class="rounded-2xl border border-slate-200 dark:border-white/5 bg-gradient-to-br from-white via-slate-50 to-amber-50/70 dark:from-slate-900 dark:via-slate-900/70 dark:to-amber-900/10 px-6 py-6 mb-6 shadow-lg shadow-amber-200/40 dark:shadow-black/30 relative overflow-hidden">
                        <div class="absolute inset-y-0 right-0 w-1/3 pointer-events-none opacity-20 bg-[radial-gradient(circle_at_top,_rgba(248,113,113,.5),_transparent_55%)]"></div>
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 relative z-10">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/30">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-amber-200/70 dark:border-amber-400/50 bg-amber-50/80 dark:bg-amber-500/10 text-xs font-semibold text-amber-700 dark:text-amber-200">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-7.364l-.707.707M7.343 16.657l-.707.707m0-11.314l.707.707m9.192 9.192l.707.707"></path></svg>
                                        Özellik kilitli
                                    </div>
                                    <p class="text-sm uppercase tracking-wide text-slate-500 dark:text-slate-400 font-semibold">Business</p>
                                    <h3 class="text-xl font-semibold text-slate-900 dark:text-white">Mesaj Merkezi’nin tam sürümünü deneyimleyin</h3>
                                    <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                                        Bu ekran, NetGSM optimizasyonu ve AI destekli içerik araçlarıyla gelen gerçek arayüzün canlı demosudur.
                                        Business pakete geçtiğinizde tüm fonksiyonlar aktif olur.
                                    </p>
                                    <div class="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-300">
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Dinamik üye listeleri
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> 500 + ek SMS kotası
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Gerçek zamanlı NetGSM kontrolü
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="index.php?view=subscription" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold shadow-lg shadow-orange-500/40 transition hover:scale-[1.01]">
                                    Business’a Yükselt
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                <button type="button" onclick="window.location.href='index.php?view=subscription&scroll=features'" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-slate-200 dark:border-white/10 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-white/80 dark:hover:bg-white/5 transition">
                                    Özellikleri İncele
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                    <div data-view="messages" class="space-y-8 <?php if ($messagesLocked) echo 'relative opacity-60 pointer-events-none select-none'; ?>">
                        <?php if (!empty($_SESSION['sms_errors'])): ?>
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-100 px-4 py-4 rounded-2xl shadow flex flex-col gap-2">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"></path>
                                </svg>
                                <span class="font-semibold">Gönderilemeyen numaralar</span>
                            </div>
                            <ul class="list-disc list-inside text-sm text-red-700 dark:text-red-200 space-y-1">
                                <?php foreach (array_slice($_SESSION['sms_errors'], 0, 8) as $smsError): ?>
                                    <li><?= htmlspecialchars($smsError) ?></li>
                                <?php endforeach; ?>
                            </ul>
                            <?php unset($_SESSION['sms_errors']); ?>
                        </div>
                        <?php endif; ?>
                        <div class="mail-quick-actions">
                            <button type="button" onclick="toastManager.show('Bilgi','Taslak kaydetme özelliği yakında eklenecek.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 6v12m6-6H6"></path></svg>
                                Taslak Kaydet
                            </button>
                            <button type="button" onclick="toastManager.show('Bilgi','Şablon yönetimi geliştiriliyor.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 7h16M4 12h10m-6 5h6"></path></svg>
                                Şablonları Yönet
                            </button>
                            <button type="button" onclick="toastManager.show('Bilgi','Gönderim raporları yakında burada.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M9.75 17L9 20l1.5 1.5M13.75 17l-.75 3 1.5 1.5M19.5 3h-15l1.5 9h12z"></path></svg>
                                Raporları Gör
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Toplam Alıcı</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white"><?= $smsTotal ?></p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-green-50 text-green-600 dark:bg-green-900/40 dark:text-green-300 px-3 py-1 rounded-full">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                            Güncel Üye Listesi
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-green-50 text-green-600 dark:bg-green-900/40 dark:text-green-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">Tüm üye listesi otomatik olarak güncellendi. Yeni eklenen üyeler de bu listeye dahil.</p>
                            </div>
                            
                            <?php
                            // SMS kullanım bilgisini al (try-catch ile güvenli)
                            $currentUsage = 0;
                            $smsLimit = 0;
                            $remainingSms = 0;
                            $usagePercentage = 0;
                            
                            try {
                                if (!function_exists('get_sms_usage_info')) {
                                    require_once __DIR__ . '/../lib/general/subscription_helper.php';
                                }
                                $smsUsage = get_sms_usage_info();
                                $currentUsage = $smsUsage['current'] ?? 0;
                                $smsLimit = $smsUsage['limit'] ?? 0;
                                $remainingSms = $smsUsage['remaining'] ?? 0;
                                
                                // Yüzde hesapla
                            $usagePercentage = $smsLimit > 0 ? min(100, ($currentUsage / max(1, $smsLimit)) * 100) : 0;
                            } catch (Exception $e) {
                                error_log("SMS usage info error in template: " . $e->getMessage());
                                // Varsayılan değerler kullanılacak
                            } catch (Error $e) {
                                error_log("SMS usage info fatal error in template: " . $e->getMessage());
                                // Varsayılan değerler kullanılacak
                            }
                            
                            // Renk belirleme
                            $cardColor = 'blue';
                            $iconBg = 'bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300';
                            $badgeBg = 'bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300';
                            
                            if ($usagePercentage >= 90) {
                                $cardColor = 'red';
                                $iconBg = 'bg-red-50 text-red-600 dark:bg-red-900/40 dark:text-red-300';
                                $badgeBg = 'bg-red-50 text-red-600 dark:bg-red-900/40 dark:text-red-300';
                            } elseif ($usagePercentage >= 70) {
                                $cardColor = 'orange';
                                $iconBg = 'bg-orange-50 text-orange-600 dark:bg-orange-900/40 dark:text-orange-300';
                                $badgeBg = 'bg-orange-50 text-orange-600 dark:bg-orange-900/40 dark:text-orange-300';
                            }
                            ?>
                            <?php if ($messagesLocked || $smsLimit <= 0): ?>
                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Kalan SMS Hakkı</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white">—</p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-amber-50 text-amber-700 dark:bg-amber-900/30 dark:text-amber-200 px-3 py-1 rounded-full">
                                            <span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
                                            Business paketine özel
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-amber-50 text-amber-600 dark:bg-amber-900/30 dark:text-amber-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 8v4m0 4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">
                                    SMS hakkı Business paketine geçtiğinizde aktif olur ve kalan kullanım burada görünür.
                                </p>
                            </div>
                            <?php else: ?>
                            <div id="sms-usage-card" class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Kalan SMS Hakkı</p>
                                        <p id="sms-remaining-count" class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white">
                                        <?= number_format($remainingSms) ?>
                                        </p>
                                        <span id="sms-usage-badge" class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide <?= $badgeBg ?> px-3 py-1 rounded-full">
                                            <span class="w-1.5 h-1.5 rounded-full <?= $usagePercentage >= 90 ? 'bg-red-500' : ($usagePercentage >= 70 ? 'bg-orange-500' : 'bg-blue-500') ?> <?= $usagePercentage >= 70 ? 'animate-pulse' : '' ?>"></span>
                                            <span id="sms-usage-text">
                                                <?= number_format($currentUsage) . ' / ' . number_format($smsLimit) . ' kullanıldı' ?>
                                            </span>
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon <?= $iconBg ?>">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <?php if ($smsLimit > 0): ?>
                                <div class="mt-4">
                                    <div class="flex items-center justify-between text-xs mb-2">
                                        <span class="text-slate-500 dark:text-slate-400">Kullanım</span>
                                        <span class="font-medium text-slate-700 dark:text-slate-300">%<?= number_format($usagePercentage, 1) ?></span>
                                    </div>
                                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                        <div id="sms-usage-progress" class="h-2 rounded-full transition-all duration-300 <?= $usagePercentage >= 90 ? 'bg-red-500' : ($usagePercentage >= 70 ? 'bg-orange-500' : 'bg-blue-500') ?>" style="width: <?= $usagePercentage ?>%"></div>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">
                                    <?php if ($remainingSms <= 0): ?>
                                        <span class="text-red-600 dark:text-red-400 font-medium">⚠️ SMS hakkınız doldu! Ek paket almanız gerekiyor.</span>
                                    <?php elseif ($remainingSms <= 50): ?>
                                        <span class="text-orange-600 dark:text-orange-400 font-medium">⚠️ SMS hakkınız azalıyor. <?= $remainingSms ?> SMS kaldı.</span>
                                    <?php else: ?>
                                        Business paketinizde aylık <?= number_format($smsLimit) ?> SMS hakkınız bulunmaktadır. Her SMS gönderiminde (kaç kişiye gönderildiyse o kadar) hakkınızdan düşülür.
                                    <?php endif; ?>
                                </p>
                                <?php endif; ?>
                            </div>
                            <?php endif; ?>
                            
                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Hazır Şablon</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white">5</p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-purple-50 text-purple-600 dark:bg-purple-900/40 dark:text-purple-300 px-3 py-1 rounded-full">
                                            Anında Kullan
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-purple-50 text-purple-600 dark:bg-purple-900/40 dark:text-purple-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">Topluluğunuza uygun hazır metinleri tek tıkla düzenleyip gönderebilirsiniz.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-lg h-full flex flex-col">
                                    <div class="flex items-start justify-between px-5 pt-5 pb-4 border-b border-slate-200 dark:border-slate-700">
                                        <div>
                                            <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                                SMS Hedef Listesi
                                </h2>
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                                Toplam <span id="sms-total-count"><?= $smsTotal ?></span> üye içerisinden <span id="selected-sms-count"><?= $smsTotal ?></span> kişi seçili.
                                            </p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600 dark:bg-green-900/40 dark:text-green-300">Dinamik</span>
                                    </div>

                                    <div class="px-5 pt-4">
                                        <div class="relative">
                                            <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-400">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-4.35-4.35M5 11a6 6 0 1112 0 6 6 0 01-12 0z"></path>
                                                </svg>
                                            </span>
                                            <input type="text" id="sms-search" placeholder="Üye veya telefon ara..." class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-200">
                                        </div>
                                        <div class="mt-3">
                                            <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400">
                                                <span>Seçili alıcılar</span>
                                                <span>%</span>
                                            </div>
                                            <div class="h-2 mt-2 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
                                                <div id="sms-selection-progress" class="h-full bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500 transition-all duration-300 ease-out" style="width: <?= $smsTotal ? '100%' : '0%' ?>;"></div>
                                            </div>
                                        </div>
                                </div>
                                
                                    <div class="mt-4 flex-1 overflow-hidden">
                                        <div class="px-5">
                                            <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/60 px-4 py-3 flex items-center justify-between">
                                                <label class="inline-flex items-center gap-2 font-medium text-slate-700 dark:text-slate-200">
                                                    <input type="checkbox" id="select-all-phones" class="form-checkbox text-green-600 rounded transition" checked>
                                                    Tüm üyeleri seç
                                        </label>
                                                <span class="text-xs text-slate-500 dark:text-slate-400">Tek tıkla kontrol</span>
                                    </div>
                                        </div>
                                        <div class="sms-contact-scroll px-5 pb-20 mt-3 space-y-2 max-h-[28rem] overflow-y-auto" id="sms-contacts-container">
                                            <?php if ($smsTotal > 0): ?>
                                        <?php foreach ($sms_contacts as $contact): ?>
                                                    <div class="sms-contact-item flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2.5 transition hover:border-green-400 hover:shadow-lg/40 cursor-pointer" onclick="this.querySelector('input[type=checkbox]').click();">
                                                        <div class="flex-1">
                                                            <span class="font-medium text-slate-800 dark:text-slate-100"><?= htmlspecialchars($contact['full_name'] ?: 'Adsız Üye') ?></span>
                                                            <div class="text-xs text-slate-500 dark:text-slate-400"><?= htmlspecialchars($contact['phone_number']) ?></div>
                                                </div>
                                                        <label class="inline-flex items-center gap-2 text-slate-500 dark:text-slate-300 cursor-pointer text-xs font-medium" onclick="event.stopPropagation();">
                                                            <input type="checkbox" name="selected_phones[]" value="<?= htmlspecialchars($contact['phone_number']) ?>" class="target-phone form-checkbox text-green-600 rounded transition" checked>
                                                            SMS
                                                </label>
                                            </div>
                                        <?php endforeach; ?>
                                            <div class="h-4"></div>
                                    <?php else: ?>
                                                <div class="text-slate-500 dark:text-slate-400 text-sm text-center italic py-6 px-4 border border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                                                    Telefon numarası olan üye bulunmamaktadır.
                                                </div>
                                    <?php endif; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-2">
                                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-lg p-6 space-y-6 h-full flex flex-col">
                                    <div class="flex flex-wrap items-start justify-between gap-4">
                                        <div>
                                            <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                    Gelişmiş SMS Gönderimi
                                </h2>
                                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Şablon seçin, içeriği düzenleyin ve topluluğunuza profesyonel SMS mesajları gönderin.</p>
                                        </div>
                                        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-50 text-green-600 text-xs font-medium dark:bg-green-900/40 dark:text-green-300">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-ping"></span>
                                            SMS durumu: Beklemede
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Hazır Şablonlar</label>
                                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                            <button type="button" onclick="loadSmsTemplate('unifoura')" class="mail-template-btn">
                                                <span class="mail-template-title">UniFour</span>
                                                <span class="mail-template-desc">Kişisel karşılama</span>
                                        </button>
                                            <button type="button" onclick="loadSmsTemplate('event')" class="mail-template-btn">
                                                <span class="mail-template-title">Etkinlik</span>
                                                <span class="mail-template-desc">Etkinlik bildirimi</span>
                                        </button>
                                            <button type="button" onclick="loadSmsTemplate('reminder')" class="mail-template-btn">
                                                <span class="mail-template-title">Hatırlatma</span>
                                                <span class="mail-template-desc">Hatırlatma mesajı</span>
                                        </button>
                                            <button type="button" onclick="loadSmsTemplate('urgent')" class="mail-template-btn">
                                                <span class="mail-template-title">Acil</span>
                                                <span class="mail-template-desc">Acil durum</span>
                                            </button>
                                            <button type="button" onclick="loadSmsTemplate('custom')" class="mail-template-btn">
                                                <span class="mail-template-title">Özel</span>
                                                <span class="mail-template-desc">Sıfırdan oluştur</span>
                                        </button>
                                    </div>
                                </div>
                                
                                    <div class="mail-quick-actions">
                                        <button type="button" onclick="toastManager.show('Bilgi','Etiket yönetimi yakında eklenecek.','info',4000)">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M7 7h10M7 12h6m-6 5h10"></path></svg>
                                            Etiket Ekle
                                        </button>
                                        <button type="button" onclick="toastManager.show('Bilgi','A/B testi hazırlıkları sürüyor.','info',4000)">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"></path></svg>
                                            A/B Testi
                                        </button>
                                    </div>

                                    <div class="mail-meta-grid">
                                        <div class="mail-meta-card">
                                            <span>Seçili Alıcılar</span>
                                            <strong id="sms-meta-selected"><?= $smsTotal ?> kişi</strong>
                                        </div>
                                        <div class="mail-meta-card">
                                            <span>Gönderici</span>
                                            <strong>NetGSM</strong>
                                        </div>
                                        <div class="mail-meta-card">
                                            <span>Zamanlama</span>
                                            <strong>Anlık gönderim</strong>
                                        </div>
                                    </div>
                                
                                    <form id="sms_form" method="POST" action="index.php" class="space-y-6 flex-1 flex flex-col">
                                    <input type="hidden" name="action" value="send_sms">
                                    <input type="hidden" name="current_view" value="messages">
                                    <?= csrf_token_field() ?>
                                    <div id="sms_form_recipients"></div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="md:col-span-2">
                                                <label for="sms_body" class="block text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">Mesaj İçeriği (Maks. 911 Karakter)</label>
                                                <div class="mb-2 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                                                    <div class="flex items-center gap-2 flex-wrap">
                                                        <button type="button" onclick="generateSmsMessage()" 
                                                                class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                                                id="ai-generate-sms-btn">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                            </svg>
                                                            <span>AI ile Oluştur</span>
                                                        </button>
                                                        <button type="button" onclick="improveText('sms_body')" 
                                                                class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                            </svg>
                                                            <span>İyileştir</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            <div class="mt-1">
                                                <div class="flex justify-between items-center mb-2">
                                                        <span class="text-sm text-slate-500 dark:text-slate-400">Karakter sayısı:</span>
                                                        <span id="sms-char-count" class="text-sm font-medium text-slate-700 dark:text-slate-300">0/911</span>
                                        </div>
                                                    <textarea name="sms_body" id="sms_body" rows="6" maxlength="911" required 
                                                              class="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm input-focus bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100" 
                                                          placeholder="SMS içeriğinizi buraya giriniz..." 
                                                          onkeyup="updateSmsCharCount()"></textarea>
                                            </div>
                                        </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gönderim Seçenekleri</label>
                                                <label class="mail-option-chip">
                                                    <input type="checkbox" name="schedule_sms" class="sr-only">
                                                    <span>Zamanla</span>
                                                </label>
                                                <label class="mail-option-chip">
                                                    <input type="checkbox" name="urgent_sms" class="sr-only">
                                                    <span>Acil</span>
                                                </label>
                                                <label class="mail-option-chip" title="Aynı mesajı kısa süre içinde tekrar gönder">
                                                    <input type="checkbox" name="allow_duplicate_sms" value="1" class="sr-only">
                                                    <span>Tekrar Gönder</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                                            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800/70 text-slate-600 dark:text-slate-300">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-5 5v-5zM4.828 7l2.586-2.586A2 2 0 018.828 4h6.344a2 2 0 011.414.586L19.172 7H4.828zM4 7v10a2 2 0 002 2h12a2 2 0 002-2V7H4z"></path></svg>
                                                    Önizleme ile kontrol edin
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button type="button" onclick="previewSms()" class="px-4 py-2 text-slate-600 dark:text-slate-200 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition duration-200">
                                                    Önizleme
                                                </button>
                                                <button type="submit" class="px-6 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700 font-semibold transition duration-200 shadow-md shadow-green-600/30">
                                                    SMS Gönder
                                        </button>
                                        </div>
                                    </div>
                                </form>

                                    <div class="mail-footer-tips">
                                        <span><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 13l4 4L19 7"></path></svg>160 karakter sınırını aşmayın</span>
                                        <span><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 8v4l3 3"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M20.488 9A8 8 0 009 20.488"></path></svg>Zamanlayarak ideal saatlerde gönderin</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php if ($messagesLocked): ?>
                    <div class="mt-6 flex flex-wrap items-center gap-4 rounded-2xl border border-amber-200/70 dark:border-amber-400/40 bg-white dark:bg-slate-900 px-6 py-5 shadow-lg shadow-amber-200/40 dark:shadow-black/30">
                        <div class="flex-1 space-y-1">
                            <p class="text-xs uppercase tracking-wide font-semibold text-amber-600 dark:text-amber-300">Uyarı</p>
                            <p class="text-sm font-semibold text-slate-900 dark:text-white">Gerçek gönderim için Business paketine geçmeniz gerekiyor</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                500 adet aylık hediye SMS, sınırsız NetGSM gönderimi, canlı raporlama ve AI destekli mesaj şablonları tek pakette.
                            </p>
                        </div>
                        <a href="index.php?view=subscription" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white text-sm font-semibold shadow-lg shadow-amber-500/40 hover:scale-[1.01] transition">
                            Business’a Geç
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </a>
                    </div>
                    <?php endif; ?>

                <?php elseif ($current_view === 'mail'): ?>
                    <?php
                    // Mail Merkezi standart pakette de mevcut, guard kontrolü yok
                    ?>
                    <?php 
                        // Tüm email contacts sayısını kullan (sadece ilk 50 değil)
                        $emailTotal = isset($all_email_contacts) ? count($all_email_contacts) : count($email_contacts);
                        $smtpSender = get_setting('smtp_username', 'info@unifour.com');
                    ?>
                    <div data-view="mail" class="space-y-8">
                        <div class="mail-quick-actions">
                            <button type="button" onclick="toastManager.show('Bilgi','Taslak kaydetme özelliği yakında eklenecek.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 6v12m6-6H6"></path></svg>
                                Taslak Kaydet
                            </button>
                            <button type="button" onclick="toastManager.show('Bilgi','Şablon yönetimi geliştiriliyor.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 7h16M4 12h10m-6 5h6"></path></svg>
                                Şablonları Yönet
                            </button>
                            <button type="button" onclick="toastManager.show('Bilgi','Gönderim raporları yakında burada.','info',4000)">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M9.75 17L9 20l1.5 1.5M13.75 17l-.75 3 1.5 1.5M19.5 3h-15l1.5 9h12z"></path></svg>
                                Raporları Gör
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Toplam Alıcı</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white"><?= $emailTotal ?></p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300 px-3 py-1 rounded-full">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                                            Güncel Üye Listesi
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">Tüm üye listesi otomatik olarak güncellendi. Yeni eklenen üyeler de bu listeye dahil.</p>
                            </div>

                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Bu Hafta Gönderilen</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white">0</p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full text-slate-600 dark:text-slate-300">
                                            Kampanyalar
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">
                                    Gönderim raporları burada görüntülenecek. SMTP ayarlarınızı tamamlayarak performansı izleyebilirsiniz.
                                </p>
                            </div>

                            <div class="mail-metric-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Hazır Şablon</p>
                                        <p class="mt-1 text-3xl font-semibold text-slate-900 dark:text-white">5</p>
                                        <span class="mt-3 inline-flex items-center gap-2 text-xs uppercase tracking-wide bg-purple-50 text-purple-600 dark:bg-purple-900/40 dark:text-purple-300 px-3 py-1 rounded-full">
                                            Anında Kullan
                                        </span>
                                    </div>
                                    <div class="mail-metric-icon bg-purple-50 text-purple-600 dark:bg-purple-900/40 dark:text-purple-300">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 leading-relaxed">Topluluğunuza uygun hazır metinleri tek tıkla düzenleyip gönderebilirsiniz.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-lg h-full flex flex-col">
                                    <div class="flex items-start justify-between px-5 pt-5 pb-4 border-b border-slate-200 dark:border-slate-700">
                                        <div>
                                            <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                                E-posta Hedef Listesi
                                            </h2>
                                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                                Toplam <span id="email-total-count"><?= $emailTotal ?></span> üye içerisinden <span id="selected-email-count"><?= $emailTotal ?></span> kişi seçili.
                                            </p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-300">Dinamik</span>
                                    </div>

                                    <div class="px-5 pt-4">
                                        <div class="relative">
                                            <span class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-slate-400">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-4.35-4.35M5 11a6 6 0 1112 0 6 6 0 01-12 0z"></path>
                                                </svg>
                                            </span>
                                            <input type="text" id="email-search" placeholder="Üye veya e-posta ara..." class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-200">
                                        </div>
                                        <div class="mt-3">
                                            <div class="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400">
                                                <span>Seçili alıcılar</span>
                                                <span>%</span>
                                            </div>
                                            <div class="h-2 mt-2 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
                                                <div id="email-selection-progress" class="h-full bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 transition-all duration-300 ease-out" style="width: <?= $emailTotal ? '100%' : '0%' ?>;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4 flex-1 overflow-hidden">
                                    <div class="px-5">
                                            <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/60 px-4 py-3 flex items-center justify-between">
                                                <label class="inline-flex items-center gap-2 font-medium text-slate-700 dark:text-slate-200">
                                                    <input type="checkbox" id="select-all-emails" class="form-checkbox text-blue-600 rounded transition" checked>
                                                    Tüm üyeleri seç
                                                </label>
                                                <span class="text-xs text-slate-500 dark:text-slate-400">Tek tıkla kontrol</span>
                                            </div>
                                        </div>
                                        <div class="email-contact-scroll px-5 pb-20 mt-3 space-y-2 max-h-[28rem] overflow-y-auto" id="email-contacts-container">
                                            <?php if ($emailTotal > 0): ?>
                                                <?php foreach ($email_contacts as $contact): ?>
                                                    <div class="email-contact-item flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/60 px-3 py-2.5 transition hover:border-blue-400 hover:shadow-lg/40 cursor-pointer" onclick="this.querySelector('input[type=checkbox]').click();">
                                                        <div class="flex-1">
                                                            <span class="font-medium text-slate-800 dark:text-slate-100"><?= htmlspecialchars($contact['full_name'] ?: 'Adsız Üye') ?></span>
                                                            <div class="text-xs text-slate-500 dark:text-slate-400"><?= htmlspecialchars($contact['email']) ?></div>
                                                        </div>
                                                        <label class="inline-flex items-center gap-2 text-slate-500 dark:text-slate-300 cursor-pointer text-xs font-medium" onclick="event.stopPropagation();">
                                                            <input type="checkbox" name="selected_emails[]" value="<?= htmlspecialchars($contact['email']) ?>" class="target-email form-checkbox text-blue-600 rounded transition" checked>
                                                            E-posta
                                                        </label>
                                                    </div>
                                                <?php endforeach; ?>
                                            <div class="h-4"></div>
                                            <?php else: ?>
                                                <div class="text-slate-500 dark:text-slate-400 text-sm text-center italic py-6 px-4 border border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                                                    E-posta adresi olan üye bulunmamaktadır.
                                                </div>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-2">
                                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-lg p-6 space-y-6 h-full flex flex-col">
                                    <div class="flex flex-wrap items-start justify-between gap-4">
                                        <div>
                                            <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                                Gelişmiş E-posta Gönderimi
                                            </h2>
                                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Şablon seçin, içeriği düzenleyin ve topluluğunuza profesyonel e-postalar gönderin.</p>
                                        </div>
                                        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 text-blue-600 text-xs font-medium dark:bg-blue-900/40 dark:text-blue-300">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500 animate-ping"></span>
                                            SMTP durumu: Beklemede
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Hazır Şablonlar</label>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <button type="button" onclick="loadTemplate('welcome')" class="mail-template-btn">
                                                <span class="mail-template-title">Hoş Geldin</span>
                                                <span class="mail-template-desc">Yeni üye karşılama</span>
                                            </button>
                                            <button type="button" onclick="loadTemplate('unifoura')" class="mail-template-btn">
                                                <span class="mail-template-title">UniFour</span>
                                                <span class="mail-template-desc">Kişisel karşılama</span>
                                            </button>
                                            <button type="button" onclick="loadTemplate('event')" class="mail-template-btn">
                                                <span class="mail-template-title">Etkinlik Duyurusu</span>
                                                <span class="mail-template-desc">Etkinlik bildirimi</span>
                                            </button>
                                            <button type="button" onclick="loadTemplate('newsletter')" class="mail-template-btn">
                                                <span class="mail-template-title">Bülten</span>
                                                <span class="mail-template-desc">Aylık bilgilendirme</span>
                                            </button>
                                            <button type="button" onclick="loadTemplate('custom')" class="mail-template-btn">
                                                <span class="mail-template-title">Özel</span>
                                                <span class="mail-template-desc">Sıfırdan oluştur</span>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mail-quick-actions">
                                        <button type="button" onclick="toastManager.show('Bilgi','Etiket yönetimi yakında eklenecek.','info',4000)">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M7 7h10M7 12h6m-6 5h10"></path></svg>
                                            Etiket Ekle
                                        </button>
                                        <button type="button" onclick="toastManager.show('Bilgi','A/B testi hazırlıkları sürüyor.','info',4000)">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"></path></svg>
                                            A/B Testi
                                        </button>
                                    </div>

                                    <div class="mail-meta-grid">
                                        <div class="mail-meta-card">
                                            <span>Seçili Alıcılar</span>
                                            <strong id="mail-meta-selected"><?= $emailTotal ?> kişi</strong>
                                        </div>
                                        <div class="mail-meta-card">
                                            <span>Gönderici</span>
                                            <strong><?= htmlspecialchars($smtpSender) ?></strong>
                                        </div>
                                        <div class="mail-meta-card">
                                            <span>Zamanlama</span>
                                            <strong>Anlık gönderim</strong>
                                        </div>
                                    </div>

                                
                                    <form id="email_form" method="POST" action="index.php" class="space-y-6 flex-1 flex flex-col">
                                        <input type="hidden" name="action" value="send_email">
                                        <input type="hidden" name="current_view" value="mail">
                                        <?= csrf_token_field() ?>
                                        <div id="email_form_recipients"></div>
                                        <div id="email_sending_status" style="display:none;" class="rounded-xl border border-blue-200 dark:border-blue-500/40 bg-blue-50 dark:bg-blue-500/10 px-4 py-3 flex items-center gap-3">
                                            <div class="animate-spin rounded-full h-5 w-5 border-2 border-blue-600 border-t-transparent"></div>
                                            <div>
                                                <p class="text-sm font-medium text-blue-700 dark:text-blue-200">E-postalar gönderiliyor, lütfen bekleyin...</p>
                                                <div id="email_progress" class="text-xs text-blue-600 dark:text-blue-300 mt-1"></div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="md:col-span-2">
                                                <label for="email_subject" class="block text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">Konu Başlığı</label>
                                                <div class="mb-2">
                                                    <button type="button" onclick="generateEmailSubject()" 
                                                            class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                        </svg>
                                                        <span>AI Öner</span>
                                                    </button>
                                                </div>
                                                <input type="text" name="email_subject" id="email_subject" required class="w-full p-3 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm input-focus bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 transition-all duration-200" placeholder="Örn. Etkinlik Daveti: Kariyer Günü 2025">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gönderim Seçenekleri</label>
                                                <label class="mail-option-chip">
                                                    <input type="checkbox" name="send_copy" class="sr-only">
                                                    <span>Kopya gönder</span>
                                                </label>
                                                <label class="mail-option-chip">
                                                    <input type="checkbox" name="schedule_email" class="sr-only">
                                                    <span>Zamanla</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mail-attachment-drop">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M16.5 6.75l-6.75 6.75a2.121 2.121 0 11-3-3L13.5 4.5a3 3 0 014.5 4l-7.5 7.5a4.243 4.243 0 11-6-6l7.5-7.5"></path></svg>
                                            Dosya eklemek için tıklayın veya sürükleyin. (Maks. 5 MB)
                                        </div>
                                        
                                        <div class="flex-1 flex flex-col">
                                            <label for="email_body" class="block text-sm font-semibold text-slate-800 dark:text-slate-200 mb-2">E-posta İçeriği</label>
                                            <div class="mb-2 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                                                <div class="flex items-center gap-2 flex-wrap">
                                                    <button type="button" onclick="generateEmailContent()" 
                                                            class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                                            id="ai-generate-email-btn">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                        </svg>
                                                        <span>AI ile Oluştur</span>
                                                    </button>
                                                    <button type="button" onclick="improveText('email_body')" 
                                                            class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        <span>İyileştir</span>
                                                    </button>
                                                    <button type="button" onclick="generateEmailTemplate()" 
                                                            class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                                                        </svg>
                                                        <span>Şablon Oluştur</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mt-2 bg-slate-50 dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700 rounded-xl flex-1 flex flex-col">
                                                <div class="flex items-center gap-2 px-3 py-2 border-b border-slate-200 dark:border-slate-700">
                                                    <button type="button" onclick="toggleEditor('html', event)" class="editor-toggle-btn active">HTML</button>
                                                    <button type="button" onclick="toggleEditor('text', event)" class="editor-toggle-btn">Metin</button>
                                                    <span class="ml-auto text-xs text-slate-400 dark:text-slate-500 flex items-center gap-2">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 6h14M5 18h14"></path></svg>
                                                        Markdown desteklenir
                                                    </span>
                                                </div>
                                                <textarea name="email_body" id="email_body" rows="8" required class="flex-1 w-full p-4 bg-transparent focus:outline-none text-sm text-slate-800 dark:text-slate-100" placeholder="E-posta içeriğinizi buraya giriniz..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-slate-200 dark:border-slate-700">
                                            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800/70 text-slate-600 dark:text-slate-300">
                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-5 5v-5zM4.828 7l2.586-2.586A2 2 0 018.828 4h6.344a2 2 0 011.414.586L19.172 7H4.828zM4 7v10a2 2 0 002 2h12a2 2 0 002-2V7H4z"></path></svg>
                                                    Önizleme ile kontrol edin
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button type="button" onclick="previewEmail()" class="px-4 py-2 text-slate-600 dark:text-slate-200 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition duration-200">
                                                    Önizleme
                                                </button>
                                                <button type="submit" class="px-6 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 font-semibold transition duration-200 shadow-md shadow-blue-600/30">
                                                    E-posta Gönder
                                                </button>
                                            </div>
                                        </div>
                                    </form>


                                    <div class="mail-footer-tips">
                                        <span><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 13l4 4L19 7"></path></svg>Linkleri test etmeyi unutmayın</span>
                                        <span><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 8v4l3 3"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M20.488 9A8 8 0 009 20.488"></path></svg>Zamanlayarak ideal saatlerde gönderin</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <?php elseif ($current_view === 'notifications'): ?>
                    <div data-view="notifications" class="space-y-6">
                        <!-- Kompakt Filtreler ve Aksiyonlar -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex flex-wrap gap-3 items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Filtre:</label>
                                    <select id="notificationFilter" class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="all">Tümü</option>
                                        <option value="unread">Okunmamış</option>
                                        <option value="read">Okunmuş</option>
                                        <option value="urgent">Acil</option>
                                        <option value="success">Başarılı</option>
                                        <option value="warning">Uyarı</option>
                                        <option value="error">Hata</option>
                                    </select>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 px-3 py-1.5 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                                        <?= count($notifications) ?> bildirim
                                    </span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="markAllAsRead()" class="px-3 py-1.5 text-sm bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-md hover:bg-green-100 dark:hover:bg-green-800 border border-green-200 dark:border-green-700 transition-colors flex items-center gap-1.5">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Hepsi
                                    </button>
                                    <button onclick="deleteAllNotifications()" class="px-3 py-1.5 text-sm bg-red-50 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-md hover:bg-red-100 dark:hover:bg-red-800 border border-red-200 dark:border-red-700 transition-colors flex items-center gap-1.5">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Temizle
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bildirim Listesi -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                <?php if (count($notifications) > 0): ?>
                                    <?php foreach ($notifications as $notification): 
                                        $badge_colors = [
                                            'success' => ['bg' => 'bg-green-500', 'badge_class' => 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300', 'badge_text' => 'Başarılı'],
                                            'warning' => ['bg' => 'bg-yellow-500', 'badge_class' => 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300', 'badge_text' => 'Uyarı'],
                                            'error' => ['bg' => 'bg-red-500', 'badge_class' => 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300', 'badge_text' => 'Hata'],
                                            'urgent' => ['bg' => 'bg-red-600', 'badge_class' => 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300', 'badge_text' => 'Acil'],
                                            'info' => ['bg' => 'bg-blue-500', 'badge_class' => 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300', 'badge_text' => 'Bilgi']
                                        ];
                                        $badge_info = $badge_colors[$notification['type']] ?? ['bg' => 'bg-gray-500', 'badge_class' => 'bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300', 'badge_text' => 'Bilgi'];
                                    ?>
                                        <div class="notification-item p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all duration-200 <?= $notification['is_read'] == 0 ? 'bg-blue-50/50 dark:bg-blue-950/30' : '' ?>" data-type="<?= $notification['type'] ?>" data-read="<?= $notification['is_read'] ?>">
                                            <div class="flex items-start gap-4">
                                                <!-- İçerik -->
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="flex items-center gap-2 flex-wrap mb-2">
                                                                <h4 class="font-semibold text-gray-900 dark:text-gray-100 text-sm"><?= htmlspecialchars($notification['title']) ?></h4>
                                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <?= $badge_info['badge_class'] ?>">
                                                                    <?= $badge_info['badge_text'] ?>
                                                                </span>
                                                                <?php if ($notification['is_read'] == 0): ?>
                                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">
                                                                        Yeni
                                                                    </span>
                                                                <?php endif; ?>
                                                            </div>
                                                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2"><?= htmlspecialchars($notification['message']) ?></p>
                                                        </div>
                                                        <span class="text-xs text-gray-500 dark:text-gray-500 whitespace-nowrap flex-shrink-0">
                                                            <?= date('d.m.Y, H:i', strtotime($notification['created_at'])) ?>
                                                        </span>
                                                    </div>
                                                    
                                                    <!-- Aksiyon Butonları -->
                                                    <div class="flex items-center gap-2 mt-3">
                                                        <?php if ($notification['is_read'] == 0): ?>
                                                            <button onclick="markAsRead(<?= $notification['id'] ?>)" class="text-xs px-2 py-1 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium transition-colors">
                                                                Okundu İşaretle
                                                            </button>
                                                        <?php endif; ?>
                                                        <button onclick="deleteNotification(<?= $notification['id'] ?>)" class="text-xs px-2 py-1 text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 font-medium transition-colors">
                                                            Sil
                                                        </button>
                                                        <button onclick="showNotificationDetail(<?= (int)$notification['id'] ?>, <?= tpl_js_escaped($notification['title'] ?? '') ?>, <?= tpl_js_escaped($notification['message'] ?? '') ?>, <?= tpl_js_escaped($notification['type'] ?? '') ?>, <?= tpl_js_escaped(date('d.m.Y H:i', strtotime($notification['created_at']))) ?>, <?= (int)$notification['is_read'] ?>)" class="text-xs px-2 py-1 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 font-medium transition-colors">
                                                            Detay
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <div class="p-8 text-center">
                                        <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l2.586-2.586A2 2 0 018.828 4h6.344a2 2 0 011.414.586L19.172 7H4.828zM4 7v10a2 2 0 002 2h12a2 2 0 002-2V7H4z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Henüz bildirim yok</h3>
                                        <p class="text-gray-500 dark:text-gray-400">Sistem bildirimleri burada görüntülenecek.</p>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>

                <?php elseif ($current_view === 'reports'): ?>
                    <?php
                    // Guard kontrolü zaten yukarıda yapıldı
                    // Eğer guard başarısız olduysa $current_view subscription_required olarak ayarlandı
                    // Bu durumda bu blok çalışmayacak çünkü $current_view artık 'reports' değil
                    ?>
                    <?php
                    // Statistics modülünü yükle
                    load_module('statistics');
                    // Raporlama verilerini al
                    $attendance_monthly = get_event_attendance_monthly();
                    $attendance_yearly = get_event_attendance_yearly();
                    $member_growth = get_member_growth();
                    $category_distribution = get_event_category_distribution();
                    $active_members = get_most_active_members();
                    $success_rates = get_event_success_rates();
                    $email_sms_stats = get_email_sms_statistics();
                    $reportsLocked = !$reports_feature_available;
                    ?>
                    <?php if ($reportsLocked): ?>
                    <div class="rounded-2xl border border-slate-200 dark:border-white/5 bg-gradient-to-br from-white via-slate-50 to-amber-50/80 dark:from-slate-900 dark:via-slate-900/70 dark:to-amber-900/10 px-6 py-6 mb-6 shadow-lg shadow-amber-200/40 dark:shadow-black/30 relative overflow-hidden">
                        <div class="absolute inset-y-0 right-0 w-1/3 pointer-events-none opacity-20 bg-[radial-gradient(circle_at_top,_rgba(251,191,36,.4),_transparent_55%)]"></div>
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 relative z-10">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/30">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 4.5l7 3V12c0 4.5-3 8.5-7 9-4-.5-7-4.5-7-9V7.5l7-3z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9.5 12.5l2 2 3-3.5"></path>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-amber-200/70 dark:border-amber-400/40 bg-amber-50/80 dark:bg-amber-500/10 text-xs font-semibold text-amber-700 dark:text-amber-200">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-7.364l-.707.707M7.343 16.657l-.707.707m0-11.314l.707.707m9.192 9.192l.707.707"></path></svg>
                                        Professional / Business
                                    </div>
                                    <h3 class="text-xl font-semibold text-slate-900 dark:text-white">Raporlar & Analitik kilitli</h3>
                                    <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                                        Şu anda gördüğünüz kartlar ön izleme modunda ve her biri bulanıklaştırıldı. Tüm analizleri gerçek verilerinizle görebilmek için Professional ya da Business paketine geçmeniz gerekiyor.
                                    </p>
                                    <div class="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-300">
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> AI analiz özetleri
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Dinamik grafikler
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Üye performans puanları
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="index.php?view=subscription" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold shadow-lg shadow-orange-500/40 transition hover:scale-[1.01]">
                                    Paketi Yükselt
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                <button type="button" onclick="window.location.href='index.php?view=subscription&scroll=features'" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-slate-200 dark:border-white/10 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-white/80 dark:hover:bg-white/5 transition">
                                    Özellikleri İncele
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                    <div data-view="reports" class="max-w-7xl mx-auto<?php if ($reportsLocked) echo ' reports-locked'; ?>"<?php if ($reportsLocked) echo ' aria-hidden="true"'; ?>>
                        <!-- Tüm İçerik Tek Kart İçinde -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 section-card">
                        <!-- Başlık -->
                            <div class="mb-8 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-slate-900/50 px-6 py-6 flex flex-col gap-6 md:flex-row md:items-center md:justify-between shadow-sm reports-blur-card">
                            <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                                <div>
                                        <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Raporlar & Analitik</h1>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Topluluk performansını ve istatistikleri görüntüleyin</p>
                                </div>
                            </div>
                                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-2">
                                    <?php
                                    // Aylık limit kontrolü için PHP'de kontrol
                                    $last_analysis_date = get_setting('last_ai_analysis_date', '');
                                    $current_month = date('Y-m');
                                    $can_analyze = true;
                                    $limit_message = '';
                                    
                                    if (!empty($last_analysis_date)) {
                                        $last_month = date('Y-m', strtotime($last_analysis_date));
                                        if ($last_month === $current_month) {
                                            $can_analyze = false;
                                            $next_available = date('Y-m-01', strtotime('+1 month'));
                                            $days_remaining = ceil((strtotime($next_available) - time()) / 86400);
                                            $limit_message = 'Bu ay için AI analizi zaten yapılmış. Bir sonraki analiz ' . date('d.m.Y', strtotime($next_available)) . ' tarihinden itibaren yapılabilir.';
                                        }
                                    }
                                    ?>
                                    <button 
                                        onclick="generateAIAnalysis()" 
                                        id="ai-analysis-trigger" 
                                        class="px-4 py-2 <?= $can_analyze ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed' ?> text-white rounded-lg font-medium shadow-sm transition-all duration-200 flex items-center gap-2"
                                        <?= !$can_analyze ? 'disabled' : '' ?>
                                        <?= !$can_analyze ? 'title="' . htmlspecialchars($limit_message, ENT_QUOTES) . '"' : '' ?>
                                    >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                        <?= $can_analyze ? 'AI İncele' : 'Bu Ay Analiz Yapıldı' ?>
                                </button>
                                    <?php if (!$can_analyze): ?>
                                        <div class="ml-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                                            <p class="text-xs text-yellow-800 dark:text-yellow-200 flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <?= htmlspecialchars($limit_message) ?>
                                            </p>
                                        </div>
                                    <?php endif; ?>
                                    <a href="?action=generate_pdf_report" target="_blank" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium shadow-sm transition duration-150 flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    PDF Rapor İndir
                                </a>
                            </div>
                        </div>
                        <!-- AI Analiz Tablosu -->
                            <?php
                            // Sayfa yüklendiğinde kaydedilmiş analizi kontrol et
                            $saved_analysis_data = get_setting('last_ai_analysis_data', '');
                            $saved_analysis_date = get_setting('last_ai_analysis_date', '');
                            $show_saved_analysis = false;
                            $saved_analysis = null;
                            
                            if (!empty($saved_analysis_data) && !empty($saved_analysis_date)) {
                                $saved_month = date('Y-m', strtotime($saved_analysis_date));
                                $current_month = date('Y-m');
                                
                                // Bu ay için analiz varsa göster
                                if ($saved_month === $current_month) {
                                    $saved_analysis = json_decode($saved_analysis_data, true);
                                    if ($saved_analysis && is_array($saved_analysis)) {
                                        $show_saved_analysis = true;
                                    }
                                }
                            }
                            ?>
                            <div id="ai-analysis-section" class="<?= $show_saved_analysis ? '' : 'hidden' ?> mb-8 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 reports-blur-card">
                                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
                                <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-md">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                        <div>
                                            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">AI Analiz Sonuçları</h2>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Topluluğunuzun performans analizi</p>
                                        </div>
                                    </div>
                                    <button onclick="document.getElementById('ai-analysis-section').classList.add('hidden')" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div id="ai-analysis-content" class="space-y-6">
                                <?php if ($show_saved_analysis && $saved_analysis): ?>
                                    <script<?= tpl_script_nonce_attr(); ?>>
                                    // Sayfa yüklendiğinde kaydedilmiş analizi göster
                                    (function() {
                                        const analysis = <?= json_encode($saved_analysis, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) ?>;
                                        const content = document.getElementById('ai-analysis-content');
                                        
                                        if (!content || !analysis) return;
                                        
                                        // Analiz render fonksiyonu (generateAIAnalysis içindeki aynı kod)
                                        function escapeHtml(text) {
                                            if (text === null || text === undefined) return '';
                                            const str = String(text);
                                            const map = {
                                                '&': '&amp;',
                                                '<': '&lt;',
                                                '>': '&gt;',
                                                '"': '&quot;',
                                                "'": '&#039;'
                                            };
                                            return str.replace(/[&<>"']/g, function(m) { return map[m]; });
                                        }
                                        
                                        function safeNumber(num) {
                                            if (num === null || num === undefined || num === '') return 0;
                                            const n = Number(num);
                                            return isNaN(n) ? 0 : n;
                                        }
                                        
                                        function safeString(str) {
                                            if (str === null || str === undefined) return '';
                                            return String(str).trim();
                                        }
                                        
                                        let html = '<div class="space-y-6">';
                                        
                                        // Özet
                                        const summary = safeString(analysis.summary || 'Analiz metni bulunamadı.');
                                        html += '<div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl p-6 border border-indigo-200 dark:border-indigo-700/50">';
                                        html += '<div class="flex items-center gap-3 mb-4">';
                                        html += '<div class="w-10 h-10 rounded-lg bg-indigo-600 dark:bg-indigo-500 flex items-center justify-center">';
                                        html += '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
                                        html += '</div>';
                                        html += '<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Analiz Özeti</h3>';
                                        html += '</div>';
                                        html += '<div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">' + escapeHtml(summary) + '</div>';
                                        html += '</div>';
                                        
                                        // Veri Özeti
                                        if (analysis.data && typeof analysis.data === 'object') {
                                            const dataObj = analysis.data;
                                            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';
                                            
                                            // Etkinlikler
                                            const eventsTotal = safeNumber(dataObj.events?.total);
                                            const eventsCompleted = safeNumber(dataObj.events?.completed);
                                            html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                            html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Etkinlikler</p>';
                                            html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + eventsTotal + '</p>';
                                            html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Tamamlanan: ' + eventsCompleted + '</p>';
                                            html += '</div>';
                                            
                                            // Üyeler
                                            const membersTotal = safeNumber(dataObj.members?.total);
                                            html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                            html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Üyeler</p>';
                                            html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + membersTotal + '</p>';
                                            html += '</div>';
                                            
                                            // Kampanyalar
                                            const campaignsTotal = safeNumber(dataObj.campaigns?.total);
                                            const campaignsActive = safeNumber(dataObj.campaigns?.active);
                                            html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                            html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Kampanyalar</p>';
                                            html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + campaignsTotal + '</p>';
                                            html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Aktif: ' + campaignsActive + '</p>';
                                            html += '</div>';
                                            
                                            // Ürünler
                                            const productsTotal = safeNumber(dataObj.products?.total);
                                            const productsActive = safeNumber(dataObj.products?.active);
                                            html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                            html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Ürünler</p>';
                                            html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + productsTotal + '</p>';
                                            html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Aktif: ' + productsActive + '</p>';
                                            html += '</div>';
                                            
                                            html += '</div>';
                                        }
                                        
                                        // Öneriler
                                        if (analysis.recommendations && Array.isArray(analysis.recommendations) && analysis.recommendations.length > 0) {
                                            html += '<div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">';
                                            html += '<div class="flex items-center gap-3 mb-5">';
                                            html += '<div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">';
                                            html += '<svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>';
                                            html += '</div>';
                                            html += '<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Öneriler</h3>';
                                            html += '</div>';
                                            html += '<ul class="space-y-3">';
                                            
                                            analysis.recommendations.forEach((rec, index) => {
                                                const recStr = safeString(rec);
                                                if (recStr.length > 0) {
                                                    html += '<li class="flex items-start gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">';
                                                    html += '<span class="flex-shrink-0 w-7 h-7 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold shadow-sm">' + (index + 1) + '</span>';
                                                    html += '<span class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed pt-0.5">' + escapeHtml(recStr) + '</span>';
                                                    html += '</li>';
                                                }
                                            });
                                            
                                            html += '</ul>';
                                            html += '</div>';
                                        }
                                        
                                        html += '</div>';
                                        
                                        content.innerHTML = html;
                                    })();
                                    </script>
                                <?php endif; ?>
                                    <div class="text-center py-12">
                                        <div class="relative inline-block">
                                            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 dark:border-indigo-900 border-t-indigo-600 dark:border-t-indigo-400 mx-auto"></div>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                        <p class="mt-6 text-gray-600 dark:text-gray-400 font-medium">Analiz hazırlanıyor...</p>
                                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-500">Bu işlem birkaç saniye sürebilir</p>
                                    </div>
                                </div>
                            </div>
                            <!-- İstatistik Özeti -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 reports-blur-grid">
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:shadow-none hover:scale-100">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Toplam Email</p>
                                            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($email_sms_stats['email']['total_sent']) ?></p>
                                        </div>
                                        <div class="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:shadow-none hover:scale-100">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Toplam SMS</p>
                                            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($email_sms_stats['sms']['total_sent']) ?></p>
                                        </div>
                                        <div class="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:shadow-none hover:scale-100">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Email Kampanyaları</p>
                                            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($email_sms_stats['email']['total_campaigns']) ?></p>
                                        </div>
                                        <div class="w-12 h-12 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:shadow-none hover:scale-100">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Başarısız Email</p>
                                            <p class="text-3xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($email_sms_stats['email']['total_failed']) ?></p>
                                        </div>
                                        <div class="w-12 h-12 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                                            <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grafikler Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Etkinlik Katılım Grafiği (Aylık) -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Etkinlik Katılımı (Aylık)</h3>
                                <div class="h-64">
                                    <canvas id="attendanceMonthlyChart"></canvas>
                                </div>
                            </div>

                            <!-- Etkinlik Katılım Grafiği (Yıllık) -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Etkinlik Katılımı (Yıllık)</h3>
                                <div class="h-64">
                                    <canvas id="attendanceYearlyChart"></canvas>
                                </div>
                            </div>

                            <!-- Üye Büyüme Grafiği -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Üye Büyümesi (Aylık)</h3>
                                <div class="h-64">
                                    <canvas id="memberGrowthChart"></canvas>
                                </div>
                            </div>

                            <!-- Etkinlik Türü Dağılımı (Pie Chart) -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Etkinlik Türü Dağılımı</h3>
                                <div class="h-64">
                                    <canvas id="categoryDistributionChart"></canvas>
                                </div>
                            </div>

                            <!-- Email/SMS İstatistikleri -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Email/SMS Gönderim İstatistikleri</h3>
                                <div class="h-64">
                                    <canvas id="emailSmsChart"></canvas>
                                </div>
                            </div>

                            <!-- Etkinlik Başarı Oranları -->
                                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Etkinlik Başarı Oranları</h3>
                                <div class="h-64">
                                    <canvas id="successRatesChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- En Aktif Üyeler Listesi -->
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 border border-gray-200 dark:border-gray-600 reports-blur-card">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">En Çok Katılım Gösteren Üyeler</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Etkinliklere en çok katılan üyeler</p>
                                </div>
                            </div>
                            <?php if (!empty($active_members)): ?>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sıra</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Üye Adı</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">E-posta</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Katılım Sayısı</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <?php foreach ($active_members as $index => $member): ?>
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <?php if ($index === 0): ?>
                                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 text-white text-sm font-bold shadow-sm">1</span>
                                                        <?php elseif ($index === 1): ?>
                                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-gray-300 to-gray-500 text-white text-sm font-bold shadow-sm">2</span>
                                                        <?php elseif ($index === 2): ?>
                                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 text-white text-sm font-bold shadow-sm">3</span>
                                                        <?php else: ?>
                                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-semibold"><?= $index + 1 ?></span>
                                                        <?php endif; ?>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($member['name']) ?></td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"><?= htmlspecialchars($member['email']) ?></td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                                            <?= $member['attendance_count'] ?> etkinlik
                                                        </span>
                                                    </td>
                                                </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            <?php else: ?>
                                <div class="text-center py-12">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">Henüz katılım kaydı bulunmuyor.</p>
                                </div>
                            <?php endif; ?>
                            </div>
                        </div>

                        <!-- AI Analiz JavaScript -->
                        <script<?= tpl_script_nonce_attr(); ?>>
                        async function generateAIAnalysis() {
                            const section = document.getElementById('ai-analysis-section');
                            const content = document.getElementById('ai-analysis-content');
                            
                            if (!section || !content) {
                                showToast('Hata', 'Analiz bölümü bulunamadı', 'error');
                                return;
                            }
                            
                            const escapeHtml = (text) => {
                                if (text === null || text === undefined) return '';
                                return String(text).replace(/[&<>\"']/g, (ch) => ({
                                    '&': '&amp;',
                                    '<': '&lt;',
                                    '>': '&gt;',
                                    '"': '&quot;',
                                    "'": '&#039;',
                                })[ch]);
                            };
                            
                            const safeNumber = (num, fallback = 0) => {
                                if (num === null || num === undefined || num === '') return fallback;
                                const parsed = Number(num);
                                return Number.isNaN(parsed) ? fallback : parsed;
                            };
                            
                            const safeString = (value, fallback = '') => {
                                if (value === null || value === undefined) return fallback;
                                const str = String(value).trim();
                                return str.length ? str : fallback;
                            };
                            
                            const safeArray = (value) => Array.isArray(value) ? value : [];
                            
                            section.classList.remove('hidden');
                            content.innerHTML = '<div class="text-center py-12"><div class="relative inline-block"><div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 dark:border-indigo-900 border-t-indigo-600 dark:border-t-indigo-400 mx-auto"></div><div class="absolute inset-0 flex items-center justify-center"><svg class="w-5 h-5 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg></div></div><p class="mt-6 text-gray-600 dark:text-gray-400 font-medium">Analiz hazırlanıyor...</p><p class="mt-2 text-sm text-gray-500 dark:text-gray-500">Bu işlem birkaç saniye sürebilir</p></div>';
                            
                            try {
                                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
                                if (!csrfToken) {
                                    showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
                                    content.innerHTML = '<div class="text-center py-8 text-red-600 dark:text-red-400">Güvenlik doğrulaması yapılamadı</div>';
                                    return;
                                }
                                
                                // AbortController ile timeout kontrolü (120 saniye)
                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => {
                                    controller.abort();
                                }, 120000);
                                
                                let response;
                                try {
                                    response = await fetch('index.php', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                                        body: new URLSearchParams({
                                            action: 'ai_analyze_reports',
                                            csrf_token: csrfToken,
                                        }),
                                        signal: controller.signal,
                                    });
                                    clearTimeout(timeoutId);
                                } catch (fetchError) {
                                    clearTimeout(timeoutId);
                                    if (fetchError.name === 'AbortError') {
                                        throw new Error('İstek zaman aşımına uğradı (120 saniye). Lütfen tekrar deneyin.');
                                    }
                                    throw fetchError;
                                }
                                
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                
                                const responseText = await response.text();
                                console.log('Response alındı, uzunluk:', responseText.length);
                                
                                if (!responseText || responseText.trim() === '') {
                                    throw new Error('Boş yanıt alındı');
                                }
                                
                                const trimmedResponse = responseText.trim();
                                
                                if (trimmedResponse.startsWith('<')) {
                                    console.error('AI Analysis HTML response:', trimmedResponse.substring(0, 500));
                                    content.innerHTML = '<div class="p-6 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 text-red-700 dark:text-red-200">' +
                                        '<p class="font-semibold mb-2">Analiz çıktısı beklenen formatta gelmedi.</p>' +
                                        '<p class="text-sm">Sunucu <code class="px-2 py-1 bg-red-100 dark:bg-red-800 rounded">logs/php_errors.log</code> dosyasını oluşturup yazma izni verdiğinizde bu uyarı kalkacaktır.</p>' +
                                        '</div>';
                                    showToast('Hata', 'Analiz oluşturulamadı', 'error');
                                    return;
                                }
                                
                                console.log('Response (ilk 500 karakter):', trimmedResponse.substring(0, 500));
                                
                                let data;
                                try {
                                    data = JSON.parse(trimmedResponse);
                                    console.log('JSON parse başarılı, success:', data.success);
                                } catch (parseError) {
                                    console.error('JSON Parse Error:', parseError);
                                    throw new Error('Yanıt parse edilemedi: ' + parseError.message + '. Response: ' + trimmedResponse.substring(0, 200));
                                }
                                
                                if (!data || typeof data !== 'object') {
                                    throw new Error('Geçersiz yanıt formatı');
                                }
                                
                                // Limit kontrolü hatası
                                if (!data.success && data.limit_reached) {
                                    // Butonu disable et
                                    const button = document.getElementById('ai-analysis-trigger');
                                    if (button) {
                                        button.disabled = true;
                                        button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                                        button.classList.add('bg-gray-400', 'cursor-not-allowed');
                                        const buttonText = button.querySelector('svg').nextSibling;
                                        if (buttonText) {
                                            buttonText.textContent = 'Bu Ay Analiz Yapıldı';
                                        }
                                    }
                                    
                                    // Limit mesajını göster
                                    showToast('Limit Aşıldı', data.message || 'Bu ay için AI analizi zaten yapılmış.', 'warning', 5000);
                                    
                                    // Limit uyarısı ekle
                                    content.innerHTML = '<div class="p-6 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700">' +
                                        '<div class="flex items-center gap-3 mb-3">' +
                                        '<svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>' +
                                        '</svg>' +
                                        '<h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">Aylık Limit Aşıldı</h3>' +
                                        '</div>' +
                                        '<p class="text-yellow-700 dark:text-yellow-300 mb-2">' + escapeHtml(data.message || 'Bu ay için AI analizi zaten yapılmış.') + '</p>' +
                                        (data.next_available ? '<p class="text-sm text-yellow-600 dark:text-yellow-400">Bir sonraki analiz: <strong>' + new Date(data.next_available).toLocaleDateString('tr-TR') + '</strong></p>' : '') +
                                        '</div>';
                                    
                                    // Sayfayı yenile (buton durumunu güncellemek için)
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 3000);
                                    return;
                                }
                                
                                if (data.success && data.analysis) {
                                    const analysis = data.analysis;
                                    
                                    // Güvenli HTML escape fonksiyonu
                                    function escapeHtml(text) {
                                        if (text === null || text === undefined) return '';
                                        const str = String(text);
                                        const map = {
                                            '&': '&amp;',
                                            '<': '&lt;',
                                            '>': '&gt;',
                                            '"': '&quot;',
                                            "'": '&#039;'
                                        };
                                        return str.replace(/[&<>"']/g, function(m) { return map[m]; });
                                    }
                                    
                                    // Güvenli sayı formatı
                                    function safeNumber(num) {
                                        if (num === null || num === undefined || num === '') return 0;
                                        const n = Number(num);
                                        return isNaN(n) ? 0 : n;
                                    }
                                    
                                    // Güvenli string kontrolü
                                    function safeString(str) {
                                        if (str === null || str === undefined) return '';
                                        return String(str).trim();
                                    }
                                    
                                    let html = '<div class="space-y-6">';
                                    
                                    // Özet
                                    const summary = safeString(analysis.summary || 'Analiz metni bulunamadı.');
                                    html += '<div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-xl p-6 border border-indigo-200 dark:border-indigo-700/50">';
                                    html += '<div class="flex items-center gap-3 mb-4">';
                                    html += '<div class="w-10 h-10 rounded-lg bg-indigo-600 dark:bg-indigo-500 flex items-center justify-center">';
                                    html += '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
                                    html += '</div>';
                                    html += '<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Analiz Özeti</h3>';
                                    html += '</div>';
                                    html += '<div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">' + escapeHtml(summary) + '</div>';
                                    html += '</div>';
                                    
                                    // Veri Özeti
                                    if (analysis.data && typeof analysis.data === 'object') {
                                        const dataObj = analysis.data;
                                        html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">';
                                        
                                        // Etkinlikler
                                        const eventsTotal = safeNumber(dataObj.events?.total);
                                        const eventsCompleted = safeNumber(dataObj.events?.completed);
                                        html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                        html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Etkinlikler</p>';
                                        html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + eventsTotal + '</p>';
                                        html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Tamamlanan: ' + eventsCompleted + '</p>';
                                        html += '</div>';
                                        
                                        // Üyeler
                                        const membersTotal = safeNumber(dataObj.members?.total);
                                        html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                        html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Üyeler</p>';
                                        html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + membersTotal + '</p>';
                                        html += '</div>';
                                        
                                        // Kampanyalar
                                        const campaignsTotal = safeNumber(dataObj.campaigns?.total);
                                        const campaignsActive = safeNumber(dataObj.campaigns?.active);
                                        html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                        html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Kampanyalar</p>';
                                        html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + campaignsTotal + '</p>';
                                        html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Aktif: ' + campaignsActive + '</p>';
                                        html += '</div>';
                                        
                                        // Ürünler
                                        const productsTotal = safeNumber(dataObj.products?.total);
                                        const productsActive = safeNumber(dataObj.products?.active);
                                        html += '<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">';
                                        html += '<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 uppercase tracking-wide">Ürünler</p>';
                                        html += '<p class="text-2xl font-bold text-gray-900 dark:text-gray-100">' + productsTotal + '</p>';
                                        html += '<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Aktif: ' + productsActive + '</p>';
                                        html += '</div>';
                                        
                                        html += '</div>';
                                    }
                                    
                                    // Öneriler
                                    if (analysis.recommendations && Array.isArray(analysis.recommendations) && analysis.recommendations.length > 0) {
                                        html += '<div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm">';
                                        html += '<div class="flex items-center gap-3 mb-5">';
                                        html += '<div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">';
                                        html += '<svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>';
                                        html += '</div>';
                                        html += '<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Öneriler</h3>';
                                        html += '</div>';
                                        html += '<ul class="space-y-3">';
                                        
                                        analysis.recommendations.forEach((rec, index) => {
                                            const recStr = safeString(rec);
                                            if (recStr.length > 0) {
                                                html += '<li class="flex items-start gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">';
                                                html += '<span class="flex-shrink-0 w-7 h-7 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold shadow-sm">' + (index + 1) + '</span>';
                                                html += '<span class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed pt-0.5">' + escapeHtml(recStr) + '</span>';
                                                html += '</li>';
                                            }
                                        });
                                        
                                        html += '</ul>';
                                        html += '</div>';
                                    }
                                    
                                    html += '</div>';
                                    
                                    // innerHTML'e güvenli şekilde ekle
                                    try {
                                        content.innerHTML = html;
                                        showToast('Başarılı', 'Analiz hazır! Sonuçlar görüntüleniyor.', 'success');
                                    } catch (innerError) {
                                        console.error('innerHTML Error:', innerError);
                                        content.innerHTML = '<div class="text-center py-8 text-red-600 dark:text-red-400">HTML oluşturulurken hata oluştu.</div>';
                                        showToast('Hata', 'Görüntüleme hatası oluştu', 'error');
                                    }
                                } else {
                                    const errorMsg = safeString(data.message || 'Analiz oluşturulamadı. Lütfen tekrar deneyin.');
                                    content.innerHTML = '<div class="text-center py-8 text-red-600 dark:text-red-400">' + escapeHtml(errorMsg) + '</div>';
                                    showToast('Hata', 'Analiz oluşturulamadı', 'error');
                                }
                            } catch (error) {
                                console.error('AI Analysis Error:', error);
                                const errorMsg = error.message || 'Bilinmeyen hata';
                                content.innerHTML = '<div class="text-center py-8 text-red-600 dark:text-red-400">Bir hata oluştu: ' + escapeHtml(errorMsg) + '</div>';
                                showToast('Hata', 'Analiz sırasında bir sorun oluştu', 'error');
                            }
                        }
                        </script>
                        
                    </div>

                    <!-- Chart.js CDN -->
                    <script <?= tpl_script_nonce_attr(); ?> src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
                    
                    <script<?= tpl_script_nonce_attr(); ?>>
                    // Chart.js tema ayarları
                    if (typeof Chart !== 'undefined') {
                        Chart.defaults.color = '#6b7280';
                        Chart.defaults.borderColor = '#e5e7eb';
                        
                        // Dark mode desteği
                        const isDark = document.documentElement.classList.contains('dark');
                        if (isDark) {
                            Chart.defaults.color = '#9ca3af';
                            Chart.defaults.borderColor = '#374151';
                        }

                        // Etkinlik Katılım Grafiği (Aylık)
                        try {
                            const attendanceMonthlyData = <?= json_encode($attendance_monthly ?? [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (Array.isArray(attendanceMonthlyData) && attendanceMonthlyData.length > 0) {
                                new Chart(document.getElementById('attendanceMonthlyChart'), {
                                    type: 'line',
                                    data: {
                                        labels: attendanceMonthlyData.map(d => d.month || ''),
                                        datasets: [{
                                            label: 'Katılım Sayısı',
                                            data: attendanceMonthlyData.map(d => d.count || 0),
                                            borderColor: 'rgb(59, 130, 246)',
                                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                            tension: 0.4,
                                            fill: true
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: true, position: 'top' }
                                        },
                                        scales: {
                                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Attendance monthly chart error:', e);
                        }

                        // Etkinlik Katılım Grafiği (Yıllık)
                        try {
                            const attendanceYearlyData = <?= json_encode($attendance_yearly ?? [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (Array.isArray(attendanceYearlyData) && attendanceYearlyData.length > 0) {
                                new Chart(document.getElementById('attendanceYearlyChart'), {
                                    type: 'bar',
                                    data: {
                                        labels: attendanceYearlyData.map(d => d.year || ''),
                                        datasets: [{
                                            label: 'Katılım Sayısı',
                                            data: attendanceYearlyData.map(d => d.count || 0),
                                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                            borderColor: 'rgb(16, 185, 129)',
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: true, position: 'top' }
                                        },
                                        scales: {
                                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Attendance yearly chart error:', e);
                        }

                        // Üye Büyüme Grafiği
                        try {
                            const memberGrowthData = <?= json_encode($member_growth ?? [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (Array.isArray(memberGrowthData) && memberGrowthData.length > 0) {
                                new Chart(document.getElementById('memberGrowthChart'), {
                                    type: 'line',
                                    data: {
                                        labels: memberGrowthData.map(d => d.month || ''),
                                        datasets: [{
                                            label: 'Yeni Üyeler',
                                            data: memberGrowthData.map(d => d.count || 0),
                                            borderColor: 'rgb(168, 85, 247)',
                                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                            tension: 0.4,
                                            fill: true
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: true, position: 'top' }
                                        },
                                        scales: {
                                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Member growth chart error:', e);
                        }

                        // Etkinlik Türü Dağılımı (Pie Chart)
                        try {
                            const categoryData = <?= json_encode($category_distribution ?? [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (Array.isArray(categoryData) && categoryData.length > 0) {
                                new Chart(document.getElementById('categoryDistributionChart'), {
                                    type: 'doughnut',
                                    data: {
                                        labels: categoryData.map(d => d.category || ''),
                                        datasets: [{
                                            data: categoryData.map(d => d.count || 0),
                                            backgroundColor: [
                                                'rgba(59, 130, 246, 0.8)',
                                                'rgba(16, 185, 129, 0.8)',
                                                'rgba(168, 85, 247, 0.8)',
                                                'rgba(245, 158, 11, 0.8)',
                                                'rgba(239, 68, 68, 0.8)',
                                                'rgba(236, 72, 153, 0.8)',
                                                'rgba(14, 165, 233, 0.8)',
                                                'rgba(34, 197, 94, 0.8)'
                                            ],
                                            borderWidth: 2,
                                            borderColor: '#ffffff'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: true, position: 'bottom' }
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Category distribution chart error:', e);
                        }

                        // Email/SMS İstatistikleri
                        try {
                            const emailSmsData = <?= json_encode($email_sms_stats ?? ['email' => ['monthly_sent' => []], 'sms' => ['monthly_sent' => []]], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (emailSmsData && emailSmsData.email && emailSmsData.email.monthly_sent && Array.isArray(emailSmsData.email.monthly_sent)) {
                                new Chart(document.getElementById('emailSmsChart'), {
                                    type: 'bar',
                                    data: {
                                        labels: emailSmsData.email.monthly_sent.map(d => d.month || ''),
                                        datasets: [
                                            {
                                                label: 'Email Gönderim',
                                                data: emailSmsData.email.monthly_sent.map(d => d.count || 0),
                                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                                borderColor: 'rgb(59, 130, 246)',
                                                borderWidth: 1
                                            },
                                            {
                                                label: 'SMS Gönderim',
                                                data: (emailSmsData.sms && emailSmsData.sms.monthly_sent && Array.isArray(emailSmsData.sms.monthly_sent)) 
                                                    ? emailSmsData.sms.monthly_sent.map(d => d.count || 0)
                                                    : [],
                                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                                borderColor: 'rgb(16, 185, 129)',
                                                borderWidth: 1
                                            }
                                        ]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: true, position: 'top' }
                                        },
                                        scales: {
                                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error('Email/SMS chart error:', e);
                        }

                        // Etkinlik Başarı Oranları
                        try {
                            const successRatesData = <?= json_encode($success_rates ?? [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>;
                            if (Array.isArray(successRatesData) && successRatesData.length > 0) {
                                new Chart(document.getElementById('successRatesChart'), {
                                    type: 'bar',
                                    data: {
                                        labels: successRatesData.slice(0, 10).map(d => {
                                            const title = d.title || '';
                                            return title.length > 30 ? title.substring(0, 30) + '...' : title;
                                        }),
                                        datasets: [{
                                            label: 'Başarı Oranı (%)',
                                            data: successRatesData.slice(0, 10).map(d => d.success_rate || 0),
                                            backgroundColor: successRatesData.slice(0, 10).map(d => {
                                                const rate = d.success_rate || 0;
                                                if (rate >= 80) return 'rgba(16, 185, 129, 0.8)';
                                                if (rate >= 50) return 'rgba(245, 158, 11, 0.8)';
                                                return 'rgba(239, 68, 68, 0.8)';
                                            }),
                                            borderWidth: 1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false }
                                        },
                                        scales: {
                                            y: { beginAtZero: true, max: 100, ticks: { callback: function(value) { return value + '%'; } } }
                                        }
                                    }
                                });
                            } else {
                                const chartEl = document.getElementById('successRatesChart');
                                if (chartEl && chartEl.parentElement) {
                                    chartEl.parentElement.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Henüz başarı oranı hesaplanabilecek etkinlik bulunmuyor.</p>';
                                }
                            }
                        } catch (e) {
                            console.error('Success rates chart error:', e);
                        }
                    }
                    </script>

                <?php elseif ($current_view === 'finance'): ?>
                    <?php
                    // Guard kontrolü zaten yukarıda yapıldı
                    // Eğer guard başarısız olduysa $current_view subscription_required olarak ayarlandı
                    // Bu durumda bu blok çalışmayacak çünkü $current_view artık 'finance' değil
                    
                    // Paket yeterli, normal finans görünümünü göster
                    {
                        // Normal finans görünümü
                    // Finans view'i görüntülenmeden önce modül yüklensin (lazy loader fallback)
                    if (!function_exists('get_financial_summary')) {
                        load_module('financial');
                    }
                    if (!function_exists('get_financial_summary')) {
                        tpl_error_log('Finance view fatal: financial module could not be loaded.');
                        throw new RuntimeException('Finans modülü yüklenemedi.');
                    }
                        
                    $schema_status = $TPL_SCHEMA_STATUS ?? tpl_ensure_core_tables();
                    $finance_schema_ok = $schema_status['domains']['finance']['ok'] ?? true;
                    $finance_schema_message = $schema_status['domains']['finance']['message'] ?? '';

                    // Session error'u temizle (finans sayfasına girerken)
                    if (isset($_SESSION['error']) && strpos($_SESSION['error'], 'CSRF') !== false && $_SERVER['REQUEST_METHOD'] === 'GET') {
                        unset($_SESSION['error']);
                    }
                    
                    if (!$finance_schema_ok) {
                        $financial_summary = ['total_income' => 0, 'total_expense' => 0, 'balance' => 0, 'income_by_category' => [], 'expense_by_category' => []];
                        $transactions = $income_categories = $expense_categories = $budgets = $payments = $events = $members = [];
                    } else {
                        try {
                            load_module('financial');
                            $db = get_db();
                            $financial_summary = get_financial_summary($db);
                            $transactions = get_financial_transactions($db, ['limit' => 50]);
                            $income_categories = get_financial_categories($db, 'income');
                            $expense_categories = get_financial_categories($db, 'expense');
                            $budgets = get_budget_plans($db, ['is_active' => true]);
                            $payments = get_payments($db, ['limit' => 50]);
                            $events = get_events();
                            $members = get_members();
                        } catch (Exception $e) {
                            tpl_error_log("Finance view error: " . $e->getMessage());
                            $finance_schema_ok = false;
                            $finance_schema_message = 'Finans tabloları okunamadı: ' . $e->getMessage();
                            $financial_summary = ['total_income' => 0, 'total_expense' => 0, 'balance' => 0, 'income_by_category' => [], 'expense_by_category' => []];
                            $transactions = $income_categories = $expense_categories = $budgets = $payments = $events = $members = [];
                            }
                        }
                    }
                    $financeLocked = !$finance_feature_available;
                    ?>
                    <?php if ($financeLocked): ?>
                    <div class="rounded-2xl border border-slate-200 dark:border-white/5 bg-gradient-to-br from-white via-slate-50 to-amber-50/70 dark:from-slate-900 dark:via-slate-900/70 dark:to-amber-900/10 px-6 py-6 mb-6 shadow-lg shadow-amber-200/40 dark:shadow-black/30 relative overflow-hidden">
                        <div class="absolute inset-y-0 right-0 w-1/3 pointer-events-none opacity-20 bg-[radial-gradient(circle_at_top,_rgba(248,113,113,.5),_transparent_55%)]"></div>
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 relative z-10">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/30">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M12 4.5l7 3V12c0 4.5-3 8.5-7 9-4-.5-7-4.5-7-9V7.5l7-3z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9.5 12.5l2 2 3-3.5"></path>
                                    </svg>
                                </div>
                                <div class="space-y-2">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-amber-200/70 dark:border-amber-400/50 bg-amber-50/80 dark:bg-amber-500/10 text-xs font-semibold text-amber-700 dark:text-amber-200">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-7.364l-.707.707M7.343 16.657l-.707.707m0-11.314l.707.707m9.192 9.192l.707.707"></path></svg>
                                        Business
                                    </div>
                                    <h3 class="text-xl font-semibold text-slate-900 dark:text-white">Finans Yönetimi Business planla açılır</h3>
                                    <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                                        Bütçe planları, ödeme takibi ve gelir-gider tabloları şu anda demo modunda gösteriliyor. Business pakete geçmeden bu alanları düzenleyemez veya gerçek rakamları göremezsiniz.
                                    </p>
                                    <div class="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-300">
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Çoklu bütçe planları
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Otomatik ödeme hatırlatıcıları
                                        </span>
                                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-white/5 border border-slate-200/60 dark:border-white/10">
                                            <span class="text-amber-500">●</span> Gelir/gider raporları
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="index.php?view=subscription" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold shadow-lg shadow-orange-500/40 transition hover:scale-[1.01]">
                                    Business’a Yükselt
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </a>
                                <button type="button" onclick="window.location.href='index.php?view=subscription&scroll=features'" class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-slate-200 dark:border-white/10 text-sm font-semibold text-slate-700 dark:text-slate-200 hover:bg-white/80 dark:hover:bg-white/5 transition">
                                    Özellikleri İncele
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <?php endif; ?>
                    <div data-view="finance" class="space-y-6<?php if ($financeLocked) echo ' relative opacity-60 pointer-events-none select-none'; ?>">
                        <?php if (!$finance_schema_ok): ?>
                        <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-red-800">
                            <h3 class="text-lg font-semibold mb-2">Finans Modülü Hazır Değil</h3>
                            <p class="text-sm"><?= htmlspecialchars($finance_schema_message ?: 'Finans tabloları oluşturulamadı. Lütfen yöneticinizden migrations komutunu çalıştırmasını isteyin.') ?></p>
                            <?php if (!empty($schema_status['issues'])): ?>
                            <ul class="mt-3 list-disc list-inside text-red-700 text-sm space-y-1">
                                <?php foreach ($schema_status['issues'] as $issue): ?>
                                <li><?= htmlspecialchars($issue) ?></li>
                                <?php endforeach; ?>
                            </ul>
                            <?php endif; ?>
                            <p class="mt-3 text-sm text-red-700">Not: Otomatik onarım başarısız oldu. `php templates/bin/migrate.php` komutunu çalıştırarak şemayı güncelleyin.</p>
                        </div>
                        <?php endif; ?>
                        <!-- Özet Kartları -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">Toplam Gelir</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($financial_summary['total_income'], 2, ',', '.') ?> ₺</p>
                                    </div>
                                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                                        <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">Toplam Gider</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= number_format($financial_summary['total_expense'], 2, ',', '.') ?> ₺</p>
                                    </div>
                                    <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                                        <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">Bakiye</p>
                                        <p class="text-2xl font-bold <?= $financial_summary['balance'] >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' ?>"><?= number_format($financial_summary['balance'], 2, ',', '.') ?> ₺</p>
                                    </div>
                                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 dark:text-gray-400 text-sm font-medium mb-1">Bekleyen Ödemeler</p>
                                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100"><?= count(array_filter($payments, fn($p) => $p['payment_status'] === 'pending')) ?></p>
                                    </div>
                                    <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                                        <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                            <div class="border-b border-gray-200 dark:border-gray-700">
                                <nav class="flex -mb-px" id="financeTabs">
                                    <button onclick="switchFinanceTab('transactions')" class="finance-tab-btn active px-6 py-4 text-sm font-medium border-b-2 border-indigo-500 text-indigo-500 dark:text-indigo-400">
                                        İşlemler
                                    </button>
                                    <button onclick="switchFinanceTab('budgets')" class="finance-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                                        Bütçe Planları
                                    </button>
                                    <button onclick="switchFinanceTab('payments')" class="finance-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                                        Ödeme Takibi
                                    </button>
                                    <button onclick="switchFinanceTab('categories')" class="finance-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                                        Kategoriler
                                    </button>
                                    <button onclick="switchFinanceTab('reports')" class="finance-tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                                        Raporlar
                                    </button>
                                </nav>
                            </div>

                            <!-- Transactions Tab -->
                            <div id="tab-transactions" class="finance-tab-content p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Gelir/Gider İşlemleri</h3>
                                    <div class="flex gap-2">
                                        <button onclick="openAddTransactionModal('income')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">
                                            + Gelir Ekle
                                        </button>
                                        <button onclick="openAddTransactionModal('expense')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium">
                                            + Gider Ekle
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-900/50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tarih</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Açıklama</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Kategori</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tutar</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <?php foreach ($transactions as $transaction): ?>
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100"><?= date('d.m.Y', strtotime($transaction['transaction_date'])) ?></td>
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100"><?= htmlspecialchars($transaction['description']) ?></td>
                                                <td class="px-4 py-3 text-sm">
                                                    <?php if ($transaction['category_name']): ?>
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: <?= htmlspecialchars($transaction['category_color']) ?>20; color: <?= htmlspecialchars($transaction['category_color']) ?>">
                                                            <?= htmlspecialchars($transaction['category_name']) ?>
                                                        </span>
                                                    <?php else: ?>
                                                        <span class="text-gray-400">-</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td class="px-4 py-3 text-sm font-semibold <?= $transaction['type'] === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' ?>">
                                                    <?= $transaction['type'] === 'income' ? '+' : '-' ?><?= number_format($transaction['amount'], 2, ',', '.') ?> ₺
                                                </td>
                                                <td class="px-4 py-3 text-sm text-right">
                                                    <button onclick="openEditTransactionModal(<?= $transaction['id'] ?>)" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 mr-2">Düzenle</button>
                                                    <button onclick="if(confirm('Bu işlemi silmek istediğinize emin misiniz?')) { document.getElementById('delete_transaction_form_<?= $transaction['id'] ?>').submit(); }" class="text-red-600 hover:text-red-800 dark:text-red-400">Sil</button>
                                                    <form id="delete_transaction_form_<?= $transaction['id'] ?>" method="POST" style="display:none;">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="delete_financial_transaction">
                                                        <input type="hidden" name="id" value="<?= $transaction['id'] ?>">
                                                        <input type="hidden" name="current_view" value="finance">
                                                    </form>
                                                </td>
                                            </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Budgets Tab -->
                            <div id="tab-budgets" class="finance-tab-content hidden p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Bütçe Planları</h3>
                                    <button onclick="openAddBudgetModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">
                                        + Bütçe Planı Ekle
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <?php if (empty($budgets)): ?>
                                        <div class="col-span-2 text-center py-8 text-gray-500 dark:text-gray-400">
                                            <p>Henüz bütçe planı eklenmemiş.</p>
                                        </div>
                                    <?php else: ?>
                                        <?php foreach ($budgets as $budget): ?>
                                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 class="font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($budget['name']) ?></h4>
                                                    <p class="text-sm text-gray-500 dark:text-gray-400"><?= date('d.m.Y', strtotime($budget['period_start'])) ?> - <?= date('d.m.Y', strtotime($budget['period_end'])) ?></p>
                                                </div>
                                                <div class="flex gap-2 items-start">
                                                    <span class="px-2 py-1 text-xs font-medium rounded <?= $budget['type'] === 'income' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' ?>">
                                                        <?= $budget['type'] === 'income' ? 'Gelir' : 'Gider' ?>
                                                    </span>
                                                    <div class="flex gap-1">
                                                        <button onclick="openEditBudgetModal(<?= $budget['id'] ?>)" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 text-xs">Düzenle</button>
                                                        <button onclick="if(confirm('Bu bütçe planını silmek istediğinize emin misiniz?')) { document.getElementById('delete_budget_form_<?= $budget['id'] ?>').submit(); }" class="text-red-600 hover:text-red-800 dark:text-red-400 text-xs">Sil</button>
                                                        <form id="delete_budget_form_<?= $budget['id'] ?>" method="POST" style="display:none;">
                                                            <?= csrf_token_field() ?>
                                                            <input type="hidden" name="action" value="delete_budget_plan">
                                                            <input type="hidden" name="id" value="<?= $budget['id'] ?>">
                                                            <input type="hidden" name="current_view" value="finance">
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="flex justify-between text-sm mb-1">
                                                    <span class="text-gray-600 dark:text-gray-400">Bütçe:</span>
                                                    <span class="font-semibold text-gray-900 dark:text-gray-100"><?= number_format($budget['budgeted_amount'], 2, ',', '.') ?> ₺</span>
                                                </div>
                                                <div class="flex justify-between text-sm mb-1">
                                                    <span class="text-gray-600 dark:text-gray-400">Harcanan:</span>
                                                    <span class="font-semibold <?= $budget['spent'] > $budget['budgeted_amount'] ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-100' ?>"><?= number_format($budget['spent'], 2, ',', '.') ?> ₺</span>
                                                </div>
                                                <div class="flex justify-between text-sm mb-2">
                                                    <span class="text-gray-600 dark:text-gray-400">Kalan:</span>
                                                    <span class="font-semibold <?= $budget['remaining'] < 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400' ?>"><?= number_format($budget['remaining'], 2, ',', '.') ?> ₺</span>
                                                </div>
                                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                    <div class="h-2 rounded-full <?= $budget['usage_percentage'] > 100 ? 'bg-red-500' : ($budget['usage_percentage'] > 80 ? 'bg-yellow-500' : 'bg-green-500') ?>" style="width: <?= min($budget['usage_percentage'], 100) ?>%"></div>
                                                </div>
                                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">%<?= number_format($budget['usage_percentage'], 1) ?> kullanıldı</p>
                                            </div>
                                        </div>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </div>
                            </div>

                            <!-- Payments Tab -->
                            <div id="tab-payments" class="finance-tab-content hidden p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Ödeme Takibi</h3>
                                    <div class="flex gap-2">
                                        <button onclick="sendPaymentConfirmationEmails()" id="sendPaymentEmailsBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            📧 Seçilenlere Mail Gönder
                                        </button>
                                        <button onclick="openAddPaymentModal()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium">
                                            + Ödeme Ekle
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-900/50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                                                    <input type="checkbox" id="selectAllPayments" onchange="toggleAllPayments(this)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700">
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Etkinlik</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Üye</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tutar</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Durum</th>
                                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <?php foreach ($payments as $payment): ?>
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/30">
                                                <td class="px-4 py-3 text-sm">
                                                    <input type="checkbox" name="payment_ids[]" value="<?= $payment['id'] ?>" 
                                                           data-email="<?= htmlspecialchars($payment['member_email'] ?? '') ?>"
                                                           data-name="<?= htmlspecialchars($payment['member_name'] ?? '') ?>"
                                                           data-amount="<?= $payment['amount'] ?>"
                                                           class="payment-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"
                                                           onchange="updateSendEmailButton()">
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100"><?= htmlspecialchars($payment['event_title'] ?? '-') ?></td>
                                                <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100"><?= htmlspecialchars($payment['member_name'] ?? '-') ?></td>
                                                <td class="px-4 py-3 text-sm font-semibold text-gray-900 dark:text-gray-100"><?= number_format($payment['amount'], 2, ',', '.') ?> ₺</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <?php
                                                    $status_colors = [
                                                        'pending' => 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400',
                                                        'paid' => 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400',
                                                        'refunded' => 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                                                        'cancelled' => 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'
                                                    ];
                                                    $status_labels = [
                                                        'pending' => 'Bekliyor',
                                                        'paid' => 'Ödendi',
                                                        'refunded' => 'İade Edildi',
                                                        'cancelled' => 'İptal'
                                                    ];
                                                    ?>
                                                    <span class="px-2 py-1 text-xs font-medium rounded <?= $status_colors[$payment['payment_status']] ?? $status_colors['pending'] ?>">
                                                        <?= $status_labels[$payment['payment_status']] ?? $payment['payment_status'] ?>
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm text-right">
                                                    <button onclick="openEditPaymentModal(<?= $payment['id'] ?>)" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 mr-2">Düzenle</button>
                                                    <button onclick="if(confirm('Bu ödemeyi silmek istediğinize emin misiniz?')) { document.getElementById('delete_payment_form_<?= $payment['id'] ?>').submit(); }" class="text-red-600 hover:text-red-800 dark:text-red-400">Sil</button>
                                                    <form id="delete_payment_form_<?= $payment['id'] ?>" method="POST" style="display:none;">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="delete_payment">
                                                        <input type="hidden" name="id" value="<?= $payment['id'] ?>">
                                                        <input type="hidden" name="current_view" value="finance">
                                                    </form>
                                                </td>
                                            </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Categories Tab -->
                            <div id="tab-categories" class="finance-tab-content hidden p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Kategoriler</h3>
                                    <button onclick="openAddCategoryModal()" class="px-4 py-2 bg-indigo-400 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium">
                                        + Kategori Ekle
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3">Gelir Kategorileri</h4>
                                        <div class="space-y-2">
                                            <?php foreach (isset($income_categories) ? $income_categories : [] as $category): ?>
                                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-4 h-4 rounded" style="background-color: <?= htmlspecialchars($category['color']) ?>"></div>
                                                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($category['name']) ?></span>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="openEditCategoryModal(<?= $category['id'] ?>)" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 text-sm">Düzenle</button>
                                                    <button onclick="if(confirm('Bu kategoriyi silmek istediğinize emin misiniz?')) { document.getElementById('delete_category_form_<?= $category['id'] ?>').submit(); }" class="text-red-600 hover:text-red-800 dark:text-red-400 text-sm">Sil</button>
                                                    <form id="delete_category_form_<?= $category['id'] ?>" method="POST" style="display:none;">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="delete_financial_category">
                                                        <input type="hidden" name="id" value="<?= $category['id'] ?>">
                                                        <input type="hidden" name="current_view" value="finance">
                                                    </form>
                                                </div>
                                            </div>
                                            <?php endforeach; ?>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3">Gider Kategorileri</h4>
                                        <div class="space-y-2">
                                            <?php foreach (isset($expense_categories) ? $expense_categories : [] as $category): ?>
                                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-4 h-4 rounded" style="background-color: <?= htmlspecialchars($category['color']) ?>"></div>
                                                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($category['name']) ?></span>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="openEditCategoryModal(<?= $category['id'] ?>)" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 text-sm">Düzenle</button>
                                                    <button onclick="if(confirm('Bu kategoriyi silmek istediğinize emin misiniz?')) { document.getElementById('delete_category_form_<?= $category['id'] ?>').submit(); }" class="text-red-600 hover:text-red-800 dark:text-red-400 text-sm">Sil</button>
                                                    <form id="delete_category_form_<?= $category['id'] ?>" method="POST" style="display:none;">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="delete_financial_category">
                                                        <input type="hidden" name="id" value="<?= $category['id'] ?>">
                                                        <input type="hidden" name="current_view" value="finance">
                                                    </form>
                                                </div>
                                            </div>
                                            <?php endforeach; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports Tab -->
                            <div id="tab-reports" class="finance-tab-content hidden p-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Finansal Raporlar</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3">Gelir Dağılımı</h4>
                                        <div class="h-64">
                                            <canvas id="incomeChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-3">Gider Dağılımı</h4>
                                        <div class="h-64">
                                            <canvas id="expenseChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <?php elseif ($current_view === 'market'): ?>
                    <?php include __DIR__ . '/template_market.php'; ?>
                
                <?php elseif ($current_view === 'campaigns'): ?>
                    <?php
                    if (!function_exists('get_current_subscription_info')) {
                        require_once __DIR__ . '/../lib/general/subscription_helper.php';
                    }
                    $campaignSubscriptionInfo = function_exists('get_current_subscription_info') ? get_current_subscription_info() : ['tier' => 'standard', 'tier_label' => 'Standart', 'limits' => ['max_campaigns' => 3]];
                    $campaignTier = $campaignSubscriptionInfo['tier'] ?? 'standard';
                    $campaignTierLabel = $campaignSubscriptionInfo['tier_label'] ?? 'Standart';
                    $campaignDefaultLimit = $campaignSubscriptionInfo['limits']['max_campaigns'] ?? 3;
                    $campaignLimitInfo = function_exists('check_campaign_limit')
                        ? check_campaign_limit(count($campaigns))
                        : [
                            'limit' => $campaignDefaultLimit,
                            'current' => count($campaigns),
                            'remaining' => $campaignDefaultLimit === -1 ? -1 : max(0, $campaignDefaultLimit - count($campaigns))
                        ];
                    $campaignLimit = $campaignLimitInfo['limit'] ?? $campaignDefaultLimit;
                    $campaignCurrentCount = $campaignLimitInfo['current'] ?? count($campaigns);
                    $campaignRemaining = $campaignLimitInfo['remaining'];
                    if ($campaignRemaining === null) {
                        $campaignRemaining = $campaignLimit === -1 ? -1 : max(0, $campaignLimit - $campaignCurrentCount);
                    }
                    $campaignLimitLabel = $campaignLimit === -1 ? 'sınırsız' : $campaignLimit;
                    $campaignLimitReached = $campaignLimit !== -1 && $campaignRemaining <= 0;
                    $campaignIsStandard = ($campaignTier === 'standard');
                    ?>
                    <div data-view="campaigns" class="max-w-full overflow-x-hidden">
                        <!-- Tüm İçerik Tek Kart İçinde -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 section-card">
                            <!-- Başlık -->
                            <div class="mb-8 flex flex-wrap items-start justify-between gap-4 border-b border-gray-200 dark:border-gray-700 pb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Kampanya Yönetimi</h1>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5"><?= count($campaigns) ?> kampanya</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 items-start">
                                    <button onclick="openAddCampaignModal()" id="open-campaign-modal-btn" class="px-4 py-2 <?= $campaignLimitReached ? 'bg-amber-100 text-amber-800 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-100 dark:border-amber-500/40' : 'bg-indigo-600 hover:bg-indigo-700 text-white' ?> rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Yeni Kampanya
                                </button>
                                    <?php if ($campaignLimitReached && $campaignIsStandard): ?>
                                        <p class="text-xs font-semibold text-amber-700 dark:text-amber-200">Standart paketteki limit doldu.</p>
                                    <?php endif; ?>
                                </div>
                            </div>
                            
                            <?php if ($campaignIsStandard): ?>
                            <div class="rounded-2xl border border-amber-200 dark:border-amber-500/40 bg-gradient-to-br from-white via-amber-50 to-orange-50 dark:from-slate-900 dark:via-amber-900/30 dark:to-slate-900 px-5 py-5 mb-8 shadow-lg shadow-amber-100/50 dark:shadow-black/40">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                                    <div class="flex items-start gap-4">
                                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-500 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/30">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 7h18M3 12h12M3 17h8"></path>
                                            </svg>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-amber-300/70 dark:border-amber-400/50 bg-amber-50/80 dark:bg-amber-500/10 text-xs font-semibold text-amber-700 dark:text-amber-200">
                                                Standart Paket · Maks. <?= htmlspecialchars((string)$campaignLimitLabel) ?> kampanya
                                            </div>
                                            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Kampanya limiti</h3>
                                            <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                                                Standart pakette en fazla <?= htmlspecialchars((string)$campaignLimitLabel) ?> kampanya yayınlanır. Şu anda <strong><?= $campaignCurrentCount ?></strong> kampanyanız var ve <?php if ($campaignLimit === -1): ?>sınırsız slotunuz var<?php else: ?><?= max(0, $campaignRemaining) ?> slot kaldı<?php endif; ?>.
                                            </p>
                                            <div class="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/80 dark:bg-white/5 border border-amber-100/70 dark:border-white/10">
                                                    <span class="text-amber-500">●</span> Otomatik raporlar
                                                </span>
                                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/80 dark:bg-white/5 border border-amber-100/70 dark:border-white/10">
                                                    <span class="text-amber-500">●</span> Çoklu partner yönetimi
                                                </span>
                                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white/80 dark:bg-white/5 border border-amber-100/70 dark:border-white/10">
                                                    <span class="text-amber-500">●</span> Sınırsız yayın için Professional
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                                        <?php if ($campaignLimitReached): ?>
                                            <span class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-100 font-semibold">
                                                Limit Doldu (<?= $campaignCurrentCount ?>/<?= htmlspecialchars((string)($campaignLimit === -1 ? '∞' : $campaignLimit)) ?>)
                                            </span>
                                        <?php else: ?>
                                            <span class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/80 border border-amber-200 text-amber-700 dark:border-amber-500/40 dark:text-amber-100 font-semibold">
                                                Kalan Slot: <?= $campaignRemaining === -1 ? 'Sınırsız' : $campaignRemaining ?>
                                            </span>
                                        <?php endif; ?>
                                        <a href="index.php?view=subscription" class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold shadow-lg shadow-orange-500/30 hover:scale-[1.01] transition">
                                            Professional’a Geç
                                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9 5l7 7-7 7"></path></svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <?php endif; ?>
                            
                            <!-- Kampanya Listesi -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="campaignsGrid">
                                <?php if (count($campaigns) > 0): ?>
                                    <?php foreach ($campaigns as $campaign): ?>
                                        <?php
                                        $is_active = (int)$campaign['is_active'] === 1;
                                        $start_date = $campaign['start_date'] ? date('d.m.Y', strtotime($campaign['start_date'])) : null;
                                        $end_date = $campaign['end_date'] ? date('d.m.Y', strtotime($campaign['end_date'])) : null;
                                        $is_expired = $end_date && strtotime($campaign['end_date']) < time();
                                        ?>
                                        <div class="bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden <?= !$is_active || $is_expired ? 'opacity-60' : '' ?>">
                                            <!-- Görsel -->
                                            <?php if ($campaign['image_path']): ?>
                                                <div class="h-48 bg-gray-100 dark:bg-gray-700 overflow-hidden">
                                                    <img src="<?= htmlspecialchars($campaign['image_path']) ?>" alt="<?= htmlspecialchars($campaign['title']) ?>" class="w-full h-full object-cover">
                                                </div>
                                            <?php else: ?>
                                                <div class="h-48 bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center">
                                                    <svg class="w-16 h-16 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                            <?php endif; ?>
                                            
                                            <!-- İçerik -->
                                            <div class="p-5">
                                                <div class="flex items-start justify-between mb-2">
                                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 line-clamp-2">
                                                        <?= htmlspecialchars($campaign['title']) ?>
                                                    </h3>
                                                    <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full <?= $is_active && !$is_expired ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' ?>">
                                                        <?= $is_active && !$is_expired ? 'Aktif' : ($is_expired ? 'Süresi Doldu' : 'Pasif') ?>
                                                    </span>
                                                </div>
                                                
                                                <?php if ($campaign['partner_name']): ?>
                                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                                        <span class="font-medium">Partner:</span> <?= htmlspecialchars($campaign['partner_name']) ?>
                                                    </p>
                                                <?php endif; ?>
                                                
                                                <?php if ($campaign['discount_percentage']): ?>
                                                    <div class="mb-2">
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                                            %<?= htmlspecialchars($campaign['discount_percentage']) ?> İndirim
                                                        </span>
                                                    </div>
                                                <?php endif; ?>
                                                
                                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">
                                                    <?= htmlspecialchars($campaign['offer_text']) ?>
                                                </p>
                                                
                                                <?php if ($campaign['description']): ?>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 line-clamp-2">
                                                        <?= htmlspecialchars($campaign['description']) ?>
                                                    </p>
                                                <?php endif; ?>
                                                
                                                <?php if ($start_date || $end_date): ?>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-4 space-y-1">
                                                        <?php if ($start_date): ?>
                                                            <div class="flex items-center gap-1">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                </svg>
                                                                <span>Başlangıç: <?= $start_date ?></span>
                                                            </div>
                                                        <?php endif; ?>
                                                        <?php if ($end_date): ?>
                                                            <div class="flex items-center gap-1">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                </svg>
                                                                <span>Bitiş: <?= $end_date ?></span>
                                                            </div>
                                                        <?php endif; ?>
                                                    </div>
                                                <?php endif; ?>
                                                
                                                <!-- İşlemler -->
                                                <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                                                    <button onclick="openEditCampaignModal(<?= $campaign['id'] ?>)" class="flex-1 px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                                                        Düzenle
                                                    </button>
                                                    <form method="POST" action="" class="inline" onsubmit="return confirm('Kampanyayı silmek istediğinize emin misiniz?');">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="delete_campaign">
                                                        <input type="hidden" name="id" value="<?= $campaign['id'] ?>">
                                                        <input type="hidden" name="current_view" value="campaigns">
                                                        <button type="submit" class="px-3 py-2 text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                                            Sil
                                                        </button>
                                                    </form>
                                                    <form method="POST" action="" class="inline">
                                                        <?= csrf_token_field() ?>
                                                        <input type="hidden" name="action" value="toggle_campaign_status">
                                                        <input type="hidden" name="id" value="<?= $campaign['id'] ?>">
                                                        <input type="hidden" name="current_view" value="campaigns">
                                                        <button type="submit" class="px-3 py-2 text-sm font-medium <?= $is_active ? 'text-yellow-600 hover:text-yellow-800 dark:text-yellow-400' : 'text-green-600 hover:text-green-800 dark:text-green-400' ?> hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                                            <?= $is_active ? 'Pasifleştir' : 'Aktifleştir' ?>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <div class="col-span-full text-center py-12">
                                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Henüz kampanya yok</h3>
                                        <p class="text-gray-500 dark:text-gray-400 mb-4">İlk kampanyanızı oluşturmak için yukarıdaki butona tıklayın.</p>
                                    </div>
                                <?php endif; ?>
                            </div>
                            
                            
                            <!-- Scroll-based Lazy Loading: Loading Indicator -->
                            <?php if (isset($has_more_campaigns) && $has_more_campaigns): ?>
                            <div id="campaignsLoadingSpinner" class="mt-6 text-center" style="min-height: 60px;">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 hidden"></div>
                                <p class="text-gray-600 dark:text-gray-400 mt-2 hidden">Yükleniyor...</p>
                            </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    
                    <!-- Kampanya Ekleme/Düzenleme Modal -->
                    <div id="campaignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="campaignModalTitle">Yeni Kampanya</h3>
                                <button onclick="closeCampaignModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <form id="campaignForm" method="POST" action="" enctype="multipart/form-data" class="p-6 space-y-4">
                                <?= csrf_token_field() ?>
                                <?= csrf_token_field() ?>
                                <input type="hidden" name="action" id="campaignAction" value="add_campaign">
                                <input type="hidden" name="id" id="campaignId">
                                <input type="hidden" name="current_view" value="campaigns">
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kampanya Başlığı *</label>
                                    <input type="text" name="title" id="campaignTitle" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Açıklama</label>
                                    <textarea name="description" id="campaignDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-800 dark:text-gray-200 mb-2">
                                        Teklif Metni <span class="text-red-500">*</span>
                                    </label>
                                    <div class="mb-2">
                                        <button type="button" onclick="generateCampaignText()" 
                                                class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                                id="ai-generate-campaign-btn">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            <span>AI ile Oluştur</span>
                                        </button>
                                    </div>
                                    <textarea name="offer_text" id="campaignOfferText" required rows="3" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="Örn: Topluluğumuza üye olursanız Coffee Den'den %50 indirim kazanın!"></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Partner Adı</label>
                                        <input type="text" name="partner_name" id="campaignPartnerName" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Örn: Coffee Den">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">İndirim Yüzdesi (%)</label>
                                        <input type="number" name="discount_percentage" id="campaignDiscount" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="50">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kampanya Kodu</label>
                                    <input type="text" name="campaign_code" id="campaignCode" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Örn: COFFEE50, WELCOME2024" maxlength="50">
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Kampanya kodu kullanıcılar tarafından kopyalanabilir</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Başlangıç Tarihi</label>
                                        <input type="date" name="start_date" id="campaignStartDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bitiş Tarihi</label>
                                        <input type="date" name="end_date" id="campaignEndDate" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kampanya Görseli</label>
                                    <input type="file" name="campaign_image" id="campaignImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">JPG, PNG, GIF veya WEBP formatında, maksimum 5MB</p>
                                    <div id="campaignImagePreview" class="mt-2 hidden">
                                        <img id="campaignImagePreviewImg" src="" alt="Önizleme" class="w-32 h-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" name="is_active" id="campaignIsActive" value="1" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Kampanyayı aktif olarak göster</span>
                                    </label>
                                </div>
                                
                                <!-- Kampanya Şartları -->
                                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Kampanya Şartları</h3>
                                    
                                    <div class="mb-4">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" name="requires_membership" id="campaignRequiresMembership" value="1" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Topluluğa üye olma şartı</span>
                                        </label>
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 ml-6">Bu seçenek işaretlenirse, kampanya kodunu görmek için kullanıcının topluluğa üye olması gerekecektir.</p>
                                    </div>
                                    
                                    <div id="requirementsContainer" class="space-y-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Özel Şartlar</label>
                                            <button type="button" onclick="addRequirement()" class="px-3 py-1 text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors">
                                                + Şart Ekle
                                            </button>
                                        </div>
                                        <div id="requirementsList" class="space-y-3">
                                            <!-- Şartlar buraya dinamik olarak eklenecek -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <button type="button" onclick="closeCampaignModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                        İptal
                                    </button>
                                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 rounded-lg transition-colors">
                                        Kaydet
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <script<?= tpl_script_nonce_attr(); ?>>
                        window.campaignLimitInfo = {
                            isStandardPlan: <?= $campaignIsStandard ? 'true' : 'false' ?>,
                            limit: <?= $campaignLimit === null ? 'null' : ($campaignLimit === -1 ? '-1' : (int)$campaignLimit) ?>,
                            remaining: <?= $campaignRemaining === null ? 'null' : ($campaignRemaining === -1 ? '-1' : (int)$campaignRemaining) ?>,
                            reached: <?= $campaignLimitReached ? 'true' : 'false' ?>
                        };

                        function showCampaignLimitToast(limit) {
                            const message = limit && limit !== -1
                                ? `Standart pakette en fazla ${limit} kampanya yayınlanabilir.`
                                : 'Standart paket limitine ulaşıldı.';
                            if (typeof toastManager !== 'undefined' && typeof toastManager.show === 'function') {
                                toastManager.show('Limit Uyarısı', message, 'warning', 4500);
                            } else {
                                alert(message);
                            }
                        }

                        function openAddCampaignModal() {
                            const limitInfo = window.campaignLimitInfo || {};
                            const limitVal = typeof limitInfo.limit !== 'undefined' ? Number(limitInfo.limit) : null;
                            const remainingVal = typeof limitInfo.remaining !== 'undefined' && limitInfo.remaining !== null
                                ? Number(limitInfo.remaining)
                                : 0;
                            if (limitInfo.isStandardPlan && limitVal !== null && limitVal !== -1 && remainingVal <= 0) {
                                showCampaignLimitToast(limitVal);
                                const modal = document.getElementById('campaignModal');
                                if (modal) {
                                    modal.classList.add('hidden');
                                }
                                return;
                            }

                            document.getElementById('campaignModalTitle').textContent = 'Yeni Kampanya';
                            document.getElementById('campaignAction').value = 'add_campaign';
                            document.getElementById('campaignId').value = '';
                            document.getElementById('campaignForm').reset();
                            document.getElementById('campaignImagePreview').classList.add('hidden');
                            document.getElementById('campaignModal').classList.remove('hidden');
                        }
                        
                        function openEditCampaignModal(id) {
                            const campaign = <?= json_encode(array_column($campaigns, null, 'id'), JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT) ?>[id];
                            if (!campaign) return;
                            
                            document.getElementById('campaignModalTitle').textContent = 'Kampanya Düzenle';
                            document.getElementById('campaignAction').value = 'update_campaign';
                            document.getElementById('campaignId').value = campaign.id;
                            document.getElementById('campaignTitle').value = campaign.title || '';
                            document.getElementById('campaignDescription').value = campaign.description || '';
                            document.getElementById('campaignOfferText').value = campaign.offer_text || '';
                            document.getElementById('campaignPartnerName').value = campaign.partner_name || '';
                            document.getElementById('campaignDiscount').value = campaign.discount_percentage || '';
                            document.getElementById('campaignCode').value = campaign.campaign_code || '';
                            document.getElementById('campaignStartDate').value = campaign.start_date || '';
                            document.getElementById('campaignEndDate').value = campaign.end_date || '';
                            document.getElementById('campaignIsActive').checked = campaign.is_active == 1;
                            document.getElementById('campaignRequiresMembership').checked = campaign.requires_membership == 1;
                            
                            // Requirements yükle
                            const requirementsList = document.getElementById('requirementsList');
                            requirementsList.innerHTML = '';
                            if (campaign.requirements) {
                                try {
                                    const requirements = JSON.parse(campaign.requirements);
                                    requirements.forEach((req, index) => {
                                        addRequirement(req.type, req.description, req.id || 'req_' + index);
                                    });
                                } catch (e) {
                                    console.error('Requirements parse error:', e);
                                }
                            }
                            
                            if (campaign.image_path) {
                                document.getElementById('campaignImagePreviewImg').src = campaign.image_path;
                                document.getElementById('campaignImagePreview').classList.remove('hidden');
                            } else {
                                document.getElementById('campaignImagePreview').classList.add('hidden');
                            }
                            
                            document.getElementById('campaignModal').classList.remove('hidden');
                        }
                        
                        function closeCampaignModal() {
                            document.getElementById('campaignModal').classList.add('hidden');
                            // Requirements listesini temizle
                            document.getElementById('requirementsList').innerHTML = '';
                        }
                        
                        // Şart ekleme fonksiyonu
                        let requirementCounter = 0;
                        function addRequirement(type = 'custom', description = '', id = null) {
                            const reqId = id || 'req_' + (++requirementCounter);
                            const requirementsList = document.getElementById('requirementsList');
                            
                            const reqDiv = document.createElement('div');
                            reqDiv.className = 'requirement-item border border-gray-300 dark:border-gray-600 rounded-lg p-3 bg-gray-50 dark:bg-gray-800';
                            reqDiv.dataset.reqId = reqId;
                            
                            reqDiv.innerHTML = `
                                <div class="grid grid-cols-12 gap-3">
                                    <div class="col-span-4">
                                        <select name="requirements[${reqId}][type]" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                            <option value="membership" ${type === 'membership' ? 'selected' : ''}>Topluluğa Üye</option>
                                            <option value="verified" ${type === 'verified' ? 'selected' : ''}>Doğrulanmış Üye</option>
                                            <option value="board_member" ${type === 'board_member' ? 'selected' : ''}>Yönetim Kurulu</option>
                                            <option value="custom" ${type === 'custom' ? 'selected' : ''}>Özel Şart</option>
                                        </select>
                                    </div>
                                    <div class="col-span-7">
                                        <input type="text" name="requirements[${reqId}][description]" value="${description.replace(/"/g, '&quot;')}" placeholder="Şart açıklaması" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" required>
                                        <input type="hidden" name="requirements[${reqId}][id]" value="${reqId}">
                                    </div>
                                    <div class="col-span-1">
                                        <button type="button" onclick="removeRequirement('${reqId}')" class="w-full px-2 py-2 text-sm font-medium text-red-600 hover:text-red-700 bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                            ×
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            requirementsList.appendChild(reqDiv);
                        }
                        
                        function removeRequirement(reqId) {
                            const reqItem = document.querySelector(`.requirement-item[data-req-id="${reqId}"]`);
                            if (reqItem) {
                                reqItem.remove();
                            }
                        }
                        
                        // Form submit'te requirements'ı JSON'a çevir
                        document.getElementById('campaignForm')?.addEventListener('submit', function(e) {
                            const requirements = [];
                            const requirementItems = document.querySelectorAll('.requirement-item');
                            
                            requirementItems.forEach(item => {
                                const type = item.querySelector('select').value;
                                const description = item.querySelector('input[type="text"]').value.trim();
                                const id = item.dataset.reqId;
                                
                                if (description) {
                                    requirements.push({
                                        id: id,
                                        type: type,
                                        description: description
                                    });
                                }
                            });
                            
                            // Hidden input ekle
                            let requirementsInput = document.getElementById('requirementsJson');
                            if (!requirementsInput) {
                                requirementsInput = document.createElement('input');
                                requirementsInput.type = 'hidden';
                                requirementsInput.id = 'requirementsJson';
                                requirementsInput.name = 'requirements_json';
                                this.appendChild(requirementsInput);
                            }
                            requirementsInput.value = JSON.stringify(requirements);
                        });
                        
                        // Görsel önizleme
                        document.getElementById('campaignImage')?.addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('campaignImagePreviewImg').src = e.target.result;
                                    document.getElementById('campaignImagePreview').classList.remove('hidden');
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    </script>

                <?php elseif ($current_view === 'system_info'): ?>
                    <div data-view="system_info" class="max-w-7xl mx-auto animate-fadeInUp">
                        <!-- Minimal Header -->
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Sistem Hakkında</h1>
                            <p class="text-gray-500">Sistem bilgileri ve yasal belgeler</p>
                        </div>
                        
                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                            
                            <!-- Minimal Tabs -->
                            <div class="border-b border-gray-200">
                                <div class="flex space-x-6 px-8 overflow-x-auto">
                                    <?php 
                                    $active_tab = tpl_filter_slug($_GET['tab'] ?? '', 'info', ['lowercase' => true]);
                                    if ($active_tab === '') {
                                        $active_tab = 'info';
                                    }
                                    $tab_class_info = ($active_tab === 'info') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    $tab_class_privacy = ($active_tab === 'privacy') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    $tab_class_terms = ($active_tab === 'terms') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    $tab_class_distance = ($active_tab === 'distance') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    $tab_class_preinfo = ($active_tab === 'preinfo') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    $tab_class_cancellation = ($active_tab === 'cancellation') ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700';
                                    ?>
                                    <a href="?view=system_info&tab=info" id="system-tab-info" class="system-info-tab <?= $tab_class_info ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        Sistem Bilgileri
                                    </a>
                                    <a href="?view=system_info&tab=privacy" id="system-tab-privacy" class="system-info-tab <?= $tab_class_privacy ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        Gizlilik Politikası
                                    </a>
                                    <a href="?view=system_info&tab=terms" id="system-tab-terms" class="system-info-tab <?= $tab_class_terms ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        Kullanım Koşulları
                                    </a>
                                    <a href="?view=system_info&tab=distance" id="system-tab-distance" class="system-info-tab <?= $tab_class_distance ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        Mesafeli Satış
                                    </a>
                                    <a href="?view=system_info&tab=preinfo" id="system-tab-preinfo" class="system-info-tab <?= $tab_class_preinfo ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        Ön Bilgilendirme
                                    </a>
                                    <a href="?view=system_info&tab=cancellation" id="system-tab-cancellation" class="system-info-tab <?= $tab_class_cancellation ?> px-1 py-4 text-sm font-medium transition-colors duration-200 -mb-px whitespace-nowrap">
                                        İptal & İade
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Tab Content -->
                            <div class="min-h-[500px] p-10">
                                <!-- Sistem Bilgileri Tab -->
                                <div id="system-content-info" class="system-info-tab-content <?= $active_tab !== 'info' ? 'hidden' : '' ?>">
                                    <?php
                                    // İstatistikleri al
                                    $stats = get_stats();
                                    $db = get_db();
                                    
                                    // Events modülünü yükle (get_events için)
                                    load_module('events');
                                    // Members modülünü yükle
                                    load_module('members');
                                    
                                    // Trial bilgileri
                                    $trial_stmt = $db->prepare("SELECT setting_value FROM settings WHERE setting_key = 'trial_start_date' AND club_id = ? LIMIT 1");
                                    $trial_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                                    $trial_result = $trial_stmt->execute();
                                    $trial_row = $trial_result->fetchArray(SQLITE3_ASSOC);
                                    
                                    if ($trial_row && !empty($trial_row['setting_value'])) {
                                        $trial_start_date = $trial_row['setting_value'];
                                        $start_timestamp = strtotime($trial_start_date);
                                        $current_timestamp = time();
                                        $days_passed = floor(($current_timestamp - $start_timestamp) / (60 * 60 * 24));
                                        $days_remaining = max(0, 365 - $days_passed);
                                        $trial_end_date = date('d.m.Y', strtotime($trial_start_date . ' +365 days'));
                                        $trial_start_formatted = date('d.m.Y', $start_timestamp);
                                    } else {
                                        $trial_start_date = date('Y-m-d');
                                        $days_passed = 0;
                                        $days_remaining = 365;
                                        $trial_start_formatted = date('d.m.Y');
                                        $trial_end_date = date('d.m.Y', strtotime('+365 days'));
                                    }
                                    
                                    // Tablo varlığını kontrol eden yardımcı fonksiyon
                                    $tableExists = function($tableName) use ($db) {
                                        try {
                                            // Güvenlik: Table name'i whitelist ile kontrol et
                                            $allowed_tables = ['events', 'members', 'board_members', 'notifications', 'settings', 'campaigns', 'email_campaigns', 'email_queue'];
                                            if (in_array($tableName, $allowed_tables)) {
                                                $table_check_stmt = $db->prepare("SELECT name FROM sqlite_master WHERE type='table' AND name=?");
                                                $table_check_stmt->bindValue(1, $tableName, SQLITE3_TEXT);
                                                $result = $table_check_stmt->execute();
                                            } else {
                                                $result = false;
                                            }
                                            if ($result) {
                                                $row = $result->fetchArray();
                                                return $row !== false;
                                            }
                                            return false;
                                        } catch (Exception $e) {
                                            return false;
                                        }
                                    };
                                    
                                    // Ek istatistikler (güvenli sorgular - tablo yoksa 0 döner)
                                    $board_members_count = 0;
                                    if ($tableExists('board_members')) {
                                        try {
                                            $result = $db->querySingle("SELECT COUNT(*) FROM board_members WHERE club_id = " . CLUB_ID);
                                            $board_members_count = $result !== false ? (int)$result : 0;
                                        } catch (Exception $e) {
                                            $board_members_count = 0;
                                        }
                                    }
                                    
                                    $surveys_count = 0;
                                    if ($tableExists('event_surveys')) {
                                        try {
                                            $result = $db->querySingle("SELECT COUNT(*) FROM event_surveys WHERE club_id = " . CLUB_ID);
                                            $surveys_count = $result !== false ? (int)$result : 0;
                                        } catch (Exception $e) {
                                            $surveys_count = 0;
                                        }
                                    }
                                    
                                    $notifications_count = 0;
                                    if ($tableExists('notifications')) {
                                        try {
                                            $result = $db->querySingle("SELECT COUNT(*) FROM notifications WHERE club_id = " . CLUB_ID);
                                            $notifications_count = $result !== false ? (int)$result : 0;
                                        } catch (Exception $e) {
                                            $notifications_count = 0;
                                        }
                                    }
                                    
                                    $upcoming_events = 0;
                                    $total_events = 0;
                                    if ($tableExists('events')) {
                                        try {
                                            $upcoming_events = $db->querySingle("SELECT COUNT(*) FROM events WHERE club_id = " . CLUB_ID . " AND date >= date('now')") ?: 0;
                                            $total_events = $db->querySingle("SELECT COUNT(*) FROM events WHERE club_id = " . CLUB_ID) ?: 0;
                                        } catch (Exception $e) {
                                            $upcoming_events = 0;
                                            $total_events = 0;
                                        }
                                    }
                                    
                                    // Financial transactions count
                                    $financial_transactions_count = 0;
                                    if ($tableExists('financial_transactions')) {
                                        try {
                                            $result = $db->querySingle("SELECT COUNT(*) FROM financial_transactions WHERE club_id = " . CLUB_ID);
                                            $financial_transactions_count = $result !== false ? (int)$result : 0;
                                        } catch (Exception $e) {
                                            $financial_transactions_count = 0;
                                        }
                                    }
                                    
                                    // Campaigns count
                                    $campaigns_count = 0;
                                    if ($tableExists('campaigns')) {
                                        try {
                                            $result = $db->querySingle("SELECT COUNT(*) FROM campaigns WHERE club_id = " . CLUB_ID . " AND is_active = 1");
                                            $campaigns_count = $result !== false ? (int)$result : 0;
                                        } catch (Exception $e) {
                                            $campaigns_count = 0;
                                        }
                                    }
                                    
                                    // Veritabanı boyutu
                                    $db_path = DB_PATH;
                                    $db_size = file_exists($db_path) ? filesize($db_path) : 0;
                                    $db_size_mb = round($db_size / 1024 / 1024, 2);
                                    
                                    // PHP versiyonu
                                    $php_version = PHP_VERSION;
                                    
                                    // Son giriş tarihi (güvenli sorgu)
                                    $last_login = 'Bilinmiyor';
                                    try {
                                        // admin_logs tablosunda timestamp kolonu var, login_time yok
                                        $table_check = $db->querySingle("SELECT name FROM sqlite_master WHERE type='table' AND name='admin_logs'");
                                        if ($table_check) {
                                            $last_login_stmt = $db->prepare("SELECT MAX(timestamp) as last_login FROM admin_logs WHERE action LIKE '%Giriş%' OR action LIKE '%Login%'");
                                        if ($last_login_stmt) {
                                            $last_login_result = $last_login_stmt->execute();
                                            if ($last_login_result) {
                                                $last_login_row = $last_login_result->fetchArray(SQLITE3_ASSOC);
                                                    if ($last_login_row && isset($last_login_row['last_login']) && !empty($last_login_row['last_login'])) {
                                                    $last_login = $last_login_row['last_login'];
                                                    }
                                                }
                                            }
                                        }
                                    } catch (Exception $e) {
                                        $last_login = 'Bilinmiyor';
                                    }
                                    ?>
                                    
                                    <div class="space-y-10">
                                        <!-- Topluluk Bilgileri - Minimal -->
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Topluluk Bilgileri</h3>
                                            <div class="bg-white border border-gray-200 rounded-lg divide-y divide-gray-200">
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Topluluk Adı</span>
                                                    <span class="font-semibold text-gray-900"><?= htmlspecialchars($club_name) ?></span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Durum</span>
                                                    <span class="text-purple-600 font-medium">Aktif</span>
                                                </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Yönetim Kurulu</span>
                                                    <span class="font-semibold text-gray-900"><span class="counter" data-target="<?= $board_members_count ?>">0</span> üye</span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Yaklaşan Etkinlik</span>
                                                    <span class="font-semibold text-gray-900"><span class="counter" data-target="<?= $upcoming_events ?>">0</span> adet</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Sistem Bilgileri - Minimal -->
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sistem Bilgileri</h3>
                                            <div class="bg-white border border-gray-200 rounded-lg divide-y divide-gray-200">
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Versiyon</span>
                                                    <span class="text-purple-600 font-medium">UniPanel v1.0</span>
                                                </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Veritabanı</span>
                                                    <span class="font-semibold text-gray-900">SQLite3</span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Mimari</span>
                                                    <span class="font-semibold text-gray-900">Multi-Tenant</span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">PHP Versiyonu</span>
                                                    <span class="text-purple-600 font-medium"><?= $php_version ?></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        <!-- Sistem Durumu - Minimal -->
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sistem Durumu</h3>
                                            <div class="bg-white border border-gray-200 rounded-lg divide-y divide-gray-200">
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Sistem Durumu</span>
                                                    <span class="text-purple-600 font-medium">Çalışıyor</span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Veritabanı Boyutu</span>
                                                    <span class="font-semibold text-gray-900"><?= $db_size_mb ?> MB</span>
                                                </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Güvenlik</span>
                                                    <span class="text-purple-600 font-medium">Aktif</span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Son Giriş</span>
                                                    <span class="font-semibold text-gray-900 text-sm"><?= $last_login !== 'Bilinmiyor' ? date('d.m.Y H:i', strtotime($last_login)) : 'Bilinmiyor' ?></span>
                                                    </div>
                                                <div class="flex justify-between items-center py-4 px-6">
                                                    <span class="text-gray-600">Sunucu Saati</span>
                                                    <span class="font-semibold text-gray-900 text-sm" id="server-time"><?= date('d.m.Y H:i:s') ?></span>
                                                    </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Güvenlik Özellikleri - Minimal -->
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Güvenlik Özellikleri</h3>
                                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">SQL Injection Koruması</div>
                                                    <div class="text-xs text-gray-500">Prepared statements aktif</div>
                                                        </div>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">XSS Koruması</div>
                                                    <div class="text-xs text-gray-500">Input sanitization aktif</div>
                                                        </div>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">Şifre Şifreleme</div>
                                                    <div class="text-xs text-gray-500">BCRYPT hash aktif</div>
                                                    </div>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">Session Güvenliği</div>
                                                    <div class="text-xs text-gray-500">HttpOnly & Secure aktif</div>
                                                        </div>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">Brute Force Koruması</div>
                                                    <div class="text-xs text-gray-500">Otomatik hesap kilitleme</div>
                                                        </div>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                                    <div class="text-sm font-semibold text-gray-900 mb-1">Dosya Güvenliği</div>
                                                    <div class="text-xs text-gray-500">MIME type kontrolü aktif</div>
                                                    </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Sayaç Animasyonu ve Sunucu Saati JavaScript -->
                                        <script<?= tpl_script_nonce_attr(); ?>>
                                        (function() {
                                            // Sayaç animasyonu
                                            function animateCounter(element, target, duration = 2000) {
                                                const start = 0;
                                                const increment = target / (duration / 16);
                                                let current = start;
                                                
                                                const timer = setInterval(() => {
                                                    current += increment;
                                                    if (current >= target) {
                                                        element.textContent = Math.floor(target);
                                                        clearInterval(timer);
                                                    } else {
                                                        element.textContent = Math.floor(current);
                                                    }
                                                }, 16);
                                            }
                                            
                                            // Tüm sayaçları başlat
                                            function initCounters() {
                                                const counters = document.querySelectorAll('.counter');
                                                counters.forEach(counter => {
                                                    const target = parseInt(counter.getAttribute('data-target')) || 0;
                                                    animateCounter(counter, target);
                                                });
                                                
                                                // Büyük sayaç (kalan gün)
                                                const largeCounter = document.querySelector('.counter-large');
                                                if (largeCounter) {
                                                    const target = parseInt(largeCounter.getAttribute('data-target')) || 0;
                                                    animateCounter(largeCounter, target, 2500);
                                                }
                                            }
                                            
                                            // Sunucu saati güncelleme
                                            function updateServerTime() {
                                                const timeElement = document.getElementById('server-time');
                                                if (!timeElement) return;
                                                
                                                const now = new Date();
                                                const day = String(now.getDate()).padStart(2, '0');
                                                const month = String(now.getMonth() + 1).padStart(2, '0');
                                                const year = now.getFullYear();
                                                const hours = String(now.getHours()).padStart(2, '0');
                                                const minutes = String(now.getMinutes()).padStart(2, '0');
                                                const seconds = String(now.getSeconds()).padStart(2, '0');
                                                
                                                timeElement.textContent = `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
                                            }
                                            
                                            // Sayfa yüklendiğinde başlat
                                            if (document.readyState === 'loading') {
                                                document.addEventListener('DOMContentLoaded', function() {
                                                    initCounters();
                                                    updateServerTime();
                                                    setInterval(updateServerTime, 1000);
                                                });
                                            } else {
                                                initCounters();
                                                updateServerTime();
                                                setInterval(updateServerTime, 1000);
                                            }
                                        })();
                                        </script>
                                    </div>
                                </div>
                                
                                <!-- Gizlilik Sözleşmesi Tab -->
                                <!-- Gizlilik Sözleşmesi Tab -->
                                <div id="system-content-privacy" class="system-info-tab-content <?= $active_tab !== 'privacy' ? 'hidden' : '' ?>">
                                    <div class="mb-8">
                                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Gizlilik Politikası</h2>
                                        <p class="text-sm text-gray-500">Son Güncelleme: <?= date('d.m.Y') ?></p>
                                    </div>
                                    
                                    <div class="space-y-8 text-gray-700">
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">1. Genel Bilgiler</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel, üniversite toplulukları için geliştirilmiş bir yönetim sistemidir. Bu gizlilik sözleşmesi, sisteminizin verilerini nasıl topladığımızı, kullandığımızı ve koruduğumuzu açıklar.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">2. Toplanan Veriler</h3>
                                            <p class="text-gray-600 mb-3">UniPanel sistemi aşağıdaki kişisel verileri toplar ve işler:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Üye Bilgileri:</strong> Ad, soyad, e-posta adresi, telefon numarası, öğrenci numarası</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Etkinlik Verileri:</strong> Etkinlik kayıtları, katılım bilgileri, RSVP durumları</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">İletişim Verileri:</strong> E-posta ve SMS gönderim geçmişi</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Dosya Verileri:</strong> Yüklenen görseller ve videolar</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Sistem Logları:</strong> Giriş kayıtları, işlem geçmişi</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">3. Veri Güvenliği</h3>
                                            <p class="text-gray-600 mb-3">UniPanel, verilerinizin güvenliğini sağlamak için aşağıdaki önlemleri alır:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Şifreleme:</strong> Tüm şifreler BCRYPT algoritması ile hash'lenir</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">SQL Injection Koruması:</strong> Prepared statements kullanılarak veritabanı sorguları güvenli hale getirilir</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">XSS Koruması:</strong> Tüm kullanıcı girdileri htmlspecialchars ile temizlenir</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Session Güvenliği:</strong> HttpOnly ve Secure flag'leri ile session çerezleri korunur</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Dosya Güvenliği:</strong> Yüklenen dosyalar MIME type kontrolünden geçer</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span><strong class="text-gray-900">Multi-Tenant İzolasyon:</strong> Her topluluk kendi veritabanında izole edilir</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">4. Veri Saklama</h3>
                                            <p class="text-gray-600 leading-relaxed">Verileriniz SQLite3 veritabanında saklanır. Her topluluk kendi veritabanına sahiptir ve veriler birbirinden izole edilmiştir. Veriler, hesabınız aktif olduğu sürece saklanır.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">5. Veri Paylaşımı</h3>
                                            <p class="text-gray-600 mb-3">UniPanel, verilerinizi üçüncü taraflarla paylaşmaz. Verileriniz sadece:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Topluluk yöneticileri tarafından görüntülenebilir</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>E-posta ve SMS gönderimi için kullanılır</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Yasal yükümlülükler gereği talep edildiğinde paylaşılabilir</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">6. Kullanıcı Hakları</h3>
                                            <p class="text-gray-600 mb-3">Verilerinizle ilgili aşağıdaki haklara sahipsiniz:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Kişisel verilerinize erişim hakkı</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Yanlış verilerin düzeltilmesini talep etme hakkı</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Verilerinizin silinmesini talep etme hakkı</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Veri işlemeye itiraz etme hakkı</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">7. Çerezler</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel, oturum yönetimi için çerezler kullanır. Bu çerezler sadece sistem işlevselliği için gereklidir ve üçüncü taraf çerezler kullanılmaz.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">8. İletişim</h3>
                                            <p class="text-gray-600 leading-relaxed">Gizlilik politikamız hakkında sorularınız için topluluk yöneticiniz ile iletişime geçebilirsiniz.</p>
                                            </section>
                                    </div>
                                </div>
                                
                                <!-- Kullanım Şartları Tab -->
                                <div id="system-content-terms" class="system-info-tab-content <?= $active_tab !== 'terms' ? 'hidden' : '' ?>">
                                    <div class="mb-8">
                                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Kullanım Şartları</h2>
                                        <p class="text-sm text-gray-500">Son Güncelleme: <?= date('d.m.Y') ?></p>
                                    </div>
                                    
                                    <div class="space-y-8 text-gray-700">
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">1. Genel Koşullar</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel sistemini kullanarak aşağıdaki şartları kabul etmiş sayılırsınız. Bu şartlara uymamanız durumunda hesabınız askıya alınabilir veya sonlandırılabilir.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">2. Hesap Güvenliği</h3>
                                            <p class="text-gray-600 mb-3">Hesabınızın güvenliğinden siz sorumlusunuz:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Şifrenizi güçlü tutun ve kimseyle paylaşmayın</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Şüpheli aktivite fark ederseniz derhal bildirin</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Oturumunuzu kullanmadığınızda kapatın</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Brute force saldırılarına karşı hesabınız otomatik olarak korunur</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">3. Kullanım Kısıtlamaları</h3>
                                            <p class="text-gray-600 mb-3">Aşağıdaki faaliyetler yasaktır:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Sistemi kötüye kullanmak veya zarar vermek</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>SQL injection, XSS veya diğer güvenlik açıklarını sömürmeye çalışmak</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Yasadışı içerik paylaşmak</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Başkalarının kişisel bilgilerini izinsiz kullanmak</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Spam veya istenmeyen e-posta/SMS göndermek</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Sistemin performansını etkileyecek aşırı yük oluşturmak</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">4. İçerik Sorumluluğu</h3>
                                            <p class="text-gray-600 leading-relaxed">Yüklediğiniz tüm içeriklerden (etkinlikler, görseller, videolar, mesajlar) siz sorumlusunuz. UniPanel, yüklenen içeriklerin doğruluğunu veya yasallığını garanti etmez.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">5. Lisans ve Kullanım Süresi</h3>
                                            <p class="text-gray-600 mb-3">UniPanel Professional Sürüm 365 günlük lisans ile sağlanır:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Lisans süresi topluluk oluşturulduğunda başlar</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>365 gün sonra lisans süresi dolacaktır</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Lisans süresi dolduğunda sistem erişimi kısıtlanabilir</span>
                                                </li>
                                                <li class="flex items-start">
                                                    <span class="text-purple-600 mr-2">•</span>
                                                    <span>Lisans yenileme işlemleri için topluluk yöneticisi ile iletişime geçin</span>
                                                </li>
                                                </ul>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">6. Veri Yedekleme</h3>
                                            <p class="text-gray-600 leading-relaxed">Verilerinizin yedeklenmesinden topluluk yöneticisi sorumludur. UniPanel otomatik yedekleme özelliği sunar ancak ek yedekleme önerilir.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">7. Hizmet Kesintileri</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel, bakım veya teknik sorunlar nedeniyle hizmet kesintileri yaşayabilir. Bu durumlarda önceden bildirim yapılmasına çalışılır ancak garanti edilmez.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">8. Değişiklikler</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel, bu kullanım şartlarını önceden haber vermeksizin değiştirme hakkını saklı tutar. Değişiklikler sistem içinde duyurulur.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">9. Sorumluluk Reddi</h3>
                                            <p class="text-gray-600 leading-relaxed">UniPanel, sistem kullanımından kaynaklanan doğrudan veya dolaylı zararlardan sorumlu tutulamaz. Sistem "olduğu gibi" sağlanır.</p>
                                            </section>
                                            
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">10. İletişim ve Destek</h3>
                                            <p class="text-gray-600 leading-relaxed">Kullanım şartları hakkında sorularınız için topluluk yöneticiniz ile iletişime geçebilirsiniz.</p>
                                            </section>
                                        </div>
                                    </div>
                                
                                <!-- Mesafeli Satış Sözleşmesi Tab -->
                                <div id="system-content-distance" class="system-info-tab-content <?= $active_tab !== 'distance' ? 'hidden' : '' ?>">
                                    <div class="mb-8">
                                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Mesafeli Satış Sözleşmesi</h2>
                                        <p class="text-sm text-gray-500">Son Güncelleme: <?= date('d.m.Y') ?></p>
                                </div>
                                    
                                    <div class="space-y-8 text-gray-700">
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">1. Taraflar</h3>
                                            <p class="text-gray-600 mb-3"><strong>Satıcı:</strong> UniFour</p>
                                            <p class="text-gray-600 mb-3"><strong>E-posta:</strong> info@unifour.com</p>
                                            <p class="text-gray-600 mb-3"><strong>Telefon:</strong> +90 533 544 59 83</p>
                                            <p class="text-gray-600 leading-relaxed">Bu sözleşme, UniFour platformu üzerinden ürün veya hizmet satın alan gerçek veya tüzel kişiler (Alıcı) ile UniFour (Satıcı) arasında 6502 sayılı Tüketicinin Korunması Hakkında Kanun ve Mesafeli Sözleşmeler Yönetmeliği hükümlerine göre düzenlenmiştir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">2. Konu</h3>
                                            <p class="text-gray-600 mb-3">Bu sözleşmenin konusu, Alıcı'nın UniFour platformu üzerinden satın aldığı ürün/hizmetin satışı ve teslimi ile ilgili tarafların hak ve yükümlülükleridir.</p>
                                            <p class="text-gray-600 mb-3"><strong>Satılan Ürün/Hizmetler:</strong></p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Profesyonel Plan abonelik hizmeti (₺250/ay)</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Topluluk yönetim platformu hizmetleri</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Web sitesi ve email hosting hizmetleri</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Diğer dijital ürün ve hizmetler</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">3. Sözleşmenin Kurulması</h3>
                                            <p class="text-gray-600 leading-relaxed">Sözleşme, Alıcı'nın platform üzerinden ürün/hizmeti seçmesi, ön bilgilendirme formunu okuması, ödeme işlemini tamamlaması ve satın alma işlemini onaylaması ile kurulmuş sayılır. Sipariş onayı gönderildiği anda sözleşme kesinleşir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">4. Fiyat ve Ödeme</h3>
                                            <p class="text-gray-600 mb-3">Ürün/hizmet fiyatları, platform üzerinde Türk Lirası (₺) cinsinden gösterilir. Tüm fiyatlar KDV dahildir. Ödeme yöntemleri: Kredi kartı, banka kartı, havale/EFT. Tüm ödeme işlemleri SSL sertifikası ile şifrelenir ve güvenli ödeme altyapısı üzerinden gerçekleştirilir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">5. Teslimat</h3>
                                            <p class="text-gray-600 mb-3">Dijital ürün ve hizmetler sipariş onayından hemen sonra aktif hale gelir. Erişim bilgileri e-posta ile Alıcı'ya gönderilir. Teslimat süresi: Dijital hizmetler için anında, fiziksel ürünler için 3-7 iş günü (varsa).</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">6. Cayma Hakkı</h3>
                                            <p class="text-gray-600 mb-3">Alıcı, 6502 sayılı Tüketicinin Korunması Hakkında Kanun'un 15. maddesi uyarınca, sözleşmeden cayma hakkına sahiptir. Cayma hakkı, ürün/hizmetin teslim edildiği tarihten itibaren <strong>14 gün</strong> içinde kullanılabilir.</p>
                                            <p class="text-gray-600 mb-3"><strong>Cayma hakkının kullanılamayacağı durumlar:</strong></p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Alıcı'nın onayı ile anında teslim edilen dijital içerikler</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Alıcı'nın özel talebi ile hazırlanan kişiselleştirilmiş ürünler</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Hizmetin tamamen ifa edilmesi durumunda (abonelik süresi dolmuşsa)</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">7. İade ve İptal</h3>
                                            <p class="text-gray-600 leading-relaxed">İade koşulları detaylı olarak İptal ve İade Koşulları sayfasında açıklanmıştır. İade talebi 14 gün içinde yapılmalıdır. İade işlemi 14 iş günü içinde tamamlanır. Ödeme, aynı yöntemle iade edilir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">8. Garanti ve Sorumluluk</h3>
                                            <p class="text-gray-600 leading-relaxed">Satıcı, satılan ürün/hizmetin sözleşmede belirtilen özelliklere uygun olmasını garanti eder. Alıcı'nın hatalı kullanımından kaynaklanan sorunlardan Satıcı sorumlu değildir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">9. İletişim</h3>
                                            <p class="text-gray-600 mb-3"><strong>E-posta:</strong> info@unifour.com</p>
                                            <p class="text-gray-600 mb-3"><strong>Telefon:</strong> +90 533 544 59 83</p>
                                            <p class="text-gray-600 leading-relaxed"><strong>Çalışma Saatleri:</strong> Pazartesi - Cuma: 09:00 - 18:00</p>
                                        </section>
                                    </div>
                                </div>
                                
                                <!-- Ön Bilgilendirme Formu Tab -->
                                <div id="system-content-preinfo" class="system-info-tab-content <?= $active_tab !== 'preinfo' ? 'hidden' : '' ?>">
                                    <div class="mb-8">
                                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ön Bilgilendirme Formu</h2>
                                        <p class="text-sm text-gray-500">Son Güncelleme: <?= date('d.m.Y') ?></p>
                                    </div>
                                    
                                    <div class="space-y-8 text-gray-700">
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Genel Bilgiler</h3>
                                            <p class="text-gray-600 leading-relaxed">Bu form, 6502 sayılı Tüketicinin Korunması Hakkında Kanun ve Mesafeli Sözleşmeler Yönetmeliği uyarınca, satın alma işlemi öncesinde tüketiciyi bilgilendirmek amacıyla hazırlanmıştır.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Satıcı Bilgileri</h3>
                                            <div class="bg-white border border-gray-200 rounded-lg divide-y divide-gray-200">
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Şirket Adı</span>
                                                    <span class="font-semibold text-gray-900">UniFour</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">E-posta</span>
                                                    <span class="font-semibold text-gray-900">info@unifour.com</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Telefon</span>
                                                    <span class="font-semibold text-gray-900">+90 533 544 59 83</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Çalışma Saatleri</span>
                                                    <span class="font-semibold text-gray-900">Pazartesi - Cuma: 09:00 - 18:00</span>
                                                </div>
                                            </div>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Ürün/Hizmet Bilgileri</h3>
                                            <p class="text-gray-600 mb-3"><strong>UniFour Profesyonel Plan</strong></p>
                                            <p class="text-gray-600 mb-3">Topluluk yönetim platformu, web sitesi, email hosting ve tüm özelliklere erişim</p>
                                            <div class="bg-white border border-gray-200 rounded-lg divide-y divide-gray-200 mt-4">
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Fiyat</span>
                                                    <span class="text-purple-600 font-semibold">₺250/ay (KDV dahil)</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Ödeme Yöntemleri</span>
                                                    <span class="font-semibold text-gray-900">Kredi kartı, banka kartı, havale/EFT</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 px-4">
                                                    <span class="text-gray-600">Teslimat Süresi</span>
                                                    <span class="font-semibold text-gray-900">Anında (dijital hizmet)</span>
                                                </div>
                                            </div>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Cayma Hakkı</h3>
                                            <p class="text-gray-600 mb-3">Alıcı, ürün/hizmetin teslim edildiği tarihten itibaren <strong>14 gün</strong> içinde cayma hakkını kullanabilir.</p>
                                            <p class="text-gray-600 mb-3"><strong>Cayma hakkının kullanılamayacağı durumlar:</strong></p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Alıcı'nın onayı ile anında teslim edilen dijital içerikler</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Alıcı'nın özel talebi ile hazırlanan kişiselleştirilmiş ürünler</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Hizmetin tamamen ifa edilmesi durumunda</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">İletişim</h3>
                                            <p class="text-gray-600 mb-3"><strong>E-posta:</strong> info@unifour.com</p>
                                            <p class="text-gray-600 mb-3"><strong>Telefon:</strong> +90 533 544 59 83</p>
                                            <p class="text-gray-600 leading-relaxed"><strong>Çalışma Saatleri:</strong> Pazartesi - Cuma: 09:00 - 18:00</p>
                                        </section>
                                    </div>
                                </div>
                                
                                <!-- İptal & İade Tab -->
                                <div id="system-content-cancellation" class="system-info-tab-content <?= $active_tab !== 'cancellation' ? 'hidden' : '' ?>">
                                    <div class="mb-8">
                                        <h2 class="text-2xl font-bold text-gray-900 mb-2">İptal ve İade Koşulları</h2>
                                        <p class="text-sm text-gray-500">Son Güncelleme: <?= date('d.m.Y') ?></p>
                                    </div>
                                    
                                    <div class="space-y-8 text-gray-700">
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">1. Genel Hükümler</h3>
                                            <p class="text-gray-600 leading-relaxed">Bu İptal ve İade Koşulları, 6502 sayılı Tüketicinin Korunması Hakkında Kanun ve Mesafeli Sözleşmeler Yönetmeliği uyarınca hazırlanmıştır. UniFour platformu üzerinden yapılan satın alma işlemlerinde geçerlidir.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">2. Cayma Hakkı</h3>
                                            <p class="text-gray-600 mb-3">Alıcı, ürün/hizmetin teslim edildiği tarihten itibaren <strong>14 gün</strong> içinde cayma hakkını kullanabilir. Bu süre, 6502 sayılı Tüketicinin Korunması Hakkında Kanun'un 15. maddesi uyarınca tanınmıştır.</p>
                                            <p class="text-gray-600 mb-3"><strong>Cayma hakkının kullanılamayacağı durumlar:</strong></p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>Dijital İçerikler:</strong> Alıcı'nın onayı ile anında teslim edilen dijital içerikler (yazılım, abonelik, platform erişimi vb.)</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>Kişiselleştirilmiş Ürünler:</strong> Alıcı'nın özel talebi ile hazırlanan, kişiselleştirilmiş ürünler</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>Tamamlanmış Hizmetler:</strong> Hizmetin tamamen ifa edilmesi durumunda (abonelik süresi dolmuşsa)</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">3. İptal İşlemi</h3>
                                            <p class="text-gray-600 mb-3">Cayma hakkını kullanmak isteyen Alıcı, aşağıdaki yollardan biriyle bildirimde bulunabilir:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>E-posta:</strong> info@unifour.com</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>Telefon:</strong> +90 533 544 59 83</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span><strong>Platform:</strong> Üyelik paneli üzerinden iletişim formu</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">4. İade İşlemleri</h3>
                                            <p class="text-gray-600 mb-3">İade edilecek ürün/hizmet aşağıdaki koşulları sağlamalıdır:</p>
                                            <ul class="space-y-2 text-gray-600">
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Ürün/hizmet kullanılmamış olmalıdır</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Orijinal ambalajında olmalıdır (fiziksel ürünler için)</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>Eksiksiz ve hasarsız olmalıdır</span></li>
                                                <li class="flex items-start"><span class="text-purple-600 mr-2">•</span><span>İade süresi içinde talep edilmelidir (14 gün)</span></li>
                                            </ul>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">5. Ödeme İadesi</h3>
                                            <p class="text-gray-600 mb-3">Ödeme iadesi, iade onayından sonra <strong>14 iş günü</strong> içinde yapılır. İade süresi, banka işlem sürelerine bağlı olarak değişebilir.</p>
                                            <p class="text-gray-600 mb-3"><strong>İade yöntemi:</strong> Ödeme, aynı yöntemle iade edilir (kredi/banka kartı, havale/EFT).</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">6. Abonelik İptali</h3>
                                            <p class="text-gray-600 mb-3">Profesyonel Plan aboneliğini iptal etmek için üyelik paneli üzerinden "Aboneliği İptal Et" seçeneğini kullanabilir, e-posta veya telefon ile bildirimde bulunabilirsiniz.</p>
                                            <p class="text-gray-600 leading-relaxed"><strong>Önemli:</strong> Abonelik dönemi içinde iptal edilirse, kalan süre için ödeme iadesi yapılmaz. Hizmet, dönem sonuna kadar devam eder.</p>
                                        </section>
                                        
                                        <section class="border-l-4 border-purple-500 pl-6">
                                            <h3 class="text-lg font-semibold text-gray-900 mb-3">7. İletişim</h3>
                                            <p class="text-gray-600 mb-3"><strong>E-posta:</strong> info@unifour.com</p>
                                            <p class="text-gray-600 mb-3"><strong>Telefon:</strong> +90 533 544 59 83</p>
                                            <p class="text-gray-600 leading-relaxed"><strong>Çalışma Saatleri:</strong> Pazartesi - Cuma: 09:00 - 18:00</p>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                    .system-info-tab {
                        transition: all 0.2s;
                    }
                    .system-info-tab.active {
                        border-bottom-color: #2563eb;
                        color: #2563eb;
                    }
                    .system-info-tab-content {
                        animation: fadeIn 0.3s ease-in;
                    }
                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                    </style>
                    

                <?php elseif ($current_view === 'subscription_required'): ?>
                    <?php
                    // Paket yükseltme gerekli sayfası
                    global $subscription_required_data;
                    if (!isset($subscription_required_data)) {
                        // Eğer data yoksa varsayılan değerler
                        $subscription_required_data = [
                            'currentTierLabel' => 'Standart',
                            'message' => 'Bu özellik için paket yükseltme gereklidir.',
                            'limitDetails' => '',
                            'upgradeMessage' => 'Paket yükselterek daha fazla özelliğe erişebilirsiniz.',
                            'requiredTier' => null
                        ];
                    }
                    
                    $currentTierLabel = $subscription_required_data['currentTierLabel'];
                    $message = $subscription_required_data['message'];
                    $limitDetails = $subscription_required_data['limitDetails'];
                    $upgradeMessage = $subscription_required_data['upgradeMessage'];
                    $requiredTier = $subscription_required_data['requiredTier'] ?? null;
                    
                    // Gerekli paket seviyesine göre renk sınıfları
                    if ($requiredTier === 'business') {
                        $iconBg = 'bg-purple-100 dark:bg-purple-900/30';
                        $iconText = 'text-purple-600 dark:text-purple-400';
                        $buttonBg = 'bg-purple-600 hover:bg-purple-700';
                        $badgeBg = 'bg-purple-600';
                        $borderColor = 'border-purple-500 dark:border-purple-400';
                        $priceText = 'text-purple-600 dark:text-purple-400';
                    } else {
                        $iconBg = 'bg-blue-100 dark:bg-blue-900/30';
                        $iconText = 'text-blue-600 dark:text-blue-400';
                        $buttonBg = 'bg-blue-600 hover:bg-blue-700';
                        $badgeBg = 'bg-blue-600';
                        $borderColor = 'border-blue-500 dark:border-blue-400';
                        $priceText = 'text-blue-600 dark:text-blue-400';
                    }
                    ?>
                    <div data-view="subscription_required" class="max-w-4xl mx-auto">
                        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm p-6 section-card">
                            <!-- Header -->
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl <?= $iconBg ?> mb-4">
                                    <svg class="w-8 h-8 <?= $iconText ?>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
                                    Paket Yükseltme Gerekli
                                </h1>
                                <p class="text-gray-600 dark:text-gray-400 mb-1">
                                    <?= htmlspecialchars($message) ?>
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-500">
                                    Mevcut paket: <span class="font-medium text-gray-700 dark:text-gray-300"><?= htmlspecialchars($currentTierLabel) ?></span>
                                </p>
                            </div>
                            
                            <!-- Info Box -->
                            <?php if ($limitDetails || $upgradeMessage): ?>
                            <div class="bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mb-8">
                                <?php if ($limitDetails): ?>
                                    <div class="mb-4">
                                        <?= $limitDetails ?>
                                    </div>
                                <?php endif; ?>
                                <?php if ($upgradeMessage): ?>
                                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                                        <?= strip_tags($upgradeMessage) ?>
                                    </p>
                                <?php endif; ?>
                            </div>
                            <?php endif; ?>
                            
                            <!-- Package Cards -->
                            <div class="mb-8">
                                <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 text-center">
                                    Paket Seçenekleri
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Standard -->
                                    <div class="bg-white dark:bg-gray-800 border-2 <?= $currentTierLabel === 'Standart' ? 'border-gray-400 dark:border-gray-500' : 'border-gray-200 dark:border-gray-700' ?> rounded-xl p-6 text-center">
                                        <?php if ($currentTierLabel === 'Standart'): ?>
                                        <div class="inline-block bg-gray-600 text-white text-xs font-semibold px-2 py-1 rounded mb-3">
                                            Mevcut
                                        </div>
                                        <?php endif; ?>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Standart</h3>
                                        <div class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">Ücretsiz</div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Temel özellikler</p>
                                    </div>
                                    
                                    <!-- Professional -->
                                    <div class="bg-white dark:bg-gray-800 border-2 <?= $requiredTier === 'professional' ? $borderColor : 'border-gray-200 dark:border-gray-700' ?> rounded-xl p-6 text-center">
                                        <?php if ($requiredTier === 'professional'): ?>
                                        <div class="inline-block <?= $badgeBg ?> text-white text-xs font-semibold px-2 py-1 rounded mb-3">
                                            Önerilen
                                        </div>
                                        <?php endif; ?>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Profesyonel</h3>
                                        <div class="text-2xl font-bold <?= $priceText ?> mb-1">250₺</div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">/ay</p>
                                    </div>
                                    
                                    <!-- Business -->
                                    <div class="bg-white dark:bg-gray-800 border-2 <?= $requiredTier === 'business' ? 'border-purple-500 dark:border-purple-400' : 'border-gray-200 dark:border-gray-700' ?> rounded-xl p-6 text-center">
                                        <?php if ($requiredTier === 'business'): ?>
                                        <div class="inline-block bg-purple-600 text-white text-xs font-semibold px-2 py-1 rounded mb-3">
                                            Önerilen
                                        </div>
                                        <?php endif; ?>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Business</h3>
                                        <div class="text-2xl font-bold <?= $requiredTier === 'business' ? 'text-purple-600 dark:text-purple-400' : 'text-gray-900 dark:text-gray-100' ?> mb-1">500₺</div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">/ay</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <a href="?view=subscription" class="inline-flex items-center justify-center px-6 py-3 <?= $buttonBg ?> text-white rounded-lg font-semibold transition-all duration-200 hover:shadow-lg">
                                    Paket Yükselt
                                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </a>
                                <a href="?view=dashboard" class="inline-flex items-center justify-center px-6 py-3 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                    Ana Sayfaya Dön
                                </a>
                            </div>
                        </div>
                    </div>

                <?php elseif ($current_view === 'subscription'): ?>
                    <?php
                    try {
                        require_once __DIR__ . '/functions/subscription.php';
                        $communityId = defined('COMMUNITY_ID') ? COMMUNITY_ID : (defined('COMMUNITY_BASE_PATH') ? basename(COMMUNITY_BASE_PATH) : 'unknown');
                        if (!isset($db)) {
                            $db = get_db();
                        }
                        render_subscription_view($db, $communityId);
                    } catch (Exception $e) {
                        echo '<div class="p-4 bg-red-50 border border-red-200 rounded-lg">';
                        echo '<p class="text-red-800">Hata: ' . htmlspecialchars($e->getMessage()) . '</p>';
                        echo '<p class="text-sm text-red-600 mt-2">Dosya: ' . htmlspecialchars($e->getFile()) . ':' . $e->getLine() . '</p>';
                        echo '</div>';
                        tpl_error_log("Subscription view error: " . $e->getMessage());
                    }
                    ?>

                <?php elseif ($current_view === 'verification'): ?>
                    <?php
                    load_module('verification');
                    $communityId = defined('COMMUNITY_ID') ? COMMUNITY_ID : (defined('CLUB_ID') ? CLUB_ID : '');
                    $latestRequest = verification_get_latest_request($communityId);
                    $requests = verification_get_requests($communityId, 6);
                    $currentStatus = $latestRequest['status'] ?? 'none';
                    $statusMeta = verification_get_status_meta($currentStatus);
                    $isVerified = $currentStatus === 'approved';
                    $canSubmitNew = !$latestRequest || $currentStatus !== 'pending';
                    $documentPath = $latestRequest['document_path'] ?? '';
                    $isSuperAdminSession = !empty($_SESSION['is_superadmin']);
                    // Timeline kademeleri - sadece ilgili kademeler gösterilsin
                    $timelineSteps = [];
                    
                    // Kademe 1: Belge Gönderildi (sadece belge gönderildiyse göster)
                    if ($latestRequest) {
                        $timelineSteps[] = [
                            'label' => 'Belge Gönderildi',
                            'description' => 'PDF belgeniz sisteme yüklendi.',
                            'state' => 'done'
                        ];
                        
                        // Kademe 2: İnceleme (sadece pending, approved veya rejected durumundaysa göster)
                        if (in_array($currentStatus, ['pending', 'approved', 'rejected'], true)) {
                            $timelineSteps[] = [
                            'label' => 'İnceleme',
                            'description' => 'UniFour güven ekibi belgeyi doğrular.',
                                'state' => $currentStatus === 'pending' ? 'active' : 'done'
                            ];
                            
                            // Kademe 3: Sonuç (sadece approved veya rejected durumundaysa göster)
                            if (in_array($currentStatus, ['approved', 'rejected'], true)) {
                                $timelineSteps[] = [
                            'label' => $currentStatus === 'rejected' ? 'Reddedildi' : 'Onaylandı',
                            'description' => $currentStatus === 'rejected'
                                ? 'Belge uygun bulunmadı. Notları inceleyin.'
                                : 'Onaylı topluluk rozetiniz görünür.',
                                    'state' => $currentStatus === 'approved' ? 'done' : 'failed'
                    ];
                            }
                        }
                    }
                    ?>
                    <div data-view="verification" class="max-w-6xl mx-auto space-y-6 animate-fadeInUp">
                        <div class="rounded-3xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900/60 shadow-xl shadow-indigo-50/50 dark:shadow-none p-8 grid gap-8 md:grid-cols-2 relative overflow-hidden">
                            <div class="absolute inset-y-0 right-0 w-1/3 bg-white dark:bg-slate-900/60 pointer-events-none"></div>
                            <div class="relative z-10 space-y-4">
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-300 uppercase tracking-[0.2em]">Mavi Tik Durumu</p>
                                <div class="flex items-center gap-3">
                                    <?= verification_get_status_badge($currentStatus); ?>
                                    <?php if ($isVerified): ?>
                                        <span class="inline-flex items-center gap-1 text-xs font-semibold text-emerald-600 dark:text-emerald-300">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                            Mavi tik aktif
                                        </span>
                                    <?php endif; ?>
                                </div>
                                <h2 class="text-3xl font-semibold text-slate-900 dark:text-white">
                                    <?= $isVerified ? 'Topluluğunuz onaylı' : 'Topluluk doğrulaması' ?>
                                </h2>
                                <p class="text-base text-slate-600 dark:text-slate-300 leading-relaxed">
                                    <?= htmlspecialchars($statusMeta['description']) ?>
                                </p>
                                <?php if ($documentPath): ?>
                                    <a href="<?= htmlspecialchars($documentPath) ?>" target="_blank" class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 dark:text-indigo-300 hover:underline">
                                        Belgeyi görüntüle (PDF)
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l9-9m0 0H8m8 0v8"></path></svg>
                                    </a>
                                <?php endif; ?>
                            </div>
                            <div class="relative z-10">
                                <div class="space-y-4">
                                    <?php foreach ($timelineSteps as $step): 
                                        $state = $step['state'];
                                        $stateClasses = [
                                            'done' => 'bg-emerald-50 border-emerald-200 text-emerald-700 dark:bg-emerald-500/10 dark:border-emerald-400/40 dark:text-emerald-100',
                                            'active' => 'bg-sky-50 border-sky-200 text-sky-700 dark:bg-sky-500/10 dark:border-sky-400/40 dark:text-sky-100',
                                            'failed' => 'bg-rose-50 border-rose-200 text-rose-700 dark:bg-rose-500/10 dark:border-rose-400/40 dark:text-rose-100',
                                            'idle' => 'bg-white border-slate-200 text-slate-500 dark:bg-slate-800/50 dark:border-slate-700 dark:text-slate-300'
                                        ][$state] ?? 'bg-white border-slate-200 text-slate-500';
                                    ?>
                                        <div class="rounded-2xl border px-4 py-3 flex items-start gap-3 text-sm <?= $stateClasses ?>">
                                            <div class="flex-shrink-0 mt-1">
                                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-current">
                                                    <?php if ($state === 'done'): ?>
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                                    <?php elseif ($state === 'failed'): ?>
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                    <?php else: ?>
                                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l3 3"></path></svg>
                                                    <?php endif; ?>
                                                </span>
                                            </div>
                                            <div>
                                                <p class="font-semibold"><?= htmlspecialchars($step['label']) ?></p>
                                                <p class="text-xs opacity-80"><?= htmlspecialchars($step['description']) ?></p>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>

                        <div class="grid gap-6 md:grid-cols-2">
                            <?php if ($isVerified): ?>
                                <div class="bg-gradient-to-br from-emerald-50 via-white to-emerald-50/40 dark:from-emerald-500/10 dark:via-slate-900/60 dark:to-emerald-500/10 rounded-2xl border border-emerald-200 dark:border-emerald-500/40 p-6 space-y-4 shadow-lg shadow-emerald-100/40 dark:shadow-none">
                                    <p class="text-sm font-semibold text-emerald-700 dark:text-emerald-300 uppercase tracking-[0.2em]">Mavi Tik Aktif</p>
                                    <h3 class="text-2xl font-semibold text-emerald-900 dark:text-white">Topluluğunuz doğrulandı</h3>
                                    <p class="text-sm text-emerald-800/90 dark:text-emerald-200 leading-relaxed">
                                        Belgeler başarıyla incelendi ve üyeleriniz artık tüm platformlarda “Onaylı Topluluk” rozeti görüyor. Yeni başvuru göndermenize gerek yok.
                                    </p>
                                    <?php if (!empty($documentPath)): ?>
                                        <a href="<?= htmlspecialchars($documentPath) ?>" target="_blank" class="inline-flex items-center gap-2 text-xs font-semibold text-emerald-700 dark:text-emerald-200 hover:underline">
                                            PDF’i görüntüle
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l9-9m0 0H8m8 0v8"></path></svg>
                                        </a>
                                    <?php endif; ?>
                                </div>
                            <?php else: ?>
                                <form id="verification-request-form" class="bg-white dark:bg-gray-900 rounded-2xl border border-slate-200 dark:border-white/10 p-6 space-y-4 shadow-sm" enctype="multipart/form-data">
                                    <div class="space-y-1">
                                        <p class="text-sm font-semibold text-slate-900 dark:text-white">Belge yükle</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Resmî kuruluş belgenizi PDF formatında ekleyin. (Üniversite yazısı, oda belgesi vb.)</p>
                                    </div>
                                    <?= csrf_token_field() ?>
                                    <input type="hidden" name="action" value="submit_verification_request">
                                    <label class="block">
                                        <span class="text-xs font-medium text-slate-600 dark:text-slate-300">PDF Belgesi *</span>
                                        <input type="file" name="verification_document" accept="application/pdf" class="mt-2 block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                    </label>
                                    <label class="block">
                                        <span class="text-xs font-medium text-slate-600 dark:text-slate-300">Açıklama (opsiyonel)</span>
                                        <textarea name="verification_notes" rows="3" class="mt-2 block w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Varsa ek açıklamalarınızı yazabilirsiniz."></textarea>
                                    </label>
                                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Belgeyi Gönder
                                    </button>
                                </form>
                            <?php endif; ?>
                            <div class="bg-gradient-to-br from-indigo-50 via-white to-blue-50 dark:from-indigo-500/10 dark:via-slate-900/70 dark:to-blue-500/10 rounded-2xl border border-indigo-200 dark:border-indigo-500/40 p-5 shadow-lg shadow-indigo-100/40 dark:shadow-none">
                                <h3 class="text-base font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Başvuru Rehberi
                                </h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-3">
                                        <div>
                                            <h4 class="text-xs font-bold text-slate-900 dark:text-white mb-2">Kabul Edilen Belgeler</h4>
                                            <ul class="space-y-1.5 text-xs text-slate-700 dark:text-slate-300">
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Üniversite resmi yazısı</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Oda/kulüp belgesi</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Kuruluş kararı</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Tüzük/ana sözleşme</span>
                                                </li>
                                </ul>
                                        </div>
                                        
                                        <div>
                                            <h4 class="text-xs font-bold text-slate-900 dark:text-white mb-2">Belge Gereksinimleri</h4>
                                            <ul class="space-y-1.5 text-xs text-slate-700 dark:text-slate-300">
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>PDF formatında, max 10 MB</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>İmza/mühür görünür olmalı</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Güncel ve okunabilir olmalı</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <h4 class="text-xs font-bold text-slate-900 dark:text-white mb-2">Neden İstiyoruz?</h4>
                                            <p class="text-xs text-slate-700 dark:text-slate-300 leading-relaxed">
                                                Platform güvenliği, üye güvenliği ve kalite kontrolü için sadece resmi olarak tanınmış toplulukları kabul ediyoruz.
                                            </p>
                                        </div>
                                        
                                        <div>
                                            <h4 class="text-xs font-bold text-slate-900 dark:text-white mb-2">Süreç</h4>
                                            <ul class="space-y-1.5 text-xs text-slate-700 dark:text-slate-300">
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>İnceleme: 1-3 iş günü</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Bildirim: E-posta ve SMS</span>
                                                </li>
                                                <li class="flex items-start gap-1.5">
                                                    <span class="text-indigo-600 dark:text-indigo-400 mt-0.5">•</span>
                                                    <span>Onay sonrası mavi tik aktif olur</span>
                                                </li>
                                            </ul>
                                        </div>
                                        
                                        <div class="bg-amber-50 dark:bg-amber-500/10 rounded-lg p-3 border border-amber-200 dark:border-amber-500/30">
                                            <p class="text-xs font-semibold text-amber-800 dark:text-amber-200 mb-1.5">Önemli</p>
                                            <p class="text-xs text-amber-700 dark:text-amber-300 leading-relaxed">
                                                Durumunuzu bu sayfadan takip edebilir, sorularınız için destek ekibiyle iletişime geçebilirsiniz.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-slate-200 dark:border-white/10 p-6 space-y-4">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Başvuru geçmişi</h3>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">En son 6 işleme kadar gösterilir.</p>
                                </div>
                                <?php if (!$latestRequest): ?>
                                    <span class="text-xs font-medium text-slate-500 dark:text-slate-300">Henüz başvuru yapılmadı.</span>
                                <?php endif; ?>
                            </div>
                            <?php if (!empty($requests)): ?>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead>
                                            <tr class="text-left text-xs uppercase text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                                                <th class="py-3 pr-4">Tarih</th>
                                                <th class="py-3 pr-4">Durum</th>
                                                <th class="py-3 pr-4">Belge</th>
                                                <th class="py-3">Notlar</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                            <?php foreach ($requests as $req): ?>
                                                <tr class="text-slate-700 dark:text-slate-200">
                                                    <td class="py-3 pr-4 font-medium"><?= htmlspecialchars(date('d.m.Y H:i', strtotime($req['created_at'] ?? 'now'))) ?></td>
                                                    <td class="py-3 pr-4"><?= verification_get_status_badge($req['status']) ?></td>
                                                    <td class="py-3 pr-4">
                                                        <?php if (!empty($req['document_path'])): ?>
                                                            <a href="<?= htmlspecialchars($req['document_path']) ?>" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 dark:text-indigo-300 text-xs font-semibold hover:underline">
                                                                PDF
                                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l9-9m0 0H8m8 0v8"></path></svg>
                                                            </a>
                                                        <?php else: ?>
                                                            <span class="text-xs text-slate-400">-</span>
                                                        <?php endif; ?>
                                                    </td>
                                                    <td class="py-3 text-xs">
                                                        <?php if (!empty($req['admin_notes'])): ?>
                                                            <p class="text-slate-600 dark:text-slate-300"><?= nl2br(htmlspecialchars($req['admin_notes'])) ?></p>
                                                        <?php elseif (!empty($req['notes'])): ?>
                                                            <p class="text-slate-500 dark:text-slate-400"><?= nl2br(htmlspecialchars($req['notes'])) ?></p>
                                                        <?php else: ?>
                                                            <span class="text-slate-400">-</span>
                                                        <?php endif; ?>
                                                    </td>
                                                </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            <?php else: ?>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Henüz doğrulama geçmişi yok.</p>
                            <?php endif; ?>
                        </div>

                        <?php if ($isSuperAdminSession && $latestRequest): ?>
                            <form id="verification-review-form" class="rounded-2xl border border-slate-800 bg-slate-900 text-white p-6 space-y-4 shadow-2xl shadow-black/30">
                                <h3 class="text-lg font-semibold">SuperAdmin inceleme paneli</h3>
                                <?= csrf_token_field() ?>
                                <input type="hidden" name="action" value="review_verification_request">
                                <input type="hidden" name="request_id" value="<?= (int)$latestRequest['id'] ?>">
                                <input type="hidden" name="new_status" id="verification-review-status" value="">
                                <div class="flex flex-wrap items-center gap-3 text-sm text-slate-300">
                                    <span>Belge: </span>
                                    <?php if ($documentPath): ?>
                                        <a href="<?= htmlspecialchars($documentPath) ?>" target="_blank" class="inline-flex items-center gap-1 text-indigo-300 hover:text-white">
                                            PDF'i aç
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l9-9m0 0H8m8 0v8"></path></svg>
                                        </a>
                                    <?php else: ?>
                                        <span class="text-slate-500">Belge yok</span>
                                    <?php endif; ?>
                                </div>
                                <label class="block text-sm font-medium text-slate-200">Yönetici notu</label>
                                <textarea id="verification-admin-note" name="admin_notes" rows="3" class="w-full rounded-xl border border-slate-700 bg-slate-800 text-sm text-white p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"><?= htmlspecialchars($latestRequest['admin_notes'] ?? '') ?></textarea>
                                <div class="flex flex-wrap gap-3">
                                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-500/20 text-emerald-200 border border-emerald-500/40 hover:bg-emerald-500/30" data-review-status="approved">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        Onayla
                                    </button>
                                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-rose-500/20 text-rose-200 border border-rose-500/40 hover:bg-rose-500/30" data-review-status="rejected">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        Reddet
                                    </button>
                                    <button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-800 text-slate-200 border border-slate-600 hover:bg-slate-700" data-review-status="pending">
                                        Beklemeye al
                                    </button>
                                </div>
                            </form>
                        <?php endif; ?>
                    </div>

                    <script <?= tpl_script_nonce_attr(); ?>>
                        (function() {
                            const form = document.getElementById('verification-request-form');
                            if (form) {
                                form.addEventListener('submit', async (event) => {
                                    event.preventDefault();
                                    const submitBtn = form.querySelector('button[type="submit"]');
                                    if (submitBtn?.disabled) return;
                                    submitBtn.disabled = true;
                                    const formData = new FormData(form);
                                    try {
                                        const response = await fetch('index.php', { method: 'POST', body: formData });
                                        const result = await response.json();
                                        const message = result.message || (result.success ? 'Talebiniz alındı.' : 'İşlem tamamlanamadı.');
                                        if (typeof toastManager !== 'undefined') {
                                            toastManager.show(result.success ? 'Harika!' : 'Hata', message, result.success ? 'success' : 'error', 5000);
                                        } else {
                                            alert(message);
                                        }
                                        if (result.success) {
                                            setTimeout(() => window.location.reload(), 800);
                                        }
                                    } catch (err) {
                                        if (typeof toastManager !== 'undefined') {
                                            toastManager.show('Hata', String(err), 'error', 5000);
                                        } else {
                                            alert('Talep gönderilemedi: ' + err);
                                        }
                                    } finally {
                                        if (submitBtn) submitBtn.disabled = false;
                                    }
                                });
                            }

                            const adminForm = document.getElementById('verification-review-form');
                            if (adminForm) {
                                const statusInput = document.getElementById('verification-review-status');
                                adminForm.querySelectorAll('[data-review-status]').forEach((btn) => {
                                    btn.addEventListener('click', async () => {
                                        const targetStatus = btn.getAttribute('data-review-status');
                                        if (!targetStatus) return;
                                        statusInput.value = targetStatus;
                                        const formData = new FormData(adminForm);
                                        try {
                                            const response = await fetch('index.php', { method: 'POST', body: formData });
                                            const result = await response.json();
                                            const message = result.message || (result.success ? 'Durum güncellendi.' : 'Durum güncellenemedi.');
                                            if (typeof toastManager !== 'undefined') {
                                                toastManager.show(result.success ? 'Güncellendi' : 'Hata', message, result.success ? 'success' : 'error', 4000);
                                            } else {
                                                alert(message);
                                            }
                                            if (result.success) {
                                                setTimeout(() => window.location.reload(), 600);
                                            }
                                        } catch (err) {
                                            if (typeof toastManager !== 'undefined') {
                                                toastManager.show('Hata', String(err), 'error', 5000);
                                            } else {
                                                alert('Durum değiştirilemedi: ' + err);
                                            }
                                        }
                                    });
                                });
                            }
                        })();
                    </script>

                <?php elseif ($current_view === 'verification_admin'): ?>
                    <?php if (empty($_SESSION['is_superadmin'])): ?>
                        <div class="max-w-3xl mx-auto bg-white dark:bg-gray-900 border border-red-200 dark:border-red-500/30 rounded-2xl p-8 text-center shadow-sm">
                            <h2 class="text-xl font-semibold text-red-600 dark:text-red-300 mb-3">Yetkiniz yok</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-300">Bu sayfaya yalnızca SuperAdmin hesapları erişebilir.</p>
                        </div>
                    <?php else: ?>
                        <?php
                        load_module('verification');
                        $adminStatusFilter = tpl_filter_slug($_GET['status'] ?? '', '');
                        if (!in_array($adminStatusFilter, ['pending', 'approved', 'rejected'], true)) {
                            $adminStatusFilter = '';
                        }
                        $adminRequests = verification_get_all_requests($adminStatusFilter ?: null, 200);
                        $statusCounts = verification_get_status_counts();
                        ?>
                        <div data-view="verification_admin" class="space-y-6 max-w-7xl mx-auto">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-[0.25em]">SuperAdmin</p>
                                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Doğrulama Kuyruğu</h1>
                                    <p class="text-sm text-slate-500 dark:text-slate-300">Belge yükleyen toplulukları buradan onaylayın.</p>
                                </div>
                                <div class="flex gap-2">
                                    <?php
                                    $filters = [
                                        '' => 'Tümü',
                                        'pending' => 'Beklemede',
                                        'approved' => 'Onaylandı',
                                        'rejected' => 'Reddedildi'
                                    ];
                                    ?>
                                    <?php foreach ($filters as $key => $label): ?>
                                        <?php
                                        $isActiveFilter = ($key === $adminStatusFilter);
                                        $filterQuery = http_build_query(array_merge($_GET, ['view' => 'verification_admin', 'status' => $key]));
                                        ?>
                                        <a href="?<?= $filterQuery ?>" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border text-xs font-semibold <?= $isActiveFilter ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-600' ?>">
                                            <?= $label ?>
                                            <?php if ($key !== ''): ?>
                                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full <?= $isActiveFilter ? 'bg-white/20' : 'bg-slate-100 dark:bg-slate-700' ?> text-[11px]">
                                                    <?= $statusCounts[$key] ?? 0 ?>
                                                </span>
                                            <?php endif; ?>
                                        </a>
                                    <?php endforeach; ?>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <?php
                                $summaryCards = [
                                    ['label' => 'Toplam Talep', 'value' => $statusCounts['total'] ?? 0, 'class' => 'from-slate-900 to-slate-700'],
                                    ['label' => 'Bekleyen', 'value' => $statusCounts['pending'] ?? 0, 'class' => 'from-amber-500 to-orange-500'],
                                    ['label' => 'Onaylanan', 'value' => $statusCounts['approved'] ?? 0, 'class' => 'from-emerald-500 to-green-500'],
                                    ['label' => 'Reddedilen', 'value' => $statusCounts['rejected'] ?? 0, 'class' => 'from-rose-500 to-red-500'],
                                ];
                                ?>
                                <?php foreach ($summaryCards as $card): ?>
                                    <div class="rounded-2xl border border-white/10 bg-gradient-to-br <?= $card['class'] ?> text-white p-4 shadow-lg shadow-black/10">
                                        <p class="text-xs uppercase tracking-[0.3em]"><?= $card['label'] ?></p>
                                        <p class="text-3xl font-semibold mt-2"><?= (int)$card['value'] ?></p>
                                    </div>
                                <?php endforeach; ?>
                            </div>

                            <div class="bg-white dark:bg-gray-900 rounded-2xl border border-slate-200 dark:border-white/10 shadow-sm overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800 text-sm">
                                        <thead class="bg-slate-50 dark:bg-slate-800/40 text-xs uppercase text-slate-500 dark:text-slate-300">
                                            <tr>
                                                <th class="px-4 py-3 text-left font-semibold">Topluluk</th>
                                                <th class="px-4 py-3 text-left font-semibold">Gönderim</th>
                                                <th class="px-4 py-3 text-left font-semibold">Durum</th>
                                                <th class="px-4 py-3 text-left font-semibold">Belge</th>
                                                <th class="px-4 py-3 text-left font-semibold">Notlar</th>
                                                <th class="px-4 py-3 text-left font-semibold">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                            <?php if (empty($adminRequests)): ?>
                                                <tr>
                                                    <td colspan="6" class="px-4 py-8 text-center text-slate-500 dark:text-slate-300">Filtreye uygun kayıt bulunamadı.</td>
                                                </tr>
                                            <?php else: ?>
                                                <?php foreach ($adminRequests as $request): ?>
                                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30">
                                                        <td class="px-4 py-3">
                                                            <p class="font-semibold text-slate-900 dark:text-white"><?= htmlspecialchars($request['community_id'] ?? (defined('COMMUNITY_ID') ? COMMUNITY_ID : 'Topluluk')) ?></p>
                                                            <p class="text-xs text-slate-500">#<?= (int)$request['id'] ?></p>
                                                        </td>
                                                        <td class="px-4 py-3 text-slate-700 dark:text-slate-200">
                                                            <p><?= date('d.m.Y H:i', strtotime($request['created_at'] ?? 'now')) ?></p>
                                                            <?php if (!empty($request['reviewed_at'])): ?>
                                                                <p class="text-xs text-slate-500">Güncellendi: <?= date('d.m.Y H:i', strtotime($request['reviewed_at'])) ?></p>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            <?= verification_get_status_badge($request['status']) ?>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            <?php if (!empty($request['document_path'])): ?>
                                                                <a href="<?= htmlspecialchars($request['document_path']) ?>" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 dark:text-indigo-300 font-semibold text-xs hover:underline">
                                                                    PDF
                                                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17l9-9m0 0H8m8 0v8"></path></svg>
                                                                </a>
                                                            <?php else: ?>
                                                                <span class="text-xs text-slate-400">Belge yok</span>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            <textarea class="w-full min-w-[200px] rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-xs text-slate-700 dark:text-slate-200 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2" placeholder="SuperAdmin notu..." data-note-for="<?= (int)$request['id'] ?>"><?= htmlspecialchars($request['admin_notes'] ?? '') ?></textarea>
                                                            <?php if (!empty($request['notes'])): ?>
                                                                <p class="text-[11px] text-slate-500 mt-1">Kullanıcı notu: <?= htmlspecialchars($request['notes']) ?></p>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            <div class="flex flex-wrap gap-2">
                                                                <button type="button" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-200" data-verification-action="approved" data-request-id="<?= (int)$request['id'] ?>">
                                                                    Onayla
                                                                </button>
                                                                <button type="button" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-rose-100 text-rose-700 dark:bg-rose-500/10 dark:text-rose-200" data-verification-action="rejected" data-request-id="<?= (int)$request['id'] ?>">
                                                                    Reddet
                                                                </button>
                                                                <button type="button" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-100 text-slate-700 dark:bg-slate-700/40 dark:text-slate-200" data-verification-action="pending" data-request-id="<?= (int)$request['id'] ?>">
                                                                    Beklemeye Al
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                <?php endforeach; ?>
                                            <?php endif; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <script <?= tpl_script_nonce_attr(); ?>>
                            (function() {
                                const csrfToken = '<?= generate_csrf_token() ?>';
                                document.querySelectorAll('[data-verification-action]').forEach((button) => {
                                    button.addEventListener('click', async () => {
                                        const requestId = button.getAttribute('data-request-id');
                                        const action = button.getAttribute('data-verification-action');
                                        if (!requestId || !action) return;
                                        const noteField = document.querySelector(`[data-note-for="${requestId}"]`);
                                        const notes = noteField ? noteField.value : '';
                                        const formData = new FormData();
                                        formData.append('action', 'review_verification_request');
                                        formData.append('csrf_token', csrfToken);
                                        formData.append('request_id', requestId);
                                        formData.append('new_status', action);
                                        formData.append('admin_notes', notes);
                                        button.disabled = true;
                                        try {
                                            const response = await fetch('index.php', { method: 'POST', body: formData });
                                            const result = await response.json();
                                            const msg = result.message || (result.success ? 'Güncellendi' : 'Güncellenemedi');
                                            if (typeof toastManager !== 'undefined') {
                                                toastManager.show(result.success ? 'Başarılı' : 'Hata', msg, result.success ? 'success' : 'error', 4000);
                                            } else {
                                                alert(msg);
                                            }
                                            if (result.success) {
                                                setTimeout(() => window.location.reload(), 600);
                                            }
                                        } catch (error) {
                                            if (typeof toastManager !== 'undefined') {
                                                toastManager.show('Hata', String(error), 'error', 4000);
                                            } else {
                                                alert('İşlem gerçekleştirilemedi: ' + error);
                                            }
                                        } finally {
                                            button.disabled = false;
                                        }
                                    });
                                });
                            })();
                        </script>
                    <?php endif; ?>

                <?php elseif ($current_view === 'support'): ?>
                    <?php
                    try {
                        require_once __DIR__ . '/functions/support.php';
                        if (!isset($db)) {
                            $db = get_db();
                        }
                        render_support_view($db);
                    } catch (Exception $e) {
                        echo '<div class="p-4 bg-red-50 border border-red-200 rounded-lg">';
                        echo '<p class="text-red-800">Hata: ' . htmlspecialchars($e->getMessage()) . '</p>';
                        echo '<p class="text-sm text-red-600 mt-2">Dosya: ' . htmlspecialchars($e->getFile()) . ':' . $e->getLine() . '</p>';
                        echo '</div>';
                        tpl_error_log("Support view error: " . $e->getMessage());
                    }
                    ?>

                <?php elseif ($current_view === 'settings'): ?>
                    <?php
                    // Settings array'ini oluştur
                    $db = get_db();
                    $settings = [];
                    try {
                        $settings_stmt = $db->prepare("SELECT setting_key, setting_value FROM settings WHERE club_id = ?");
                        $settings_stmt->bindValue(1, CLUB_ID, SQLITE3_INTEGER);
                        $settings_result = $settings_stmt->execute();
                        if ($settings_result) {
                            while ($row = $settings_result->fetchArray(SQLITE3_ASSOC)) {
                                $settings[$row['setting_key']] = $row['setting_value'];
                            }
                        }
                    } catch (Exception $e) {
                        tpl_error_log("Settings fetch error: " . $e->getMessage());
                    }
                    
                    // Ayarlar sayfası için gerekli değişkenleri al
                    $smtp_username = get_setting('smtp_username', '');
                    $smtp_password = get_setting('smtp_password', '');
                    $smtp_host = get_setting('smtp_host', '');
                    $smtp_port = get_setting('smtp_port', '587');
                    $smtp_secure = get_setting('smtp_secure', 'tls');
                    $smtp_from_email = get_setting('smtp_from_email', '');
                    $smtp_from_name = get_setting('smtp_from_name', '');
                    $default_test_email = get_setting('smtp_test_recipient', '');
                    if (empty($default_test_email)) {
                        $default_test_email = $smtp_from_email ?: $smtp_username;
                    }
                    
                    $club_description = get_setting('club_description', '');
                    $email_notifications = get_setting('email_notifications', '1');
                    $sms_notifications = get_setting('sms_notifications', '0');
                    $session_timeout = get_setting('session_timeout', '30');
                    $max_login_attempts = get_setting('max_login_attempts', '5');
                    $auto_backup_enabled = get_setting('auto_backup_enabled', '0');
                    $auto_backup_frequency = get_setting('auto_backup_frequency', 'daily');
                    $auto_backup_time = get_setting('auto_backup_time', '02:00');
                    $auto_backup_notify_email = get_setting('auto_backup_notify_email', '');
                    $netgsm_username = get_setting('netgsm_username', '');
                    $netgsm_password = get_setting('netgsm_password', '');
                    $netgsm_msgheader = get_setting('netgsm_msgheader', '');

                    if (defined('NETGSM_FORCE_USERNAME') && NETGSM_FORCE_USERNAME !== '') {
                        $netgsm_username = NETGSM_FORCE_USERNAME;
                    } elseif (empty($netgsm_username)) {
                        $netgsm_username = '5428055983';
                    }

                    if (defined('NETGSM_FORCE_PASSWORD') && NETGSM_FORCE_PASSWORD !== '') {
                        $netgsm_password = NETGSM_FORCE_PASSWORD;
                    } elseif (empty($netgsm_password)) {
                        // Güvenlik: Hardcoded password kaldırıldı
                        tpl_error_log('NetGSM password not configured. SMS sending disabled. Please configure NetGSM settings in admin panel.');
                        $netgsm_password = '';
                    }

                    if (defined('NETGSM_FORCE_MSGHEADER') && NETGSM_FORCE_MSGHEADER !== '') {
                        $netgsm_msgheader = NETGSM_FORCE_MSGHEADER;
                    } elseif (empty($netgsm_msgheader)) {
                        $netgsm_msgheader = '8503022568';
                    }
                    $auto_backup_last_run = get_setting('auto_backup_last_run', '');
                    $auto_backup_last_status = get_setting('auto_backup_last_status', '');
                    $auto_backup_last_error = get_setting('auto_backup_last_error', '');
                    $auto_backup_last_run_label = 'Henüz çalışmadı';
                    $auto_backup_next_run = '';
                    $last_ts = false;
                    if (!empty($auto_backup_last_run)) {
                        $last_ts = strtotime($auto_backup_last_run);
                        if ($last_ts !== false) {
                            $auto_backup_last_run_label = date('d.m.Y H:i', $last_ts);
                            $frequency_map = [
                                'hourly' => '+1 hour',
                                'daily' => '+1 day',
                                'weekly' => '+1 week',
                                'monthly' => '+1 month',
                            ];
                            $modifier = $frequency_map[$auto_backup_frequency] ?? '+1 day';
                            $next_ts = strtotime($modifier, $last_ts);
                            if ($next_ts !== false) {
                                $auto_backup_next_run = date('d.m.Y H:i', $next_ts);
                            }
                        }
                    }
                    $auto_backup_next_run_label = $auto_backup_next_run ?: 'Bir sonraki panel ziyaretiyle tetiklenecek';
                    ?>
                    <div data-view="settings" class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6 animate-fadeInUp">
                        <?php
                        $config_health = $TPL_CONFIG_HEALTH ?? tpl_get_comm_config_health();
                        if (!$config_health['smtp']['configured'] || !$config_health['sms']['configured']):
                        ?>
                        <div class="mb-6 space-y-3">
                            <?php if (!$config_health['smtp']['configured']): ?>
                            <div class="border border-amber-300 bg-amber-50 text-amber-900 rounded-lg p-4">
                                <h3 class="font-semibold mb-1">SMTP Ayarları Eksik</h3>
                                <ul class="text-sm list-disc list-inside space-y-1">
                                    <?php foreach ($config_health['smtp']['issues'] as $issue): ?>
                                    <li><?= htmlspecialchars($issue) ?></li>
                                    <?php endforeach; ?>
                                </ul>
                                <p class="text-xs mt-2">SMTP yapılandırması tamamlanana kadar e-posta gönderimleri ve raporlar devre dışı kalacaktır.</p>
                            </div>
                            <?php endif; ?>
                            <?php if (!$config_health['sms']['configured']): ?>
                            <div class="border border-red-300 bg-red-50 text-red-900 rounded-lg p-4">
                                <h3 class="font-semibold mb-1">SMS Servisi Hazır Değil</h3>
                                <ul class="text-sm list-disc list-inside space-y-1">
                                    <?php foreach ($config_health['sms']['issues'] as $issue): ?>
                                    <li><?= htmlspecialchars($issue) ?></li>
                                    <?php endforeach; ?>
                                </ul>
                                <p class="text-xs mt-2">SMS doğrulamaları ve kampanyaları, sağlayıcı bilgileri tamamlanana kadar gönderilemez.</p>
                            </div>
                            <?php endif; ?>
                        </div>
                        <?php endif; ?>
                        <!-- Birleşik Ayarlar Kutusu -->
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-md shadow-xl border border-gray-200 dark:border-gray-700">
                            <!-- Başlık Bölümü -->
                            <div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-200 dark:border-gray-600">
                                <div>
                                    <h1 class="text-4xl font-bold mb-2 text-gray-800 dark:text-gray-200">Sistem Ayarları</h1>
                                    <p class="text-gray-600 dark:text-gray-300 text-lg">Topluluk yapılandırması ve sistem tercihleri</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-4 border border-gray-200 dark:border-gray-600">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Mevcut Topluluk</p>
                                    <p class="text-2xl font-bold text-gray-800 dark:text-gray-200"><?= htmlspecialchars($club_name) ?></p>
                                </div>
                            </div>
                            
                            <!-- Form İçeriği -->
                            <form method="POST" action="index.php" class="space-y-6" id="settingsForm">
                                <?= csrf_token_field() ?>
                                <input type="hidden" name="action" value="update_settings">
                                <input type="hidden" name="current_view" value="settings">
                                <!-- Kategoriler boş olsa bile form submit edildiğinde kaydetmek için hidden input -->
                                <input type="hidden" name="club_categories_submitted" value="1">
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="space-y-6">
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                                </svg>
                                                Topluluk Bilgileri
                                            </h3>
                                            
                                            <div class="space-y-4">
                                                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 p-4 rounded-md">
                                                    <div class="flex items-center mb-2">
                                                        <svg class="w-5 h-5 text-blue-500 dark:text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                        <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-200">Topluluk Adı</h4>
                                                    </div>
                                                    <p class="text-sm text-blue-700 dark:text-blue-300 mb-2">Güvenlik nedeniyle topluluk adı değiştirilemez.</p>
                                                    <div class="bg-white dark:bg-gray-800 p-3 border border-blue-200 dark:border-blue-600 rounded-md">
                                                        <span class="text-lg font-semibold text-gray-800 dark:text-gray-200"><?= htmlspecialchars($club_name) ?></span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Topluluk Logosu -->
                                                <div class="mt-4">
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                        Topluluk Logosu
                                                    </label>
                                                    <?php 
                                                    $current_logo = get_setting('club_logo', '');
                                                    $logo_path = $current_logo ? community_path($current_logo) : '';
                                                    $logo_exists = $current_logo && file_exists($logo_path);
                                                    ?>
                                                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg">
                                                        <div class="flex-shrink-0">
                                                            <?php if ($logo_exists): ?>
                                                                <img src="<?= htmlspecialchars($current_logo) ?>" alt="Topluluk Logosu" class="w-20 h-20 rounded-md object-cover border-2 border-gray-300 dark:border-gray-600 shadow-sm">
                                                            <?php else: ?>
                                                                <div class="w-20 h-20 rounded-md bg-gray-100 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center shadow-sm">
                                                                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                </div>
                                                            <?php endif; ?>
                                                        </div>
                                                        <div class="flex-1 w-full">
                                                            <form id="clubLogoForm" enctype="multipart/form-data" class="space-y-3">
                                                                <div>
                                                                    <input type="file" id="clubLogoFile" name="club_logo" accept="image/*" required class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                                </div>
                                                                <p class="text-xs text-gray-500 dark:text-gray-400">Desteklenen formatlar: JPG, PNG, GIF, WebP (Max: 2MB)</p>
                                                                <button type="submit" class="w-full sm:w-auto px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-medium transition-colors shadow-sm hover:shadow-md">
                                                                    <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                                    </svg>
                                                                    Logoyu Yükle
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label for="club_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Topluluk Açıklaması
                                                    </label>
                                                    <textarea name="club_description" id="club_description" rows="3" 
                                                              class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                                              placeholder="Topluluk hakkında kısa açıklama..."><?= htmlspecialchars($club_description ?? '') ?></textarea>
                                                </div>
                                                
                                                <div>
                                                    <label for="club_categories" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Topluluk Kategorileri <span class="text-xs text-gray-500">(En fazla 3 kategori seçebilirsiniz)</span>
                                                    </label>
                                                    <?php
                                                    // Mevcut kategorileri al
                                                    $current_categories = [];
                                                    if (!empty($settings['club_category'])) {
                                                        $decoded = json_decode($settings['club_category'], true);
                                                        if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
                                                            $current_categories = $decoded;
                                                        } else {
                                                            $current_categories = array_filter(explode(',', $settings['club_category']), function($cat) {
                                                                return !empty(trim($cat)) && trim($cat) !== 'other';
                                                            });
                                                        }
                                                    }
                                                    $available_categories = ['Mühendislik', 'Bilim', 'Sanat', 'Spor', 'Sosyal', 'Akademik', 'Teknoloji', 'Kültür'];
                                                    ?>
                                                    <div class="grid grid-cols-2 gap-3">
                                                        <?php foreach ($available_categories as $cat): ?>
                                                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors <?= in_array($cat, $current_categories) ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500' : 'bg-white dark:bg-gray-800' ?>">
                                                            <input type="checkbox" 
                                                                   name="club_categories[]" 
                                                                   value="<?= htmlspecialchars($cat) ?>" 
                                                                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                                                                   <?= in_array($cat, $current_categories) ? 'checked' : '' ?>
                                                                   onchange="limitCategorySelection(this)">
                                                            <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300"><?= htmlspecialchars($cat) ?></span>
                                                        </label>
                                                        <?php endforeach; ?>
                                                    </div>
                                                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400" id="categoryCount">Seçilen: <span id="selectedCount"><?= count($current_categories) ?></span>/3</p>
                                                    
                                                    <!-- Ayrı Kategori Kaydetme Butonu -->
                                                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                                                        <button type="button" onclick="saveCategoriesOnly()" class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-semibold transition-all duration-200 shadow-md flex items-center justify-center">
                                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                            Kategorileri Kaydet
                                                        </button>
                                                        <p class="mt-2 text-xs text-center text-gray-500 dark:text-gray-400">Sadece kategorileri kaydetmek için</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-green-500 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                Bildirim Ayarları
                                            </h3>
                                            
                                            <div class="space-y-4">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">E-posta Bildirimleri</label>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400">Yeni üye kayıtları için e-posta bildirimi</p>
                                                    </div>
                                                    <label class="relative inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" name="email_notifications" class="sr-only peer" <?= ($email_notifications ?? true) ? 'checked' : '' ?>>
                                                        <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 dark:after:border-gray-600 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                    </label>
                                                </div>
                                                
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">SMS Bildirimleri</label>
                                                        <p class="text-xs text-gray-500 dark:text-gray-400">Acil durumlar için SMS bildirimi</p>
                                                    </div>
                                                    <label class="relative inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" name="sms_notifications" class="sr-only peer" <?= ($sms_notifications ?? false) ? 'checked' : '' ?>>
                                                        <div class="w-11 h-6 bg-gray-200 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 dark:after:border-gray-600 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Dil Ayarları -->
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-indigo-500 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                                                </svg>
                                                Dil Ayarları
                                            </h3>
                                            
                                            <div class="space-y-4">
                                                <div>
                                                    <label for="ui_language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Arayüz Dili
                                                    </label>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Sayfanın görüntüleneceği dili seçin. İngilizce seçildiğinde sayfa otomatik olarak çevrilecektir.</p>
                                                    <?php 
                                                    $current_language = get_setting('ui_language', 'tr');
                                                    ?>
                                                    <select name="ui_language" id="ui_language" onchange="handleLanguageChange(this.value)" class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                                                        <option value="tr" <?= $current_language === 'tr' ? 'selected' : '' ?>>Türkçe</option>
                                                        <option value="en" <?= $current_language === 'en' ? 'selected' : '' ?>>English (Otomatik Çeviri)</option>
                                                    </select>
                                                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                        İngilizce seçildiğinde Google Translate kullanılarak sayfa otomatik çevrilecektir.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Veritabanı Yedekleme -->
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-purple-500 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                                </svg>
                                                Veritabanı Yedeği
                                            </h3>
                                            
                                            <div class="space-y-4">
                                                <p class="text-sm text-gray-600 dark:text-gray-400">Tüm verilerin yedeğini oluşturun. Yedekler 30 gün saklanır.</p>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                                                        <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Son Otomatik Yedek</p>
                                                        <div class="mt-1 flex items-center gap-2 flex-wrap">
                                                            <span class="font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($auto_backup_last_run_label) ?></span>
                                                            <?php if ($auto_backup_last_status === 'success'): ?>
                                                                <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300">Başarılı</span>
                                                            <?php elseif ($auto_backup_last_status === 'failed'): ?>
                                                                <span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300">Hatalı</span>
                                                            <?php endif; ?>
                                                        </div>
                                                    </div>
                                                    <div class="p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                                                        <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tahmini Bir Sonraki Çalışma</p>
                                                        <p class="mt-1 font-semibold text-gray-900 dark:text-gray-100"><?= htmlspecialchars($auto_backup_next_run_label) ?></p>
                                                    </div>
                                                </div>
                                                
                                                <?php if ($auto_backup_last_status === 'failed' && !empty($auto_backup_last_error)): ?>
                                                    <div class="p-3 rounded-md bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-xs text-red-700 dark:text-red-200">
                                                        <strong>Son Hata:</strong> <?= htmlspecialchars($auto_backup_last_error) ?>
                                                    </div>
                                                <?php endif; ?>
                                                
                                                <div>
                                                    <button type="button" onclick="createBackup()" class="px-6 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-md font-semibold transition-all duration-200 shadow-md flex items-center">
                                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                                        </svg>
                                                        Yedek Oluştur
                                                    </button>
                                                </div>
                                                
                                                <?php $backups = list_backups(); ?>
                                                <?php if (count($backups) > 0): ?>
                                                <div class="mt-4">
                                                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Mevcut Yedekler (Son 5)</h4>
                                                    <div class="space-y-2">
                                                        <?php foreach (array_slice($backups, 0, 5) as $backup): ?>
                                                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-600">
                                                            <div class="flex items-center space-x-3">
                                                                <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"></path>
                                                                </svg>
                                                                <div>
                                                                    <p class="text-xs font-medium text-gray-900 dark:text-gray-100"><?= htmlspecialchars($backup['filename']) ?></p>
                                                                    <p class="text-xs text-gray-500 dark:text-gray-400"><?= $backup['date'] ?> • <?= $backup['size'] ?></p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <?php endforeach; ?>
                                                    </div>
                                                </div>
                                                <?php else: ?>
                                                <div class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                                                    Henüz yedek oluşturulmamış
                                                </div>
                                                <?php endif; ?>
                                            </div>
                                            
                                            <!-- Otomatik Yedekleme Ayarları -->
                                            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-600">
                                                <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4 flex items-center">
                                                    <svg class="w-4 h-4 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    Otomatik Yedekleme
                                                </h4>
                                                
                                                <div class="space-y-4">
                                                    <div class="flex items-center">
                                                        <input type="checkbox" name="auto_backup_enabled" id="auto_backup_enabled" value="1" <?= $auto_backup_enabled === '1' ? 'checked' : '' ?> class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                        <label for="auto_backup_enabled" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Otomatik yedeklemeyi etkinleştir</label>
                                                    </div>
                                                    
                                                    <div id="auto_backup_settings" class="space-y-4 <?= $auto_backup_enabled === '1' ? '' : 'hidden' ?>">
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Yedekleme Sıklığı</label>
                                                            <select name="auto_backup_frequency" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                                <option value="hourly" <?= $auto_backup_frequency === 'hourly' ? 'selected' : '' ?>>Saatlik</option>
                                                                <option value="daily" <?= $auto_backup_frequency === 'daily' ? 'selected' : '' ?>>Günlük</option>
                                                                <option value="weekly" <?= $auto_backup_frequency === 'weekly' ? 'selected' : '' ?>>Haftalık</option>
                                                                <option value="monthly" <?= $auto_backup_frequency === 'monthly' ? 'selected' : '' ?>>Aylık</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Yedekleme Saati (HH:MM formatında)</label>
                                                            <input type="time" name="auto_backup_time" value="<?= htmlspecialchars($auto_backup_time) ?>" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cron job için referans saati (örn: 02:00)</p>
                                                        </div>
                                                        
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bildirim E-posta Adresi</label>
                                                            <input type="email" name="auto_backup_notify_email" value="<?= htmlspecialchars($auto_backup_notify_email) ?>" placeholder="ornek@email.com" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Yedekleme tamamlandığında bildirim gönderilecek e-posta adresi</p>
                                                        </div>
                                                        
                                                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-3">
                                                            <p class="text-xs text-blue-800 dark:text-blue-200">
                                                                <strong>Cron Job Kurulumu:</strong><br>
                                                                Otomatik yedekleme için aşağıdaki cron job'ı sunucunuza ekleyin:<br>
                                                                <code class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded mt-1 inline-block text-xs">0 2 * * * /usr/bin/php <?= htmlspecialchars(realpath((defined('PROJECT_ROOT') ? PROJECT_ROOT : dirname(__DIR__, 2)) . '/system/scripts/auto_backup.php')) ?></code><br>
                                                                <span class="text-blue-600 dark:text-blue-300">(Her gün saat 02:00'de çalışır)</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-6">
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-purple-500 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                                </svg>
                                                Güvenlik Ayarları
                                            </h3>
                                            
                                            <div class="space-y-4">
                                                <div>
                                                    <label for="session_timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Oturum Zaman Aşımı (dakika)
                                                    </label>
                                                    <select name="session_timeout" id="session_timeout" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                                        <option value="30" <?= ($session_timeout ?? 30) == 30 ? 'selected' : '' ?>>30 Dakika</option>
                                                        <option value="60" <?= ($session_timeout ?? 30) == 60 ? 'selected' : '' ?>>1 Saat</option>
                                                        <option value="120" <?= ($session_timeout ?? 30) == 120 ? 'selected' : '' ?>>2 Saat</option>
                                                        <option value="240" <?= ($session_timeout ?? 30) == 240 ? 'selected' : '' ?>>4 Saat</option>
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label for="max_login_attempts" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        Maksimum Giriş Denemesi
                                                    </label>
                                                    <select name="max_login_attempts" id="max_login_attempts" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                                        <option value="3" <?= ($max_login_attempts ?? 3) == 3 ? 'selected' : '' ?>>3 Deneme</option>
                                                        <option value="5" <?= ($max_login_attempts ?? 3) == 5 ? 'selected' : '' ?>>5 Deneme</option>
                                                        <option value="10" <?= ($max_login_attempts ?? 3) == 10 ? 'selected' : '' ?>>10 Deneme</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        
                                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-md border border-gray-200 dark:border-gray-600">
                                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
                                                <svg class="w-5 h-5 mr-2 text-orange-500 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                                </svg>
                                                Sistem Bilgileri
                                            </h3>
                                            
                                            <div class="space-y-3 text-sm">
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600 dark:text-gray-400">PHP Sürümü:</span>
                                                    <span class="font-medium text-gray-800 dark:text-gray-200"><?= PHP_VERSION ?></span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600 dark:text-gray-400">Veritabanı:</span>
                                                    <span class="font-medium text-gray-800 dark:text-gray-200">SQLite <?= SQLite3::version()['versionString'] ?></span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600 dark:text-gray-400">Son Güncelleme:</span>
                                                    <span class="font-medium text-gray-800 dark:text-gray-200"><?= date('d.m.Y H:i') ?></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-600">
                                    <button type="button" onclick="resetSettings()" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-200 font-medium border border-gray-300 dark:border-gray-600">
                                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Sıfırla
                                    </button>
                                    <button type="submit" class="px-8 py-3 text-white dark:text-gray-900 bg-gray-800 dark:bg-gray-200 rounded-md hover:bg-gray-900 dark:hover:bg-gray-100 font-semibold shadow-lg transition duration-200 border border-gray-700 dark:border-gray-300">
                                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Ayarları Kaydet
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </main>

    <!-- Yeni Sekmeli Etkinlik Modal -->
    <div id="addEventModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-md shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col transform transition-transform duration-300 scale-100 my-4">
            <div class="flex items-center justify-between mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Yeni Etkinlik Oluştur</h3>
                <button onclick="closeModal('addEventModal')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form method="POST" action="index.php" enctype="multipart/form-data" id="addEventForm" onsubmit="return handleEventFormSubmit(this)" class="flex flex-col flex-1 min-h-0">
                <input type="hidden" name="action" value="add_event">
                <input type="hidden" name="current_view" value="events">
                <?= csrf_token_field() ?>
                
                <!-- Sekmeler -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-4 flex-shrink-0">
                    <nav class="flex space-x-1" aria-label="Tabs">
                        <button type="button" onclick="switchEventTab('general')" id="tab-general" class="event-tab-btn active px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                            Genel Bilgiler
                        </button>
                        <button type="button" onclick="switchEventTab('datetime')" id="tab-datetime" class="event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                            Tarih & Saat
                        </button>
                        <button type="button" onclick="switchEventTab('location')" id="tab-location" class="event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                            Konum & İletişim
                        </button>
                        <button type="button" onclick="switchEventTab('media')" id="tab-media" class="event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                            Medya
                        </button>
                        <button type="button" onclick="switchEventTab('settings')" id="tab-settings" class="event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                            Ayarlar
                        </button>
                        <button type="button" onclick="switchEventTab('survey')" id="tab-survey" class="event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                            Anket
                        </button>
                    </nav>
                </div>
                
                <!-- Tab İçerikleri Wrapper -->
                <div class="flex-1 min-h-0 overflow-y-auto">
                <!-- Genel Bilgiler Sekmesi -->
                <div id="tab-content-general" class="event-tab-content space-y-4">
                    <div>
                        <label for="modal_event_title" class="block text-sm font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            Etkinlik Başlığı <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="text" name="title" id="modal_event_title" required 
                                   class="w-full p-3 pr-24 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-200" 
                                   placeholder="Örn: Yıllık Kongre ve Sempozyumu">
                            <button type="button" onclick="generateEventTitleSuggestions()" 
                                    class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-md transition-all duration-200 inline-flex items-center gap-1.5 shadow-sm hover:shadow-md"
                                    title="AI ile başlık önerileri al">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                <span>AI Öner</span>
                            </button>
                        </div>
                        <div id="title-suggestions" class="hidden mt-3 p-4 bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 rounded-xl border border-purple-200/50 dark:border-purple-700/50 shadow-sm">
                            <div class="flex items-center gap-2 mb-3">
                                <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                <p class="text-sm font-semibold text-purple-800 dark:text-purple-200">AI Başlık Önerileri</p>
                            </div>
                            <div id="title-suggestions-list" class="space-y-2"></div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="modal_event_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Kategori
                        </label>
                        <select name="category" id="modal_event_category" 
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="Genel">Genel</option>
                            <option value="Seminer">Seminer</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Kongre">Kongre</option>
                            <option value="Sosyal">Sosyal Etkinlik</option>
                            <option value="Spor">Spor</option>
                            <option value="Kültür">Kültür & Sanat</option>
                            <option value="Eğitim">Eğitim</option>
                            <option value="Teknoloji">Teknoloji</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="modal_event_description" class="block text-sm font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            Detaylı Açıklama
                        </label>
                        
                        <!-- AI Butonları - Modern Grid Layout -->
                        <div class="mb-3 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center gap-2 flex-wrap">
                                <button type="button" onclick="generateEventDescription()" 
                                        class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                        id="ai-generate-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <span>AI ile Oluştur</span>
                                </button>
                                <button type="button" onclick="generateEventHashtags()" 
                                        class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                        title="Hashtag önerileri al">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    <span>Hashtag</span>
                                </button>
                                <button type="button" onclick="generateSocialMediaPost()" 
                                        class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                        title="Sosyal medya paylaşım metni oluştur">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                                    </svg>
                                    <span>Sosyal Medya</span>
                                </button>
                                <button type="button" onclick="improveText('modal_event_description')" 
                                        class="px-3 py-2 text-xs font-medium bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white rounded-lg transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md"
                                        title="Metni iyileştir">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    <span>İyileştir</span>
                                </button>
                            </div>
                        </div>
                        
                        <textarea name="description" id="modal_event_description" rows="5" 
                                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-200" 
                                  placeholder="Etkinliğin amacını, konuşmacıları ve katılım detaylarını belirtiniz..."></textarea>
                        
                        <!-- Hashtag Sonuç Alanı -->
                        <div id="hashtags-result" class="hidden mt-3 p-4 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-xl border border-blue-200/50 dark:border-blue-700/50 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    <p class="text-sm font-semibold text-blue-800 dark:text-blue-200">Hashtag Önerileri</p>
                                </div>
                                <button type="button" onclick="copyToClipboard('hashtags-text')" class="px-2 py-1 text-xs font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                                    Kopyala
                                </button>
                            </div>
                            <p id="hashtags-text" class="text-sm text-blue-700 dark:text-blue-300 leading-relaxed"></p>
                        </div>
                        
                        <!-- Sosyal Medya Sonuç Alanı -->
                        <div id="social-post-result" class="hidden mt-3 p-4 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 rounded-xl border border-green-200/50 dark:border-green-700/50 shadow-sm">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                                    </svg>
                                    <p class="text-sm font-semibold text-green-800 dark:text-green-200">Sosyal Medya Paylaşım Metni</p>
                                </div>
                                <button type="button" onclick="copyToClipboard('social-post-text')" class="px-3 py-1.5 text-xs font-medium bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors shadow-sm hover:shadow">
                                    Kopyala
                                </button>
                            </div>
                            <textarea id="social-post-text" rows="4" class="w-full p-3 text-sm text-green-800 dark:text-green-200 bg-white/50 dark:bg-gray-800/50 border border-green-200 dark:border-green-700 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <label for="modal_event_tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Etiketler (virgülle ayırın)
                        </label>
                        <input type="text" name="tags" id="modal_event_tags" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="teknoloji, eğitim, workshop">
                        <p class="text-xs text-gray-500 mt-1">Örn: teknoloji, eğitim, workshop</p>
                    </div>
                    
                    <div>
                        <label for="modal_event_organizer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Organizatör
                        </label>
                        <input type="text" name="organizer" id="modal_event_organizer" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="Organizatör adı veya kurum">
                    </div>
                </div>
                
                <!-- Tarih & Saat Sekmesi -->
                <div id="tab-content-datetime" class="event-tab-content hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal_event_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Başlangıç Tarihi <span class="text-red-500">*</span>
                            </label>
                            <input type="date" name="date" id="modal_event_date" required 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="modal_event_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Başlangıç Saati <span class="text-red-500">*</span>
                            </label>
                            <input type="time" name="time" id="modal_event_time" required 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal_event_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Bitiş Tarihi
                            </label>
                            <input type="date" name="end_date" id="modal_event_end_date" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="modal_event_end_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Bitiş Saati
                            </label>
                            <input type="time" name="end_time" id="modal_event_end_time" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    
                    <div>
                        <label for="modal_event_registration_deadline" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Kayıt Son Tarihi
                        </label>
                        <input type="datetime-local" name="registration_deadline" id="modal_event_registration_deadline" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                </div>
                
                <!-- Konum & İletişim Sekmesi -->
                <div id="tab-content-location" class="event-tab-content hidden space-y-4">
                    <div>
                        <label for="modal_event_location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Konum/Yer
                        </label>
                        <input type="text" name="location" id="modal_event_location" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="Salon Adı, Adres veya Çevrimiçi Bağlantı">
                    </div>
                    
                    <div>
                        <label for="modal_event_contact_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            İletişim E-postası
                        </label>
                        <input type="email" name="contact_email" id="modal_event_contact_email" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="etkinlik@topluluk.edu.tr">
                    </div>
                    
                    <div>
                        <label for="modal_event_contact_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            İletişim Telefonu
                        </label>
                        <input type="tel" name="contact_phone" id="modal_event_contact_phone" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="0555 123 45 67">
                    </div>
                    
                    <div>
                        <label for="modal_event_external_link" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Dış Bağlantı (URL)
                        </label>
                        <input type="url" name="external_link" id="modal_event_external_link" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="https://...">
                    </div>
                </div>
                
                <!-- Medya Sekmesi -->
                <div id="tab-content-media" class="event-tab-content hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Etkinlik Görseli</label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md p-4 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-colors">
                            <input type="file" name="event_image" id="event_image" accept="image/*" class="hidden" onchange="previewImage(this, 'imagePreview')">
                            <label for="event_image" class="cursor-pointer">
                                <div class="flex flex-col items-center">
                                    <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Görsel yüklemek için tıklayın</span>
                                    <span class="text-xs text-gray-500">PNG, JPG, JPEG (Max: 5MB)</span>
                                </div>
                            </label>
                        </div>
                        <div id="imagePreview" class="mt-2 hidden">
                            <img id="previewImg" class="w-full h-32 object-cover rounded-md">
                            <button type="button" onclick="removeImage()" class="mt-2 text-red-600 text-sm hover:text-red-800">Görseli Kaldır</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Etkinlik Videosu</label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md p-4 text-center hover:border-gray-400 dark:hover:border-gray-500 transition-colors">
                            <input type="file" name="event_video" id="event_video" accept="video/*" class="hidden" onchange="previewVideo(this, 'videoPreview')">
                            <label for="event_video" class="cursor-pointer">
                                <div class="flex flex-col items-center">
                                    <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Video yüklemek için tıklayın</span>
                                    <span class="text-xs text-gray-500">MP4, AVI, MOV (Max: 50MB)</span>
                                </div>
                            </label>
                        </div>
                        <div id="videoPreview" class="mt-2 hidden">
                            <video id="previewVideo" class="w-full h-32 object-cover rounded-md" controls></video>
                            <button type="button" onclick="removeVideo()" class="mt-2 text-red-600 text-sm hover:text-red-800">Videoyu Kaldır</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ayarlar Sekmesi -->
                <div id="tab-content-settings" class="event-tab-content hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal_event_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Durum
                            </label>
                            <select name="status" id="modal_event_status" 
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="planlanıyor">Planlanıyor</option>
                                <option value="devam_ediyor">Devam Ediyor</option>
                                <option value="tamamlandı">Tamamlandı</option>
                                <option value="iptal">İptal Edildi</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal_event_priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Öncelik
                            </label>
                            <select name="priority" id="modal_event_priority" 
                                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="normal">Normal</option>
                                <option value="yüksek">Yüksek</option>
                                <option value="düşük">Düşük</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="modal_event_visibility" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Görünürlük
                        </label>
                        <select name="visibility" id="modal_event_visibility" 
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="public">Herkese Açık</option>
                            <option value="members_only">Sadece Üyelere</option>
                            <option value="private">Özel</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="featured" value="1" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Öne Çıkarılmış Etkinlik</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" name="registration_required" value="1" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Kayıt Gerekli</span>
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="modal_event_capacity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Kapasite
                            </label>
                            <input type="number" name="capacity" id="modal_event_capacity" min="0" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                                   placeholder="Kişi sayısı">
                        </div>
                        
                        <div>
                            <label for="modal_event_max_attendees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Maksimum Katılımcı
                            </label>
                            <input type="number" name="max_attendees" id="modal_event_max_attendees" min="0" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                                   placeholder="Max">
                        </div>
                        
                        <div>
                            <label for="modal_event_min_attendees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Minimum Katılımcı
                            </label>
                            <input type="number" name="min_attendees" id="modal_event_min_attendees" min="0" 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                                   placeholder="Min">
                        </div>
                    </div>
                    
                    <div>
                        <label for="modal_event_cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Ücret (TL)
                        </label>
                        <input type="number" name="cost" id="modal_event_cost" step="0.01" min="0" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="0.00">
                    </div>
                </div>
                
                <!-- Anket Sekmesi -->
                <div id="tab-content-survey" class="event-tab-content hidden space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800 dark:text-blue-200">
                            <strong>Not:</strong> Etkinlik oluşturulduktan sonra bu ankete sorular ekleyebilirsiniz. Anket başlığı ve açıklamasını şimdi belirleyebilirsiniz.
                        </p>
                    </div>
                    
                    <div>
                        <label for="add_event_survey_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Anket Başlığı
                        </label>
                        <input type="text" name="survey_title" id="add_event_survey_title" 
                               class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                               placeholder="Örn: Etkinlik Değerlendirme Anketi">
                    </div>
                    
                    <div>
                        <label for="add_event_survey_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Anket Açıklaması
                        </label>
                        <textarea name="survey_description" id="add_event_survey_description" rows="4" 
                                  class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" 
                                  placeholder="Anket hakkında kısa bir açıklama..."></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="create_survey_with_event" id="create_survey_with_event" value="1" 
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="create_survey_with_event" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Etkinlik oluşturulduğunda bu anketi de oluştur
                        </label>
                    </div>
                </div>
                </div>
                
                <!-- Butonlar -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700 mt-6 flex-shrink-0">
                    <button type="button" onclick="closeModal('addEventModal')" 
                            class="px-6 py-2 text-white color-secondary-btn rounded-md hover-secondary transition duration-150">
                        İptal
                    </button>
                    <button type="submit" 
                            class="px-6 py-2 text-white color-primary rounded-md hover-primary transition duration-150 font-semibold">
                        Etkinlik Oluştur
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script<?= tpl_script_nonce_attr(); ?>>
    function switchEventTab(tabName) {
        // Tüm sekmeleri gizle
        document.querySelectorAll('.event-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Tüm sekme butonlarını pasif yap
        document.querySelectorAll('.event-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Seçilen sekmeyi göster
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        
        // Seçilen sekme butonunu aktif yap
        const activeBtn = document.getElementById('tab-' + tabName);
        activeBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
        activeBtn.classList.remove('text-gray-500', 'border-transparent');
    }
    
    function switchEditEventTab(tabName) {
        // Tüm sekmeleri gizle
        document.querySelectorAll('.edit-event-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Tüm sekme butonlarını pasif yap
        document.querySelectorAll('.edit-event-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        
        // Seçilen sekmeyi göster
        document.getElementById('edit-tab-content-' + tabName).classList.remove('hidden');
        
        // Seçilen sekme butonunu aktif yap
        const activeBtn = document.getElementById('edit-tab-' + tabName);
        activeBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
        activeBtn.classList.remove('text-gray-500', 'border-transparent');
    }
    </script>
    
    <style>
    .event-tab-btn {
        transition: all 0.2s;
    }
    .event-tab-btn:hover {
        color: #2563eb;
    }
    .event-tab-content {
        min-height: 350px;
    }
    .edit-event-tab-btn {
        transition: all 0.2s;
    }
    .edit-event-tab-btn:hover {
        color: #2563eb;
    }
    .edit-event-tab-content {
        min-height: 350px;
    }
    /* Event Card Styles */
    .event-card .event-image {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .event-card:hover .event-image {
        transform: scale(1.02);
    }
    .event-card:hover {
        border-color: rgba(99, 102, 241, 0.3);
    }
    
    .member-card {
        transition: all 0.2s ease-in-out;
    }
    .member-card:hover {
        border-color: rgba(99, 102, 241, 0.4);
        transform: translateY(-2px);
    }
    .member-card .w-12 {
        transition: transform 0.2s ease-in-out;
    }
    .member-card:hover .w-12 {
        transform: scale(1.1);
    }
    </style>
    
    <script<?= tpl_script_nonce_attr(); ?>>
    function filterEvents() {
        try {
            const searchInput = document.getElementById('event_search');
            const statusSelect = document.getElementById('filter_status');
            const categorySelect = document.getElementById('filter_category');
            
            if (!searchInput || !statusSelect || !categorySelect) {
                console.warn('Filter elements not found');
                return;
            }
            
            const search = (searchInput.value || '').toLowerCase().trim();
            const statusFilter = statusSelect.value || '';
            const categoryFilter = categorySelect.value || '';
            
            const rows = document.querySelectorAll('.event-row');
            const cards = document.querySelectorAll('.event-card');
            
            // Tablo satırları için filtreleme
            rows.forEach(row => {
                const title = (row.dataset.title || '').toLowerCase();
                const status = row.dataset.status || '';
                const category = row.dataset.category || '';
                const rowText = (row.textContent || '').toLowerCase();
                
                const matchesSearch = !search || title.includes(search) || rowText.includes(search);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesCategory = !categoryFilter || category === categoryFilter;
                
                row.style.display = (matchesSearch && matchesStatus && matchesCategory) ? '' : 'none';
            });
            
            // Mobil kartlar için filtreleme
            cards.forEach(card => {
                const title = (card.dataset.title || '').toLowerCase();
                const status = card.dataset.status || '';
                const category = card.dataset.category || '';
                const cardText = (card.textContent || '').toLowerCase();
                
                const matchesSearch = !search || title.includes(search) || cardText.includes(search);
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesCategory = !categoryFilter || category === categoryFilter;
                
                card.style.display = (matchesSearch && matchesStatus && matchesCategory) ? '' : 'none';
            });
        } catch (error) {
            console.error('filterEvents error:', error);
        }
    }
    
    // Sayfa yüklendiğinde arama fonksiyonunu hazırla
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('event_search');
        if (searchInput) {
            // Input event listener ekle (onkeyup yerine)
            searchInput.addEventListener('input', filterEvents);
            searchInput.addEventListener('keyup', filterEvents);
        }
        
        const statusSelect = document.getElementById('filter_status');
        if (statusSelect) {
            statusSelect.addEventListener('change', filterEvents);
        }
        
        const categorySelect = document.getElementById('filter_category');
        if (categorySelect) {
            categorySelect.addEventListener('change', filterEvents);
        }
    });
    
    function sortEvents() {
        const sortBy = document.getElementById('sort_events').value;
        const tbody = document.getElementById('eventsTableBody');
        const rows = Array.from(tbody.querySelectorAll('.event-row'));
        const cardsContainer = document.getElementById('eventsCardsContainer');
        const cards = Array.from(cardsContainer.querySelectorAll('.event-card'));
        
        // Sıralama fonksiyonu
        const sortFunction = (a, b) => {
            switch(sortBy) {
                case 'date_desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date_asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'title_asc':
                    return a.dataset.title.localeCompare(b.dataset.title);
                case 'title_desc':
                    return b.dataset.title.localeCompare(a.dataset.title);
                case 'priority':
                    const priorityOrder = {'yüksek': 3, 'normal': 2, 'düşük': 1};
                    return (priorityOrder[b.dataset.priority] || 0) - (priorityOrder[a.dataset.priority] || 0);
                default:
                    return 0;
            }
        };
        
        // Tablo satırlarını sırala
        rows.sort(sortFunction);
        rows.forEach(row => tbody.appendChild(row));
        
        // Mobil kartları sırala
        cards.sort(sortFunction);
        cards.forEach(card => cardsContainer.appendChild(card));
    }
    
    // AI ile etkinlik açıklaması oluştur
    async function generateEventDescription() {
        const btn = document.getElementById('ai-generate-btn');
        const descriptionField = document.getElementById('modal_event_description');
        
        if (!descriptionField) {
            showToast('Hata', 'Açıklama alanı bulunamadı', 'error');
            return;
        }
        
        // Form verilerini topla
        const title = document.getElementById('modal_event_title')?.value || '';
        const date = document.getElementById('modal_event_date')?.value || '';
        const time = document.getElementById('modal_event_time')?.value || '';
        const location = document.getElementById('modal_event_location')?.value || '';
        const category = document.getElementById('modal_event_category')?.value || 'Genel';
        const organizer = document.getElementById('modal_event_organizer')?.value || '';
        
        // CSRF token'ı al
        const form = document.getElementById('addEventForm');
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        // Minimum bilgi kontrolü
        if (!title || !date || !time) {
            showToast('Uyarı', 'Lütfen önce etkinlik başlığı, tarih ve saat bilgilerini girin', 'warning');
            return;
        }
        
        // Butonu devre dışı bırak
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Oluşturuluyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    action: 'ai_generate_event_description',
                    csrf_token: csrfToken,
                    title: title,
                    date: date,
                    time: time,
                    location: location,
                    category: category,
                    organizer: organizer
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.description) {
                descriptionField.value = result.description;
                showToast('Başarılı', 'Açıklama oluşturuldu', 'success');
            } else {
                showToast('Hata', result.error || 'Açıklama oluşturulamadı', 'error');
            }
        } catch (error) {
            console.error('AI generation error:', error);
            showToast('Hata', 'Bir sorun oluştu: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function generateEventTitleSuggestions() {
        const title = document.getElementById('modal_event_title')?.value || '';
        const category = document.getElementById('modal_event_category')?.value || 'Genel';
        const location = document.getElementById('modal_event_location')?.value || '';
        const date = document.getElementById('modal_event_date')?.value || '';
        
        const form = document.getElementById('addEventForm');
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        const suggestionsDiv = document.getElementById('title-suggestions');
        const listDiv = document.getElementById('title-suggestions-list');
        
        if (!suggestionsDiv || !listDiv) {
            showToast('Hata', 'Başlık önerileri alanı bulunamadı', 'error');
            return;
        }
        
        suggestionsDiv.classList.remove('hidden');
        listDiv.innerHTML = '<p class="text-xs text-gray-600">Yükleniyor...</p>';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_event_title_suggestions',
                    csrf_token: csrfToken,
                    title: title,
                    category: category,
                    location: location,
                    date: date,
                }),
            });
            
            const data = await response.json();
            
            if (data.success && data.titles && data.titles.length > 0) {
                listDiv.innerHTML = data.titles.map((title, index) => {
                    // Başlığı temizle ve güvenli hale getir
                    let cleanTitle = String(title || '').replace(/^\d+[\.\)]\s*/, '').trim();
                    cleanTitle = cleanTitle.replace(/['"]/g, ''); // Tırnak işaretlerini kaldır
                    
                    // HTML escape
                    const safeTitle = cleanTitle
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    
                    // JavaScript için escape
                    const jsSafeTitle = cleanTitle
                        .replace(/\\/g, '\\\\')
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"')
                        .replace(/\n/g, '\\n')
                        .replace(/\r/g, '\\r');
                    
                    return `<button type="button" onclick="selectTitleSuggestion('${jsSafeTitle}')" 
                             class="w-full text-left px-4 py-3 text-sm font-medium text-purple-800 dark:text-purple-200 bg-white dark:bg-gray-800 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded-lg border border-purple-200 dark:border-purple-700 transition-all duration-200 hover:shadow-sm hover:border-purple-300 dark:hover:border-purple-600 group">
                        <span class="flex items-center gap-3">
                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400 flex items-center justify-center text-xs font-semibold group-hover:bg-purple-200 dark:group-hover:bg-purple-800 transition-colors">${index + 1}</span>
                            <span class="flex-1">${safeTitle}</span>
                            <svg class="w-4 h-4 text-purple-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </span>
                    </button>`;
                }).join('');
            } else {
                listDiv.innerHTML = '<p class="text-sm text-red-600 dark:text-red-400 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">Başlık önerileri oluşturulamadı.</p>';
            }
        } catch (error) {
            console.error('Error:', error);
            listDiv.innerHTML = '<p class="text-xs text-red-600">Bir hata oluştu.</p>';
        }
    }
    
    function selectTitleSuggestion(title) {
        document.getElementById('modal_event_title').value = title;
        document.getElementById('title-suggestions').classList.add('hidden');
        showToast('Başarılı', 'Başlık seçildi', 'success');
    }
    
    async function generateEventHashtags() {
        const title = document.getElementById('modal_event_title')?.value || '';
        const category = document.getElementById('modal_event_category')?.value || 'Genel';
        const location = document.getElementById('modal_event_location')?.value || '';
        
        const form = document.getElementById('addEventForm');
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        if (!title) {
            showToast('Uyarı', 'Lütfen önce etkinlik başlığını girin', 'warning');
            return;
        }
        
        const resultDiv = document.getElementById('hashtags-result');
        const textDiv = document.getElementById('hashtags-text');
        if (!resultDiv || !textDiv) {
            showToast('Hata', 'Hashtag alanı bulunamadı', 'error');
            return;
        }
        
        resultDiv.classList.remove('hidden');
        textDiv.textContent = 'Yükleniyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_event_hashtags',
                    csrf_token: csrfToken,
                    title: title,
                    category: category,
                    location: location,
                }),
            });
            
            const data = await response.json();
            if (data.success && data.hashtags) {
                textDiv.textContent = data.hashtags;
                showToast('Başarılı', 'Hashtag\'ler oluşturuldu', 'success');
            } else {
                textDiv.textContent = 'Hashtag\'ler oluşturulamadı.';
            }
        } catch (error) {
            console.error('Error:', error);
            textDiv.textContent = 'Bir hata oluştu.';
        }
    }
    
    async function generateSocialMediaPost() {
        const title = document.getElementById('modal_event_title')?.value || '';
        const date = document.getElementById('modal_event_date')?.value || '';
        const time = document.getElementById('modal_event_time')?.value || '';
        const location = document.getElementById('modal_event_location')?.value || '';
        const platform = prompt('Platform seçin (instagram/twitter/facebook):', 'instagram') || 'instagram';
        
        const form = document.getElementById('addEventForm');
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik hatası: CSRF token bulunamadı', 'error');
            return;
        }
        
        if (!title || !date || !time) {
            showToast('Uyarı', 'Lütfen önce etkinlik bilgilerini girin', 'warning');
            return;
        }
        
        const resultDiv = document.getElementById('social-post-result');
        const textArea = document.getElementById('social-post-text');
        if (!resultDiv || !textArea) {
            showToast('Hata', 'Sosyal medya alanı bulunamadı', 'error');
            return;
        }
        
        resultDiv.classList.remove('hidden');
        textArea.value = 'Yükleniyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_social_media_post',
                    csrf_token: csrfToken,
                    title: title,
                    date: date,
                    time: time,
                    location: location,
                    platform: platform,
                }),
            });
            
            const data = await response.json();
            if (data.success && data.post) {
                textArea.value = data.post;
                showToast('Başarılı', 'Sosyal medya metni oluşturuldu', 'success');
            } else {
                textArea.value = 'Metin oluşturulamadı.';
            }
        } catch (error) {
            console.error('Error:', error);
            textArea.value = 'Bir hata oluştu.';
        }
    }
    
    async function improveText(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
            showToast('Uyarı', 'Lütfen önce metin girin', 'warning');
            return;
        }
        
        const improvementType = prompt('İyileştirme tipi seçin:\n1. gramer\n2. akıcılık\n3. kısalık\n4. genişletme\n5. profesyonel\n6. samimi', 'gramer') || 'gramer';
        
        // Farklı formları kontrol et
        let form = document.getElementById('addEventForm');
        if (!form) form = document.getElementById('email_form');
        if (!form) form = document.getElementById('sms_form');
        if (!form) form = field.closest('form');
        
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik hatası: CSRF token bulunamadı', 'error');
            return;
        }
        
        const originalText = field.value;
        field.disabled = true;
        field.value = 'İyileştiriliyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_improve_text',
                    csrf_token: csrfToken,
                    text: originalText,
                    improvement_type: improvementType,
                }),
            });
            
            const data = await response.json();
            if (data.success && data.improved_text) {
                field.value = data.improved_text;
                if (fieldId === 'sms_body') {
                    updateSmsCharCount();
                }
                showToast('Başarılı', 'Metin iyileştirildi', 'success');
            } else {
                field.value = originalText;
                showToast('Hata', data.message || 'Metin iyileştirilemedi', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            field.value = originalText;
            showToast('Hata', 'Bir sorun oluştu: ' + error.message, 'error');
        } finally {
            field.disabled = false;
        }
    }
    
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element.tagName === 'TEXTAREA') {
            element.select();
        } else {
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
        document.execCommand('copy');
        showToast('Kopyalandı!', 'success');
    }
    
    async function generateSmsMessage() {
        const btn = document.getElementById('ai-generate-sms-btn');
        const smsField = document.getElementById('sms_body');
        
        if (!smsField) {
            showToast('Hata', 'SMS alanı bulunamadı', 'error');
            return;
        }
        
        const purpose = prompt('Mesaj amacı (duyuru, hatırlatma, teşekkür, davet):', 'duyuru') || 'duyuru';
        const tone = prompt('Ton (resmi/samimi/eğlenceli):', 'samimi') || 'samimi';
        
        // SMS formunu bul
        let form = document.getElementById('sms_form');
        if (!form) form = smsField.closest('form');
        
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Oluşturuluyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_message',
                    csrf_token: csrfToken,
                    purpose: purpose,
                    tone: tone,
                    is_sms: '1',
                }),
            });
            
            const data = await response.json();
            if (data.success && data.message) {
                smsField.value = data.message;
                if (typeof updateSmsCharCount === 'function') {
                    updateSmsCharCount();
                }
                showToast('Başarılı', 'SMS mesajı oluşturuldu', 'success');
            } else {
                showToast('Hata', data.message || 'Mesaj oluşturulamadı', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Hata', 'Bir sorun oluştu: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function generateEmailSubject() {
        const subjectField = document.getElementById('email_subject');
        if (!subjectField) {
            showToast('Hata', 'Konu alanı bulunamadı', 'error');
            return;
        }
        
        const purpose = prompt('Email amacı (duyuru, hatırlatma, teşekkür, davet):', 'duyuru') || 'duyuru';
        
        // Email formunu bul
        let form = document.getElementById('email_form');
        if (!form) form = subjectField.closest('form');
        
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        const originalValue = subjectField.value;
        subjectField.disabled = true;
        subjectField.value = 'Oluşturuluyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_email_subject',
                    csrf_token: csrfToken,
                    purpose: purpose,
                }),
            });
            
            const data = await response.json();
            if (data.success && data.subject) {
                subjectField.value = data.subject;
                showToast('Başarılı', 'Email konusu oluşturuldu', 'success');
            } else {
                subjectField.value = originalValue;
                showToast('Hata', data.message || 'Konu oluşturulamadı', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            subjectField.value = originalValue;
            showToast('Hata', 'Bir sorun oluştu: ' + error.message, 'error');
        } finally {
            subjectField.disabled = false;
        }
    }
    
    async function generateEmailContent() {
        const btn = document.getElementById('ai-generate-email-btn');
        const emailField = document.getElementById('email_body');
        
        if (!emailField) {
            showToast('Hata', 'Email alanı bulunamadı', 'error');
            return;
        }
        
        const subject = document.getElementById('email_subject')?.value || '';
        const purpose = prompt('Email amacı (duyuru, hatırlatma, teşekkür, davet):', 'duyuru') || 'duyuru';
        const tone = prompt('Ton (resmi/samimi/eğlenceli):', 'samimi') || 'samimi';
        
        // Email formunu bul
        let form = document.getElementById('email_form');
        if (!form) form = emailField.closest('form');
        
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Oluşturuluyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_message',
                    csrf_token: csrfToken,
                    purpose: purpose,
                    tone: tone,
                    subject: subject,
                    is_sms: '0',
                }),
            });
            
            const data = await response.json();
            if (data.success && data.message) {
                emailField.value = data.message;
                showToast('Başarılı', 'Email içeriği oluşturuldu', 'success');
            } else {
                showToast('Hata', data.message || 'İçerik oluşturulamadı', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Hata', 'Bir sorun oluştu: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function generateEmailTemplate() {
        const emailField = document.getElementById('email_body');
        
        if (!emailField) {
            showToast('Hata', 'Email alanı bulunamadı', 'error');
            return;
        }
        
        const purpose = prompt('Email şablonu amacı (duyuru, hatırlatma, teşekkür, davet):', 'duyuru') || 'duyuru';
        const subject = document.getElementById('email_subject')?.value || '';
        
        // Email formunu bul
        let form = document.getElementById('email_form');
        if (!form) form = emailField.closest('form');
        
        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value || '';
        
        if (!csrfToken) {
            showToast('Güvenlik Hatası', 'Güvenlik doğrulaması yapılamadı', 'error');
            return;
        }
        
        const originalValue = emailField.value;
        emailField.disabled = true;
        emailField.value = 'Şablon oluşturuluyor...';
        
        try {
            const response = await fetch('index.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    action: 'ai_generate_email_template',
                    csrf_token: csrfToken,
                    purpose: purpose,
                    subject: subject,
                }),
            });
            
            const data = await response.json();
            if (data.success && data.template) {
                emailField.value = data.template;
                showToast('Başarılı', 'Email şablonu oluşturuldu', 'success');
            } else {
                emailField.value = originalValue;
                showToast('Hata', data.message || 'Şablon oluşturulamadı', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            emailField.value = originalValue;
            showToast('Bir hata oluştu: ' + error.message, 'error');
        } finally {
            emailField.disabled = false;
        }
    }
    
    // Topluluk bazlı localStorage key'i oluştur
    function getEventFormStorageKey() {
        // DB_PATH'den hash oluştur (her topluluk için farklı)
        const dbPath = '<?= md5(DB_PATH) ?>';
        return 'eventFormData_' + dbPath;
    }
    
    // Form verilerini localStorage'a kaydet
    function saveEventFormData(form) {
        const formData = {};
        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type === 'file') return; // Dosya yüklemelerini kaydetme
            if (input.name === 'csrf_token') return; // CSRF token'ı kaydetme - her seferinde yeni token kullanılmalı
            if (input.type === 'checkbox') {
                formData[input.name] = input.checked;
            } else if (input.type === 'radio') {
                if (input.checked) {
                    formData[input.name] = input.value;
                }
            } else {
                formData[input.name] = input.value || '';
            }
        });
        try {
            localStorage.setItem(getEventFormStorageKey(), JSON.stringify(formData));
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
    }
    
    // Form verilerini localStorage'dan geri yükle
    function restoreEventFormData(form) {
        let savedData = null;
        try {
            savedData = localStorage.getItem(getEventFormStorageKey());
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
            return;
        }
        if (!savedData) return;
        
        try {
            const formData = JSON.parse(savedData);
            Object.keys(formData).forEach(name => {
                if (name === 'csrf_token') return; // CSRF token'ı restore etme
                const input = form.querySelector(`[name="${name}"]`);
                if (!input) return;
                
                if (input.type === 'checkbox') {
                    input.checked = formData[name];
                } else if (input.type === 'radio') {
                    const radio = form.querySelector(`[name="${name}"][value="${formData[name]}"]`);
                    if (radio) radio.checked = true;
                } else {
                    input.value = formData[name];
                }
            });
        } catch (e) {
            console.error('Form verileri geri yüklenirken hata:', e);
        }
    }
    
    // Form verilerini temizle
    function clearEventFormData() {
        try {
            localStorage.removeItem(getEventFormStorageKey());
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
    }
    
    // escapeHtml ve escapeJs helper fonksiyonları global scope'a ekle
    window.escapeHtml = escapeHtml;
    window.escapeJs = escapeJs;
    
    // Form submit handler - validasyon + veri kaydetme
    function handleEventFormSubmit(form) {
        // Önce validasyonu yap
        if (!validateEventForm(form)) {
            // Validasyon başarısızsa verileri kaydet (zaten kaydedilmiş olabilir)
            saveEventFormData(form);
            return false;
        }
        
        // Validasyon başarılıysa form gönderilecek
        // Form gönderildikten sonra başarılı olursa PHP tarafında temizlenecek
        // Hata olursa veriler localStorage'da kalacak (kullanıcı tekrar deneyebilir)
        return true;
    }
    
    // Sayfa yüklendiğinde form verilerini geri yükle ve değişiklikleri dinle
    document.addEventListener('DOMContentLoaded', function() {
        const addEventForm = document.getElementById('addEventForm');
        if (addEventForm) {
            // Form alanlarında değişiklik olduğunda otomatik kaydet
            addEventForm.addEventListener('input', function(e) {
                if (e.target.type !== 'file') {
                    saveEventFormData(addEventForm);
                }
            });
            addEventForm.addEventListener('change', function(e) {
                if (e.target.type !== 'file') {
                    saveEventFormData(addEventForm);
                }
            });
            
            // Modal açıldığında verileri geri yükle, kapandığında temizle
            const addEventModal = document.getElementById('addEventModal');
            if (addEventModal) {
                let wasOpen = false;
                // Modal açılma/kapanma olayını dinle
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const isOpen = !addEventModal.classList.contains('hidden');
                            
                            if (isOpen && !wasOpen) {
                                // Modal açıldı - verileri geri yükle
                                setTimeout(() => {
                                    restoreEventFormData(addEventForm);
                                }, 100);
                                wasOpen = true;
                            } else if (!isOpen && wasOpen) {
                                // Modal kapandı - formu temizle (yeni etkinlik için hazırla)
                                setTimeout(() => {
                                    const form = document.getElementById('addEventForm');
                                    if (form) {
                                        form.reset();
                                        clearEventFormData();
                                    }
                                }, 300);
                                wasOpen = false;
                            }
                        }
                    });
                });
                observer.observe(addEventModal, { attributes: true });
            }
        }
        
        // Başarı mesajı varsa veya clear_form_data flag'i varsa form verilerini temizle
        <?php if (isset($_SESSION['clear_form_data']) || isset($_SESSION['event_added_successfully']) || (isset($_SESSION['message']) && (strpos($_SESSION['message'], 'etkinlik') !== false || strpos($_SESSION['message'], 'Etkinlik') !== false || strpos($_SESSION['message'], 'başarıyla') !== false))): ?>
        clearEventFormData();
        // Formu da temizle
        const addEventForm = document.getElementById('addEventForm');
        if (addEventForm) {
            addEventForm.reset();
        }
        <?php 
        unset($_SESSION['clear_form_data']); // Flag'i temizle
        unset($_SESSION['event_added_successfully']); // Flag'i temizle
        endif; ?>
    });
    
    // Form Validasyonu
    function validateEventForm(form) {
        console.log('validateEventForm çağrıldı');
        const title = form.querySelector('[name="title"]');
        const date = form.querySelector('[name="date"]');
        const time = form.querySelector('[name="time"]');
        const endDate = form.querySelector('[name="end_date"]');
        const endTime = form.querySelector('[name="end_time"]');
        const cost = form.querySelector('[name="cost"]');
        const maxAttendees = form.querySelector('[name="max_attendees"]');
        const minAttendees = form.querySelector('[name="min_attendees"]');
        const capacity = form.querySelector('[name="capacity"]');
        const contactEmail = form.querySelector('[name="contact_email"]');
        const externalLink = form.querySelector('[name="external_link"]');
        
        console.log('validateEventForm - Alanlar:', {
            title: title ? title.value : 'BULUNAMADI',
            date: date ? date.value : 'BULUNAMADI',
            time: time ? time.value : 'BULUNAMADI'
        });
        
        // Başlık kontrolü
        if (!title || !title.value.trim()) {
            console.error('validateEventForm - Başlık boş veya bulunamadı');
            alert('Etkinlik başlığı zorunludur!');
            title?.focus();
            return false;
        }
        
        // Tarih kontrolü
        if (!date || !date.value) {
            console.error('validateEventForm - Tarih boş veya bulunamadı');
            alert('Başlangıç tarihi zorunludur!');
            date?.focus();
            return false;
        }
        
        // Saat kontrolü
        if (!time || !time.value) {
            console.error('validateEventForm - Saat boş veya bulunamadı');
            alert('Başlangıç saati zorunludur!');
            time?.focus();
            return false;
        }
        
        // Bitiş tarihi kontrolü (başlangıçtan sonra olmalı)
        if (endDate && endDate.value && date && date.value) {
            if (new Date(endDate.value) < new Date(date.value)) {
                alert('Bitiş tarihi başlangıç tarihinden önce olamaz!');
                endDate.focus();
                return false;
            }
        }
        
        // Ücret kontrolü
        if (cost && cost.value && parseFloat(cost.value) < 0) {
            alert('Ücret negatif olamaz!');
            cost.focus();
            return false;
        }
        
        // Kapasite kontrolü
        if (capacity && capacity.value && parseInt(capacity.value) < 0) {
            alert('Kapasite negatif olamaz!');
            capacity.focus();
            return false;
        }
        
        // Maksimum/Minimum katılımcı kontrolü
        if (maxAttendees && minAttendees && maxAttendees.value && minAttendees.value) {
            if (parseInt(maxAttendees.value) < parseInt(minAttendees.value)) {
                alert('Maksimum katılımcı sayısı minimumdan küçük olamaz!');
                maxAttendees.focus();
                return false;
            }
        }
        
        // E-posta format kontrolü
        if (contactEmail && contactEmail.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contactEmail.value)) {
                alert('Geçerli bir e-posta adresi giriniz!');
                contactEmail.focus();
                return false;
            }
        }
        
        // URL format kontrolü
        if (externalLink && externalLink.value) {
            try {
                new URL(externalLink.value);
            } catch (e) {
                alert('Geçerli bir URL giriniz! (örn: https://...)');
                externalLink.focus();
                return false;
            }
        }
        
        return true;
    }
    
    // Edit form submit handler
    function handleEditFormSubmit(form) {
        const result = validateEditForm(form);
        if (result) {
            // Form submit edilecek, loading göster
            const submitBtn = form.querySelector('#editFormSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Kaydediliyor...';
            }
        }
        return result;
    }
    
    // Edit form validasyonu - hangi tip form olduğuna göre validasyon yapar
    function validateEditForm(form) {
        const modalAction = form.querySelector('#modalAction');
        const action = modalAction ? modalAction.value : '';
        const modalId = form.querySelector('#modalId');
        const id = modalId ? modalId.value : '';
        
        if (!action) {
            alert('Form action bulunamadı. Lütfen sayfayı yenileyin.');
            return false;
        }
        
        // Event düzenleme
        if (action === 'update_event') {
            return validateEventForm(form);
        }
        
        // Member düzenleme - validasyon yok (tüm alanlar opsiyonel)
        if (action === 'update_member') {
            return true;
        }
        
        // Board düzenleme - zorunlu alanlar kontrolü
        if (action === 'update_board_member') {
            const fullName = form.querySelector('[name="full_name"]');
            const role = form.querySelector('[name="role"]');
            const phone = form.querySelector('[name="phone"]');
            const email = form.querySelector('[name="contact_email"]');
            
            if (!fullName || !fullName.value.trim()) {
                alert('Adı Soyadı zorunludur!');
                fullName?.focus();
                return false;
            }
            
            if (!role || !role.value) {
                alert('Görev seçimi zorunludur!');
                role?.focus();
                return false;
            }
            
            if (!phone || !phone.value.trim()) {
                alert('Telefon numarası zorunludur!');
                phone?.focus();
                return false;
            }
            
            if (!email || !email.value.trim()) {
                alert('E-posta zorunludur!');
                email?.focus();
                return false;
            }
            
            // E-posta format kontrolü
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email.value)) {
                alert('Geçerli bir e-posta adresi giriniz!');
                email.focus();
                return false;
            }
            
            return true;
        }
        
        // Bilinmeyen action
        return true;
    }
    </script>

    <div id="addMemberModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-md shadow-2xl w-full max-w-lg transform transition-transform duration-300 scale-100">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-900">Yeni Üye Kaydı</h3>
            <form method="POST" action="index.php" class="space-y-4" id="addMemberForm">
                <input type="hidden" name="action" value="add_member">
                <input type="hidden" name="current_view" value="members">
                <?= csrf_token_field() ?>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                        <label for="modal_member_first_name" class="block text-sm font-medium text-gray-700">Ad <span class="text-red-500">*</span></label>
                        <input type="text" name="first_name" id="modal_member_first_name" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Ad">
                    </div>
                    <div>
                        <label for="modal_member_last_name" class="block text-sm font-medium text-gray-700">Soyad <span class="text-red-500">*</span></label>
                        <input type="text" name="last_name" id="modal_member_last_name" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Soyad">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="modal_member_student_id" class="block text-sm font-medium text-gray-700">Öğrenci Numarası <span class="text-red-500">*</span></label>
                        <input type="text" name="student_id" id="modal_member_student_id" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Sadece rakamlar" pattern="[0-9]+" title="Sadece rakam giriniz">
                    </div>
                    <div>
                        <label for="modal_member_phone" class="block text-sm font-medium text-gray-700">Telefon Numarası <span class="text-red-500">*</span></label>
                        <input type="tel" name="phone_number" id="modal_member_phone" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="5XX XXX XX XX" pattern="^5[0-9]{9}$" title="5 ile başlayan 10 haneli numara giriniz">
                    </div>
                </div>
                <div>
                    <label for="modal_member_email" class="block text-sm font-medium text-gray-700">E-posta</label>
                    <input type="email" name="email" id="modal_member_email" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Otomatik oluşturulacak" readonly>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('addMemberModal')" class="px-4 py-2 text-white color-secondary-btn rounded-md hover-secondary transition duration-150">İptal</button>
                    <button type="submit" class="px-4 py-2 text-white color-primary rounded-md hover-primary font-semibold shadow-md transition duration-150">Üye Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="addBoardModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-md shadow-2xl w-full max-w-lg transform transition-transform duration-300 scale-100">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-900">Yeni Görevli Tanımlama</h3>
            <form method="POST" action="index.php" class="space-y-4">
                <input type="hidden" name="action" value="add_board_member">
                <input type="hidden" name="current_view" value="board">
                <?= csrf_token_field() ?>
                <div>
                    <label for="modal_board_name" class="block text-sm font-medium text-gray-700">Adı Soyadı <span class="text-red-500">*</span></label>
                    <input type="text" name="full_name" id="modal_board_name" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                </div>
                <div>
                    <label for="modal_board_role" class="block text-sm font-medium text-gray-700">Görevi/Pozisyonu <span class="text-red-500">*</span></label>
                    <select name="role" id="modal_board_role" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                        <option value="">Görev Seçin</option>
                        <option value="Başkan">Başkan</option>
                        <option value="Başkan Yardımcısı">Başkan Yardımcısı</option>
                        <option value="Genel Sekreter">Genel Sekreter</option>
                        <option value="Mali İşler Sorumlusu">Mali İşler Sorumlusu</option>
                        <option value="Sosyal İşler Sorumlusu">Sosyal İşler Sorumlusu</option>
                        <option value="Eğitim Sorumlusu">Eğitim Sorumlusu</option>
                        <option value="Kültür Sanat Sorumlusu">Kültür Sanat Sorumlusu</option>
                        <option value="Spor Sorumlusu">Spor Sorumlusu</option>
                        <option value="Basın Yayın Sorumlusu">Basın Yayın Sorumlusu</option>
                        <option value="Teknoloji Sorumlusu">Teknoloji Sorumlusu</option>
                        <option value="Çevre Sorumlusu">Çevre Sorumlusu</option>
                        <option value="Üye">Üye</option>
                    </select>
                </div>
                <div>
                    <label for="modal_board_email" class="block text-sm font-medium text-gray-700">İletişim E-postası <span class="text-red-500">*</span></label>
                    <input type="email" name="contact_email" id="modal_board_email" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Kurumsal e-posta adresi">
                </div>
                <div>
                    <label for="modal_board_phone" class="block text-sm font-medium text-gray-700">Telefon Numarası</label>
                    <input type="tel" name="phone" id="modal_board_phone" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="0555 123 45 67">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('addBoardModal')" class="px-4 py-2 text-white color-secondary-btn rounded-md hover-secondary transition duration-150">İptal</button>
                    <button type="submit" class="px-4 py-2 text-white color-primary rounded-md hover-primary font-semibold shadow-md transition duration-150">Görevli Ekle</button>
                </div>
            </form>
        </div>
    </div>


    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300 overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-md shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform transition-transform duration-300 scale-95 my-4">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 dark:text-gray-200">Öğe Düzenle</h3>
            <form method="POST" action="index.php" id="editForm" enctype="multipart/form-data" class="flex flex-col flex-1 min-h-0 space-y-4" onsubmit="return handleEditFormSubmit(this);">
                <input type="hidden" name="action" id="modalAction">
                <input type="hidden" name="id" id="modalId">
                <input type="hidden" name="current_view" value="<?= $current_view ?>">
                <?= csrf_token_field() ?>

                <div id="eventFields" class="hidden flex flex-col" style="flex: 1 1 auto; min-height: 0;">
                    <!-- Sekmeler -->
                    <div class="border-b border-gray-200 dark:border-gray-700 mb-4 flex-shrink-0">
                        <nav class="flex space-x-1" aria-label="Tabs">
                            <button type="button" onclick="switchEditEventTab('general')" id="edit-tab-general" class="edit-event-tab-btn active px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                                Genel Bilgiler
                            </button>
                            <button type="button" onclick="switchEditEventTab('datetime')" id="edit-tab-datetime" class="edit-event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                Tarih & Saat
                            </button>
                            <button type="button" onclick="switchEditEventTab('location')" id="edit-tab-location" class="edit-event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                Konum & İletişim
                            </button>
                            <button type="button" onclick="switchEditEventTab('media')" id="edit-tab-media" class="edit-event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                Medya
                            </button>
                            <button type="button" onclick="switchEditEventTab('settings')" id="edit-tab-settings" class="edit-event-tab-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
                                Ayarlar
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Tab İçerikleri Wrapper -->
                    <div class="flex-1 min-h-0 overflow-y-auto">
                    <!-- Genel Bilgiler Sekmesi -->
                    <div id="edit-tab-content-general" class="edit-event-tab-content space-y-4">
                        <div>
                            <label for="edit_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Etkinlik Başlığı <span class="text-red-500">*</span></label>
                            <input type="text" name="title" id="edit_title" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="edit_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori</label>
                            <select name="category" id="edit_category" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="Genel">Genel</option>
                                <option value="Seminer">Seminer</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Kongre">Kongre</option>
                                <option value="Sosyal">Sosyal Etkinlik</option>
                                <option value="Spor">Spor</option>
                                <option value="Kültür">Kültür & Sanat</option>
                                <option value="Eğitim">Eğitim</option>
                                <option value="Teknoloji">Teknoloji</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Detaylı Açıklama</label>
                            <textarea name="description" id="edit_description" rows="5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
                        </div>
                        <div>
                            <label for="edit_tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Etiketler (virgülle ayırın)</label>
                            <input type="text" name="tags" id="edit_tags" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="teknoloji, eğitim, workshop">
                        </div>
                        <div>
                            <label for="edit_organizer" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Organizatör</label>
                            <input type="text" name="organizer" id="edit_organizer" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    
                    <!-- Tarih & Saat Sekmesi -->
                    <div id="edit-tab-content-datetime" class="edit-event-tab-content hidden space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Başlangıç Tarihi <span class="text-red-500">*</span></label>
                                <input type="date" name="date" id="edit_date" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="edit_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Başlangıç Saati <span class="text-red-500">*</span></label>
                                <input type="time" name="time" id="edit_time" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bitiş Tarihi</label>
                                <input type="date" name="end_date" id="edit_end_date" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="edit_end_time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bitiş Saati</label>
                                <input type="time" name="end_time" id="edit_end_time" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                        <div>
                            <label for="edit_registration_deadline" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kayıt Son Tarihi</label>
                            <input type="datetime-local" name="registration_deadline" id="edit_registration_deadline" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    
                    <!-- Konum & İletişim Sekmesi -->
                    <div id="edit-tab-content-location" class="edit-event-tab-content hidden space-y-4">
                        <div>
                            <label for="edit_location" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Konum/Yer</label>
                            <input type="text" name="location" id="edit_location" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="edit_contact_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">İletişim E-postası</label>
                            <input type="email" name="contact_email" id="edit_contact_email" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="edit_contact_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">İletişim Telefonu</label>
                            <input type="tel" name="contact_phone" id="edit_contact_phone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="edit_external_link" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dış Bağlantı (URL)</label>
                            <input type="url" name="external_link" id="edit_external_link" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    
                    <!-- Medya Sekmesi -->
                    <div id="edit-tab-content-media" class="edit-event-tab-content hidden space-y-4">
                        <div id="existingImagesContainer" class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mevcut Fotoğraflar</label>
                            <div id="existingImagesList" class="grid grid-cols-3 gap-2 mb-2"></div>
                        </div>
                        <div id="existingVideosContainer" class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mevcut Videolar</label>
                            <div id="existingVideosList" class="space-y-2 mb-2"></div>
                        </div>
                        <div class="mb-4">
                            <label for="edit_event_images" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Yeni Fotoğraflar Ekle (Çoklu Seçim)</label>
                            <input type="file" name="event_images[]" id="edit_event_images" accept="image/*" multiple class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <p class="text-xs text-gray-500 mt-1">Birden fazla fotoğraf seçebilirsiniz (JPG, PNG, GIF - Max 5MB)</p>
                        </div>
                        <div>
                            <label for="edit_event_videos" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Yeni Videolar Ekle (Çoklu Seçim)</label>
                            <input type="file" name="event_videos[]" id="edit_event_videos" accept="video/*" multiple class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <p class="text-xs text-gray-500 mt-1">Birden fazla video seçebilirsiniz (MP4, AVI, MOV - Max 50MB)</p>
                        </div>
                    </div>
                    
                    <!-- Ayarlar Sekmesi -->
                    <div id="edit-tab-content-settings" class="edit-event-tab-content hidden space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Durum</label>
                                <select name="status" id="edit_status" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="planlanıyor">Planlanıyor</option>
                                    <option value="devam_ediyor">Devam Ediyor</option>
                                    <option value="tamamlandı">Tamamlandı</option>
                                    <option value="iptal">İptal Edildi</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit_priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Öncelik</label>
                                <select name="priority" id="edit_priority" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                    <option value="normal">Normal</option>
                                    <option value="yüksek">Yüksek</option>
                                    <option value="düşük">Düşük</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="edit_visibility" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Görünürlük</label>
                            <select name="visibility" id="edit_visibility" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                                <option value="public">Herkese Açık</option>
                                <option value="members_only">Sadece Üyelere</option>
                                <option value="private">Özel</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" name="featured" id="edit_featured" value="1" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Öne Çıkarılmış Etkinlik</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="registration_required" id="edit_registration_required" value="1" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Kayıt Gerekli</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="edit_capacity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kapasite</label>
                                <input type="number" name="capacity" id="edit_capacity" min="0" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="edit_max_attendees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maksimum Katılımcı</label>
                                <input type="number" name="max_attendees" id="edit_max_attendees" min="0" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="edit_min_attendees" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Minimum Katılımcı</label>
                                <input type="number" name="min_attendees" id="edit_min_attendees" min="0" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                        <div>
                            <label for="edit_cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ücret (TL)</label>
                            <input type="number" name="cost" id="edit_cost" step="0.01" min="0" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm input-focus bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        </div>
                    </div>
                    </div>
                </div>
                
                <div id="memberFields" class="hidden space-y-4">
                    <input type="hidden" name="member_id" id="edit_member_id">
                    <div>
                        <label for="edit_member_name" class="block text-sm font-medium text-gray-700">Adı Soyadı</label>
                        <input type="text" name="full_name" id="edit_member_name" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Zorunlu değil">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit_student_id" class="block text-sm font-medium text-gray-700">Öğrenci Numarası</label>
                            <input type="text" name="student_id" id="edit_student_id" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Zorunlu değil">
                        </div>
                        <div>
                            <label for="edit_phone_number" class="block text-sm font-medium text-gray-700">Telefon Numarası</label>
                            <input type="tel" name="phone_number" id="edit_phone_number" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Zorunlu değil">
                        </div>
                    </div>
                    <div>
                        <label for="edit_member_email" class="block text-sm font-medium text-gray-700">E-posta</label>
                        <input type="email" name="email" id="edit_member_email" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="Zorunlu değil">
                    </div>
                </div>

                <div id="boardFields" class="hidden space-y-4">
                    <div>
                        <label for="edit_board_name" class="block text-sm font-medium text-gray-700">Adı Soyadı <span class="text-red-500">*</span></label>
                        <input type="text" name="full_name" id="edit_board_name" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                    </div>
                    <div>
                        <label for="edit_board_role" class="block text-sm font-medium text-gray-700">Görevi <span class="text-red-500">*</span></label>
                        <select name="role" id="edit_board_role" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                            <option value="">Görev Seçin</option>
                            <option value="Başkan">Başkan</option>
                            <option value="Başkan Yardımcısı">Başkan Yardımcısı</option>
                            <option value="Genel Sekreter">Genel Sekreter</option>
                            <option value="Mali İşler Sorumlusu">Mali İşler Sorumlusu</option>
                            <option value="Sosyal İşler Sorumlusu">Sosyal İşler Sorumlusu</option>
                            <option value="Eğitim Sorumlusu">Eğitim Sorumlusu</option>
                            <option value="Kültür Sanat Sorumlusu">Kültür Sanat Sorumlusu</option>
                            <option value="Spor Sorumlusu">Spor Sorumlusu</option>
                            <option value="Basın Yayın Sorumlusu">Basın Yayın Sorumlusu</option>
                            <option value="Teknoloji Sorumlusu">Teknoloji Sorumlusu</option>
                            <option value="Çevre Sorumlusu">Çevre Sorumlusu</option>
                            <option value="Üye">Üye</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit_board_phone" class="block text-sm font-medium text-gray-700">Telefon Numarası <span class="text-red-500">*</span></label>
                        <input type="tel" name="phone" id="edit_board_phone" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus" placeholder="0555 123 45 67">
                    </div>
                    <div>
                        <label for="edit_board_email" class="block text-sm font-medium text-gray-700">E-posta <span class="text-red-500">*</span></label>
                        <input type="email" name="contact_email" id="edit_board_email" class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                    </div>
                </div>
                
                <!-- Butonlar (her zaman görünür) -->
                <div class="flex justify-end space-x-3 pt-4 flex-shrink-0 border-t border-gray-200 dark:border-gray-700 mt-4">
                    <button type="button" onclick="closeModal('editModal')" class="px-4 py-2 text-white color-secondary-btn rounded-md hover-secondary transition duration-150">İptal</button>
                    <button type="submit" id="editFormSubmitBtn" class="px-4 py-2 text-white color-primary rounded-md hover-primary transition duration-150 font-semibold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Anket Oluşturma Modalı -->
    <div id="surveyModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-md shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Etkinlik Anketi Oluştur</h3>
                <button onclick="closeModal('surveyModal')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form method="POST" action="index.php" id="surveyForm" enctype="multipart/form-data">
                <input type="hidden" name="action" value="create_survey">
                <input type="hidden" name="event_id" id="surveyEventId">
                <?= csrf_token_field() ?>
                <div class="space-y-4">
                    <div>
                        <label for="survey_title" class="block text-sm font-medium text-gray-700 mb-2">Anket Başlığı <span class="text-red-500">*</span></label>
                        <input type="text" name="survey_title" id="survey_title" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                    </div>
                    <div>
                        <label for="survey_description" class="block text-sm font-medium text-gray-700 mb-2">Açıklama</label>
                        <textarea name="survey_description" id="survey_description" rows="3" class="w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus"></textarea>
                    </div>
                    <div id="questionsContainer" class="space-y-4">
                        <!-- Sorular dinamik olarak eklenecek -->
                    </div>
                    <button type="button" onclick="addSurveyQuestion()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-150 font-medium">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Yeni Soru Ekle
                    </button>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeModal('surveyModal')" class="px-4 py-2 text-white bg-gray-600 rounded-md hover:bg-gray-700 transition duration-150">İptal</button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-150 font-semibold">Anketi Oluştur</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Medya Yükleme Modalı -->
    <div id="mediaUploadModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-md shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Medya Yükle</h3>
                <button onclick="closeModal('mediaUploadModal')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form method="POST" action="index.php" enctype="multipart/form-data" id="mediaUploadForm">
                <input type="hidden" name="action" value="upload_event_media">
                <input type="hidden" name="event_id" id="mediaEventId">
                <?= csrf_token_field() ?>
                <div class="space-y-4">
                    <div>
                        <label for="upload_images" class="block text-sm font-medium text-gray-700 mb-2">Fotoğraflar (Çoklu Seçim)</label>
                        <input type="file" name="event_images[]" id="upload_images" accept="image/*" multiple class="w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                        <p class="text-xs text-gray-500 mt-1">Birden fazla fotoğraf seçebilirsiniz (JPG, PNG, GIF - Max 5MB)</p>
                    </div>
                    <div>
                        <label for="upload_videos" class="block text-sm font-medium text-gray-700 mb-2">Videolar (Çoklu Seçim)</label>
                        <input type="file" name="event_videos[]" id="upload_videos" accept="video/*" multiple class="w-full p-3 border border-gray-300 rounded-md shadow-sm input-focus">
                        <p class="text-xs text-gray-500 mt-1">Birden fazla video seçebilirsiniz (MP4, AVI, MOV - Max 50MB)</p>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeModal('mediaUploadModal')" class="px-4 py-2 text-white bg-gray-600 rounded-md hover:bg-gray-700 transition duration-150">İptal</button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-150 font-semibold">Yükle</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bildirim Detay Modalı -->
    <div id="notificationDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 border border-gray-200 dark:border-gray-700">
            <!-- Üst Kısım -->
            <div id="notificationDetailHeader" class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="notificationDetailIcon" class="w-10 h-10 rounded-lg flex items-center justify-center">
                            <!-- Icon buraya dinamik eklenecek -->
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Bildirim Detayı</h3>
                            <p id="notificationDetailBadge" class="text-xs mt-1 inline-flex items-center px-2 py-0.5 rounded font-medium">
                                <!-- Badge buraya dinamik eklenecek -->
                            </p>
                        </div>
                    </div>
                    <button onclick="closeNotificationModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- İçerik -->
            <div id="notificationDetailContent" class="px-6 py-6">
                <!-- İçerik buraya dinamik olarak yüklenecek -->
            </div>
            
            <!-- Alt Kısım -->
            <div id="notificationDetailFooter" class="px-6 py-4 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <span id="notificationDetailDate" class="text-sm text-gray-500 dark:text-gray-400">
                    <!-- Tarih buraya eklenecek -->
                </span>
                <div class="flex gap-2">
                    <button onclick="closeNotificationModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Kapat
                    </button>
                    <button id="markAsReadBtn" onclick="markNotificationAsRead()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors hidden">
                        Okundu İşaretle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Bildirim Modalı -->
    <div id="newNotificationModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-6 rounded-md shadow-2xl w-full max-w-lg transform transition-transform duration-300 scale-95">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">Yeni Bildirim</h3>
                <button onclick="closeNewNotificationModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="newNotificationContent">
                <!-- İçerik buraya dinamik olarak yüklenecek -->
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button onclick="closeNewNotificationModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition duration-200">
                    Kapat
                </button>
                <button onclick="markNewNotificationAsRead()" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-200">
                    Okundu İşaretle
                </button>
            </div>
        </div>
    </div>

    <!-- Acil Bildirim Modalı -->
    <div id="urgentNotificationModal" class="fixed inset-0 bg-red-900 bg-opacity-80 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white p-8 rounded-md shadow-2xl w-full max-w-2xl transform transition-transform duration-300 scale-95 border-4 border-red-500">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-red-600">ACİL BİLDİRİM</h3>
                </div>
                <button onclick="closeUrgentNotificationModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="urgentNotificationContent" class="space-y-4">
                <!-- İçerik buraya dinamik olarak yüklenecek -->
            </div>
            
            <div class="flex justify-center pt-6 border-t border-red-200">
                <button onclick="markUrgentNotificationAsRead()" class="px-8 py-3 text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-200 font-semibold text-lg">
                    OKUNDU İŞARETLE
                </button>
            </div>
        </div>
    </div>

    <!-- İşbirliği Logosu Modal -->
    <div id="partnerLogoModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200" id="partnerModalTitle">İşbirliği Logosu Yönetimi</h3>
                <button onclick="closePartnerLogoModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Mevcut Logo Bilgileri -->
            <?php if (!empty($partner_logos)): ?>
                <?php $current_logo = $partner_logos[0]; ?>
                <div id="currentLogoInfo" class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl border border-gray-200 dark:border-gray-600">
                    <div class="flex items-center space-x-4 mb-3">
                        <img src="<?= htmlspecialchars($current_logo['logo_path']) ?>" alt="<?= htmlspecialchars($current_logo['partner_name']) ?>" class="w-16 h-16 rounded-md object-cover">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200"><?= htmlspecialchars($current_logo['partner_name']) ?></h4>
                            <?php if (!empty($current_logo['partner_website'])): ?>
                                <a href="<?= htmlspecialchars($current_logo['partner_website']) ?>" target="_blank" class="text-sm text-blue-600 dark:text-blue-400 hover:underline"><?= htmlspecialchars($current_logo['partner_website']) ?></a>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="showLogoUpdateForm()" class="px-3 py-2 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-sm">
                            Değiştir
                        </button>
                        <button type="button" onclick="deletePartnerLogo()" class="px-3 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors shadow-sm">
                            Sil
                        </button>
                    </div>
                </div>
            <?php endif; ?>
            
            <!-- Logo Formu -->
            <form id="logoForm" enctype="multipart/form-data" class="<?= empty($partner_logos) ? '' : 'hidden' ?>">
                <?= csrf_token_field() ?>
                <div class="mb-4">
                    <label for="partnerLogoFile" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Logo Dosyası Seç <span class="text-red-500">*</span></label>
                    <input type="file" id="partnerLogoFile" name="partner_logo" accept="image/*" required class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Desteklenen formatlar: JPG, PNG, GIF (Max: 2MB)</p>
                </div>
                
                <div class="mb-4">
                    <label for="partnerName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">İşbirliği Adı <span class="text-red-500">*</span></label>
                    <input type="text" id="partnerName" name="partner_name" placeholder="Örn: ABC Şirketi" required class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="partnerWebsite" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Website (Opsiyonel)</label>
                    <input type="url" id="partnerWebsite" name="partner_website" placeholder="https://example.com" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closePartnerLogoModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-200 border border-gray-200 dark:border-gray-600">
                        İptal
                    </button>
                    <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-200 shadow-sm">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Acil Bildirim Modalı -->
    <div id="urgentNotificationModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-[60] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full mx-4 transform transition-all duration-300 scale-95 opacity-0 border border-gray-200 dark:border-gray-700" id="urgentModalContent">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold" id="urgentNotificationTitle">Önemli Duyuru</h3>
                            <p class="text-blue-100 text-sm">Sistem Yöneticisinden</p>
                        </div>
                    </div>
                    <div class="bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm">
                        <span class="text-xs font-semibold">ÖNEMLİ</span>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 mb-4">
                    <p class="text-gray-700 dark:text-gray-200 leading-relaxed" id="urgentNotificationMessage">
                        Bu önemli duyuru mesajı burada görünecek.
                    </p>
                </div>
                
                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-4">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="urgentNotificationTime">Şimdi</span>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 rounded-b-2xl flex justify-end">
                <button onclick="acknowledgeUrgentNotification()" 
                        class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Anladım
                </button>
            </div>
        </div>
    </div>

</body>
<script<?= tpl_script_nonce_attr(); ?>>
    // --- ACİL BİLDİRİM SİSTEMİ ---
    
    // Sayfa yüklendiğinde acil bildirimleri kontrol et
    document.addEventListener('DOMContentLoaded', function() {
        checkUrgentNotifications();
    });
    
    // Acil bildirimleri kontrol et
    function checkUrgentNotifications() {
        // Storage hatası veya server hatası olabilir, try-catch ile yakala
        try {
            const fetchPromise = fetch('index.php?action=check_urgent_notifications', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            }).catch(err => {
                // Fetch hatası (network, storage, vb.) - sessizce geç
                return null;
            });
            
            if (!fetchPromise) return;
            
            fetchPromise
            .then(response => {
                // Response yoksa veya hata varsa sessizce geç
                if (!response || !response.ok) {
                    return null;
                }
                
                // Content-Type kontrolü
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return null;
                }
                
                return response.json().catch(() => null);
            })
            .then(data => {
                if (data && data.success && data.notification) {
                    showUrgentNotification(data.notification);
                }
            })
            .catch(error => {
                // Tüm hataları sessizce yakala (storage, network, vb.)
                // Hata loglamayı devre dışı bırak
            });
        } catch (error) {
            // Synchronous hataları da yakala (storage erişimi vb.)
            // Hata loglamayı devre dışı bırak
        }
    }
    
    // Acil bildirim modalını göster
    function showUrgentNotification(notification) {
        const modal = document.getElementById('urgentNotificationModal');
        const modalContent = document.getElementById('urgentModalContent');
        const title = document.getElementById('urgentNotificationTitle');
        const message = document.getElementById('urgentNotificationMessage');
        const time = document.getElementById('urgentNotificationTime');
        
        // İçeriği güncelle
        title.textContent = notification.title;
        message.textContent = notification.message;
        time.textContent = formatTime(notification.created_at);
        
        // Modalı göster
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Animasyon
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        
        // Sayfa arka planını kilitle
        document.body.style.overflow = 'hidden';
    }
    
    // Acil bildirimi onayla
    function acknowledgeUrgentNotification() {
        const modal = document.getElementById('urgentNotificationModal');
        const modalContent = document.getElementById('urgentModalContent');
        
        // Kapanış animasyonu
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            
            // Bildirimi okundu olarak işaretle
            fetch('index.php?action=acknowledge_urgent_notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=acknowledge_urgent_notification'
            });
        }, 300);
    }
    
    // Zaman formatla
    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) { // 1 dakikadan az
            return 'Az önce';
        } else if (diff < 3600000) { // 1 saatten az
            return Math.floor(diff / 60000) + ' dakika önce';
        } else if (diff < 86400000) { // 1 günden az
            return Math.floor(diff / 3600000) + ' saat önce';
        } else {
            return date.toLocaleDateString('tr-TR');
        }
    }
    
    // --- JAVASCRIPT MANTIĞI ---
    
    // Global Error Handler - Unhandled Promise Rejections
    window.addEventListener('unhandledrejection', function(event) {
        const errorMessage = event.reason?.message || event.reason?.toString() || '';
        const errorString = String(errorMessage).toLowerCase();
        
        // localStorage/sessionStorage hatalarını sessizce yakala
        if (errorString.includes('access to storage') || 
            errorString.includes('storage is not allowed') ||
            errorString.includes('localstorage') ||
            errorString.includes('sessionstorage') ||
            errorString.includes('quotaexceedederror')) {
            // Storage erişimi engellendi - bu normal bir durum, sessizce geç
            event.preventDefault();
            return;
        }
        
        // Diğer hatalar için console'da göster
        console.error('Unhandled Promise Rejection:', event.reason);
        // Sayfayı bozmamak için preventDefault kullan
        event.preventDefault();
    });
    
    // Global Error Handler - Genel Hatalar
    window.addEventListener('error', function(event) {
        const errorMessage = event.message || event.error?.message || '';
        const errorString = String(errorMessage).toLowerCase();
        
        // localStorage/sessionStorage hatalarını sessizce yakala
        if (errorString.includes('access to storage') || 
            errorString.includes('storage is not allowed') ||
            errorString.includes('localstorage') ||
            errorString.includes('sessionstorage')) {
            event.preventDefault();
            return;
        }
    });
    
    // Mobile Menü Toggle
    const sidebar = document.getElementById('sidebar');
    const toggleButton = document.getElementById('mobile-menu-toggle');
    
    if (toggleButton) {
        toggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });
    }

    // Üye Ekleme Formu - Öğrenci Numarası ve Telefon Kontrolü
    document.addEventListener('DOMContentLoaded', function() {
        const studentIdInput = document.getElementById('modal_member_student_id');
        const phoneInput = document.getElementById('modal_member_phone');
        const emailInput = document.getElementById('modal_member_email');
        const addMemberModal = document.getElementById('addMemberModal');
        
        // Öğrenci numarası değiştiğinde email'i otomatik oluştur
        if (studentIdInput) {
            studentIdInput.addEventListener('input', function() {
                const studentId = this.value.trim();
                if (studentId) {
                    // Sadece rakamları al
                    const cleanStudentId = studentId.replace(/\D/g, '');
                    this.value = cleanStudentId;
                    
                    // Email'i otomatik oluştur
                    if (cleanStudentId) {
                        emailInput.value = cleanStudentId + '@ogr.bandirma.edu.tr';
                    } else {
                        emailInput.value = '';
                    }
                } else {
                    emailInput.value = '';
                }
            });
        }
        
        // Telefon numarası kontrolü - 5'ten başlamalı, 0 yazılamaz, boşluk yok
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                let value = this.value.replace(/\s/g, ''); // Boşlukları kaldır
                value = value.replace(/\D/g, ''); // Sadece rakamları al
                
                // 0 ile başlıyorsa veya 5'ten farklı bir rakamla başlıyorsa, 5 ekle
                if (value.length > 0 && value[0] !== '5') {
                    if (value[0] === '0') {
                        value = '5' + value.substring(1);
                    } else {
                        value = '5' + value;
                    }
                }
                
                // Maksimum 10 karakter
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                
                this.value = value;
            });
            
            // Focus olduğunda eğer boşsa 5 ekle
            phoneInput.addEventListener('focus', function() {
                if (!this.value || this.value.length === 0) {
                    this.value = '5';
                }
            });
        }
        
        // Modal açıldığında formu temizle
        if (addMemberModal) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const isVisible = !addMemberModal.classList.contains('hidden');
                        if (isVisible) {
                            // Formu temizle
                            const form = document.getElementById('addMemberForm');
                            if (form) {
                                form.reset();
                                if (emailInput) emailInput.value = '';
                            }
                        }
                    }
                });
            });
            
            observer.observe(addMemberModal, {
                attributes: true,
                attributeFilter: ['class']
            });
        }
    });

    // Modal Kapatma Fonksiyonu (Hem Edit hem de Add Modalları için)
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        // Eğer addEventModal kapanıyorsa, formu temizle
        if (modalId === 'addEventModal') {
            const form = document.getElementById('addEventForm');
            if (form) {
                form.reset();
                clearEventFormData();
            }
        }
        
        // Eğer addMemberModal kapanıyorsa, formu temizle
        if (modalId === 'addMemberModal') {
            const form = document.getElementById('addMemberForm');
            if (form) {
                form.reset();
                const emailInput = document.getElementById('modal_member_email');
                if (emailInput) emailInput.value = '';
            }
        }

        const modalContent = modal.querySelector('.bg-white'); 
        
        // Kapanış animasyonu
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        // Kısa bir gecikme sonrası gizle
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
            
            // Eğer Edit Modal ise form alanlarını gizle
            if (modalId === 'editModal') {
                document.getElementById('eventFields').classList.add('hidden');
                document.getElementById('memberFields').classList.add('hidden');
                document.getElementById('boardFields').classList.add('hidden');
            }
        }, 300);
    }
 
    // Görsel ve Video Preview Fonksiyonları
    function previewImage(input, previewId) {
        const file = input.files[0];
        if (file) {
            // Dosya boyutu kontrolü (5MB)
            if (file.size > 5 * 1024 * 1024) {
                toastManager.show('Dosya Boyutu Hatası', 'Görsel dosyası 5MB\'dan büyük olamaz!', 'error', 4000);
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(previewId);
                const img = document.getElementById('previewImg');
                img.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }
    
    function previewVideo(input, previewId) {
        const file = input.files[0];
        if (file) {
            // Dosya boyutu kontrolü (50MB)
            if (file.size > 50 * 1024 * 1024) {
                toastManager.show('Dosya Boyutu Hatası', 'Video dosyası 50MB\'dan büyük olamaz!', 'error', 4000);
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(previewId);
                const video = document.getElementById('previewVideo');
                video.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }
    
    function removeImage() {
        document.getElementById('event_image').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
    }
    
    function removeVideo() {
        document.getElementById('event_video').value = '';
        document.getElementById('videoPreview').classList.add('hidden');
    }
    
    // Modalın dışına tıklanınca kapanmasını sağla
    document.querySelectorAll('[id$="Modal"]').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target.id === modal.id) {
                closeModal(modal.id);
            }
        });
    });


    // Yeni Kayıt Ekleme Modalını Açma Fonksiyonu
    function openAddModal(type) {
        const modalId = `add${type.charAt(0).toUpperCase() + type.slice(1)}Modal`;
        const modal = document.getElementById(modalId);
        
        if (!modal) return;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        const modalContent = modal.querySelector('.bg-white');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
    }

    // Düzenleme Modalını Açma Fonksiyonu
    function openEditModal(type, id, ...data) {
        console.log('openEditModal çağrıldı:', {type, id, data});
        
        const modal = document.getElementById('editModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalAction = document.getElementById('modalAction');
        const modalId = document.getElementById('modalId');
        const eventFields = document.getElementById('eventFields');
        const memberFields = document.getElementById('memberFields'); 
        const boardFields = document.getElementById('boardFields');
        
        // Debug için
        if (!modal) {
            console.error('editModal elementi bulunamadı');
            alert('Modal açılamadı. Lütfen sayfayı yenileyin.');
            return;
        }
        
        if (!modalTitle || !modalAction || !modalId) {
            console.error('Modal elementleri bulunamadı:', {modalTitle, modalAction, modalId});
            alert('Modal açılamadı. Lütfen sayfayı yenileyin.');
            return;
        }
        
        // Alanları gizle ve sıfırla
        if (eventFields) eventFields.classList.add('hidden');
        if (memberFields) memberFields.classList.add('hidden');
        if (boardFields) boardFields.classList.add('hidden');

        // Ortak alanları ayarla
        modalId.value = id;
        
        // Modal'ı göster
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Transform class'larını ekle/kaldır
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-800');
        if (modalContent) {
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }


        if (type === 'event') {
            if (!eventFields) {
                console.error('eventFields elementi bulunamadı');
                alert('Etkinlik düzenleme formu yüklenemedi. Lütfen sayfayı yenileyin.');
                closeModal('editModal');
                return;
            }
            
            modalTitle.textContent = 'Etkinlik Düzenle';
            modalAction.value = 'update_event';
            console.log('openEditModal - Event için modalAction set edildi:', modalAction.value);
            eventFields.classList.remove('hidden');
            
            // İlk sekme aktif olsun
            setTimeout(() => {
                if (typeof switchEditEventTab === 'function') {
                    switchEditEventTab('general');
                }
            }, 100);

            // Eski yöntem (geriye dönük uyumluluk)
            if (data.length >= 5) {
                document.getElementById('edit_title').value = data[0] || '';
                document.getElementById('edit_date').value = data[1] || '';
                document.getElementById('edit_time').value = data[2] || '';
                document.getElementById('edit_location').value = data[3] || '';
                document.getElementById('edit_description').value = data[4] || '';
            }
            
            // AJAX ile tam etkinlik verilerini çek
            console.log('AJAX isteği gönderiliyor:', `?view=event_detail&event_id=${id}&ajax=1`);
            fetch(`?view=event_detail&event_id=${id}&ajax=1`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            })
                .then(response => {
                    console.log('Response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.text().then(text => {
                        console.log('Response text (ilk 200 karakter):', text.substring(0, 200));
                        try {
                            const json = JSON.parse(text);
                            console.log('JSON parse başarılı:', json);
                            return json;
                        } catch (e) {
                            console.error('JSON parse hatası:', e, 'Text:', text);
                            throw new Error('Geçersiz JSON yanıtı: ' + e.message);
                        }
                    });
                })
                .then(event => {
                    if (event && event.id) {
                        // Genel Bilgiler
                        const editTitle = document.getElementById('edit_title');
                        const editCategory = document.getElementById('edit_category');
                        const editDescription = document.getElementById('edit_description');
                        const editTags = document.getElementById('edit_tags');
                        const editOrganizer = document.getElementById('edit_organizer');
                        
                        if (editTitle) editTitle.value = event.title || '';
                        if (editCategory) editCategory.value = event.category || 'Genel';
                        if (editDescription) editDescription.value = event.description || '';
                        if (editTags) {
                            try {
                                editTags.value = event.tags ? (typeof event.tags === 'string' ? JSON.parse(event.tags).join(', ') : event.tags.join(', ')) : '';
                            } catch (e) {
                                editTags.value = event.tags || '';
                            }
                        }
                        if (editOrganizer) editOrganizer.value = event.organizer || '';
                        
                        // Tarih & Saat
                        const editDate = document.getElementById('edit_date');
                        const editTime = document.getElementById('edit_time');
                        const editEndDate = document.getElementById('edit_end_date');
                        const editEndTime = document.getElementById('edit_end_time');
                        const editRegistrationDeadline = document.getElementById('edit_registration_deadline');
                        
                        if (editDate) editDate.value = event.date || '';
                        if (editTime) editTime.value = event.time || '';
                        if (editEndDate && event.end_datetime) {
                            try {
                                const endDate = new Date(event.end_datetime);
                                if (!isNaN(endDate.getTime())) {
                                    editEndDate.value = endDate.toISOString().split('T')[0];
                                }
                            } catch (e) {
                                console.error('End date parse hatası:', e);
                            }
                        }
                        if (editEndTime && event.end_datetime) {
                            try {
                                const endDate = new Date(event.end_datetime);
                                if (!isNaN(endDate.getTime())) {
                                    editEndTime.value = endDate.toTimeString().slice(0, 5);
                                }
                            } catch (e) {
                                console.error('End time parse hatası:', e);
                            }
                        }
                        if (editRegistrationDeadline && event.registration_deadline) {
                            try {
                                editRegistrationDeadline.value = event.registration_deadline.replace(' ', 'T').slice(0, 16);
                            } catch (e) {
                                editRegistrationDeadline.value = event.registration_deadline || '';
                            }
                        }
                        
                        // Konum & İletişim
                        const editLocation = document.getElementById('edit_location');
                        const editContactEmail = document.getElementById('edit_contact_email');
                        const editContactPhone = document.getElementById('edit_contact_phone');
                        const editExternalLink = document.getElementById('edit_external_link');
                        
                        if (editLocation) editLocation.value = event.location || '';
                        if (editContactEmail) editContactEmail.value = event.contact_email || '';
                        if (editContactPhone) editContactPhone.value = event.contact_phone || '';
                        if (editExternalLink) editExternalLink.value = event.external_link || '';
                        
                        // Ayarlar
                        const editStatus = document.getElementById('edit_status');
                        const editPriority = document.getElementById('edit_priority');
                        const editVisibility = document.getElementById('edit_visibility');
                        const editFeatured = document.getElementById('edit_featured');
                        const editRegistrationRequired = document.getElementById('edit_registration_required');
                        const editCapacity = document.getElementById('edit_capacity');
                        const editMaxAttendees = document.getElementById('edit_max_attendees');
                        const editMinAttendees = document.getElementById('edit_min_attendees');
                        const editCost = document.getElementById('edit_cost');
                        
                        if (editStatus) editStatus.value = event.status || 'planlanıyor';
                        if (editPriority) editPriority.value = event.priority || 'normal';
                        if (editVisibility) editVisibility.value = event.visibility || 'public';
                        if (editFeatured) editFeatured.checked = event.featured == 1 || event.featured === '1';
                        if (editRegistrationRequired) editRegistrationRequired.checked = event.registration_required == 1 || event.registration_required === '1';
                        if (editCapacity) editCapacity.value = event.capacity || '';
                        if (editMaxAttendees) editMaxAttendees.value = event.max_attendees || '';
                        if (editMinAttendees) editMinAttendees.value = event.min_attendees || '';
                        if (editCost) editCost.value = event.cost || '0';
                    } else {
                        console.error('Etkinlik verisi bulunamadı veya geçersiz:', event);
                    }
                })
                .catch(err => {
                    console.error('Etkinlik verileri yüklenemedi:', err);
                    alert('Etkinlik verileri yüklenirken bir hata oluştu: ' + err.message + '\nLütfen sayfayı yenileyin ve tekrar deneyin.');
                    // Modal'ı kapat
                    closeModal('editModal');
                });
            
            // Etkinlik için mevcut fotoğrafları ve videoları yükle
            if (typeof loadEventMedia === 'function') {
                loadEventMedia(id);
            }
        } else if (type === 'member') {
            modalTitle.textContent = 'Üye Bilgilerini Düzenle';
            modalAction.value = 'update_member';
            console.log('openEditModal - Member için modalAction set edildi:', modalAction.value);
            memberFields.classList.remove('hidden');

            // Data sırası: full_name, email, student_id, phone_number
            // Hem modalId hem de edit_member_id'yi set et
            const modalIdElement = document.getElementById('modalId');
            if (modalIdElement) {
                modalIdElement.value = id;
            }
            document.getElementById('edit_member_id').value = id;
            document.getElementById('edit_member_name').value = data[0] || '';
            document.getElementById('edit_member_email').value = data[1] || '';
            document.getElementById('edit_student_id').value = data[2] || '';
            document.getElementById('edit_phone_number').value = data[3] || '';
            
            console.log('openEditModal - Member verileri set edildi:', {
                id: id,
                modalId: modalIdElement ? modalIdElement.value : 'BULUNAMADI',
                member_id: document.getElementById('edit_member_id').value,
                full_name: data[0] || '',
                email: data[1] || '',
                student_id: data[2] || '',
                phone_number: data[3] || ''
            });

        } else if (type === 'board') {
            modalTitle.textContent = 'Yönetim Kurulu Üyesi Düzenle';
            modalAction.value = 'update_board_member';
            boardFields.classList.remove('hidden');
            
            // Data sırası: full_name, role, contact_email, phone
            document.getElementById('edit_board_name').value = data[0];
            document.getElementById('edit_board_role').value = data[1];
            document.getElementById('edit_board_email').value = data[2];
            document.getElementById('edit_board_phone').value = data[3] || '';
        }
    }

    // Arama ve Filtreleme Fonksiyonu
    function filterTable(tableId, inputId) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const table = document.getElementById(tableId);
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            let visible = false;
            // İlk 5 sütunu kontrol et (Adı, Öğrenci No, E-posta, Telefon, Kayıt Tarihi)
            for (let j = 0; j < 5; j++) { 
                const td = tr[i].getElementsByTagName("td")[j];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        visible = true;
                        break; 
                    }
                }
            }
            tr[i].style.display = visible ? "" : "none";
        }
    }

    // Üye kartlarını filtrele
    function filterMemberCards() {
        const input = document.getElementById('member_search');
        const filter = input.value.toLowerCase();
        const cards = document.querySelectorAll('.member-card');
        
        cards.forEach(card => {
            const name = card.getAttribute('data-name') || '';
            const email = card.getAttribute('data-email') || '';
            const studentId = card.getAttribute('data-student-id') || '';
            const phone = card.getAttribute('data-phone') || '';
            
            const searchText = (name + ' ' + email + ' ' + studentId + ' ' + phone).toLowerCase();
            
            if (searchText.includes(filter)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // İletişim Merkezi JS Mantığı
    
    // Tümünü Seç/Seçimi Kaldır işlevi
    const selectAllEmails = document.getElementById('select-all-emails');
    const selectAllPhones = document.getElementById('select-all-phones');
    const emailSelectionCounter = document.getElementById('selected-email-count');
    const emailTotalCounter = document.getElementById('email-total-count');
    const emailSelectionProgress = document.getElementById('email-selection-progress');
    const smsSelectionCounter = document.getElementById('selected-sms-count');
    const smsTotalCounter = document.getElementById('sms-total-count');
    const smsSelectionProgress = document.getElementById('sms-selection-progress');

    function updateSelectedEmailCount() {
        if (!emailSelectionCounter) {
            return;
        }
        const total = document.querySelectorAll('.target-email').length;
        const selected = document.querySelectorAll('.target-email:checked').length;
        emailSelectionCounter.textContent = selected;
        if (emailTotalCounter) {
            emailTotalCounter.textContent = total;
        }
        if (emailSelectionProgress) {
            const percent = total === 0 ? 0 : Math.round((selected / total) * 100);
            emailSelectionProgress.style.width = `${percent}%`;
        }
    }

    function updateSelectedSmsCount() {
        if (!smsSelectionCounter) {
            return;
        }
        const total = document.querySelectorAll('.target-phone').length;
        const selected = document.querySelectorAll('.target-phone:checked').length;
        smsSelectionCounter.textContent = selected;
        if (smsTotalCounter) {
            smsTotalCounter.textContent = total;
        }
        if (smsSelectionProgress) {
            const percent = total === 0 ? 0 : Math.round((selected / total) * 100);
            smsSelectionProgress.style.width = `${percent}%`;
        }
    }

    function refreshEmailSelectionStyles() {
        document.querySelectorAll('.target-email').forEach(checkbox => {
            const item = checkbox.closest('.email-contact-item');
            if (item) {
                item.classList.toggle('selected', checkbox.checked);
            }
        });
    }

    function refreshSmsSelectionStyles() {
        document.querySelectorAll('.target-phone').forEach(checkbox => {
            const item = checkbox.closest('.sms-contact-item');
            if (item) {
                item.classList.toggle('selected', checkbox.checked);
            }
        });
    }

    if (selectAllEmails) {
        selectAllEmails.addEventListener('change', (e) => {
            document.querySelectorAll('.target-email').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            refreshEmailSelectionStyles();
            updateSelectedEmailCount();
        });
    }

    if (selectAllPhones) {
        selectAllPhones.addEventListener('change', (e) => {
            document.querySelectorAll('.target-phone').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            refreshSmsSelectionStyles();
            updateSelectedSmsCount();
        });
    }

    // Bireysel checkbox'lardan herhangi biri değiştiğinde "Tümünü Seç" kutusunu güncelle
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('target-email')) {
            if (selectAllEmails) {
                const allChecked = document.querySelectorAll('.target-email').length === document.querySelectorAll('.target-email:checked').length;
                selectAllEmails.checked = allChecked;
            }
            refreshEmailSelectionStyles();
            updateSelectedEmailCount();
        }
        if (e.target.classList.contains('target-phone')) {
            if (selectAllPhones) {
            const allChecked = document.querySelectorAll('.target-phone').length === document.querySelectorAll('.target-phone:checked').length;
            selectAllPhones.checked = allChecked;
            }
            refreshSmsSelectionStyles();
            updateSelectedSmsCount();
        }
    });

    // Sayfa yüklendiğinde başlangıç stillerini ayarla
    document.addEventListener('DOMContentLoaded', function() {
        refreshEmailSelectionStyles();
        refreshSmsSelectionStyles();
        updateSelectedEmailCount();
        updateSelectedSmsCount();
    });

    /**
     * Form gönderilmeden önce seçilen alıcıları gizli alanlara ekler.
     * @param {string} formType 'email_form' veya 'sms_form'
     * @returns {boolean} Formun gönderilip gönderilmeyeceği
     */
    function collectRecipients(formType) {
        const containerId = formType === 'email_form' ? 'email_form_recipients' : 'sms_form_recipients';
        const checkboxSelector = formType === 'email_form' ? '.target-email' : '.target-phone';
        const inputName = formType === 'email_form' ? 'selected_emails[]' : 'selected_phones[]';
        const jsonInputName = formType === 'email_form' ? 'selected_emails_json' : 'selected_phones_json';
        const countInputName = formType === 'email_form' ? 'selected_email_count' : 'selected_phone_count';
        const maxSafeInputs = 900; // PHP default max_input_vars ≈1000
        
        const container = document.getElementById(containerId);
        if (!container) {
            return true;
        }
        
        const selectedCheckboxes = Array.from(document.querySelectorAll(checkboxSelector + ':checked'));
        const values = selectedCheckboxes
            .map(cb => (cb.value || '').trim())
            .filter(Boolean);
        const uniqueValues = Array.from(new Set(values));
        
        container.innerHTML = '';

        if (uniqueValues.length === 0) {
            toastManager.show('Alıcı Seçimi Gerekli', 'Lütfen en az bir alıcı seçin veya "Tüm Üyeleri Seç" kutusunu işaretleyin.', 'warning', 5000);
            return false; 
        }

        if (uniqueValues.length > maxSafeInputs) {
            const jsonInput = document.createElement('input');
            jsonInput.type = 'hidden';
            jsonInput.name = jsonInputName;
            jsonInput.value = JSON.stringify(uniqueValues);
            container.appendChild(jsonInput);
        } else {
            uniqueValues.forEach(value => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = inputName;
                input.value = value;
            container.appendChild(input);
        });
        }

        const countInput = document.createElement('input');
        countInput.type = 'hidden';
        countInput.name = countInputName;
        countInput.value = uniqueValues.length;
        container.appendChild(countInput);

        return true; 
    }

    // Email form AJAX gönderimi
    let emailCampaignInterval = null;
    let currentCampaignId = null;

    function checkCampaignStatus(campaignId) {
        if (!campaignId) return;
        
        // Worker'ı tetikle (arka planda mailleri işle) - her seferinde
        fetch(`index.php?action=process_email_queue`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).catch(err => {
            // Sessizce devam et, worker çalışmıyorsa sorun değil
        });
        
        // Sonra durumu kontrol et
        fetch(`index.php?action=get_campaign_status&campaign_id=${campaignId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json().catch(err => {
                    console.error('JSON parse hatası:', err);
                    return { success: false, error: 'Geçersiz yanıt' };
                });
            })
            .then(data => {
                if (data.success && data.campaign) {
                    const campaign = data.campaign;
                    const statusDiv = document.getElementById('email_sending_status');
                    const progressDiv = document.getElementById('email_progress');
                    
                    if (statusDiv && progressDiv) {
                        const progress = campaign.progress || 0;
                        const statusText = campaign.status === 'completed' 
                            ? `✅ Tamamlandı! ${campaign.sent}/${campaign.total} e-posta gönderildi. ${campaign.failed > 0 ? `${campaign.failed} başarısız.` : ''}`
                            : campaign.status === 'processing'
                            ? `📧 Gönderiliyor... ${campaign.sent}/${campaign.total} (${progress}%)`
                            : `⏳ Beklemede... ${campaign.sent}/${campaign.total}`;
                        
                        progressDiv.innerHTML = `
                            <div class="mb-2">${statusText}</div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                        `;
                        
                        if (campaign.status === 'completed' || campaign.status === 'failed') {
                            if (emailCampaignInterval) {
                                clearInterval(emailCampaignInterval);
                                emailCampaignInterval = null;
                            }
                            const submitButton = document.querySelector('#email_form button[type="submit"]');
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = 'E-posta Gönder';
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Campaign status check error:', error);
            });
    }

    function handleEmailFormSubmit(e) {
        e.preventDefault();
        
        // Alıcıları topla
        if (!collectRecipients('email_form')) {
            return false;
        }
        
        const form = document.getElementById('email_form');
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById('email_sending_status');
        const progressDiv = document.getElementById('email_progress');
        
        // Loading durumunu göster
        submitButton.disabled = true;
        submitButton.textContent = 'Kuyruğa ekleniyor...';
        statusDiv.style.display = 'block';
        progressDiv.innerHTML = '<div class="mb-2">📧 E-posta kampanyası oluşturuluyor...</div>';
        
        // Önceki interval'i temizle
        if (emailCampaignInterval) {
            clearInterval(emailCampaignInterval);
            emailCampaignInterval = null;
        }
        
        // AJAX isteği
        fetch('index.php', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json().catch(err => {
                console.error('JSON parse hatası:', err);
                return { success: false, error: 'Geçersiz yanıt' };
            });
        })
        .then(data => {
            if (data.success) {
                toastManager.show('Başarılı', data.message, 'success', 5000);
                
                // Campaign ID'yi al ve progress tracking başlat
                if (data.campaign_id) {
                    currentCampaignId = data.campaign_id;
                    
                    // İlk durum kontrolü
                    checkCampaignStatus(currentCampaignId);
                    
                    // Her 1 saniyede bir durum kontrolü yap ve worker'ı tetikle (daha hızlı)
                    emailCampaignInterval = setInterval(() => {
                        checkCampaignStatus(currentCampaignId);
                    }, 1000);
                } else {
                    // Eski sistem (campaign_id yoksa)
                    statusDiv.style.display = 'none';
                    submitButton.disabled = false;
                    submitButton.textContent = 'E-posta Gönder';
                    // Formu temizle
                    form.reset();
                    document.querySelectorAll('.target-email:checked').forEach(cb => cb.checked = false);
                    refreshEmailSelectionStyles();
                    updateSelectedEmailCount();
                }
            } else {
                statusDiv.style.display = 'none';
                submitButton.disabled = false;
                submitButton.textContent = 'E-posta Gönder';
                toastManager.show('Hata', data.message, 'error', 5000);
            }
        })
        .catch(error => {
            statusDiv.style.display = 'none';
            submitButton.disabled = false;
            submitButton.textContent = 'E-posta Gönder';
            toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 5000);
            console.error('Error:', error);
        });
        
        return false;
    }

    // Formların onsubmit olaylarını bağlamak için DOMContentLoaded kullanıyoruz
    document.addEventListener('DOMContentLoaded', () => {
        // Email form AJAX handler
        const emailForm = document.getElementById('email_form');
        if (emailForm) {
            emailForm.addEventListener('submit', handleEmailFormSubmit);
        }
        // SMS Formunu bağla - AJAX ile gönder (sayfa yenilenmeden)
        const smsForm = document.getElementById('sms_form');
        if (smsForm) {
            smsForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Sayfa yenilenmesini engelle
                
                // Alıcıları topla
                if (!collectRecipients('sms_form')) {
                    return false;
                }
                
                // SMS gönderiminden önce alıcı sayısını kaydet
                const selectedPhones = smsForm.querySelectorAll('input[name="selected_phones[]"]:checked');
                const recipientCount = selectedPhones.length;
                
                const formData = new FormData(smsForm);
                const submitButton = smsForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton ? submitButton.textContent : 'Mesaj Gönder';
                
                // Loading durumunu göster
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Gönderiliyor...';
                    submitButton.classList.add('opacity-70', 'pointer-events-none');
                }
                
                // AJAX isteği - SMS gönderimi tamamlanana kadar bekle
                fetch('index.php', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    // Response'u kontrol et - JSON değilse text olabilir
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // JSON değilse, sayfa yönlendirmesi olabilir - başarılı say
                        return response.text().then(text => {
                            // Eğer başarı mesajı varsa
                            if (text.includes('başarıyla') || text.includes('gönderildi')) {
                                return { success: true, message: 'SMS başarıyla gönderildi' };
                            }
                            return { success: false, message: 'Yanıt alınamadı' };
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        // Başarılı - Toast bildirimi göster
                        const message = data.message || 'SMS başarıyla gönderildi';
                        toastManager.show('Başarılı', message, 'success', 5000);
                        
                        // Kısa bir gecikme sonrası sayfayı yenile (toast görünsün)
                        setTimeout(() => {
                            window.location.href = 'index.php?view=messages';
                        }, 500);
                    } else {
                        // Hata - Butonu tekrar aktif et
                        toastManager.show('Hata', data.message || 'SMS gönderilemedi', 'error', 5000);
                        
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.textContent = originalButtonText;
                            submitButton.classList.remove('opacity-70', 'pointer-events-none');
                        }
                    }
                })
                .catch(error => {
                    console.error('SMS send error:', error);
                    toastManager.show('Hata', 'SMS gönderilirken bir hata oluştu: ' + error.message, 'error', 5000);
                    
                    // Butonu tekrar aktif et
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                        submitButton.classList.remove('opacity-70', 'pointer-events-none');
                    }
                });
                
                return false;
            });
        }
        
        // SMS kullanım bilgisini dinamik güncelle
        function updateSmsUsage() {
            const smsUsageCard = document.getElementById('sms-usage-card');
            if (!smsUsageCard) return;
            
            fetch('index.php?action=get_sms_usage&view=messages', {
                method: 'GET',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json().catch(err => {
                    console.error('JSON parse hatası:', err);
                    return { success: false };
                });
            })
            .then(data => {
                if (data.success) {
                    const remaining = data.remaining || 0;
                    const current = data.current || 0;
                    const limit = data.limit || 0;
                    const percentage = limit > 0 ? Math.min(100, (current / limit) * 100) : 0;
                    
                    // Kalan SMS sayısını güncelle
                    const remainingEl = document.getElementById('sms-remaining-count');
                    if (remainingEl) {
                        remainingEl.textContent = limit > 0 ? new Intl.NumberFormat('tr-TR').format(remaining) : 'Sınırsız';
                    }
                    
                    // Kullanım bilgisini güncelle
                    const usageText = document.getElementById('sms-usage-text');
                    if (usageText) {
                        usageText.textContent = limit > 0 ? new Intl.NumberFormat('tr-TR').format(current) + ' / ' + new Intl.NumberFormat('tr-TR').format(limit) + ' kullanıldı' : 'Sınırsız';
                    }
                    
                    // Progress bar'ı güncelle
                    const progressEl = document.getElementById('sms-usage-progress');
                    if (progressEl) {
                        progressEl.style.width = percentage + '%';
                        // Renk güncelle
                        progressEl.className = 'h-2 rounded-full transition-all duration-300 ' + 
                            (percentage >= 90 ? 'bg-red-500' : (percentage >= 70 ? 'bg-orange-500' : 'bg-blue-500'));
                    }
                }
            })
            .catch(error => console.error('SMS usage update error:', error));
        }
        
        // Sayfa yüklendiğinde ve SMS gönderiminden sonra güncelle
        if (document.getElementById('sms-usage-card')) {
            // İlk yüklemede güncelle
            updateSmsUsage();
            
            // Her 5 saniyede bir güncelle (SMS gönderiminden sonra)
            setInterval(updateSmsUsage, 5000);
            
            // Session storage'dan SMS gönderim bilgisini kontrol et (try-catch ile güvenli)
            try {
                const sentCount = sessionStorage.getItem('sms_sent_count');
                if (sentCount) {
                    // SMS gönderildi, hemen güncelle
                    setTimeout(updateSmsUsage, 1000);
                    sessionStorage.removeItem('sms_sent_count');
                }
            } catch (e) {
                // Storage erişimi yoksa sessizce devam et
                console.warn('Storage access not available:', e.message);
            }
        }
        
        // Tema sistemi başlatma
        initTheme();
        
        // Bildirim sistemi başlatma
        initNotifications();
        
        // Profil dropdown başlatma
        initProfileDropdown();

        refreshEmailSelectionStyles();
        updateSelectedEmailCount();
    });
    
    // Tema Sistemi - SADECE kullanıcı seçimini kullan, CİHAZ TEMASINI GÖRMEZDEN GEL
    function initTheme() {
        // Varsayılan light mode (cihaz dark mode olsa bile)
        let savedTheme = 'light';
        try {
            savedTheme = localStorage.getItem('theme') || 'light';
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
        
        // Tema uygula (cihaz temasından bağımsız)
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        
        updateThemeToggle(savedTheme);
        
        // Dark mode'u uygula
        applyDarkMode();
        
        // Sayfa yüklendikten sonra tekrar uygula
        setTimeout(() => {
            applyDarkMode();
        }, 100);
    }
    
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        
        let newTheme;
        if (currentTheme === 'dark') {
            newTheme = 'light';
        } else {
            newTheme = 'dark';
        }
        
        // Dark mode'a geçişte onay iste - Toast ile (bildirim silme toast'ı gibi)
        if (newTheme === 'dark') {
            // Onay toast'ı göster (duration 0 - otomatik kapanmıyor)
            const confirmToastId = toastManager.show('Dark Mode Beta', 'Dark mode\'a geçmek istediğinize emin misiniz? Bu özellik beta aşamasındadır.', 'warning', 0);
            
            // Onay butonları ekle
            const confirmToast = document.getElementById(confirmToastId);
            if (confirmToast) {
                // Mesaj kısmını bul
                const messageContainer = confirmToast.querySelector('.flex-1');
                
                if (messageContainer) {
                    // Buton container'ı oluştur
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-3 flex gap-2';
                    
                    // Evet butonu
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'flex-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors font-medium';
                    confirmBtn.textContent = 'Evet';
                    confirmBtn.onclick = () => {
                        toastManager.remove(confirmToastId);
                        
                        // localStorage'a kaydet (try-catch ile güvenli)
                        try {
                            localStorage.setItem('theme', 'dark');
                        } catch (e) {
                            // localStorage erişimi engellendi, devam et
                        }
                
                // Smooth geçiş için body'ye class ekle
                document.body.classList.add('theme-transition');
                
                document.documentElement.setAttribute('data-theme', 'dark');
                document.documentElement.classList.add('dark');
                try {
                    localStorage.setItem('theme', 'dark');
                } catch (e) {
                    console.warn('localStorage erişimi engellendi:', e);
                }
                updateThemeToggle('dark');
                
                // Dark mode'u uygula
                applyDarkMode();
                
                // Smooth geçiş sonrası class'ı kaldır
                setTimeout(() => {
                    document.body.classList.remove('theme-transition');
                }, 300);
                
                // Beta bildirimi göster
                        toastManager.show('Bilgi', 'Dark mode aktif. Bu özellik beta aşamasındadır.', 'info', 5000);
                    };
                    
                    // Hayır butonu
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'flex-1 px-3 py-1.5 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors font-medium';
                    cancelBtn.textContent = 'Hayır';
                    cancelBtn.onclick = () => toastManager.remove(confirmToastId);
                    
                    buttonContainer.appendChild(confirmBtn);
                    buttonContainer.appendChild(cancelBtn);
                    messageContainer.appendChild(buttonContainer);
                }
            }
            
            return;
        }
        
        // Light mode'a geçişte doğrudan geç
        // Smooth geçiş için body'ye class ekle
        document.body.classList.add('theme-transition');
        
        document.documentElement.setAttribute('data-theme', 'light');
        document.documentElement.classList.remove('dark');
        
        try {
            localStorage.setItem('theme', 'light');
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
        updateThemeToggle('light');
        
        // Dark mode'u uygula
        applyDarkMode();
        
        // Smooth geçiş sonrası class'ı kaldır
        setTimeout(() => {
            document.body.classList.remove('theme-transition');
        }, 300);
    }
    
    // Dark Mode Flash Önleme - Sayfa Yüklenmeden Önce
    (function() {
        let theme = 'light';
        try {
            theme = localStorage.getItem('theme') || 'light';
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
        if (theme === 'dark') {
            // Hemen uygula - sayfa yüklenmeden önce
            document.documentElement.setAttribute('data-theme', 'dark');
            document.documentElement.style.backgroundColor = '#0f172a';
            document.documentElement.style.color = '#f1f5f9';
            
            // Body'yi hemen dark mode'a çevir
            document.body.style.backgroundColor = '#0f172a';
            document.body.style.color = '#f1f5f9';
            
            // Tüm elementleri hemen dark mode'a çevir
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.classList.contains('bg-white')) {
                    el.style.backgroundColor = '#1e293b';
                }
                if (el.classList.contains('bg-gray-50')) {
                    el.style.backgroundColor = '#1e293b';
                }
                if (el.classList.contains('bg-gray-100')) {
                    el.style.backgroundColor = '#334155';
                }
                if (el.classList.contains('text-gray-900')) {
                    el.style.color = '#f1f5f9';
                }
                if (el.classList.contains('text-gray-700')) {
                    el.style.color = '#cbd5e1';
                }
                if (el.classList.contains('text-gray-600')) {
                    el.style.color = '#94a3b8';
                }
                if (el.classList.contains('text-gray-500 dark:text-gray-400')) {
                    el.style.color = '#64748b';
                }
                if (el.classList.contains('border-gray-200')) {
                    el.style.borderColor = '#334155';
                }
                if (el.classList.contains('border-gray-300')) {
                    el.style.borderColor = '#475569';
                }
            });
            
            // Theme toggle butonunu hemen güncelle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.style.backgroundColor = '#3b82f6';
                themeToggle.style.transition = 'none';
                const toggleBefore = themeToggle.querySelector('::before');
                if (toggleBefore) {
                    toggleBefore.style.transform = 'translateX(26px)';
                    toggleBefore.style.transition = 'none';
                }
            }
            
            // Header layout'unu düzelt
            const mainHeader = document.querySelector('.main-header');
            if (mainHeader) {
                mainHeader.style.position = 'sticky';
                mainHeader.style.top = '0';
                mainHeader.style.left = '0';
                mainHeader.style.right = '0';
                mainHeader.style.width = '100%';
                mainHeader.style.margin = '0';
                mainHeader.style.padding = '0';
                mainHeader.style.transform = 'none';
                mainHeader.style.transition = 'none';
            }
            
            // Main content layout'unu düzelt
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.style.marginLeft = '16rem';
                mainContent.style.width = 'calc(100% - 16rem)';
                mainContent.style.position = 'relative';
            }
            
            // Sidebar layout'unu düzelt
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.style.position = 'fixed';
                sidebar.style.top = '0';
                sidebar.style.left = '0';
                sidebar.style.width = '16rem';
                sidebar.style.height = '100vh';
                sidebar.style.zIndex = '30';
            }
            
            // Tablo hover efektlerini düzelt
            const tableRows = document.querySelectorAll('table tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#334155';
                    const cells = this.querySelectorAll('td, th');
                    cells.forEach(cell => {
                        cell.style.backgroundColor = '#334155';
                        cell.style.color = '#f1f5f9';
                    });
                });
                
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                    const cells = this.querySelectorAll('td, th');
                    cells.forEach(cell => {
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                    });
                });
            });
            
            // Etkinlik açıklama bölümünü düzelt
            const gradientElements = document.querySelectorAll('.bg-gradient-to-r');
            gradientElements.forEach(el => {
                if (el.classList.contains('from-gray-50') && el.classList.contains('to-gray-100')) {
                    el.style.background = 'linear-gradient(to right, #1e293b, #334155)';
                }
            });
            
            const textElements = document.querySelectorAll('.text-gray-700, .text-gray-800 dark:text-gray-200');
            textElements.forEach(el => {
                el.style.color = '#f1f5f9';
            });
            
            // Etkinlik detay header'ını düzelt
            const eventDetailHeader = document.querySelector('.bg-white');
            if (eventDetailHeader) {
                eventDetailHeader.style.backgroundColor = '#1f2937';
            }
            
            const grayTextElements = document.querySelectorAll('.text-gray-600');
            grayTextElements.forEach(el => {
                el.style.color = '#d1d5db';
            });
            
            const grayBgElements = document.querySelectorAll('.bg-gray-50');
            grayBgElements.forEach(el => {
                el.style.backgroundColor = '#374151';
            });
            
            const iconElements = document.querySelectorAll('.text-yellow-500, .text-green-500, .text-red-500');
            iconElements.forEach(el => {
                if (el.classList.contains('text-yellow-500')) {
                    el.style.color = '#fbbf24';
                } else if (el.classList.contains('text-green-500')) {
                    el.style.color = '#34d399';
                } else if (el.classList.contains('text-red-500')) {
                    el.style.color = '#f87171';
                }
            });
        }
    })();
    
    // Dark mode kontrolü ve uygulama
    function applyDarkMode() {
        let theme = 'light';
        try {
            theme = localStorage.getItem('theme') || 'light';
        } catch (e) {
            console.warn('localStorage erişimi engellendi:', e);
        }
        document.documentElement.setAttribute('data-theme', theme);

        // Flash önleme sınıfını kaldır
        document.body.classList.remove('dark-mode-flash-prevention');
        
        // Header'daki topluluk adını koruyalım
        const clubNameElement = document.querySelector('.main-header h1');
        if (clubNameElement) {
            if (theme === 'dark') {
                clubNameElement.style.color = '#f3f4f6';
                clubNameElement.style.setProperty('color', '#f3f4f6', 'important');
            } else {
                clubNameElement.style.color = '#111827';
                clubNameElement.style.setProperty('color', '#111827', 'important');
            }
        }
        
        // Header'ın pointer events'ini ayarla
        const mainHeader = document.querySelector('.main-header');
        if (mainHeader) {
            mainHeader.style.pointerEvents = 'auto';
        }
        
        // Tüm elementleri yeniden uygula
        if (theme === 'dark') {
            // HTML ve body'yi hemen dark mode'a çevir
            document.documentElement.style.backgroundColor = '#0f172a';
            document.documentElement.style.color = '#f1f5f9';
            document.body.style.backgroundColor = '#0f172a';
            document.body.style.color = '#f1f5f9';
            
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                // Header'daki butonları koru
                if (el.classList.contains('main-header') || el.closest('.main-header')) {
                    return;
                }
                
                if (el.classList.contains('bg-white')) {
                    el.style.backgroundColor = '#1e293b';
                }
                if (el.classList.contains('bg-gray-50')) {
                    el.style.backgroundColor = '#1e293b';
                }
                if (el.classList.contains('bg-gray-100')) {
                    el.style.backgroundColor = '#334155';
                }
                if (el.classList.contains('text-gray-900')) {
                    el.style.color = '#f1f5f9';
                }
                if (el.classList.contains('text-gray-700')) {
                    el.style.color = '#cbd5e1';
                }
                if (el.classList.contains('text-gray-600')) {
                    el.style.color = '#94a3b8';
                }
                if (el.classList.contains('text-gray-500 dark:text-gray-400')) {
                    el.style.color = '#64748b';
                }
                if (el.classList.contains('border-gray-200')) {
                    el.style.borderColor = '#334155';
                }
                if (el.classList.contains('border-gray-300')) {
                    el.style.borderColor = '#475569';
                }
            });
            
            // Theme toggle butonunu güncelle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.style.backgroundColor = '#3b82f6';
                themeToggle.style.transition = 'none';
                const toggleBefore = themeToggle.querySelector('::before');
                if (toggleBefore) {
                    toggleBefore.style.transform = 'translateX(26px)';
                    toggleBefore.style.transition = 'none';
                }
            }
            
            // Header layout'unu düzelt
            const mainHeader = document.querySelector('.main-header');
            if (mainHeader) {
                mainHeader.style.position = 'sticky';
                mainHeader.style.top = '0';
                mainHeader.style.left = '0';
                mainHeader.style.right = '0';
                mainHeader.style.width = '100%';
                mainHeader.style.margin = '0';
                mainHeader.style.padding = '0';
                mainHeader.style.transform = 'none';
                mainHeader.style.transition = 'none';
            }
            
            // Main content layout'unu düzelt
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.style.marginLeft = '16rem';
                mainContent.style.width = 'calc(100% - 16rem)';
                mainContent.style.position = 'relative';
            }
            
            // Sidebar layout'unu düzelt
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.style.position = 'fixed';
                sidebar.style.top = '0';
                sidebar.style.left = '0';
                sidebar.style.width = '16rem';
                sidebar.style.height = '100vh';
                sidebar.style.zIndex = '30';
            }
            
            // Tablo hover efektlerini düzelt
            const tableRows = document.querySelectorAll('table tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#334155';
                    const cells = this.querySelectorAll('td, th');
                    cells.forEach(cell => {
                        cell.style.backgroundColor = '#334155';
                        cell.style.color = '#f1f5f9';
                    });
                });
                
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                    const cells = this.querySelectorAll('td, th');
                    cells.forEach(cell => {
                        cell.style.backgroundColor = '';
                        cell.style.color = '';
                    });
                });
            });
        } else {
            // Light mode'a geçiş
            document.documentElement.style.backgroundColor = '';
            document.documentElement.style.color = '';
            document.body.style.backgroundColor = '';
            document.body.style.color = '';
            
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.backgroundColor = '';
                el.style.color = '';
                el.style.borderColor = '';
            });
            
            // Theme toggle butonunu light mode'a çevir
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.style.backgroundColor = '#e2e8f0';
                themeToggle.style.transition = 'none';
                const toggleBefore = themeToggle.querySelector('::before');
                if (toggleBefore) {
                    toggleBefore.style.transform = 'translateX(0px)';
                    toggleBefore.style.transition = 'none';
                }
            }
            
            // Layout'u light mode'a çevir
            const mainHeader = document.querySelector('.main-header');
            if (mainHeader) {
                mainHeader.style.position = '';
                mainHeader.style.top = '';
                mainHeader.style.left = '';
                mainHeader.style.right = '';
                mainHeader.style.width = '';
                mainHeader.style.margin = '';
                mainHeader.style.padding = '';
                mainHeader.style.transform = '';
                mainHeader.style.transition = '';
            }
            
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.style.marginLeft = '';
                mainContent.style.width = '';
                mainContent.style.position = '';
            }
            
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.style.position = '';
                sidebar.style.top = '';
                sidebar.style.left = '';
                sidebar.style.width = '';
                sidebar.style.height = '';
                sidebar.style.zIndex = '';
            }
        }
        
        // Tüm elementleri dark mode'a göre güncelle
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            
            // Tüm input, textarea, select elementlerini güncelle
            const formElements = document.querySelectorAll('input, textarea, select');
            formElements.forEach(element => {
                element.style.backgroundColor = 'var(--input-bg)';
                element.style.borderColor = 'var(--input-border)';
                element.style.color = 'var(--text-primary)';
            });
            
            // Tüm kartları güncelle
            const cards = document.querySelectorAll('.bg-white');
            cards.forEach(card => {
                card.style.backgroundColor = 'var(--card-bg)';
            });
            
            // Tüm text elementlerini güncelle
            const textElements = document.querySelectorAll('.text-gray-800 dark:text-gray-200, .text-gray-700, .text-gray-600, .text-gray-500 dark:text-gray-400');
            textElements.forEach(element => {
                if (element.classList.contains('text-gray-800 dark:text-gray-200') || element.classList.contains('text-gray-700')) {
                    element.style.color = 'var(--text-primary)';
                } else {
                    element.style.color = 'var(--text-secondary)';
                }
            });
            
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
    
    function updateThemeToggle(theme) {
        const toggle = document.getElementById('theme-toggle');
        if (!toggle) return;
        
        if (theme === 'dark') {
            toggle.classList.add('active');
            toggle.style.backgroundColor = '#3b82f6';
        } else {
            toggle.classList.remove('active');
            toggle.style.backgroundColor = '#e2e8f0';
        }
    }
    
    // Email Template Sistemi
    const emailTemplates = {
        welcome: {
            subject: 'Hoş Geldiniz - <?= htmlspecialchars($club_name) ?>',
            body: `<h2>Merhaba!</h2>
<p>Hoş geldiniz! <?= htmlspecialchars($club_name) ?> topluluğuna katıldığınız için teşekkür ederiz.</p>
<p>Topluluk etkinlikleri ve güncellemeler hakkında bilgi almak için bizi takip etmeye devam edin.</p>
<p>İyi günler,<br><?= htmlspecialchars($club_name) ?> Yönetimi</p>`
        },
        unifoura: {
            subject: 'UniFour\'a Hoş Geldin {{member_name}}!',
            body: `<h2>Merhaba {{member_name}},</h2>
<p>UniFour topluluğuna resmen katıldın! Artık etkinlikleri takip edebilir, kulüp haberlerini ilk sen öğrenebilirsin.</p>
<p>Başlamak için yapabileceklerin:</p>
<ul>
<li>Profil bilgilerini kontrol et ve güncel tut.</li>
<li>Etkinlik takviminden ilgini çeken etkinliklere katıl.</li>
<li>Soru veya önerilerin için bize istediğin zaman yaz.</li>
</ul>
<p>Kayıtlı e-posta adresin: <strong>{{member_email}}</strong></p>
<p>Aramıza hoş geldin!<br><?= htmlspecialchars($club_name) ?> &amp; UniFour Ekibi</p>`
        },
        event: {
            subject: 'Yeni Etkinlik Duyurusu - <?= htmlspecialchars($club_name) ?>',
            body: `<h2>Yeni Etkinlik!</h2>
<p>Merhaba,</p>
<p>Yaklaşan etkinliğimiz hakkında sizi bilgilendirmek istiyoruz.</p>
<p><strong>Etkinlik:</strong> [Etkinlik Adı]<br>
<strong>Tarih:</strong> [Tarih]<br>
<strong>Saat:</strong> [Saat]<br>
<strong>Yer:</strong> [Konum]</p>
<p>Katılımınızı bekliyoruz!</p>
<p>Saygılarımızla,<br><?= htmlspecialchars($club_name) ?> Yönetimi</p>`
        },
        newsletter: {
            subject: 'Aylık Bülten - <?= htmlspecialchars($club_name) ?>',
            body: `<h2>Aylık Bülten</h2>
<p>Merhaba,</p>
<p>Bu ay gerçekleştirdiğimiz etkinlikler ve gelecek planlarımız hakkında bilgi paylaşmak istiyoruz.</p>
<h3>Bu Ay Neler Yaptık?</h3>
<ul>
<li>[Etkinlik 1]</li>
<li>[Etkinlik 2]</li>
<li>[Etkinlik 3]</li>
</ul>
<h3>Gelecek Ay Planları</h3>
<p>[Gelecek etkinlikler ve planlar]</p>
<p>Görüşmek üzere,<br><?= htmlspecialchars($club_name) ?> Yönetimi</p>`
        },
        custom: {
            subject: '',
            body: ''
        }
    };
    
    function loadTemplate(templateName) {
        const template = emailTemplates[templateName];
        if (template) {
            document.getElementById('email_subject').value = template.subject;
            document.getElementById('email_body').value = template.body;
        }
    }
    
    function toggleEditor(type, evt) {
        const buttons = document.querySelectorAll('.editor-toggle-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        
        const trigger = evt?.currentTarget || evt?.target || event?.currentTarget || event?.target;
        if (trigger && trigger.classList) {
            trigger.classList.add('active');
        }
        
        const textarea = document.getElementById('email_body');
        if (!textarea) {
            return;
        }
        textarea.placeholder = type === 'html'
            ? 'HTML formatında e-posta içeriği yazın...'
            : 'Düz metin e-posta içeriği yazın...';
    }
    
    function previewEmail() {
        const subject = document.getElementById('email_subject').value;
        const body = document.getElementById('email_body').value;
        
        if (!subject || !body) {
            toastManager.show('Eksik Bilgi', 'Lütfen konu ve içerik alanlarını doldurun.', 'warning', 4000);
            return;
        }
        
        const previewWindow = window.open('', '_blank', 'width=800,height=600');
        // XSS koruması: subject ve body'yi escape et
        const escapeHtml = (text) => {
            if (text === null || text === undefined) return '';
            return String(text).replace(/[&<>"']/g, (ch) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            })[ch] || ch);
        };
        const escapedSubject = escapeHtml(subject);
        const escapedBody = escapeHtml(body).replace(/\n/g, '<br>');
        
        previewWindow.document.write(`
            <html>
            <head>
                <title>E-posta Önizleme</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                    .email-container { background: white; padding: 30px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                    .subject { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #333; }
                    .body { line-height: 1.6; color: #555; }
                </style>
            </head>
            <body>
                <div class="email-container">
                    <div class="subject">${escapedSubject}</div>
                    <div class="body">${escapedBody}</div>
                </div>
            </body>
            </html>
        `);
    }
    
    // Email arama fonksiyonu
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('email-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const contactItems = document.querySelectorAll('.email-contact-item');
                
                contactItems.forEach(item => {
                    const name = item.querySelector('span').textContent.toLowerCase();
                    const email = item.querySelector('.text-xs').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || email.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        // SMS arama fonksiyonu
        const smsSearchInput = document.getElementById('sms-search');
        if (smsSearchInput) {
            smsSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const contactItems = document.querySelectorAll('.sms-contact-item');
                
                contactItems.forEach(item => {
                    const name = item.querySelector('span').textContent.toLowerCase();
                    const phone = item.querySelector('.text-xs').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || phone.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    });
    
    // SMS Template Sistemi
    const smsTemplates = {
        unifoura: {
            message: 'UniFour\'a hoş geldin {{member_name}}! Profilini güncelle, etkinlikleri keşfet ve topluluğa katıl. Destek için her zaman buradayız. - {{club_name}}'
        },
        event: {
            message: 'Yeni etkinlik: [Etkinlik Adı] - [Tarih] [Saat] - [Konum]. Detaylar için kulüp web sitesini kontrol edin.'
        },
        reminder: {
            message: 'Hatırlatma: [Etkinlik Adı] etkinliği [Tarih] günü [Saat] saatinde [Konum] adresinde gerçekleşecek.'
        },
        urgent: {
            message: 'ACİL: [Mesaj] - Lütfen hemen kulüp web sitesini kontrol edin.'
        },
        custom: {
            message: ''
        }
    };
    
    function loadSmsTemplate(templateName) {
        const template = smsTemplates[templateName];
        if (template) {
            document.getElementById('sms_body').value = template.message;
            updateSmsCharCount();
        }
    }
    
    function updateSmsCharCount() {
        const textarea = document.getElementById('sms_body');
        const charCount = document.getElementById('sms-char-count');
        const length = textarea.value.length;
        
        charCount.textContent = `${length}/160`;
        
        if (length > 160) {
            charCount.classList.add('text-red-500');
            charCount.classList.remove('text-gray-700');
        } else if (length > 140) {
            charCount.classList.add('text-yellow-500');
            charCount.classList.remove('text-gray-700');
        } else {
            charCount.classList.remove('text-red-500', 'text-yellow-500');
            charCount.classList.add('text-gray-700');
        }
    }
    
    function previewSms() {
        const message = document.getElementById('sms_body').value;
        
        if (!message) {
            toastManager.show('Eksik Bilgi', 'Lütfen SMS içeriğini girin.', 'warning', 4000);
            return;
        }
        
        // XSS koruması: message'ı escape et
        const escapeHtml = (text) => {
            if (text === null || text === undefined) return '';
            return String(text).replace(/[&<>"']/g, (ch) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            })[ch] || ch);
        };
        const escapedMessage = escapeHtml(message).replace(/\n/g, '<br>');
        
        const previewWindow = window.open('', '_blank', 'width=400,height=300');
        previewWindow.document.write(`
            <html>
            <head>
                <title>SMS Önizleme</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        padding: 20px; 
                        background: #f5f5f5; 
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100vh;
                        margin: 0;
                    }
                    .sms-preview { 
                        background: white; 
                        padding: 20px; 
                        border-radius: 4px; 
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        word-wrap: break-word;
                        max-width: 300px;
                        border-left: 4px solid #10b981;
                    }
                    .sms-header {
                        font-size: 12px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    .sms-content {
                        line-height: 1.4;
                        color: #333;
                    }
                    .sms-footer {
                        font-size: 10px;
                        color: #999;
                        margin-top: 10px;
                        text-align: right;
                    }
                </style>
            </head>
            <body>
                <div class="sms-preview">
                    <div class="sms-header">SMS Önizleme</div>
                    <div class="sms-content">${escapedMessage}</div>
                    <div class="sms-footer">${message.length}/160 karakter</div>
                </div>
            </body>
            </html>
        `);
    }
    
    // Bildirim Sistemi
    function initNotifications() {
        const notificationBtn = document.getElementById('notification-btn');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationBadge = document.getElementById('notification-badge');
        
        if (notificationBtn && notificationDropdown) {
            // Bildirim butonuna tıklama
            notificationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Tıklama animasyonu - shake efekti
                const svg = notificationBtn.querySelector('svg');
                if (svg) {
                    svg.classList.add('notification-shake');
                    setTimeout(() => {
                        svg.classList.remove('notification-shake');
                    }, 500);
                }
                
                // Önce profil dropdown'ını kapat
                const profileDropdown = document.getElementById('profile-dropdown');
                if (profileDropdown) {
                    profileDropdown.classList.add('hidden');
                    profileDropdown.style.display = 'none';
                }
                
                // Bildirim dropdown'ını aç/kapat
                const isHidden = notificationDropdown.classList.contains('hidden') || notificationDropdown.style.display === 'none';
                if (isHidden) {
                    // Pozisyonu hesapla ve ayarla
                    const rect = notificationBtn.getBoundingClientRect();
                    notificationDropdown.style.top = (rect.bottom + 8) + 'px';
                    notificationDropdown.style.right = (window.innerWidth - rect.right) + 'px';
                    notificationDropdown.classList.remove('hidden');
                    notificationDropdown.style.display = 'block';
                } else {
                    notificationDropdown.classList.add('hidden');
                    notificationDropdown.style.display = 'none';
                }
            });
            
            // Dışarı tıklayınca kapat
            document.addEventListener('click', function(e) {
                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                    notificationDropdown.style.display = 'none';
                }
            });
            
            // Bildirim sayısını güncelle
            updateNotificationCount();
            
            // Gerçek zamanlı bildirim simülasyonu
            simulateNotifications();
        }
    }
    
    function initProfileDropdown() {
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        
        if (profileBtn && profileDropdown) {
            // Profil butonuna tıklama
            profileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                // Önce bildirim dropdown'ını kapat
                const notificationDropdown = document.getElementById('notification-dropdown');
                if (notificationDropdown) {
                    notificationDropdown.classList.add('hidden');
                    notificationDropdown.style.display = 'none';
                }
                
                // Profil dropdown'ını aç/kapat
                const isHidden = profileDropdown.classList.contains('hidden') || profileDropdown.style.display === 'none';
                if (isHidden) {
                    // Pozisyonu hesapla ve ayarla
                    const rect = profileBtn.getBoundingClientRect();
                    profileDropdown.style.top = (rect.bottom + 12) + 'px';
                    profileDropdown.style.right = (window.innerWidth - rect.right) + 'px';
                    profileDropdown.classList.remove('hidden');
                    profileDropdown.style.display = 'block';
                } else {
                    profileDropdown.classList.add('hidden');
                    profileDropdown.style.display = 'none';
                }
            });
            
            // Dışarı tıklayınca kapat
            document.addEventListener('click', function(e) {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                    profileDropdown.style.display = 'none';
                }
            });
        }
    }
    
    function updateNotificationCount() {
        const badge = document.getElementById('notification-badge');
        const count = <?= $unread_notification_count ?>;
        
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    function simulateNotifications() {
        // Her 10 saniyede bir gerçek bildirimleri kontrol et
        setInterval(() => {
            checkForNewNotifications();
        }, 10000);
    }
    
    function checkForNewNotifications() {
        fetch('index.php?action=get_notification_count', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const badge = document.getElementById('notification-badge');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Bildirim kontrolü hatası:', error);
            });
    }
    
    // Yeni bildirim modalı kaldırıldı - artık sadece badge güncelleniyor
    
    // Acil bildirim modalını göster
    function showUrgentNotification(notification) {
        const modal = document.getElementById('urgentNotificationModal');
        const content = document.getElementById('urgentNotificationContent');
        
        // XSS koruması: notification verilerini escape et
        const escapeHtml = (text) => {
            if (text === null || text === undefined) return '';
            return String(text).replace(/[&<>"']/g, (ch) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            })[ch] || ch);
        };
        const escapedTitle = escapeHtml(notification.title);
        const escapedMessage = escapeHtml(notification.message).replace(/\n/g, '<br>');
        const escapedDate = escapeHtml(notification.date);
        
        // İçeriği doldur
        content.innerHTML = `
            <div class="space-y-6">
                <div class="bg-red-50 border border-red-200 rounded-md p-4">
                    <h4 class="text-xl font-bold text-red-800 mb-2">${escapedTitle}</h4>
                    <p class="text-red-700 leading-relaxed text-lg">${escapedMessage}</p>
                </div>
                
                <div class="text-sm text-gray-600">
                    <span class="font-medium">Tarih:</span> ${escapedDate}
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                    <p class="text-yellow-800 font-semibold">
                        Bu acil bildirim okundu olarak işaretlenene kadar sayfanın ortasında kalacaktır.
                    </p>
                </div>
            </div>
        `;
        
        // Modalı göster
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        const modalContent = modal.querySelector('.bg-white');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
        
        // Acil bildirim sesi çal
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ACİL BİLDİRİM: ' + notification.title, {
                body: notification.message,
                icon: 'assets/images/logo_tr.png',
                tag: 'urgent-notification'
            });
        }
        
        // Sayfa başlığını değiştir
        document.title = '🚨 ACİL BİLDİRİM - ' + notification.title;
        
        // Acil bildirim ID'sini sakla
        window.urgentNotificationId = notification.id;
    }
    
    // Acil bildirim modalını kapat
    function closeUrgentNotificationModal() {
        // Acil bildirim kapatılamaz, sadece okundu işaretlenebilir
        showToast('Uyarı', 'Acil bildirim kapatılamaz. Lütfen "OKUNDU İŞARETLE" butonuna tıklayın.', 'warning');
    }
    
    // Acil bildirimi okundu işaretle
    function markUrgentNotificationAsRead() {
        if (window.urgentNotificationId) {
            markAsRead(window.urgentNotificationId);
            
            // Modalı kapat
            const modal = document.getElementById('urgentNotificationModal');
            const modalContent = modal.querySelector('.bg-white');
            
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
            
            // Sayfa başlığını normale döndür
            document.title = 'UniPanel | Kulüp Yönetim Paneli';
            
            // Acil bildirim ID'sini temizle
            window.urgentNotificationId = null;
        }
    }
    
    function showNotification(title, message, type = 'info') {
        // Tarayıcı bildirimi
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(title, {
                body: message,
                icon: 'assets/images/logo_tr.png'
            });
        }
        
        // Toast bildirimi
        showToast(title, message, type);
    }
    
    // Modern Toast Sistemi
    class ToastManager {
        constructor() {
            this.toasts = [];
            this.container = null;
            this.init();
        }

        init() {
            // Toast container'ı oluştur
            this.container = document.createElement('div');
            this.container.id = 'toast-container';
            this.container.className = 'fixed top-4 right-4 z-[70] space-y-3 max-w-sm';
            document.body.appendChild(this.container);
        }

        show(title, message, type = 'info', duration = 5000) {
            const toastId = 'toast-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const toast = this.createToast(toastId, title, message, type, duration);
            
            this.container.appendChild(toast);
            this.toasts.push({ id: toastId, element: toast });

            // Slide-in animasyonu
            setTimeout(() => {
                toast.classList.add('toast-enter');
            }, 10);

            // Otomatik kaldırma createToast içinde yönetilecek (pause/resume destekli)

            return toastId;
        }

        createToast(id, title, message, type, duration) {
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `toast toast-${type} bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-4 transform translate-x-full opacity-0 transition-all duration-300 ease-out relative`;
            
            // Toast tipine göre renk ve ikon
            const typeConfig = {
                success: { 
                    color: 'text-green-600 dark:text-green-400', 
                    bg: 'bg-green-50 dark:bg-green-900/20',
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                },
                error: { 
                    color: 'text-red-600 dark:text-red-400', 
                    bg: 'bg-red-50 dark:bg-red-900/20',
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                },
                warning: { 
                    color: 'text-yellow-600 dark:text-yellow-400', 
                    bg: 'bg-yellow-50 dark:bg-yellow-900/20',
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>'
                },
                info: { 
                    color: 'text-blue-600 dark:text-blue-400', 
                    bg: 'bg-blue-50 dark:bg-blue-900/20',
                    icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'
                }
            };

            const config = typeConfig[type] || typeConfig.info;

            // XSS koruması: title ve message'ı escape et
            const escapeHtml = (text) => {
                if (text === null || text === undefined) return '';
                return String(text).replace(/[&<>"']/g, (ch) => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;',
                })[ch] || ch);
            };
            const escapedTitle = escapeHtml(title);
            const escapedMessage = escapeHtml(message);
            const escapedId = escapeHtml(id);

            toast.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 ${config.color}">
                        ${config.icon}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">${escapedTitle}</h4>
                        <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">${escapedMessage}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center space-x-2">
                        <button onclick="toastManager.handleManualClose('${escapedId}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="toast-progress-container">
                    <div class="toast-progress-fill" style="animation-duration: ${duration}ms;"></div>
                </div>
            `;

            // Progress bar CSS animasyonu ile otomatik olarak başlar

            // Auto-dismiss timer with hover pause/resume
            if (duration > 0) {
                const progressEl = toast.querySelector('.toast-progress-fill');
                let remaining = duration;
                let startTs = Date.now();
                let timerId = setTimeout(() => this.remove(id), remaining);

                // Store state on element for potential future use
                toast.__timer = { timerId, remaining, startTs };

                const pause = () => {
                    // Pause timer
                    clearTimeout(timerId);
                    const elapsed = Date.now() - startTs;
                    remaining = Math.max(0, remaining - elapsed);
                    // Pause CSS animation
                    if (progressEl) progressEl.style.animationPlayState = 'paused';
                };

                const resume = () => {
                    startTs = Date.now();
                    clearTimeout(timerId);
                    timerId = setTimeout(() => this.remove(id), remaining);
                    // Resume CSS animation
                    if (progressEl) progressEl.style.animationPlayState = 'running';
                };

                toast.addEventListener('mouseenter', pause);
                toast.addEventListener('mouseleave', resume);
                toast.__timer.pause = pause;
                toast.__timer.resume = resume;
            }

            return toast;
        }

        remove(toastId) {
            const toastIndex = this.toasts.findIndex(t => t.id === toastId);
            if (toastIndex === -1) return;

            const toast = this.toasts[toastIndex].element;
            
            // Slide-out animasyonu
            toast.classList.remove('toast-enter');
            toast.classList.add('toast-exit');

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
                this.toasts.splice(toastIndex, 1);
            }, 300);
        }

        handleManualClose(toastId) {
            const toastEntry = this.toasts.find(t => t.id === toastId);
            if (!toastEntry) {
                return;
            }

            const toast = toastEntry.element;
            const timerState = toast.__timer;
            if (timerState && timerState.timerId) {
                clearTimeout(timerState.timerId);
            }

            const progressEl = toast.querySelector('.toast-progress-fill');
            if (progressEl) {
                progressEl.style.animationPlayState = 'paused';
                progressEl.style.transition = 'width 200ms ease-out';
                // Force reflow before changing width to ensure transition plays
                void progressEl.offsetWidth;
                progressEl.style.width = '100%';
            }

            // Küçük bir gecikmeden sonra normal remove animasyonunu çalıştır
            setTimeout(() => this.remove(toastId), 220);
        }

        clear() {
            this.toasts.forEach(toast => {
                this.remove(toast.id);
            });
        }
    }

    // Toast manager instance
    const toastManager = new ToastManager();

    // Eski showToast fonksiyonunu yeni sisteme yönlendir
    function showToast(title, message, type) {
        return toastManager.show(title, message, type);
    }
    
    // Test fonksiyonu - Progress bar'ı test etmek için
    function testToastProgress() {
        console.log('Toast Progress Bar Test Başlatılıyor...');
        
        // Önce mevcut toast'ları temizle
        toastManager.clear();
        
        // Farklı sürelerle test toast'ları göster
        toastManager.show('Başarı', '3 saniye süreli toast - Progress bar yeşil olmalı', 'success', 3000);
        
        setTimeout(() => {
            toastManager.show('Hata', '5 saniye süreli toast - Progress bar kırmızı olmalı', 'error', 5000);
        }, 1000);
        
        setTimeout(() => {
            toastManager.show('Uyarı', '2 saniye süreli toast - Progress bar sarı olmalı', 'warning', 2000);
        }, 2000);
        
        setTimeout(() => {
            toastManager.show('Bilgi', '4 saniye süreli toast - Progress bar mavi olmalı', 'info', 4000);
        }, 3000);
        
        console.log('Test toast\'ları gönderildi! Progress bar\'ları toast\'ların altında kontrol edin!');
        console.log('Progress bar\'lar soldan sağa doğru akacak ve belirlenen sürede dolacak');
        console.log('Her toast tipi için farklı renkli gradient progress bar göreceksiniz');
    }
    
    // Test fonksiyonunu global olarak erişilebilir yap
    window.testToastProgress = testToastProgress;

    // Toast sistemi hazır - artık tüm feedback'ler modern toast olarak gösterilecek
    
    // Bildirim izni butonu durumunu güncelle
    function updateNotificationButton() {
        const btn = document.getElementById('notification-permission-btn');
        if (!btn) return;
        
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>';
                btn.title = 'Bildirim İzni Verildi';
            } else if (Notification.permission === 'denied') {
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>';
                btn.title = 'Bildirim İzni Reddedildi';
            } else {
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>';
                btn.title = 'Bildirim İzni İste';
            }
        }
    }
    
    // Manuel bildirim izni iste
    function requestNotificationPermission() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        showNotification('Bildirim izni verildi!', 'Artık yeni bildirimler alacaksınız.', 'success');
                        // Test bildirimi gönder
                        new Notification('Bildirim Sistemi Aktif', {
                            body: 'Artık yeni bildirimler alacaksınız!',
                            icon: 'assets/images/logo_tr.png'
                        });
                    } else {
                        showNotification('Bildirim izni reddedildi', 'Bildirimleri tarayıcı ayarlarından açabilirsiniz.', 'warning');
                    }
                    updateNotificationButton();
                });
            } else if (Notification.permission === 'denied') {
                showNotification('Bildirim izni reddedildi', 'Bildirimleri tarayıcı ayarlarından açabilirsiniz.', 'warning');
            } else {
                showNotification('Bildirim izni zaten verilmiş', 'Artık yeni bildirimler alacaksınız.', 'success');
            }
        }
    }
    
    // Sayfa yüklendiğinde buton durumunu güncelle
    document.addEventListener('DOMContentLoaded', function() {
        updateNotificationButton();
    });
    
    // Bildirim okundu işaretleme - Toast ile güncellenmiş
    function markAsRead(notificationId) {
        console.log('Marking notification as read:', notificationId);
        
        fetch('index.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `action=mark_as_read&notification_id=${notificationId}&csrf_token=<?= $_SESSION['csrf_token'] ?? '' ?>`
        })
        .then(response => response.json())
        .then(data => {
            console.log('Mark as read response:', data);
            if (data.success) {
                // Toast bildirimi göster
                toastManager.show('Başarılı', 'Bildirim okundu olarak işaretlendi', 'success', 3000);
                
                // Badge'i güncelle
                updateNotificationBadge();
                
                // Modalı kapat
                closeNotificationModal();
                
                // Bildirim listesini güncelle (sayfa yenileme yok)
                updateNotificationList();
            } else {
                toastManager.show('Hata', data.error || 'Bildirim işaretlenemedi', 'error', 4000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastManager.show('Hata', 'Bağlantı hatası', 'error', 4000);
        });
    }

    // Bildirim silme - Toast ile güncellenmiş
    function deleteNotification(notificationId) {
        // Onay toast'ı göster
        const confirmToastId = toastManager.show('Onay Gerekli', 'Bu bildirimi silmek istediğinizden emin misiniz?', 'warning', 0);
        
        // Onay butonları ekle
        const confirmToast = document.getElementById(confirmToastId);
        if (confirmToast) {
            const buttonContainer = confirmToast.querySelector('.flex-shrink-0');
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'ml-2 px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors';
            confirmBtn.textContent = 'Sil';
            confirmBtn.onclick = () => {
                toastManager.remove(confirmToastId);
                performDeleteNotification(notificationId);
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'ml-2 px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors';
            cancelBtn.textContent = 'İptal';
            cancelBtn.onclick = () => toastManager.remove(confirmToastId);
            
            buttonContainer.appendChild(confirmBtn);
            buttonContainer.appendChild(cancelBtn);
        }
    }

    // Gerçek silme işlemi
    function performDeleteNotification(notificationId) {
        console.log('Deleting notification:', notificationId);
        
        fetch('index.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `action=delete_notification&notification_id=${notificationId}`
        })
        .then(response => response.json())
        .then(data => {
            console.log('Delete notification response:', data);
            if (data.success) {
                toastManager.show('Başarılı', 'Bildirim silindi', 'success', 3000);
                
                // Badge'i güncelle
                updateNotificationBadge();
                
                // Modalı kapat
                closeNotificationModal();
                
                // Bildirim listesini güncelle (sayfa yenileme yok)
                updateNotificationList();
            } else {
                toastManager.show('Hata', data.error || 'Bildirim silinemedi', 'error', 4000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastManager.show('Hata', 'Bağlantı hatası', 'error', 4000);
        });
    }
    
    // Bildirim listesini dinamik olarak güncelle
    function updateNotificationList() {
        fetch('index.php?action=get_notifications', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Bildirim dropdown'ını güncelle
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) {
                        const notificationsContainer = dropdown.querySelector('.max-h-64');
                        if (notificationsContainer) {
                            if (data.notifications.length > 0) {
                                notificationsContainer.innerHTML = data.notifications.map(notification => `
                                    <div class="p-3 border-b border-gray-100 hover:bg-gray-50 ${notification.is_read == 0 ? 'bg-blue-50' : ''} cursor-pointer" onclick="showNotificationDetail(${notification.id}, '${notification.title.replace(/'/g, "\\'")}', '${notification.message.replace(/'/g, "\\'")}', '${notification.type}', '${new Date(notification.created_at).toLocaleDateString('tr-TR')} ${new Date(notification.created_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}', ${notification.is_read})">
                                        <div class="flex items-start space-x-3">
                                            <div class="w-2 h-2 ${notification.type === 'success' ? 'bg-green-500' : (notification.type === 'warning' ? 'bg-yellow-500' : (notification.type === 'error' ? 'bg-red-500' : (notification.type === 'urgent' ? 'bg-red-600' : 'bg-blue-500')))} rounded-full mt-2"></div>
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200">${notification.title}</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">${notification.message.substring(0, 50)}${notification.message.length > 50 ? '...' : ''}</p>
                                                <p class="text-xs text-gray-400">${new Date(notification.created_at).toLocaleDateString('tr-TR')} ${new Date(notification.created_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</p>
                                            </div>
                                            ${notification.is_read == 0 ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>' : ''}
                                        </div>
                                    </div>
                                `).join('');
                            } else {
                                notificationsContainer.innerHTML = `
                                    <div class="p-8 text-center">
                                        <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                                        </svg>
                                        <p class="text-gray-500 dark:text-gray-400">Henüz bildirim bulunmuyor</p>
                                    </div>
                                `;
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Bildirim listesi güncellenemedi:', error);
            });
    }
    
    // Bildirim badge'ini güncelle
    function updateNotificationBadge() {
        fetch('index.php?action=get_notification_count', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const badge = document.getElementById('notification-badge');
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Badge güncelleme hatası:', error);
            });
    }
    
    // Bildirim detayını göster
    function showNotificationDetail(id, title, message, type, date, isRead) {
        const modal = document.getElementById('notificationDetailModal');
        const content = document.getElementById('notificationDetailContent');
        const header = document.getElementById('notificationDetailHeader');
        const icon = document.getElementById('notificationDetailIcon');
        const badge = document.getElementById('notificationDetailBadge');
        const markBtn = document.getElementById('markAsReadBtn');
        const footerDate = document.getElementById('notificationDetailDate');
        
        // Tip renkleri ve ikonları
        const typeConfig = {
            'success': {
                iconBg: 'bg-green-100 dark:bg-green-900',
                iconColor: 'text-green-600 dark:text-green-400',
                iconSvg: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`,
                badgeText: 'Başarılı',
                badgeClass: 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300'
            },
            'warning': {
                iconBg: 'bg-yellow-100 dark:bg-yellow-900',
                iconColor: 'text-yellow-600 dark:text-yellow-400',
                iconSvg: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`,
                badgeText: 'Uyarı',
                badgeClass: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300'
            },
            'error': {
                iconBg: 'bg-red-100 dark:bg-red-900',
                iconColor: 'text-red-600 dark:text-red-400',
                iconSvg: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`,
                badgeText: 'Hata',
                badgeClass: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300'
            },
            'urgent': {
                iconBg: 'bg-red-200 dark:bg-red-900',
                iconColor: 'text-red-700 dark:text-red-400',
                iconSvg: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>`,
                badgeText: 'Acil',
                badgeClass: 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-300'
            },
            'info': {
                iconBg: 'bg-blue-100 dark:bg-blue-900',
                iconColor: 'text-blue-600 dark:text-blue-400',
                iconSvg: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`,
                badgeText: 'Bilgi',
                badgeClass: 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300'
            }
        };
        
        const config = typeConfig[type] || typeConfig['info'];
        
        // Icon ayarla
        icon.className = `${icon.className} ${config.iconBg} ${config.iconColor}`;
        icon.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">${config.iconSvg}</svg>`;
        
        // Badge ayarla
        badge.innerHTML = config.badgeText;
        badge.className = `${config.badgeClass} inline-flex items-center px-2 py-0.5 rounded text-xs font-medium`;
        
        // XSS koruması: title, message ve date'i escape et
        const escapeHtml = (text) => {
            if (text === null || text === undefined) return '';
            return String(text).replace(/[&<>"']/g, (ch) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            })[ch] || ch);
        };
        const escapedTitle = escapeHtml(title);
        const escapedMessage = escapeHtml(message).replace(/\n/g, '<br>');
        const escapedDate = escapeHtml(date);
        
        // İçeriği doldur
        content.innerHTML = `
            <div class="space-y-6">
                <div>
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">${escapedTitle}</h4>
                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">${escapedMessage}</p>
                </div>
            </div>
        `;
        
        // Footer tarih
        footerDate.textContent = escapedDate;
        
        // Okundu butonunu ayarla
        if (isRead == 0) {
            markBtn.classList.remove('hidden');
            markBtn.onclick = () => {
                markAsRead(id);
                closeNotificationModal();
            };
        } else {
            markBtn.classList.add('hidden');
        }
        
        // Modalı göster
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Animasyon
        setTimeout(() => {
            const modalContent = modal.querySelector('.rounded-xl');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
    }
    
    // Bildirim detay modalını kapat
    function closeNotificationModal() {
        const modal = document.getElementById('notificationDetailModal');
        const modalContent = modal.querySelector('.rounded-xl');
        
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }
    
    // Yeni bildirim modalını kapat
    function closeNewNotificationModal() {
        const modal = document.getElementById('newNotificationModal');
        const modalContent = modal.querySelector('.bg-white');
        
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }
    
    // Yeni bildirim modalını göster
    function showNewNotification(notification) {
        const modal = document.getElementById('newNotificationModal');
        const content = document.getElementById('newNotificationContent');
        
        // İçeriği doldur
        content.innerHTML = `
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 ${notification.type === 'success' ? 'bg-green-500' : (notification.type === 'warning' ? 'bg-yellow-500' : (notification.type === 'error' ? 'bg-red-500' : 'bg-blue-500'))} rounded-full"></div>
                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">${notification.type === 'success' ? 'Başarı' : (notification.type === 'warning' ? 'Uyarı' : (notification.type === 'error' ? 'Hata' : 'Bilgi'))}</span>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">${notification.title}</h4>
                    <p class="text-gray-600 leading-relaxed">${notification.message}</p>
                </div>
                
                <div class="text-sm text-gray-500 dark:text-gray-400">
                    <span class="font-medium">Tarih:</span> ${notification.date}
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                    <p class="text-sm text-blue-700"><strong>Yeni Bildirim</strong> - SuperAdmin'den geldi</p>
                </div>
            </div>
        `;
        
        // Modalı göster
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        const modalContent = modal.querySelector('.bg-white');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
        
        // Bildirim sesi çal (eğer izin verilmişse)
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(notification.title, {
                body: notification.message,
                icon: 'assets/images/logo_tr.png'
            });
        }
    }
    
    // Yeni bildirimi okundu işaretle
    function markNewNotificationAsRead() {
    // Bu fonksiyon yeni bildirim için özel olarak çalışacak
    closeNewNotificationModal();
    // Sayfa yenileme yok - bildirimler dinamik olarak güncellenir
    }
    
    // Bildirim okundu işaretleme (genel)
    function markNotificationAsRead() {
        const modal = document.getElementById('notificationDetailModal');
        const markBtn = document.getElementById('markAsReadBtn');
        
        if (markBtn.onclick) {
            markBtn.onclick();
        }
    }
    
    // İşbirliği Logosu Modal Fonksiyonları
    function openPartnerLogoModal() {
        const modal = document.getElementById('partnerLogoModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-800');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
    }
    
    function closePartnerLogoModal() {
        const modal = document.getElementById('partnerLogoModal');
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-800');
        
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 200);
    }
    
    // Topluluk Logosu Form Handler
    document.addEventListener('DOMContentLoaded', function() {
        const clubLogoForm = document.getElementById('clubLogoForm');
        if (clubLogoForm) {
            clubLogoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                formData.append('action', 'upload_club_logo');
                
                // CSRF token ekle
                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
                if (csrfToken) {
                    formData.append('csrf_token', csrfToken);
                }
                
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Yükleniyor...';
                submitBtn.disabled = true;
                
                fetch('', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (typeof toastManager !== 'undefined') {
                            toastManager.show('Başarılı', data.message, 'success', 3000);
                        } else {
                            alert(data.message);
                        }
                        // Sayfayı yenile
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        if (typeof toastManager !== 'undefined') {
                            toastManager.show('Hata', data.message, 'error', 4000);
                        } else {
                            alert('Hata: ' + data.message);
                        }
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (typeof toastManager !== 'undefined') {
                        toastManager.show('Hata', 'Logo yüklenirken bir hata oluştu', 'error', 4000);
                    } else {
                        alert('Logo yüklenirken bir hata oluştu');
                    }
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            });
        }
    });
    
    function showLogoUpdateForm() {
        const currentInfo = document.getElementById('currentLogoInfo');
        if (currentInfo) currentInfo.classList.add('hidden');
        const formEl = document.getElementById('logoForm');
        if (formEl) formEl.classList.remove('hidden');
        const titleEl = document.getElementById('partnerModalTitle');
        if (titleEl) titleEl.textContent = 'İşbirliği Logosu Güncelle';
    }
    
    function deletePartnerLogo() {
        if (confirm('Bu işbirliği logosunu silmek istediğinizden emin misiniz?')) {
            const formData = new FormData();
            formData.append('action', 'delete_partner_logo');
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]')?.value || '<?= generate_csrf_token() ?>');
            
            fetch('', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        toastManager.show('Başarılı', 'İşbirliği logosu başarıyla silindi!', 'success', 4000);
                        closePartnerLogoModal();
                        // Sayfa yenileme yok - dinamik güncelleme
                    } else {
                        toastManager.show('Hata', data.message, 'error', 5000);
                    }
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    toastManager.show('Sunucu Hatası', 'Sunucu yanıtı geçersiz: ' + text.substring(0, 200), 'error', 6000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 5000);
            });
        }
    }
    
    // İşbirliği logosu form submit
    document.getElementById('logoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('action', 'upload_partner_logo');
        // CSRF token ekle (form içinde yoksa)
        if (!formData.has('csrf_token')) {
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '<?= generate_csrf_token() ?>';
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }
        }
        
        // Loading göster
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Yükleniyor...';
        submitBtn.disabled = true;
        
        fetch('', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.text(); // Önce text olarak al
        })
        .then(text => {
            console.log('Raw response:', text); // Debug için
            try {
                const data = JSON.parse(text);
                if (data.success) {
                    toastManager.show('Başarılı', 'İşbirliği logosu başarıyla eklendi!', 'success', 4000);
                    closePartnerLogoModal();
                    // Sayfa yenileme yok - dinamik güncelleme
                } else {
                    toastManager.show('Hata', data.message, 'error', 5000);
                }
            } catch (parseError) {
                console.error('JSON Parse Error:', parseError);
                console.error('Response text:', text);
                toastManager.show('Sunucu Hatası', 'Sunucu yanıtı geçersiz: ' + text.substring(0, 200), 'error', 6000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 5000);
        })
        .finally(() => {
            // Loading'i kaldır
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Anket Modal Fonksiyonları
    function openSurveyModal(eventId) {
        const modal = document.getElementById('surveyModal');
        document.getElementById('surveyEventId').value = eventId;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function addSurveyQuestion() {
        const container = document.getElementById('questionsContainer');
        const questionCount = container.children.length;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'border p-4 rounded-md bg-gray-50';
        questionDiv.dataset.questionIndex = questionCount;
        questionDiv.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-gray-700">Soru ${questionCount + 1}</h5>
                <button type="button" onclick="this.closest('.border').remove()" class="text-red-600 hover:text-red-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Soru Metni</label>
                <input type="text" name="questions[${questionCount}]" required class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div id="options_${questionCount}" class="space-y-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Seçenekler</label>
                <div class="flex items-center gap-2">
                    <input type="text" name="options_${questionCount + 1}[0]" required class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Seçenek 1">
                    <button type="button" onclick="addOption(${questionCount})" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">+</button>
                </div>
            </div>
        `;
        container.appendChild(questionDiv);
    }
    
    let optionCounters = {};
    function addOption(questionNum) {
        const container = document.getElementById(`options_${questionNum}`);
        if (!optionCounters[questionNum]) {
            optionCounters[questionNum] = 0;
        }
        optionCounters[questionNum]++;
        const optionIndex = optionCounters[questionNum];
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center gap-2';
        optionDiv.innerHTML = `
            <input type="text" name="options_${questionNum + 1}[${optionIndex}]" required class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Yeni seçenek">
            <button type="button" onclick="this.closest('.flex').remove()" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">-</button>
        `;
        container.appendChild(optionDiv);
    }
    
    // Medya Yükleme Modal Fonksiyonları
    function openMediaUploadModal(eventId) {
        const modal = document.getElementById('mediaUploadModal');
        if (!modal) {
            console.error('mediaUploadModal bulunamadı');
            toastManager.show('Hata', 'Modal bulunamadı', 'error', 3000);
            return;
        }
        const eventIdInput = document.getElementById('mediaEventId');
        if (eventIdInput) {
            eventIdInput.value = eventId;
        }
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }
    
    // Etkinlik Medya Yükleme Fonksiyonu
    function loadEventMedia(eventId) {
        // AJAX ile mevcut fotoğraf ve videoları yükle
        fetch(`?action=get_event_media&event_id=${eventId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayExistingImages(data.images);
                    displayExistingVideos(data.videos);
                }
            })
            .catch(error => console.error('Error loading media:', error));
    }
    
    function resolveMediaPath(rawPath) {
        if (typeof rawPath !== 'string') {
            return null;
        }

        const trimmed = rawPath.trim();
        if (!trimmed || trimmed.includes('${')) {
            return null;
        }

        if (/^https?:\/\//i.test(trimmed) || trimmed.startsWith('/')) {
            return trimmed;
        }

        return trimmed;
    }
    
    function displayExistingImages(images) {
        const container = document.getElementById('existingImagesList');
        container.innerHTML = '';
        
        if (images && images.length > 0) {
            images.forEach(image => {
                const imagePath = resolveMediaPath(image.image_path);
                if (!imagePath) {
                    console.warn('Geçersiz image_path değeri atlandı:', image);
                    return;
                }
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'relative group';
                imageDiv.innerHTML = `
                    <img src="${imagePath}" alt="Fotoğraf" class="w-full h-24 object-cover rounded-md">
                    <button type="button" onclick="deleteEventImage(${image.id})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(imageDiv);
            });
            document.getElementById('existingImagesContainer').classList.remove('hidden');
        } else {
            document.getElementById('existingImagesContainer').classList.add('hidden');
        }
    }
    
    function displayExistingVideos(videos) {
        const container = document.getElementById('existingVideosList');
        container.innerHTML = '';
        
        if (videos && videos.length > 0) {
            videos.forEach(video => {
                const videoPath = resolveMediaPath(video.video_path);
                if (!videoPath) {
                    console.warn('Geçersiz video_path değeri atlandı:', video);
                    return;
                }
                
                const videoDiv = document.createElement('div');
                videoDiv.className = 'relative group border rounded-md p-2';
                videoDiv.innerHTML = `
                    <video src="${videoPath}" class="w-full h-32 object-cover rounded-md" controls></video>
                    <button type="button" onclick="deleteEventVideo(${video.id})" class="absolute top-3 right-3 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(videoDiv);
            });
            document.getElementById('existingVideosContainer').classList.remove('hidden');
        } else {
            document.getElementById('existingVideosContainer').classList.add('hidden');
        }
    }
    
    function deleteEventImage(imageId) {
        if (confirm('Bu fotoğrafı silmek istediğinizden emin misiniz?')) {
            fetch('', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=delete_event_image&image_id=${imageId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadEventMedia(document.getElementById('modalId').value);
                    toastManager.show('Başarılı', 'Fotoğraf silindi!', 'success', 3000);
                } else {
                    toastManager.show('Hata', data.message, 'error', 4000);
                }
            })
            .catch(error => {
                toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 4000);
            });
        }
    }
    
    function deleteEventVideo(videoId) {
        if (confirm('Bu videoyu silmek istediğinizden emin misiniz?')) {
            fetch('', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `action=delete_event_video&video_id=${videoId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadEventMedia(document.getElementById('modalId').value);
                    toastManager.show('Başarılı', 'Video silindi!', 'success', 3000);
                } else {
                    toastManager.show('Hata', data.message, 'error', 4000);
                }
            })
            .catch(error => {
                toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 4000);
            });
        }
    }
    
    // Anket Form Submit Handler
    const surveyFormEl = document.getElementById('surveyForm');
    if (surveyFormEl) {
        surveyFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Oluşturuluyor...';
            submitBtn.disabled = true;
            
            fetch('index.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse hatası:', text);
                        throw new Error('JSON parse hatası: ' + e.message);
                    }
                });
            })
            .then(data => {
                if (data && data.success) {
                    toastManager.show('Başarılı', data.message, 'success', 3000);
                    closeModal('surveyModal');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastManager.show('Hata', data && data.message ? data.message : 'Bilinmeyen bir hata oluştu', 'error', 4000);
                }
            })
            .catch(error => {
                console.error('Anket oluşturma hatası:', error);
                toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 4000);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Medya Yükleme Form Submit Handler
    const mediaUploadFormEl = document.getElementById('mediaUploadForm');
    if (mediaUploadFormEl) {
        mediaUploadFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Yükleniyor...';
            submitBtn.disabled = true;
            
            fetch('index.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse hatası:', text);
                        throw new Error('JSON parse hatası: ' + e.message);
                    }
                });
            })
            .then(data => {
                if (data && data.success) {
                    toastManager.show('Başarılı', data.message, 'success', 3000);
                    closeModal('mediaUploadModal');
                    this.reset();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastManager.show('Hata', data && data.message ? data.message : 'Bilinmeyen bir hata oluştu', 'error', 4000);
                }
            })
            .catch(error => {
                console.error('Medya yükleme hatası:', error);
                toastManager.show('Hata', 'Bir hata oluştu: ' + error.message, 'error', 4000);
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Test SMTP Function
    function testSMTP(evt) {
        return typeof testSmtpFromSettings === 'function' ? testSmtpFromSettings(evt) : null;
    }
    
    // Geriye dönük uyumluluk
    function sendTestMail(evt) {
        return sendTestEmail(evt);
    }
    
    // Test E-posta Gönderme Function (Settings sayfası için)
    function sendTestEmail(evtOrElement) {
        const getEmailCandidate = (selector) => {
            const el = document.getElementById(selector);
            return el && el.value ? el.value.trim() : '';
        };
        const getDatasetEmail = (el) => {
            if (!el || typeof el.getAttribute !== 'function') {
                return '';
            }
            const value = el.getAttribute('data-default-test-email');
            return value ? value.trim() : '';
        };
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const showToast = (title, message, type = 'info', duration = 5000) => {
            if (typeof toastManager !== 'undefined' && typeof toastManager.show === 'function') {
                toastManager.show(title, message, type, duration);
            } else {
                console.log(`${title}: ${message}`);
            }
        };
        
        const btn = evtOrElement?.currentTarget || evtOrElement?.target || evtOrElement || (typeof event !== 'undefined' ? event.target : null);
        let testEmail = getDatasetEmail(btn) || getEmailCandidate('smtp_from_email') || getEmailCandidate('smtp_username');
        
        if (!emailRegex.test(testEmail)) {
            const manual = window.prompt('Test e-postası hangi adrese gönderilsin?');
            if (!manual) {
                showToast('Bilgi', 'Geçerli bir alıcı adresi belirlenmedi.', 'warning', 4000);
                return;
            }
            testEmail = manual.trim();
        }
        
        if (!emailRegex.test(testEmail)) {
            showToast('Hata', 'Lütfen geçerli bir e-posta adresi girin.', 'error', 5000);
            return;
        }
        
        if (!window.confirm(`Test e-postası ${testEmail} adresine gönderilecek. Devam etmek istiyor musunuz?`)) {
            return;
        }
        
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
        let originalText = '';
        if (btn && typeof btn.disabled !== 'undefined') {
            originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Gönderiliyor...';
        }
        
        const body = new URLSearchParams({
            action: 'send_test_email',
            csrf_token: csrfToken,
            test_email: testEmail
        }).toString();
        
        fetch('index.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
        })
        .then(response => response.text())
        .then(data => {
            if (btn && typeof btn.disabled !== 'undefined') {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
            
            if (data.includes('BAŞARILI')) {
                showToast('Başarılı', `Test e-postası ${testEmail} adresine gönderildi.`, 'success', 7000);
            } else {
                let errorMsg = data || 'Test e-postası gönderilemedi.';
                if (errorMsg.length > 600) {
                    errorMsg = errorMsg.substring(0, 600) + '...\n\n(Ayrıntılar için tarayıcı konsolunu inceleyin)';
                }
                showToast('Hata', errorMsg, 'error', 10000);
                console.error('SMTP Test Hatası:', data);
            }
        })
        .catch(error => {
            if (btn && typeof btn.disabled !== 'undefined') {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
            showToast('Hata', 'Test e-postası gönderilirken bir hata oluştu: ' + error.message, 'error', 6000);
        });
    }
    
    // Manuel Kaydetme Function
    function saveSMTP() {
        const username = document.getElementById('smtp_username').value;
        const password = document.getElementById('smtp_password').value;
        
        if (!username || !password) {
            toastManager.show('Eksik Bilgi', 'SMTP kullanıcı adı ve şifresi gerekli!', 'warning', 6000);
            return;
        }
        
        fetch('index.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=save_smtp&smtp_username=' + encodeURIComponent(username) + '&smtp_password=' + encodeURIComponent(password)
        })
        .then(response => response.text())
        .then(data => {
            toastManager.show('Kaydetme Sonucu', data, data.includes('BAŞARILI') ? 'success' : 'error', 6000);
        })
        .catch(error => {
            toastManager.show('Kaydetme Hatası', error, 'error', 5000);
        });
    }
    
    // Backup oluşturma
    // Kategori seçim limiti (max 3)
    function limitCategorySelection(checkbox) {
        const checkboxes = document.querySelectorAll('input[name="club_categories[]"]');
        const checked = document.querySelectorAll('input[name="club_categories[]"]:checked');
        const maxSelection = 3;
        
        if (checked.length > maxSelection) {
            checkbox.checked = false;
            alert('En fazla 3 kategori seçebilirsiniz.');
        }
        
        // Seçilen kategori sayısını güncelle
        const selectedCount = document.querySelectorAll('input[name="club_categories[]"]:checked').length;
        const countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = selectedCount;
        }
    }
    
    // Sadece kategorileri kaydet - KESIN ÇALIŞACAK VERSİYON
    function saveCategoriesOnly() {
        console.log('saveCategoriesOnly çağrıldı');
        
        const checkboxes = document.querySelectorAll('input[name="club_categories[]"]:checked');
        const categories = Array.from(checkboxes).map(cb => cb.value);
        
        console.log('Seçilen kategoriler:', categories);
        
        if (categories.length > 3) {
            alert('En fazla 3 kategori seçebilirsiniz.');
            return;
        }
        
        // FormData oluştur
        const formData = new FormData();
        formData.append('action', 'update_categories_only');
        formData.append('club_categories_submitted', '1');
        categories.forEach(cat => {
            formData.append('club_categories[]', cat);
            console.log('Kategori eklendi:', cat);
        });
        
        // CSRF token ekle
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            formData.append('csrf_token', csrfToken.value);
            console.log('CSRF token eklendi');
        } else {
            console.error('CSRF token bulunamadı!');
        }
        
        // Loading göster
        const button = event.target.closest('button');
        if (!button) {
            console.error('Button bulunamadı!');
            alert('Buton bulunamadı!');
            return;
        }
        
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Kaydediliyor...';
        
        console.log('AJAX isteği gönderiliyor...');
        
        // AJAX ile gönder - X-Requested-With header ekle
        fetch('index.php', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return response.text();
            }
        })
        .then(data => {
            console.log('Response data:', data);
            
            let success = false;
            if (typeof data === 'object' && data.success) {
                success = true;
            } else if (typeof data === 'string') {
                success = data.includes('başarıyla') || data.includes('success') || data.includes('Kategoriler');
            }
            
            if (success) {
                // Başarılı
                button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Kaydedildi!';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                
                // Başarı mesajı göster
                if (typeof data === 'object' && data.message) {
                    alert(data.message);
                } else {
                    alert('Kategoriler başarıyla kaydedildi!');
                }
                
                // Sayfayı hemen yenile
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                // Hata
                const errorMsg = typeof data === 'object' ? (data.message || 'Bilinmeyen hata') : 'Kategoriler kaydedilirken bir hata oluştu.';
                console.error('Hata:', errorMsg);
                alert(errorMsg);
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('Bir hata oluştu: ' + error.message);
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
    
    function createBackup() {
        if (!confirm('Veritabanı yedeği oluşturulsun mu? Bu işlem birkaç saniye sürebilir.')) {
            return;
        }
        
        toastManager.show('Yedekleme Başladı', 'Veritabanı yedeği oluşturuluyor...', 'info', 3000);
        
        const params = new URLSearchParams({
            action: 'create_backup',
            csrf_token: '<?= generate_csrf_token() ?>',
            ajax: '1'
        });
        
        fetch('index.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: params.toString()
        })
        .then(async response => {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const json = await response.json();
                json.ok = response.ok;
                return json;
            }
            const text = await response.text();
            return { success: response.ok, message: text || 'Sunucudan beklenmeyen yanıt' };
        })
        .then(result => {
            if (result.success) {
                const msg = result.message ?? 'Yedekleme başarıyla tamamlandı.';
                toastManager.show('Yedekleme Tamamlandı', msg, 'success', 5000);
                setTimeout(() => location.reload(), 2000);
            } else {
                const errorMsg = result.message || 'Yedek oluşturulamadı.';
                toastManager.show('Yedekleme Hatası', errorMsg, 'error', 5000);
            }
        })
        .catch(error => {
            toastManager.show('Bağlantı Hatası', 'Yedek oluşturulamadı: ' + error, 'error', 5000);
        });
    }
    
    // Otomatik yedekleme ayarları toggle
    document.addEventListener('DOMContentLoaded', function() {
        const autoBackupCheckbox = document.getElementById('auto_backup_enabled');
        const autoBackupSettings = document.getElementById('auto_backup_settings');
        
        if (autoBackupCheckbox && autoBackupSettings) {
            autoBackupCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    autoBackupSettings.classList.remove('hidden');
                } else {
                    autoBackupSettings.classList.add('hidden');
                }
            });
        }
    });
    
    function testSmtpFromSettings() {
        const host = document.getElementById('smtp_host')?.value || 'mail.guzel.net.tr';
        const port = document.getElementById('smtp_port')?.value || '587';
        const secure = document.getElementById('smtp_secure')?.value || 'tls';
        const username = document.getElementById('smtp_username')?.value || '';
        const password = document.getElementById('smtp_password')?.value || '';
        const fromEmail = document.getElementById('smtp_from_email')?.value || username;
        const fromName = document.getElementById('smtp_from_name')?.value || 'Topluluk';

        if (!username || !password) {
            toastManager.show('Eksik Bilgi', 'SMTP kullanıcı adı ve şifre gerekli!', 'warning', 4000);
            return;
        }

        const body = new URLSearchParams({
            action: 'test_smtp',
            smtp_host: host,
            smtp_port: port,
            smtp_secure: secure,
            smtp_username: username,
            smtp_password: password,
            smtp_from_email: fromEmail,
            smtp_from_name: fromName,
            csrf_token: '<?= generate_csrf_token() ?>'
        }).toString();

        fetch('index.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
        })
        .then(r => r.text())
        .then(t => {
            const ok = t.includes('BAŞARILI');
            toastManager.show(ok ? 'Başarılı' : 'Hata', t, ok ? 'success' : 'error', ok ? 4000 : 7000);
        })
        .catch(err => {
            toastManager.show('Hata', String(err), 'error', 6000);
        });
    }
    
</script>

<!-- Mobil Navigasyon -->
<nav class="mobile-nav lg:hidden">
    <a href="?view=dashboard" class="mobile-nav-item <?= $current_view === 'dashboard' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
        </svg>
        <span>Pano</span>
    </a>
    
    <a href="?view=events" class="mobile-nav-item <?= $current_view === 'events' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
        </svg>
        <span>Etkinlik</span>
    </a>
    
    <a href="?view=members" class="mobile-nav-item <?= $current_view === 'members' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <span>Üyeler</span>
    </a>
    
    <a href="?view=mail" class="mobile-nav-item <?= $current_view === 'mail' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.84 5.23L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
        <span>Mail</span>
    </a>
    
    <a href="?view=campaigns" class="mobile-nav-item <?= $current_view === 'campaigns' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Kampanyalar</span>
    </a>
    
    <a href="?view=reports" class="mobile-nav-item <?= $current_view === 'reports' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <span>Raporlar</span>
    </a>
    
    <a href="?view=finance" class="mobile-nav-item <?= $current_view === 'finance' ? 'active' : '' ?>">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Finans</span>
    </a>
    
    <a href="?view=settings" class="mobile-nav-item <?= $current_view === 'settings' ? 'active' : '' ?>">
        <i class="fas fa-cog"></i>
        <span>Ayarlar</span>
    </a>
    <a href="?view=system_info" class="mobile-nav-item <?= $current_view === 'system_info' ? 'active' : '' ?>">
        <i class="fas fa-info-circle"></i>
        <span>Sistem Hakkında</span>
    </a>
</nav>

<script<?= tpl_script_nonce_attr(); ?>>
// Finans Yönetimi JavaScript Fonksiyonları
function switchFinanceTab(tabName) {
    // Tüm tab içeriklerini gizle
    document.querySelectorAll('.finance-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Tüm tab butonlarını pasif yap
    document.querySelectorAll('.finance-tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-indigo-500', 'text-indigo-500', 'dark:text-indigo-400');
        btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    
    // Seçili tab'ı göster
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    }
    
    // Seçili butonu aktif yap
    event.target.classList.add('active', 'border-indigo-500', 'text-indigo-500', 'dark:text-indigo-400');
    event.target.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    
    // Raporlar sekmesinde grafikleri çiz
    if (tabName === 'reports') {
        setTimeout(() => {
            drawFinancialCharts();
        }, 100);
    }
}

function openAddTransactionModal(type) {
    const modal = document.getElementById('addTransactionModal');
    if (!modal) return;
    
    // Formu temizle
    const form = document.getElementById('addTransactionForm');
    if (form) {
        form.reset();
        form.querySelector('input[name="type"]').value = type;
        form.querySelector('input[name="transaction_date"]').value = new Date().toISOString().split('T')[0];
    }
    
    // Başlık güncelle
    const title = modal.querySelector('h3');
    if (title) {
        title.textContent = type === 'income' ? 'Yeni Gelir Ekle' : 'Yeni Gider Ekle';
    }
    
    // Kategori seçeneklerini güncelle
    const categorySelect = form.querySelector('select[name="category_id"]');
    if (categorySelect) {
        const incomeCats = <?= json_encode(isset($income_categories) ? $income_categories : []) ?>;
        const expenseCats = <?= json_encode(isset($expense_categories) ? $expense_categories : []) ?>;
        const allCategories = [...incomeCats, ...expenseCats];
        categorySelect.innerHTML = '<option value="">Kategori Seçiniz</option>';
        allCategories.forEach(cat => {
            if (cat.type === type) {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            }
        });
    }
    
    modal.classList.remove('hidden');
}

function openEditTransactionModal(id) {
    fetch(`?view=finance&action=get_transaction&id=${id}&ajax=1`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = document.getElementById('editTransactionModal');
                const form = document.getElementById('editTransactionForm');
                if (!modal || !form) return;
                
                form.querySelector('input[name="id"]').value = data.transaction.id;
                form.querySelector('input[name="type"]').value = data.transaction.type;
                form.querySelector('input[name="amount"]').value = data.transaction.amount;
                form.querySelector('input[name="description"]').value = data.transaction.description || '';
                form.querySelector('input[name="transaction_date"]').value = data.transaction.transaction_date;
                form.querySelector('select[name="category_id"]').value = data.transaction.category_id || '';
                form.querySelector('input[name="payment_method"]').value = data.transaction.payment_method || '';
                form.querySelector('input[name="reference_number"]').value = data.transaction.reference_number || '';
                form.querySelector('textarea[name="notes"]').value = data.transaction.notes || '';
                
                const title = modal.querySelector('h3');
                if (title) {
                    title.textContent = data.transaction.type === 'income' ? 'Gelir Düzenle' : 'Gider Düzenle';
                }
                
                modal.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('İşlem yüklenirken bir hata oluştu.');
        });
}

function openAddBudgetModal() {
    const modal = document.getElementById('addBudgetModal');
    if (modal) {
        const form = document.getElementById('addBudgetForm');
        if (form) form.reset();
        modal.classList.remove('hidden');
    }
}

function openEditBudgetModal(id) {
    fetch(`?view=finance&action=get_budget&id=${id}&ajax=1`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = document.getElementById('editBudgetModal');
                const form = document.getElementById('editBudgetForm');
                if (!modal || !form) return;
                
                form.querySelector('input[name="id"]').value = data.budget.id;
                form.querySelector('input[name="name"]').value = data.budget.name;
                form.querySelector('input[name="type"]').value = data.budget.type;
                form.querySelector('input[name="budgeted_amount"]').value = data.budget.budgeted_amount;
                form.querySelector('input[name="period_start"]').value = data.budget.period_start;
                form.querySelector('input[name="period_end"]').value = data.budget.period_end;
                form.querySelector('select[name="category_id"]').value = data.budget.category_id || '';
                form.querySelector('textarea[name="description"]').value = data.budget.description || '';
                
                modal.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bütçe yüklenirken bir hata oluştu.');
        });
}

function openAddPaymentModal() {
    const modal = document.getElementById('addPaymentModal');
    if (modal) {
        const form = document.getElementById('addPaymentForm');
        if (form) {
            form.reset();
            form.querySelector('input[name="payment_date"]').value = new Date().toISOString().split('T')[0];
            // Tüm checkbox'ları temizle
            document.querySelectorAll('.member-checkbox').forEach(cb => cb.checked = false);
            updateSelectedMembersCount();
        }
        modal.classList.remove('hidden');
    }
}

function updateSelectedMembersCount() {
    const checkboxes = document.querySelectorAll('.member-checkbox:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selectedMembersCount');
    if (countElement) {
        countElement.textContent = count + ' üye seçildi';
    }
}

function selectAllMembers() {
    const checkboxes = document.querySelectorAll('.member-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateSelectedMembersCount();
}

function toggleAllPayments(checkbox) {
    const paymentCheckboxes = document.querySelectorAll('.payment-checkbox');
    paymentCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSendEmailButton();
}

function updateSendEmailButton() {
    const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
    const btn = document.getElementById('sendPaymentEmailsBtn');
    if (btn) {
        btn.disabled = checkboxes.length === 0;
    }
}

function sendPaymentConfirmationEmails() {
    const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Lütfen en az bir ödeme seçin!');
        return;
    }
    
    const paymentIds = Array.from(checkboxes).map(cb => cb.value);
    const emails = Array.from(checkboxes)
        .map(cb => cb.getAttribute('data-email'))
        .filter(email => email && email.trim() !== '');
    
    if (emails.length === 0) {
        alert('Seçilen ödemelerde e-posta adresi bulunamadı!');
        return;
    }
    
    if (!confirm(`${emails.length} üyeye ödeme onay e-postası gönderilecek. Devam etmek istiyor musunuz?`)) {
        return;
    }
    
    // Loading göster
    const btn = document.getElementById('sendPaymentEmailsBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '📧 Gönderiliyor...';
    
    // AJAX ile mail gönder
    const formData = new FormData();
    formData.append('action', 'send_payment_confirmation_emails');
    formData.append('payment_ids', JSON.stringify(paymentIds));
    formData.append('ajax', '1');
    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]')?.value || '');
    
    fetch('index.php?view=finance&ajax=1', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Mail gönderme sonucu:', data);
        if (data.success) {
            let message = '✅ ' + data.message;
            if (data.sent > 0) {
                message += '\n\nGönderilen: ' + data.sent;
            }
            if (data.failed > 0) {
                message += '\nBaşarısız: ' + data.failed;
            }
            if (data.no_email > 0) {
                message += '\nE-posta yok: ' + data.no_email;
            }
            alert(message);
            // Checkbox'ları temizle
            checkboxes.forEach(cb => cb.checked = false);
            updateSendEmailButton();
        } else {
            alert('❌ Hata: ' + (data.message || 'Mail gönderilemedi'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Bir hata oluştu: ' + error.message + '\n\nLütfen konsolu kontrol edin (F12)');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function openEditPaymentModal(id) {
    fetch(`?view=finance&action=get_payment&id=${id}&ajax=1`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = document.getElementById('editPaymentModal');
                const form = document.getElementById('editPaymentForm');
                if (!modal || !form) return;
                
                form.querySelector('input[name="id"]').value = data.payment.id;
                form.querySelector('select[name="event_id"]').value = data.payment.event_id || '';
                form.querySelector('select[name="member_id"]').value = data.payment.member_id || '';
                form.querySelector('input[name="member_name"]').value = data.payment.member_name || '';
                form.querySelector('input[name="member_email"]').value = data.payment.member_email || '';
                form.querySelector('input[name="amount"]').value = data.payment.amount;
                form.querySelector('select[name="payment_status"]').value = data.payment.payment_status;
                form.querySelector('input[name="payment_method"]').value = data.payment.payment_method || '';
                form.querySelector('input[name="payment_date"]').value = data.payment.payment_date || '';
                form.querySelector('input[name="transaction_id"]').value = data.payment.transaction_id || '';
                form.querySelector('textarea[name="notes"]').value = data.payment.notes || '';
                
                modal.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ödeme yüklenirken bir hata oluştu.');
        });
}

function openAddCategoryModal() {
    const modal = document.getElementById('addCategoryModal');
    if (modal) {
        const form = document.getElementById('addCategoryForm');
        if (form) form.reset();
        modal.classList.remove('hidden');
    }
}

function openEditCategoryModal(id) {
    fetch(`?view=finance&action=get_category&id=${id}&ajax=1`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = document.getElementById('editCategoryModal');
                const form = document.getElementById('editCategoryForm');
                if (!modal || !form) return;
                
                form.querySelector('input[name="id"]').value = data.category.id;
                form.querySelector('input[name="name"]').value = data.category.name;
                form.querySelector('select[name="type"]').value = data.category.type;
                form.querySelector('input[name="color"]').value = data.category.color;
                form.querySelector('textarea[name="description"]').value = data.category.description || '';
                
                modal.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Kategori yüklenirken bir hata oluştu.');
        });
}

function drawFinancialCharts() {
    // Chart.js ile finansal grafikleri çiz
    const incomeData = <?= json_encode(isset($financial_summary['income_by_category']) ? $financial_summary['income_by_category'] : []) ?>;
    const expenseData = <?= json_encode(isset($financial_summary['expense_by_category']) ? $financial_summary['expense_by_category'] : []) ?>;
    
    // Gelir grafiği
    const incomeCtx = document.getElementById('incomeChart');
    if (incomeCtx && incomeData.length > 0) {
        new Chart(incomeCtx, {
            type: 'doughnut',
            data: {
                labels: incomeData.map(item => item.name),
                datasets: [{
                    data: incomeData.map(item => item.total),
                    backgroundColor: incomeData.map(item => item.color)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    // Gider grafiği
    const expenseCtx = document.getElementById('expenseChart');
    if (expenseCtx && expenseData.length > 0) {
        new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: expenseData.map(item => item.name),
                datasets: [{
                    data: expenseData.map(item => item.total),
                    backgroundColor: expenseData.map(item => item.color)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
}
</script>

<!-- Import Members Modal -->
<div id="importMembersModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Üyeleri İçe Aktar</h3>
            <button onclick="document.getElementById('importMembersModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" enctype="multipart/form-data" action="index.php?view=members">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="import_members">
            <input type="hidden" name="current_view" value="members">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CSV Dosyası Seç</label>
                <input type="file" name="csv_file" accept=".csv" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <div class="mt-2 space-y-2">
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <strong>Format:</strong> Ad Soyad;E-posta;Öğrenci No;Telefon;Kayıt Tarihi;Bölüm;Sınıf;Doğum Tarihi;Adres;Notlar
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        <strong>Not:</strong> Noktalı virgül (;) ile ayrılmış CSV formatı. Ad Soyad ve E-posta zorunludur. Mevcut üyeler e-posta adresine göre güncellenir.
                    </p>
                    <a href="?action=download_sample_members_csv" class="inline-flex items-center gap-2 text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Örnek Dosya İndir
                    </a>
                </div>
            </div>
            <?php if (isset($_SESSION['import_errors']) && !empty($_SESSION['import_errors'])): ?>
                <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
                    <p class="text-sm font-medium text-red-800 dark:text-red-400 mb-2">Hatalar:</p>
                    <ul class="text-xs text-red-700 dark:text-red-300 list-disc list-inside max-h-32 overflow-y-auto">
                        <?php foreach ($_SESSION['import_errors'] as $error): ?>
                            <li><?= htmlspecialchars($error) ?></li>
                        <?php endforeach; ?>
                    </ul>
                </div>
                <?php unset($_SESSION['import_errors']); ?>
            <?php endif; ?>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('importMembersModal').classList.add('hidden')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">İçe Aktar</button>
            </div>
        </form>
    </div>
</div>

<!-- Import Events Modal -->
<div id="importEventsModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Etkinlikleri İçe Aktar</h3>
            <button onclick="document.getElementById('importEventsModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" enctype="multipart/form-data" action="index.php?view=events">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="import_events">
            <input type="hidden" name="current_view" value="events">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CSV Dosyası Seç</label>
                <input type="file" name="csv_file" accept=".csv" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <div class="mt-2 flex items-center justify-between">
                    <p class="text-xs text-gray-500 dark:text-gray-400">Format: Başlık;Tarih;Saat;Konum;Kategori;Durum;Açıklama (noktalı virgül ile ayrılmış)</p>
                    <a href="?action=download_sample_events_csv" class="text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Örnek Dosya İndir
                    </a>
                </div>
            </div>
            <?php if (isset($_SESSION['import_errors']) && !empty($_SESSION['import_errors'])): ?>
                <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
                    <p class="text-sm font-medium text-red-800 dark:text-red-400 mb-2">Hatalar:</p>
                    <ul class="text-xs text-red-700 dark:text-red-300 list-disc list-inside max-h-32 overflow-y-auto">
                        <?php foreach ($_SESSION['import_errors'] as $error): ?>
                            <li><?= htmlspecialchars($error) ?></li>
                        <?php endforeach; ?>
                    </ul>
                </div>
                <?php unset($_SESSION['import_errors']); ?>
            <?php endif; ?>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('importEventsModal').classList.add('hidden')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">İçe Aktar</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Transaction Modal -->
<div id="addTransactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Yeni Gelir/Gider Ekle</h3>
            <button onclick="closeModal('addTransactionModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="addTransactionForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="add_financial_transaction">
            <input type="hidden" name="current_view" value="finance">
            <input type="hidden" name="type" value="">
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutar <span class="text-red-500">*</span></label>
                        <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tarih <span class="text-red-500">*</span></label>
                        <input type="date" name="transaction_date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama <span class="text-red-500">*</span></label>
                    <input type="text" name="description" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="İşlem açıklaması">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori</label>
                        <select name="category_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Kategori Seçiniz</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Yöntemi</label>
                        <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Seçiniz</option>
                            <option value="Nakit">Nakit</option>
                            <option value="Banka Transferi">Banka Transferi</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Çek">Çek</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Referans No</label>
                    <input type="text" name="reference_number" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Fatura/İşlem numarası">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notlar</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Ek notlar..."></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('addTransactionModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div id="editTransactionModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">İşlem Düzenle</h3>
            <button onclick="closeModal('editTransactionModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="editTransactionForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="update_financial_transaction">
            <input type="hidden" name="current_view" value="finance">
            <input type="hidden" name="id" value="">
            <input type="hidden" name="type" value="">
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutar <span class="text-red-500">*</span></label>
                        <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tarih <span class="text-red-500">*</span></label>
                        <input type="date" name="transaction_date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama <span class="text-red-500">*</span></label>
                    <input type="text" name="description" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori</label>
                        <select name="category_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Kategori Seçiniz</option>
                            <?php 
                            $all_cats = array_merge(isset($income_categories) ? $income_categories : [], isset($expense_categories) ? $expense_categories : []);
                            foreach ($all_cats as $cat): ?>
                                <option value="<?= $cat['id'] ?>"><?= htmlspecialchars($cat['name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Yöntemi</label>
                        <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Seçiniz</option>
                            <option value="Nakit">Nakit</option>
                            <option value="Banka Transferi">Banka Transferi</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Çek">Çek</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Referans No</label>
                    <input type="text" name="reference_number" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notlar</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('editTransactionModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Güncelle</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Budget Modal -->
<div id="addBudgetModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Yeni Bütçe Planı Ekle</h3>
            <button onclick="closeModal('addBudgetModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="addBudgetForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="add_budget_plan">
            <input type="hidden" name="current_view" value="finance">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bütçe Adı <span class="text-red-500">*</span></label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Örn: 2024 Yıllık Bütçe">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tür <span class="text-red-500">*</span></label>
                        <select name="type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="income">Gelir</option>
                            <option value="expense">Gider</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bütçe Tutarı <span class="text-red-500">*</span></label>
                        <input type="number" name="budgeted_amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Başlangıç Tarihi <span class="text-red-500">*</span></label>
                        <input type="date" name="period_start" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bitiş Tarihi <span class="text-red-500">*</span></label>
                        <input type="date" name="period_end" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori</label>
                    <select name="category_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                        <option value="">Kategori Seçiniz</option>
                        <?php 
                        $all_cats = array_merge(isset($income_categories) ? $income_categories : [], isset($expense_categories) ? $expense_categories : []);
                        foreach ($all_cats as $cat): ?>
                            <option value="<?= $cat['id'] ?>"><?= htmlspecialchars($cat['name']) ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Bütçe planı hakkında notlar..."></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('addBudgetModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Budget Modal -->
<div id="editBudgetModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Bütçe Planı Düzenle</h3>
            <button onclick="closeModal('editBudgetModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="editBudgetForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="update_budget_plan">
            <input type="hidden" name="current_view" value="finance">
            <input type="hidden" name="id" value="">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bütçe Adı <span class="text-red-500">*</span></label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tür <span class="text-red-500">*</span></label>
                        <select name="type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="income">Gelir</option>
                            <option value="expense">Gider</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bütçe Tutarı <span class="text-red-500">*</span></label>
                        <input type="number" name="budgeted_amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Başlangıç Tarihi <span class="text-red-500">*</span></label>
                        <input type="date" name="period_start" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bitiş Tarihi <span class="text-red-500">*</span></label>
                        <input type="date" name="period_end" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori</label>
                    <select name="category_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                        <option value="">Kategori Seçiniz</option>
                        <?php 
                        $all_cats = array_merge(isset($income_categories) ? $income_categories : [], isset($expense_categories) ? $expense_categories : []);
                        foreach ($all_cats as $cat): ?>
                            <option value="<?= $cat['id'] ?>"><?= htmlspecialchars($cat['name']) ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('editBudgetModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Güncelle</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Yeni Ödeme Ekle</h3>
            <button onclick="closeModal('addPaymentModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="addPaymentForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="add_payments">
            <input type="hidden" name="current_view" value="finance">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Etkinlik</label>
                    <select name="event_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                        <option value="">Etkinlik Seçiniz</option>
                        <?php foreach (isset($events) ? $events : [] as $event): ?>
                            <option value="<?= $event['id'] ?>"><?= htmlspecialchars($event['title']) ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Üyeleri Seçin <span class="text-red-500">*</span></label>
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 p-3 max-h-64 overflow-y-auto">
                        <div class="mb-2 flex items-center justify-between">
                            <span class="text-xs text-gray-500 dark:text-gray-400" id="selectedMembersCount">0 üye seçildi</span>
                            <button type="button" onclick="selectAllMembers()" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Tümünü Seç</button>
                        </div>
                        <div class="space-y-2">
                            <?php foreach (isset($members) ? $members : [] as $member): ?>
                            <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-600/50 rounded cursor-pointer">
                                <input type="checkbox" name="selected_members[]" value="<?= $member['id'] ?>" 
                                       data-name="<?= htmlspecialchars($member['full_name']) ?>" 
                                       data-email="<?= htmlspecialchars($member['email']) ?>"
                                       class="member-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700"
                                       onchange="updateSelectedMembersCount()">
                                <span class="text-sm text-gray-900 dark:text-gray-100"><?= htmlspecialchars($member['full_name']) ?></span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">(<?= htmlspecialchars($member['email']) ?>)</span>
                            </label>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutar <span class="text-red-500">*</span></label>
                        <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Durum <span class="text-red-500">*</span></label>
                        <select name="payment_status" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="pending">Bekliyor</option>
                            <option value="paid">Ödendi</option>
                            <option value="refunded">İade Edildi</option>
                            <option value="cancelled">İptal</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Yöntemi</label>
                        <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Seçiniz</option>
                            <option value="Nakit">Nakit</option>
                            <option value="Banka Transferi">Banka Transferi</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Online Ödeme">Online Ödeme</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Tarihi</label>
                        <input type="date" name="payment_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">İşlem ID</label>
                    <input type="text" name="transaction_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Banka/Ödeme işlem numarası">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notlar</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Ek notlar..."></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('addPaymentModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Payment Modal -->
<div id="editPaymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60] overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full p-6 my-4">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Ödeme Düzenle</h3>
            <button onclick="closeModal('editPaymentModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="editPaymentForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="update_payment">
            <input type="hidden" name="current_view" value="finance">
            <input type="hidden" name="id" value="">
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Etkinlik</label>
                        <select name="event_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Etkinlik Seçiniz</option>
                            <?php foreach (isset($events) ? $events : [] as $event): ?>
                                <option value="<?= $event['id'] ?>"><?= htmlspecialchars($event['title']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Üye</label>
                        <select name="member_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" onchange="updateMemberInfo(this)">
                            <option value="">Üye Seçiniz</option>
                            <?php foreach (isset($members) ? $members : [] as $member): ?>
                                <option value="<?= $member['id'] ?>" data-name="<?= htmlspecialchars($member['full_name']) ?>" data-email="<?= htmlspecialchars($member['email']) ?>"><?= htmlspecialchars($member['full_name']) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Üye Adı</label>
                        <input type="text" name="member_name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Üye E-posta</label>
                        <input type="email" name="member_email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutar <span class="text-red-500">*</span></label>
                        <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Durum <span class="text-red-500">*</span></label>
                        <select name="payment_status" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="pending">Bekliyor</option>
                            <option value="paid">Ödendi</option>
                            <option value="refunded">İade Edildi</option>
                            <option value="cancelled">İptal</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Yöntemi</label>
                        <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                            <option value="">Seçiniz</option>
                            <option value="Nakit">Nakit</option>
                            <option value="Banka Transferi">Banka Transferi</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Online Ödeme">Online Ödeme</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ödeme Tarihi</label>
                        <input type="date" name="payment_date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">İşlem ID</label>
                    <input type="text" name="transaction_id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notlar</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('editPaymentModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Güncelle</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Yeni Kategori Ekle</h3>
            <button onclick="closeModal('addCategoryModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="addCategoryForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="add_financial_category">
            <input type="hidden" name="current_view" value="finance">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori Adı <span class="text-red-500">*</span></label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tür <span class="text-red-500">*</span></label>
                    <select name="type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                        <option value="income">Gelir</option>
                        <option value="expense">Gider</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Renk</label>
                    <input type="color" name="color" value="#3b82f6" class="w-full h-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500" placeholder="Kategori açıklaması..."></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('addCategoryModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editCategoryModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Kategori Düzenle</h3>
            <button onclick="closeModal('editCategoryModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form method="POST" id="editCategoryForm" action="index.php?view=finance">
            <?= csrf_token_field() ?>
            <input type="hidden" name="action" value="update_financial_category">
            <input type="hidden" name="current_view" value="finance">
            <input type="hidden" name="id" value="">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategori Adı <span class="text-red-500">*</span></label>
                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tür <span class="text-red-500">*</span></label>
                    <select name="type" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500">
                        <option value="income">Gelir</option>
                        <option value="expense">Gider</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Renk</label>
                    <input type="color" name="color" value="#3b82f6" class="w-full h-10 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-500"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeModal('editCategoryModal')" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">İptal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Güncelle</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script<?= tpl_script_nonce_attr(); ?>>
function updateMemberInfo(select) {
    const option = select.options[select.selectedIndex];
    if (option.value) {
        const form = select.closest('form');
        form.querySelector('input[name="member_name"]').value = option.dataset.name || '';
        form.querySelector('input[name="member_email"]').value = option.dataset.email || '';
    }
}
</script>

<!-- Optimize Edilmiş Aktivite İzleme Sistemi -->
<script<?= tpl_script_nonce_attr(); ?>>
(function() {
    'use strict';
    
    // Log batch sistemi - performans için
    const logQueue = [];
    const LOG_BATCH_SIZE = 10; // 10 log biriktirince gönder
    const LOG_BATCH_INTERVAL = 5000; // 5 saniyede bir gönder
    const LOG_RATE_LIMIT = 50; // Dakikada maksimum 50 log
    let logCount = 0;
    let logResetTime = Date.now() + 60000; // 1 dakika
    
    // Rate limiting kontrolü
    function checkRateLimit() {
        const now = Date.now();
        if (now > logResetTime) {
            logCount = 0;
            logResetTime = now + 60000;
        }
        return logCount < LOG_RATE_LIMIT;
    }
    
    // Log gönderme fonksiyonu (batch)
    function sendLogBatch() {
        if (logQueue.length === 0) return;
        
        const batch = logQueue.splice(0, LOG_BATCH_SIZE);
        
        try {
            fetch('index.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    action: 'log_activity_batch',
                    logs: JSON.stringify(batch),
                    current_view: new URLSearchParams(window.location.search).get('view') || 'dashboard',
                    page_url: window.location.href
                })
            }).catch(err => {
                // Hata durumunda logları geri ekle (ilk 10 tanesi)
                logQueue.unshift(...batch.slice(0, 10));
                console.error('Log gönderme hatası:', err);
            });
        } catch (e) {
            console.error('Log aktivite hatası:', e);
        }
    }
    
    // Periyodik batch gönderimi
    setInterval(sendLogBatch, LOG_BATCH_INTERVAL);
    
    // Sayfa kapanırken kalan logları gönder
    window.addEventListener('beforeunload', function() {
        if (logQueue.length > 0) {
            // Synchronous gönderim (sayfa kapanırken)
            navigator.sendBeacon('index.php', new URLSearchParams({
                action: 'log_activity_batch',
                logs: JSON.stringify(logQueue),
                current_view: new URLSearchParams(window.location.search).get('view') || 'dashboard',
                page_url: window.location.href
            }).toString());
        }
    });
    
    // Log ekleme fonksiyonu (optimize edilmiş)
    function logActivity(actionType, actionDescription, additionalData = {}, priority = 'normal') {
        // Rate limiting kontrolü
        if (!checkRateLimit() && priority !== 'high') {
            return; // Öncelikli değilse ve rate limit aşıldıysa loglama
        }
        
        // Önemli olmayan logları filtrele
        const lowPriorityActions = ['page_view', 'modal_open', 'modal_close', 'tab_switch'];
        if (lowPriorityActions.includes(actionType) && priority !== 'high') {
            // Düşük öncelikli logları daha az sıklıkla logla
            if (Math.random() > 0.3) return; // %70'i atla
        }
        
        logCount++;
        
        const logEntry = {
            action_type: actionType,
            action_description: actionDescription,
            additional_data: additionalData,
            timestamp: new Date().toISOString()
        };
        
        logQueue.push(logEntry);
        
        // Batch dolduysa hemen gönder
        if (logQueue.length >= LOG_BATCH_SIZE) {
            sendLogBatch();
        }
    }
    
    // Sayfa görüntüleme logu (sadece önemli sayfalar)
    document.addEventListener('DOMContentLoaded', function() {
        const currentView = new URLSearchParams(window.location.search).get('view') || 'dashboard';
        const importantViews = ['logs', 'finance', 'reports', 'settings'];
        if (importantViews.includes(currentView)) {
            logActivity('page_view', 'Sayfa görüntülendi: ' + currentView, {
                view: currentView,
                url: window.location.href
            }, 'normal');
        }
    });
    
    // Önemli form gönderimlerini logla (sadece kritik işlemler)
    document.addEventListener('submit', function(e) {
        const form = e.target;
        if (form.tagName === 'FORM' && form.method === 'POST') {
            const formData = new FormData(form);
            const action = formData.get('action') || 'form_submit';
            
            // Sadece önemli işlemleri logla
            const importantActions = ['add_event', 'update_event', 'delete_event', 'add_member', 'update_member', 'delete_member', 
                                     'add_board_member', 'update_board_member', 'delete_board_member', 'send_email', 'send_sms',
                                     'add_financial_transaction', 'update_financial_transaction', 'delete_financial_transaction',
                                     'update_settings', 'create_backup'];
            
            if (importantActions.includes(action)) {
                logActivity('form_submit', 'Form gönderildi: ' + action, {
                    action: action,
                    form_id: form.id || 'unknown'
                }, 'high'); // Yüksek öncelik
            }
        }
    });
    
    // Tüm buton tıklamalarını logla (önemli butonlar)
    document.addEventListener('click', function(e) {
        const target = e.target;
        const button = target.closest('button, a[href], input[type="submit"], input[type="button"]');
        
        if (button) {
            const buttonText = button.textContent?.trim() || button.value || button.title || 'Unknown';
            const buttonId = button.id || '';
            const buttonClass = button.className || '';
            const href = button.href || '';
            const onclick = button.getAttribute('onclick') || '';
            
            // Önemli butonları filtrele
            const importantActions = ['add', 'update', 'delete', 'edit', 'save', 'send', 'export', 'import', 'backup', 'clear', 'logout', 'delete', 'sil', 'ekle', 'güncelle', 'gönder', 'dışa aktar', 'içe aktar'];
            const isImportant = importantActions.some(action => 
                buttonText.toLowerCase().includes(action) || 
                buttonId.toLowerCase().includes(action) ||
                buttonClass.toLowerCase().includes(action) ||
                onclick.toLowerCase().includes(action)
            );
            
            if (isImportant || button.classList.contains('bg-red') || button.classList.contains('bg-blue') || button.classList.contains('bg-green')) {
                logActivity('button_click', 'Buton tıklandı: ' + buttonText, {
                    button_id: buttonId,
                    button_text: buttonText,
                    button_class: buttonClass,
                    href: href,
                    onclick: onclick.substring(0, 200)
                });
            }
        }
    });
    
    // Arama işlemlerini logla (sadece önemli aramalar - uzun arama terimleri)
    const searchInputs = document.querySelectorAll('input[type="search"], input[placeholder*="ara"], input[placeholder*="Ara"], input[name*="search"], input[id*="search"]');
    searchInputs.forEach(input => {
        let searchTimeout;
        input.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                const searchTerm = e.target.value;
                // Sadece 3+ karakterlik aramaları logla
                if (searchTerm.length >= 3) {
                    logActivity('search', 'Arama yapıldı: ' + searchTerm.substring(0, 50), {
                        search_term: searchTerm.substring(0, 50),
                        input_id: e.target.id || ''
                    }, 'normal');
                }
            }, 2000); // 2 saniye bekle (daha uzun debounce)
        });
    });
    
    // Dosya yükleme işlemlerini logla (sadece büyük dosyalar)
    document.addEventListener('change', function(e) {
        if (e.target.type === 'file' && e.target.files.length > 0) {
            const file = e.target.files[0];
            // Sadece 1MB'dan büyük dosyaları logla
            if (file.size > 1048576) {
                logActivity('file_upload', 'Büyük dosya yüklendi: ' + file.name, {
                    file_name: file.name,
                    file_size: file.size,
                    file_type: file.type
                }, 'high');
            }
        }
    });
    
    // Sadece önemli AJAX isteklerini logla
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const url = args[0];
        const options = args[1] || {};
        
        if (options.method === 'POST' && typeof url === 'string' && url.includes('index.php')) {
            const body = options.body;
            let action = 'unknown';
            
            if (body instanceof FormData) {
                action = body.get('action') || 'unknown';
            } else if (typeof body === 'string') {
                const params = new URLSearchParams(body);
                action = params.get('action') || 'unknown';
            }
            
            // Sadece kritik AJAX isteklerini logla
            const importantAjaxActions = ['send_email', 'send_sms', 'process_email_queue', 'create_backup'];
            if (importantAjaxActions.includes(action)) {
                logActivity('ajax_request', 'Kritik AJAX isteği: ' + action, {
                    action: action
                }, 'high');
            }
        }
        
        return originalFetch.apply(this, args);
    };
    
    console.log('✅ Optimize Edilmiş Aktivite İzleme Sistemi aktif! (Batch logging, Rate limiting aktif)');
})();
</script>

    <!-- QR Kod Modal -->
    <div id="qrCodeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full mx-4 p-6 sm:p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 id="qrCodeTitle" class="text-xl font-bold text-gray-900 dark:text-white">QR Kod</h3>
                <button onclick="closeQRCodeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-center space-y-4">
                <div class="flex justify-center">
                    <img id="qrCodeImage" src="" alt="QR Code" class="w-64 h-64 bg-white p-4 rounded-xl shadow-lg" style="display: none;">
                </div>
                <p id="qrCodeContent" class="text-sm text-gray-600 dark:text-gray-400 font-mono break-all px-4"></p>
                <button onclick="closeQRCodeModal()" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl">
                    Kapat
                </button>
            </div>
        </div>
    </div>

    <script<?= tpl_script_nonce_attr(); ?>>
        // QR Kod Fonksiyonları
        function resolveQrApiPath() {
            const pathname = window.location.pathname || '';
            if (pathname.includes('/communities/')) {
                return '../../api/qr_code.php';
            }
            if (pathname.includes('/public/')) {
                return '../api/qr_code.php';
            }
            return 'api/qr_code.php';
        }

        function showQRCode(type, id, title, communityId = null) {
            const modal = document.getElementById('qrCodeModal');
            const qrImage = document.getElementById('qrCodeImage');
            const qrTitle = document.getElementById('qrCodeTitle');
            const qrContent = document.getElementById('qrCodeContent');
            
            if (!modal || !qrImage || !qrTitle || !qrContent) return;
            
            qrTitle.textContent = title + ' QR Kodu';
            qrContent.textContent = 'Yükleniyor...';
            qrImage.src = '';
            qrImage.style.display = 'none';
            
            // QR kod URL'i oluştur
            const apiPath = resolveQrApiPath();
            let qrUrl = apiPath + '?type=' + encodeURIComponent(type) + '&id=' + encodeURIComponent(id) + '&size=300';
            if (type === 'event' && communityId) {
                qrUrl += '&community_id=' + encodeURIComponent(communityId);
            }
            
            // QR kod içeriği
            let qrContentText = '';
            if (type === 'community') {
                qrContentText = 'unifour://community/' + id;
            } else if (type === 'event') {
                qrContentText = 'unifour://event/' + (communityId || id) + '/' + id;
            }
            qrContent.textContent = qrContentText;
            
            // QR kod görselini yükle
            qrImage.onload = function() {
                qrImage.style.display = 'block';
            };
            qrImage.onerror = function() {
                qrImage.style.display = 'none';
                qrContent.textContent = 'QR kod yüklenemedi. Lütfen tekrar deneyin.';
            };
            qrImage.src = qrUrl;
            
            modal.classList.remove('hidden');
        }
        
        function closeQRCodeModal() {
            const modal = document.getElementById('qrCodeModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // QR kod modal'ını kapat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQRCodeModal();
            }
        });
        
    </script>

</body>
</html>

<?php
// =================================================================
// OTOMATİK TEMPLATE SENKRONİZASYONU
// =================================================================

// Template değişikliklerini tüm topluluklara otomatik uygula
if (isset($_SESSION['admin_id']) && $_SESSION['admin_id']) {
    // Sadece admin kullanıcıları için çalıştır
    try {
        // Sync script'ini dahil et (PROJECT_ROOT kullanarak)
        $syncScriptPath = defined('PROJECT_ROOT')
            ? PROJECT_ROOT . '/system/scripts/sync_templates.php'
            : __DIR__ . '/../../system/scripts/sync_templates.php';
        
        if (file_exists($syncScriptPath)) {
            require_once $syncScriptPath;
        } else {
            tpl_error_log("Sync script bulunamadı: " . $syncScriptPath);
        }
        
        // Tüm topluluklara template'leri senkronize et
        $syncResult = syncTemplates();
        
        // Sync log'u (opsiyonel)
        if (!$syncResult['success']) {
            tpl_error_log("Template sync hatası: " . implode(', ', $syncResult['errors']));
        }
    } catch (Exception $e) {
        tpl_error_log("Template sync exception: " . $e->getMessage());
    }
}
?>

<!-- Portal Dropdown'lar - Body'nin sonunda, header'dan bağımsız -->
<div id="notification-dropdown" class="fixed w-96 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 z-50 hidden overflow-hidden" style="display: none;">
    <!-- Header - Simple gray -->
    <div class="bg-gray-50 dark:bg-gray-900 p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                </svg>
                Bildirimler
            </h3>
            <?php if ($unread_notification_count > 0): ?>
                <span class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2.5 py-1 rounded-full font-semibold">
                    <?= $unread_notification_count ?> yeni
                </span>
            <?php endif; ?>
    </div>
    </div>
    
    <!-- Notifications List -->
    <div class="max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">
        <?php if (count($notifications) > 0): ?>
            <?php foreach ($notifications as $notification): ?>
                <div class="group p-4 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 <?= $notification['is_read'] == 0 ? 'bg-gray-50/50 dark:bg-gray-900/50' : '' ?> cursor-pointer transition-all duration-200" onclick="showNotificationDetail(<?= (int)$notification['id'] ?>, <?= tpl_js_escaped($notification['title'] ?? '') ?>, <?= tpl_js_escaped($notification['message'] ?? '') ?>, <?= tpl_js_escaped($notification['type'] ?? '') ?>, <?= tpl_js_escaped(date('d.m.Y H:i', strtotime($notification['created_at']))) ?>, <?= (int)$notification['is_read'] ?>)">
                    <div class="flex items-start gap-3">
                        <!-- Simple Icon -->
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg shrink-0">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
                            </svg>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-1">
                                <p class="text-sm font-semibold text-gray-900 dark:text-gray-100 line-clamp-1 flex-1">
                                    <?= htmlspecialchars($notification['title']) ?>
                                </p>
                                <?php if ($notification['is_read'] == 0): ?>
                                    <span class="inline-flex items-center w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full shrink-0"></span>
                                <?php endif; ?>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 mb-2 leading-relaxed">
                                <?= htmlspecialchars($notification['message']) ?>
                            </p>
                            <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <?= date('d.m.Y H:i', strtotime($notification['created_at'])) ?>
                            </div>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php else: ?>
            <div class="p-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 mb-4 bg-gray-100 dark:bg-gray-700 rounded-full">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
                </div>
                <p class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-1">Henüz bildirim yok</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Yeni bildirimler burada görünecek</p>
            </div>
        <?php endif; ?>
    </div>
    
    <!-- Footer -->
    <div class="p-3 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700">
        <a href="?view=notifications" class="block text-center text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 transition-colors py-1">
            Tüm bildirimleri gör →
        </a>
    </div>
</div>

<div id="profile-dropdown" class="fixed w-64 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 z-50 hidden overflow-hidden" style="display: none;">
    <!-- Header -->
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-3">
            <div class="relative">
                <div class="w-12 h-12 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center border border-gray-200 dark:border-gray-600">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
            </div>
                <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></div>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate"><?= htmlspecialchars($club_name) ?></p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Yönetici</p>
        </div>
    </div>
    </div>
    
    <!-- Menu Items -->
    <div class="py-2">
        <?php
        $verificationBadgeClasses = [
            'approved' => 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-100 dark:border-emerald-500/30',
            'pending' => 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-500/10 dark:text-amber-100 dark:border-amber-500/30',
            'rejected' => 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-500/10 dark:text-rose-100 dark:border-rose-500/30',
            'none' => 'bg-gray-100 text-gray-600 border-gray-200 dark:bg-gray-700/40 dark:text-gray-200 dark:border-gray-600'
        ];
        $verificationBadgeClass = $verificationBadgeClasses[$verificationStatusCode] ?? $verificationBadgeClasses['none'];
        ?>
        <a href="?view=settings" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            </div>
            <span class="font-medium">Ayarlar</span>
        </a>
        
        <a href="?view=verification" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                <img src="<?= htmlspecialchars($verificationBadgeImage) ?>" alt="" class="w-4 h-4" loading="lazy">
            </div>
            <div class="flex-1 min-w-0">
                <span class="font-medium">Topluluk Onayı</span>
                <p class="text-xs text-gray-500 dark:text-gray-400"><?= htmlspecialchars($verificationStatusMeta['description']) ?></p>
            </div>
            <span class="ml-2 text-[11px] font-semibold px-2 py-0.5 rounded-full border <?= $verificationBadgeClass ?>">
                <?= htmlspecialchars($verificationStatusMeta['label']) ?>
            </span>
        </a>
        
        <?php if (!empty($_SESSION['is_superadmin'])): ?>
            <div class="px-4 pt-3 pb-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-400 dark:text-gray-500">SuperAdmin</div>
            <a href="?view=verification_admin" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
                <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                    <img src="<?= htmlspecialchars($verificationBadgeImage) ?>" alt="" class="w-4 h-4" loading="lazy">
                </div>
                <div class="flex-1 min-w-0">
                    <span class="font-medium">Topluluk Onayı</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400"><?= htmlspecialchars($verificationStatusMeta['description']) ?></p>
                </div>
                <span class="ml-2 text-[11px] font-semibold px-2 py-0.5 rounded-full border <?= $verificationBadgeClass ?>">
                    <?= htmlspecialchars($verificationStatusMeta['label']) ?>
                </span>
            </a>
        <?php endif; ?>
        
        <a href="?view=support" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <span class="font-medium">Destek</span>
        </a>
        
        <a href="?view=notifications" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200 relative">
                <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            </div>
            <span class="font-medium">Bildirimler</span>
            <?php if ($unread_notification_count > 0): ?>
                <span class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-medium"><?= $unread_notification_count ?></span>
            <?php endif; ?>
        </a>
        
        <a href="?view=subscription" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                </svg>
            </div>
            <span class="font-medium">Abonelik Yönetimi</span>
        </a>
        
        <a href="?view=system_info" class="group flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
            <div class="w-8 h-8 mr-3 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gray-200 dark:group-hover:bg-gray-600 transition-colors duration-200">
                <svg class="w-4 h-4 text-gray-600 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <span class="font-medium">Sistem Hakkında</span>
        </a>
        
        <!-- Çıkış Yap -->
        <div class="border-t border-gray-200 dark:border-gray-700 mt-2 pt-2">
            <form method="POST" action="index.php" class="block">
                <input type="hidden" name="action" value="logout">
                <?= csrf_token_field() ?>
                <button type="submit" class="w-full group flex items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-200 rounded-lg">
                    <div class="w-8 h-8 mr-3 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center group-hover:bg-red-200 dark:group-hover:bg-red-900/50 transition-colors duration-200">
                        <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    </div>
                    <span class="font-medium">Çıkış Yap</span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Lazy Loading JavaScript - YENİ SİSTEM -->
<script>
(function() {
    'use strict';
    
    // API Base URL
    const API_BASE_URL = '/unipanel/api';
    
    // escapeHtml ve escapeJs zaten head'de tanımlı, burada sadece referans al
    const escapeHtml = window.escapeHtml;
    const escapeJs = window.escapeJs;
    
    // Lazy Loading System - Scroll-based
    const LazyLoader = {
        state: {},
        observers: {},
        
        // Initialize lazy loading for a type
        init(type, config) {
            if (!config || !config.endpoint || !config.containerId) {
                console.warn(`[${type}] Lazy loading config eksik:`, config);
                return;
            }
            
            // State'i başlat
            this.state[type] = {
                offset: config.initialOffset || 0,
                limit: config.limit || 30,
                hasMore: true,
                loading: false,
                total: 0
            };
            
            // Intersection Observer oluştur
            const container = document.getElementById(config.containerId);
            const spinner = config.spinnerId ? document.getElementById(config.spinnerId) : null;
            
            if (!container) {
                console.warn(`[${type}] Container bulunamadı: ${config.containerId}`);
                return;
            }
            
            // Observer oluştur
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !this.state[type].loading && this.state[type].hasMore) {
                        this.load(type, config, observer);
                    }
                });
            }, {
                rootMargin: '200px' // 200px önceden yükle
            });
            
            this.observers[type] = observer;
            
            // Spinner'ı gözle
            if (spinner) {
                observer.observe(spinner);
            }
            
            console.log(`[${type}] Lazy loading başlatıldı`, {
                containerId: config.containerId,
                spinnerId: config.spinnerId,
                hasSpinner: !!spinner,
                hasContainer: !!container
            });
        },
        
        // Load more data
        async load(type, config, observer = null) {
            const state = this.state[type];
            if (!state) {
                console.error(`[${type}] State bulunamadı`);
                return;
            }
            
            // Daha fazla veri yoksa veya zaten yükleniyorsa çık
            if (!state.hasMore || state.loading) {
                return;
            }
            
            state.loading = true;
            const { endpoint, containerId, spinnerId, createCard, limit = 30 } = config;
            
            const spinner = spinnerId ? document.getElementById(spinnerId) : null;
            const container = containerId ? document.getElementById(containerId) : null;
            
            if (!container) {
                console.error(`[${type}] Container bulunamadı: ${containerId}`);
                state.loading = false;
                return;
            }
            
            if (!createCard || typeof createCard !== 'function') {
                console.error(`[${type}] createCard fonksiyonu bulunamadı`);
                state.loading = false;
                return;
            }
            
            // Spinner'ı göster
            if (spinner) {
                spinner.classList.remove('hidden');
            }
            
            const apiUrl = `${API_BASE_URL}/${endpoint}?offset=${state.offset}&limit=${limit}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Items'ı al
                let items = [];
                if (type === 'members' && data.members) {
                    items = data.members;
                } else if (type === 'events' && data.events) {
                    items = data.events;
                } else {
                    items = data[type] || data.data || [];
                }
                
                if (data.success && Array.isArray(items) && items.length > 0) {
                    // Items'ı ekle
                    items.forEach((item) => {
                        try {
                            const html = createCard(item);
                            if (html && html.trim() !== '') {
                                container.insertAdjacentHTML('beforeend', html);
                            }
                        } catch (error) {
                            console.error(`[${type}] Item eklenirken hata:`, error);
                        }
                    });
                    
                    // State güncelle
                    state.offset += items.length;
                    state.hasMore = data.has_more !== undefined ? data.has_more : (data.hasMore !== undefined ? data.hasMore : false);
                    state.total = data.total || state.total;
                    
                    // Daha fazla yoksa spinner'ı gizle
                    if (!state.hasMore && spinner) {
                        spinner.classList.add('hidden');
                    }
                } else {
                    state.hasMore = false;
                    if (spinner) {
                        spinner.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error(`[${type}] Yükleme hatası:`, error);
                if (spinner) {
                    spinner.classList.add('hidden');
                }
            } finally {
                state.loading = false;
            }
        }
    };
    
    // Global scope'a ekle
    window.LazyLoader = LazyLoader;
    
    // Sayfa yüklendiğinde lazy loading'i başlat
    document.addEventListener('DOMContentLoaded', function() {
        // Sadece events veya members view'ında lazy loading başlat
        const currentView = new URLSearchParams(window.location.search).get('view');
        
        // Etkinlikler için lazy loading
        if (currentView === 'events' || !currentView) {
            const eventsContainer = document.getElementById('eventsCardsContainer');
            if (eventsContainer) {
                const initialEventsCount = eventsContainer.children.length;
                // Eğer daha fazla etkinlik varsa lazy loading başlat
                <?php if ($has_more_events): ?>
                LazyLoader.init('events', {
                    endpoint: 'load_events.php',
                    containerId: 'eventsCardsContainer',
                    spinnerId: 'eventsLoadingSpinner',
                    createCard: window.createEventCard,
                    limit: 30,
                    initialOffset: initialEventsCount
                });
                console.log('[LazyLoader] Etkinlikler lazy loading başlatıldı, ilk yükleme:', initialEventsCount);
                <?php else: ?>
                // Daha fazla etkinlik yok, spinner'ı gizle
                const eventsSpinner = document.getElementById('eventsLoadingSpinner');
                if (eventsSpinner) eventsSpinner.classList.add('hidden');
                <?php endif; ?>
            }
        }
        
        // Üyeler için lazy loading
        if (currentView === 'members') {
            const membersContainer = document.getElementById('member_cards_container');
            if (membersContainer) {
                const initialMembersCount = membersContainer.children.length;
                // Eğer daha fazla üye varsa lazy loading başlat
                <?php if ($has_more_members): ?>
                LazyLoader.init('members', {
                    endpoint: 'load_members.php',
                    containerId: 'member_cards_container',
                    spinnerId: 'membersLoadingSpinner',
                    createCard: window.createMemberCard,
                    limit: 30,
                    initialOffset: initialMembersCount
                });
                console.log('[LazyLoader] Üyeler lazy loading başlatıldı, ilk yükleme:', initialMembersCount);
                <?php else: ?>
                // Daha fazla üye yok, spinner'ı gizle
                const membersSpinner = document.getElementById('membersLoadingSpinner');
                if (membersSpinner) membersSpinner.classList.add('hidden');
                <?php endif; ?>
            }
        }
    });
})();

// Etkinlik kartı oluştur
window.createEventCard = function(event) {
    if (!event) return '';
    
    // escapeHtml ve escapeJs fonksiyonlarını kontrol et
    const escapeHtml = window.escapeHtml || function(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    };
    const escapeJs = window.escapeJs || function(text) {
        if (text == null) return '';
        return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    };
    
    const status = event.status || 'planlanıyor';
    const category = event.category || 'Genel';
    const priority = event.priority || 'normal';
    const featured = event.featured || 0;
    
    const statusColors = {
        'planlanıyor': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200',
        'devam_ediyor': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
        'tamamlandı': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200',
        'iptal': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
    };
    
    const eventDate = new Date(event.date);
    const formattedDate = eventDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    // Event image
    const eventImage = event.image_path || '';
    const imageHtml = eventImage ? 
        `<img src="${escapeHtml(eventImage)}" alt="${escapeHtml(event.title || '')}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
        '';
    
    // Gradient colors
    const gradientColors = {
        'Genel': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'Seminer': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'Workshop': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'Kongre': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'Sosyal': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'Spor': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
        'Kültür': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        'Eğitim': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
        'Teknoloji': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
    };
    const gradient = gradientColors[category] || gradientColors['Genel'];
    
    const isPast = new Date(event.date) < new Date();
    const formattedDate = new Date(event.date).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    return `
        <div class="event-card bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col"
             data-title="${escapeHtml((event.title || '').toLowerCase())}"
             data-status="${status}"
             data-category="${category}"
             data-priority="${priority}"
             data-date="${event.date}">
            <!-- Event Image -->
            <div class="event-image relative h-48 overflow-hidden bg-white dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                ${imageHtml}
                <div class="absolute inset-0 flex items-center justify-center" style="${eventImage ? 'display: none;' : ''}">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-16 h-16 text-indigo-500 dark:text-indigo-400 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="mt-2 text-xs text-gray-400 dark:text-gray-500 font-medium">Etkinlik Görseli</span>
                    </div>
                </div>
                ${featured ? `
                <div class="absolute top-3 right-3">
                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                </div>
                ` : ''}
            </div>
            
            <!-- Event Content -->
            <div class="p-5 flex flex-col flex-grow">
                <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-3 line-clamp-2">
                    ${escapeHtml(event.title || 'Etkinlik')}
                </h3>
                
                <div class="space-y-2 mb-4 flex-grow">
                    ${event.location ? `
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-map-marker-alt text-indigo-500 dark:text-indigo-400 w-4 mr-2"></i>
                        <span>${escapeHtml(event.location)}</span>
                    </div>
                    ` : ''}
                    
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <svg class="w-4 h-4 mr-2 text-indigo-500 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>${formattedDate}${event.time ? ' ' + escapeHtml(event.time) : ''}</span>
                    </div>
                    
                    <div class="flex items-center gap-2 mt-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[status] || statusColors['planlanıyor']}">
                            ${escapeHtml(status)}
                        </span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">
                            ${escapeHtml(category)}
                        </span>
                    </div>
                </div>
                
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-users text-indigo-500 dark:text-indigo-400 mr-1.5"></i>
                        <span>0 katılımcı</span>
                    </div>
                    <div class="flex gap-2">
                        <a href="?view=event_detail&event_id=${event.id}" 
                           class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-xs font-semibold transition">
                            Detay
                        </a>
                        <button onclick="openEditModal('event', ${event.id}, '${escapeJs(event.title || '')}', '${escapeJs(event.date || '')}', '${escapeJs(event.time || '')}', '${escapeJs(event.location || '')}', '${escapeJs((event.description || '').replace(/\r|\n/g, ' '))}')" 
                                class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-xs font-semibold transition">
                            Düzenle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// Üye kartı oluştur
// Yönetim kurulu üyesi satırı oluştur
window.createBoardMemberCard = function(officer) {
    if (!officer) return '';
    
    // escapeHtml fonksiyonunu kontrol et
    const escapeHtml = window.escapeHtml || function(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    };
    
    const fullName = escapeHtml(officer.full_name || officer.name || '');
    const role = escapeHtml(officer.role || officer.position || '');
    const phone = escapeHtml(officer.phone || officer.phone_number || 'Belirtilmemiş');
    const email = escapeHtml(officer.contact_email || officer.email || '');
    const id = officer.id || 0;
    
    return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${fullName}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                    ${role}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${phone}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="openEditModal('board', ${id}, ${JSON.stringify(fullName)}, ${JSON.stringify(role)}, ${JSON.stringify(email)}, ${JSON.stringify(phone)})" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold mx-2 transition duration-150">Düzenle</button>
                <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu görevliyi silmek istediğinizden emin misiniz?');">
                    <input type="hidden" name="action" value="delete_board_member">
                    <input type="hidden" name="current_view" value="board">
                    <input type="hidden" name="id" value="${id}">
                    <input type="hidden" name="csrf_token" value="${document.querySelector('meta[name="csrf-token"]')?.content || ''}">
                    <button type="submit" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold transition duration-150">Sil</button>
                </form>
            </td>
        </tr>
    `;
};

window.createMemberCard = function(member) {
    // escapeHtml ve escapeJs fonksiyonlarını kontrol et
    const escapeHtml = window.escapeHtml || function(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    };
    const escapeJs = window.escapeJs || function(text) {
        if (text == null) return '';
        return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    };
    
    const fullName = escapeHtml(member.full_name || 'İsimsiz Üye');
    const nameParts = fullName.split(' ', 2);
    const firstName = nameParts[0] || '';
    const lastName = nameParts[1] || '';
    const initials = (firstName.charAt(0) + (lastName ? lastName.charAt(0) : '')).toUpperCase();
    
    const regDate = member.registration_date ? new Date(member.registration_date).toLocaleDateString('tr-TR') : '';
    
    return `
        <div class="member-card bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg p-5 hover:shadow-md transition-all duration-200" 
             data-name="${fullName.toLowerCase()}"
             data-email="${escapeHtml((member.email || '').toLowerCase())}"
             data-student-id="${escapeHtml(member.student_id || '')}"
             data-phone="${escapeHtml(member.phone_number || '')}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-lg shadow-md">
                        ${initials || '?'}
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-900 dark:text-slate-100 text-base">${fullName}</h3>
                        ${member.student_id ? `<p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">${escapeHtml(member.student_id)}</p>` : ''}
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="openEditModal('member', ${member.id}, '${escapeJs(member.full_name || '')}', '${escapeJs(member.email || '')}', '${escapeJs(member.student_id || '')}', '${escapeJs(member.phone_number || '')}')" 
                        class="p-2 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition duration-150" title="Düzenle">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                    <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu üyeyi listeden kaldırmak istediğinizden emin misiniz?');">
                        <input type="hidden" name="action" value="delete_member">
                        <input type="hidden" name="current_view" value="members">
                        <input type="hidden" name="id" value="${member.id}">
                        <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                        <button type="submit" class="p-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition duration-150" title="Sil">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="space-y-2">
                ${member.email ? `
                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span class="truncate">${escapeHtml(member.email)}</span>
                </div>
                ` : ''}
                
                ${member.phone_number ? `
                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                    <span>${escapeHtml(member.phone_number)}</span>
                </div>
                ` : ''}
                
                ${regDate ? `
                <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 pt-2 border-t border-slate-100 dark:border-slate-700">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Kayıt: ${regDate}</span>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

    // Yönetim kurulu üyelerini yükle

// SMS ve Email contacts lazy loading kaldırıldı - tüm liste tek seferde yükleniyor

// Yönetim kurulu satırı oluştur
window.createBoardRow = function(officer) {
    return `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${escapeHtml(officer.full_name || '')}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                    ${escapeHtml(officer.role || '')}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${escapeHtml(officer.phone || 'Belirtilmemiş')}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${escapeHtml(officer.contact_email || '')}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="openEditModal('board', ${officer.id}, '${escapeJs(officer.full_name || '')}', '${escapeJs(officer.role || '')}', '${escapeJs(officer.contact_email || '')}', '${escapeJs(officer.phone || '')}')" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 font-semibold mx-2 transition duration-150">Düzenle</button>
                <form method="POST" action="index.php" class="inline-block" onsubmit="return confirm('Bu görevliyi silmek istediğinizden emin misiniz?');">
                    <input type="hidden" name="action" value="delete_board_member">
                    <input type="hidden" name="current_view" value="board">
                    <input type="hidden" name="id" value="${officer.id}">
                    <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                    <button type="submit" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold transition duration-150">Sil</button>
                </form>
            </td>
        </tr>
    `;
};

// Ürün kartı oluştur
window.createProductCard = function(product) {
    const imageUrl = product.image_url || (product.image_path ? `index.php?action=product_media&file=${encodeURIComponent(product.image_path)}` : '');
    const statusClass = product.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
    const statusText = product.status === 'active' ? 'Aktif' : 'Pasif';
    
    return `
        <div class="product-card bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden hover:shadow-md transition duration-200" 
             data-category="${escapeHtml(product.category || '')}"
             data-name="${escapeHtml((product.name || '').toLowerCase())}">
            ${imageUrl ? `
                <div class="h-48 bg-gray-200 dark:bg-gray-700 overflow-hidden">
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(product.name || '')}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EGörsel Yüklenemedi%3C/text%3E%3C/svg%3E';">
                </div>
            ` : `
                <div class="h-48 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/30 dark:to-purple-900/30 flex items-center justify-center">
                    <svg class="w-16 h-16 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
            `}
            <div class="p-4">
                <div class="flex items-start justify-between mb-2">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${escapeHtml(product.name || '')}</h4>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2">${escapeHtml(product.description || 'Açıklama yok')}</p>
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400">₺${parseFloat(product.price || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Stok:</span> ${product.stock || 0}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openEditProductModal(${product.id})" class="flex-1 px-3 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition-colors">
                        Düzenle
                    </button>
                    <form method="POST" action="index.php" class="inline" onsubmit="return confirm('Bu ürünü silmek istediğinize emin misiniz?');">
                        <input type="hidden" name="action" value="delete_product">
                        <input type="hidden" name="id" value="${product.id}">
                        <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                        <button type="submit" class="px-3 py-2 text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                            Sil
                        </button>
                    </form>
                </div>
            </div>
        </div>
    `;
};

// Kampanya kartı oluştur
window.createCampaignCard = function(campaign) {
    if (!campaign) return '';
    
    // escapeHtml ve escapeJs fonksiyonlarını kontrol et
    const escapeHtml = window.escapeHtml || function(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    };
    const escapeJs = window.escapeJs || function(text) {
        if (text == null) return '';
        return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
    };
    
    const isActive = parseInt(campaign.is_active) === 1;
    const startDate = campaign.start_date ? new Date(campaign.start_date).toLocaleDateString('tr-TR') : null;
    const endDate = campaign.end_date ? new Date(campaign.end_date).toLocaleDateString('tr-TR') : null;
    const isExpired = endDate && new Date(campaign.end_date) < new Date();
    const statusClass = isActive && !isExpired ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
    const statusText = isActive && !isExpired ? 'Aktif' : (isExpired ? 'Süresi Doldu' : 'Pasif');
    
    return `
        <div class="bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden ${!isActive || isExpired ? 'opacity-60' : ''}">
            ${campaign.image_path ? `
                <div class="h-48 bg-gray-100 dark:bg-gray-700 overflow-hidden">
                    <img src="${escapeHtml(campaign.image_path)}" alt="${escapeHtml(campaign.title || '')}" class="w-full h-full object-cover">
                </div>
            ` : `
                <div class="h-48 bg-gradient-to-br from-blue-500 to-indigo-500 flex items-center justify-center">
                    <svg class="w-16 h-16 text-white opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            `}
            <div class="p-5">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 line-clamp-2">${escapeHtml(campaign.title || '')}</h3>
                    <span class="ml-2 px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                </div>
                ${campaign.partner_name ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-2"><span class="font-medium">Partner:</span> ${escapeHtml(campaign.partner_name)}</p>` : ''}
                ${campaign.discount_percentage ? `<div class="mb-2"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">%${escapeHtml(campaign.discount_percentage)} İndirim</span></div>` : ''}
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-3 line-clamp-2">${escapeHtml(campaign.offer_text || '')}</p>
                ${startDate || endDate ? `
                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-4 space-y-1">
                        ${startDate ? `<div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Başlangıç: ${startDate}</span></div>` : ''}
                        ${endDate ? `<div class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Bitiş: ${endDate}</span></div>` : ''}
                    </div>
                ` : ''}
                <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="openEditCampaignModal(${campaign.id})" class="flex-1 px-3 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors">Düzenle</button>
                    <form method="POST" action="" class="inline" onsubmit="return confirm('Kampanyayı silmek istediğinize emin misiniz?');">
                        <input type="hidden" name="action" value="delete_campaign">
                        <input type="hidden" name="id" value="${campaign.id}">
                        <input type="hidden" name="csrf_token" value="<?= csrf_token() ?>">
                        <button type="submit" class="px-3 py-2 text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">Sil</button>
                    </form>
                </div>
            </div>
        </div>
    `;
};

// DOMContentLoaded'da event listener'ları ekle (güvenlik için)
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded: Event listener\'lar ekleniyor...');
    
    // Butonları bul ve event listener ekle
});
</script>


